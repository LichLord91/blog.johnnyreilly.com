<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=297675200"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","297675200",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="I CAN MAKE THIS WORK" href="/opensearch.xml">
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#3578e5">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">5 posts tagged with &quot;entity framework&quot; | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="5 posts tagged with &quot;entity framework&quot; | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/tags/entity-framework"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><meta data-react-helmet="true" name="robots" content="max-image-preview:large"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/tags/entity-framework"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/entity-framework" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/entity-framework" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://J3MYR1INLT-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.03530969.css">
<link rel="preload" href="/assets/js/runtime~main.e8b5d5f0.js" as="script">
<link rel="preload" href="/assets/js/main.e341d18b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://polywork.johnnyreilly.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Polywork<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/01/22/azure-container-apps-dapr-bicep-github-actions-debug-devcontainer">Azure Container Apps: dapr, devcontainer, debug and deploy</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2021/12/29/preload-fonts-with-docusaurus">Preload fonts with Docusaurus</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2021/12/28/azure-cli-show-query-output-properties">Query deployment outputs with the Azure CLI</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2021/12/27/azure-container-apps-build-and-deploy-with-bicep-and-github-actions">Azure Container Apps: build and deploy with Bicep and GitHub Actions</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2021/12/19/azure-container-apps-bicep-and-github-actions">Azure Container Apps, Bicep and GitHub Actions</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>5 posts tagged with &quot;entity framework&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2021/03/10/managed-identity-azure-sql-entity-framework">Managed Identity, Azure SQL and Entity Framework</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-03-10T00:00:00.000Z" itemprop="datePublished">March 10, 2021</time> Â· <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/assets/images/entity-framework-core-nuget-464de9500035d0815f4eae413acf55a7.png"><div class="markdown" itemprop="articleBody"><p>Managed Identity offers a very secure way for applications running in Azure to connect to Azure SQL databases. It&#x27;s an approach that does not require code changes; merely configuration of connection string and associated resources. Hence it has a good developer experience. Importantly, it allows us to avoid exposing our database to username / password authentication, and hence making it a tougher target for bad actors.</p><p>This post talks us through using managed identity for connecting to Azure SQL.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="integrated-securitytrue"><code>Integrated Security=true</code><a class="hash-link" href="#integrated-securitytrue" title="Direct link to heading">â€‹</a></h2><p>Everyone is deploying to the cloud. Few are the organisations that view deployment to data centers they manage as the future. This is generally a good thing, however in the excitement of the new, it&#x27;s possible to forget some of the good properties that &quot;on premise&quot; deployment afforded when it came to connectivity and authentication.</p><p>I speak of course, of our old friend <code>Integrated Security=true</code>. When you seek to connect a web application to a database, you&#x27;ll typically use some kind of database connection string. And back in the day, it may have looked something like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">Data Source=myServer;Initial Catalog=myDB;Integrated Security=true;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The above provides a database server, a database and also <code>Integrated Security=true</code>. When you see <code>Integrated Security=true</code>, what you&#x27;re essentially looking at is an instruction to use the identity that an application is running under (typically called a &quot;service account&quot;) as the authentication credential to secure access to the database. Under the covers, this amounts to <a href="https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/authentication-in-sql-server" target="_blank" rel="noopener noreferrer">Windows Authentication</a>.</p><p>The significant thing about this approach is that it is more secure than using usernames and passwords in the connection string. If you have to use username and password to authenticate, then you need to persist them somewhere - so you need to make sure that&#x27;s secure. Also, if someone manages to acquire that username and password, they&#x27;re free to get access to the database and do malicious things.</p><p>Bottom line: the less you are sharing authentication credentials, the better your security. Integrated Security is a harder nut to crack than username and password. The thing to note about the above phrase is &quot;Windows Authentication&quot;. Web Apps in Azure / AWS etc do not typically use Windows Authentication when it comes to connecting to the database. Connecting with username / password is far more common.</p><p>What if there was a way to have the developer experience of <code>Integrated Security=true</code> without needing to use Windows Authentication? There is.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="managed-identity">Managed Identity<a class="hash-link" href="#managed-identity" title="Direct link to heading">â€‹</a></h2><p>The docs express the purpose of <a href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview" target="_blank" rel="noopener noreferrer">managed identity</a> well:</p><blockquote><p>A common challenge for developers is the management of secrets and credentials to secure communication between different services. On Azure, managed identities eliminate the need for developers having to manage credentials by providing an identity for the Azure resource in Azure AD and using it to obtain Azure Active Directory (Azure AD) tokens</p></blockquote><p>Historically a certain amount of ceremony was required to use managed identity to connect to a database, and could involve augmenting a <code>DbContext</code> like so:</p><div class="codeBlockContainer_I0IT language-cs theme-code-block"><div class="codeBlockContent_wNvx cs"><pre tabindex="0" class="prism-code language-cs codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">public MyDbContext(DbContextOptions options) : base(options) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    var conn = (Microsoft.Data.SqlClient.SqlConnection)Database.GetDbConnection();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    var credential = new DefaultAzureCredential();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    var token = credential</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        .GetToken(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            new Azure.Core.TokenRequestContext(new[] { &quot;https://database.windows.net/.default&quot; })</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    conn.AccessToken = token.Token;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This mechanism works, and has the tremendous upside of no longer requiring credentials be passed in a connection string. However, as you can see this isn&#x27;t the simplest of setups. And also, what if you don&#x27;t want to use managed identity when you&#x27;re developing locally? This approach has baggage and forces us to make code changes.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="connection-string-alone">Connection String alone<a class="hash-link" href="#connection-string-alone" title="Direct link to heading">â€‹</a></h2><p>The wonderful aspect of the original <code>Integrated Security=true</code> approach, was that there were no code changes required; one need only supply the connection string. Just configuration.</p><p>This is now possible with Azure SQL thanks to <a href="https://github.com/dotnet/SqlClient/pull/730" target="_blank" rel="noopener noreferrer">this PR</a> to the <a href="https://www.nuget.org/packages/Microsoft.Data.SqlClient/" target="_blank" rel="noopener noreferrer">Microsoft.Data.SqlClient</a> nuget package. (Incidentally, <a href="https://devblogs.microsoft.com/dotnet/introducing-the-new-microsoftdatasqlclient/" target="_blank" rel="noopener noreferrer">Microsoft.Data.SqlClient is the successor to System.Data.SqlClient.</a>)</p><p>Support for connection string managed identities <a href="https://github.com/dotnet/SqlClient/blob/master/release-notes/2.1/2.1.0/index.md#Azure-Active-Directory-Managed-Identity-authentication" target="_blank" rel="noopener noreferrer">shipped with v2.1</a>. Connection strings can look slightly different depending on the type of managed identity you&#x27;re using:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">// For System Assigned Managed Identity</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&quot;Server:{serverURL}; Authentication=Active Directory MSI; Initial Catalog={db};&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// For System Assigned Managed Identity</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&quot;Server:{serverURL}; Authentication=Active Directory Managed Identity; Initial Catalog={db};&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// For User Assigned Managed Identity</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&quot;Server:{serverURL}; Authentication=Active Directory MSI; User Id={ObjectIdOfManagedIdentity}; Initial Catalog={db};&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// For User Assigned Managed Identity</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&quot;Server:{serverURL}; Authentication=Active Directory Managed Identity; User Id={ObjectIdOfManagedIdentity}; Initial Catalog={db};&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Regardless of the approach, you can see that none of the connection strings have credentials in them. And that&#x27;s special.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="usage-with-entity-framework-core-5">Usage with Entity Framework Core 5<a class="hash-link" href="#usage-with-entity-framework-core-5" title="Direct link to heading">â€‹</a></h2><p>If you&#x27;re using Entity Framework Core, you might be struggling to get this working and encountering strange error messages. In my ASP.NET project I had a dependendency on
<a href="https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.SqlServer/5.0.4" target="_blank" rel="noopener noreferrer">Microsoft.EntityFrameworkCore.SqlServer@5</a>.</p><p><img loading="lazy" alt="Microsoft.EntityFrameworkCore.SqlServer@5 in NuGet" src="/assets/images/entity-framework-core-nuget-464de9500035d0815f4eae413acf55a7.png" width="1516" height="1120"></p><p>If you look close above, you&#x27;ll see that the package has a dependency on Microsoft.Data.SqlClient, but crucially on 2.0.1 or greater. So if <code>dotnet</code> has installed a version of Microsoft.Data.SqlClient which is <em>less</em> than 2.1 then the functionality required will not be installed. The resolution is simple, ensure that the required version is installed:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet add package Microsoft.Data.SqlClient --version 2.1.2</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The version which we want to use is 2.1 (or greater) and fortunately that is compatible with Entity Framework Core 5. Incidentally, when Entity Framework Core 6 ships it will no longer be necessary to manually specify this dependency as it already requires <a href="mailto:Microsoft.Data.SqlClient@2.1" target="_blank" rel="noopener noreferrer">Microsoft.Data.SqlClient@2.1</a> as a minimum.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="user-assigned-managed-identity">User Assigned Managed Identity<a class="hash-link" href="#user-assigned-managed-identity" title="Direct link to heading">â€‹</a></h2><p>If you&#x27;re using user assigned managed identity, you&#x27;ll need to supply the object id of your managed identity, which you can find in the <a href="https://portal.azure.com/" target="_blank" rel="noopener noreferrer">Azure Portal</a>:</p><p><img loading="lazy" alt="Managed Identity object id" src="/assets/images/managed-identity-object-id-d793647bd73d2763f766bc3cad144ceb.png" width="1250" height="634"></p><p>You can configure this in ARM as well, but cryptically, the object id goes by the nom de plume of <code>principalId</code> (thanks to my partner in crime <a href="https://github.com/jmccor99" target="_blank" rel="noopener noreferrer">John McCormick</a> for puzzling that out):</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token property" style="color:rgb(128, 203, 196)">&quot;CONNECTIONSTRINGS__OURDBCONNECTION&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;[concat(&#x27;Server=tcp:&#x27;, parameters(&#x27;sqlServerName&#x27;) , &#x27;.database.windows.net,1433;Initial Catalog=&#x27;, parameters(&#x27;sqlDatabaseName&#x27;),&#x27;;Authentication=Active Directory MSI&#x27;,&#x27;;User Id=&#x27;, reference(resourceId(&#x27;Microsoft.ManagedIdentity/userAssignedIdentities/&#x27;, parameters(&#x27;managedIdentityName&#x27;)), &#x27;2018-11-30&#x27;).principalId)]&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>That&#x27;s it! With managed identity handling your authentication you can sleep easy, knowing you should be in a better place security wise.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/connection-string">connection string</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/managed-identity">managed identity</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/entity-framework">entity framework</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/microsoft-data-sql-client">Microsoft.Data.SqlClient</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Managed Identity, Azure SQL and Entity Framework" href="/2021/03/10/managed-identity-azure-sql-entity-framework"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2020/01/02/ef-core-31-breaks-left-join-with-no-navigation-property">EF Core 3.1 breaks left join with no navigation property</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2020-01-02T00:00:00.000Z" itemprop="datePublished">January 2, 2020</time> Â· <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Just recently my team took on the challenge of upgrading our codebase from .NET Core 2.2 to .NET Core 3.1. Along the way we encountered a quirky issue which caused us much befuddlement. Should you be befuddled too, then maybe this can help you.</p><p>Whilst running our app, we started encountering an error with an Entity Framework Query that looked like this:</p><div class="codeBlockContainer_I0IT language-cs theme-code-block"><div class="codeBlockContent_wNvx cs"><pre tabindex="0" class="prism-code language-cs codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">var stuffWeCareAbout = await context.Things</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    .Include(thing =&gt; thing.ThisIsFine)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    .Include(thing =&gt; thing.Problematic)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    .Where(thing =&gt; thing.CreatedOn &gt; startFromThisTime &amp;&amp; thing.CreatedOn &lt; endAtThisTime)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    .OrderByDescending(thing =&gt; thing.CreatedOn)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    .ToArrayAsync();</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="join-me">Join me!<a class="hash-link" href="#join-me" title="Direct link to heading">â€‹</a></h2><p>As EF Core tried to join from the <code>Things</code> table to the <code>Problematic</code> table (some obfuscation in table names here), that which worked in .NET Core 2.2 was <em>not</em> working in .NET Core 3.1. Digging into the issue, we discovered EF Core was generating an invalid <code>LEFT JOIN</code>:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx sql"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">fail: Microsoft</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">EntityFrameworkCore</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token keyword" style="color:rgb(127, 219, 202)">Database</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">20102</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      Failed executing DbCommand </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">18</span><span class="token plain">ms</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">Parameters</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token variable" style="color:rgb(214, 222, 235)">@__startFromThisTime_0</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;?&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">DbType </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> DateTime2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(214, 222, 235)">@__endAtThisTime_1</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;?&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">DbType </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> DateTime2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> CommandType</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Text&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> CommandTimeout</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;30&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token keyword" style="color:rgb(127, 219, 202)">SELECT</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">AnonymousId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">CreatedOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token keyword" style="color:rgb(127, 219, 202)">Status</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">UpdatedOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">Id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">Name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token keyword" style="color:rgb(127, 219, 202)">Status</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">CreatedOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">SentOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token keyword" style="color:rgb(127, 219, 202)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">Things</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token keyword" style="color:rgb(127, 219, 202)">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">JOIN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThisIsFines</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token keyword" style="color:rgb(127, 219, 202)">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">JOIN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">Problematic</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token keyword" style="color:rgb(127, 219, 202)">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">CreatedOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(214, 222, 235)">@__startFromThisTime_0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">CreatedOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">&lt;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(214, 222, 235)">@__endAtThisTime_1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token keyword" style="color:rgb(127, 219, 202)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">CreatedOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">DESC</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token keyword" style="color:rgb(127, 219, 202)">Status</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Microsoft</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">EntityFrameworkCore</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token keyword" style="color:rgb(127, 219, 202)">Database</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Command: Error: Failed executing DbCommand </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">18</span><span class="token plain">ms</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">Parameters</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token variable" style="color:rgb(214, 222, 235)">@__startFromThisTime_0</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;?&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">DbType </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> DateTime2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(214, 222, 235)">@__endAtThisTime_1</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;?&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">DbType </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> DateTime2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> CommandType</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Text&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> CommandTimeout</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;30&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">SELECT</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">AnonymousId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">CreatedOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token keyword" style="color:rgb(127, 219, 202)">Status</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">UpdatedOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">Id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">Name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token keyword" style="color:rgb(127, 219, 202)">Status</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">CreatedOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">SentOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">Things</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">JOIN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThisIsFines</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">JOIN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">Problematic</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">CreatedOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token variable" style="color:rgb(214, 222, 235)">@__startFromThisTime_0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">CreatedOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">&lt;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(214, 222, 235)">@__endAtThisTime_1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">CreatedOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">DESC</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token keyword" style="color:rgb(127, 219, 202)">Status</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Do you see it? Probably not; it took us a while too... The issue lay here:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx sql"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">JOIN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">Problematic</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This should actually have been:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx sql"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">JOIN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">Problematic</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">ON</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">o1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">ThingId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>For some reason EF Core was looking for <code>ThingThingId</code> where it should have looked for <code>ThingId</code>. But why?</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="navigation-properties-to-the-rescue">Navigation properties to the rescue!<a class="hash-link" href="#navigation-properties-to-the-rescue" title="Direct link to heading">â€‹</a></h2><p>This was the <code>Problematic</code> class:</p><div class="codeBlockContainer_I0IT language-cs theme-code-block"><div class="codeBlockContent_wNvx cs"><pre tabindex="0" class="prism-code language-cs codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.ComponentModel.DataAnnotations;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.ComponentModel.DataAnnotations.Schema;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace Treasury.Data.Entities</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class Problematic</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [ForeignKey(&quot;Thing&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [Required]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public Guid ThingId { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [Required]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public DateTime CreatedOn { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public DateTime SentOn { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If you look closely you&#x27;ll see it has a <code>ForeignKey</code> but <em>no</em> accompanying Navigation property. So let&#x27;s add one:</p><div class="codeBlockContainer_I0IT language-cs theme-code-block"><div class="codeBlockContent_wNvx cs"><pre tabindex="0" class="prism-code language-cs codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.ComponentModel.DataAnnotations;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.ComponentModel.DataAnnotations.Schema;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace Our.App</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class Problematic</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [ForeignKey(&quot;Thing&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [Required]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public Guid ThingId { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [Required]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public DateTime CreatedOn { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public DateTime SentOn { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /* THIS NAVIGATION PROPERTY IS WHAT WE NEEDED!!! */</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public virtual Thing Thing { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>With this in place our app starts generating the SQL we need.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/entity-framework">Entity Framework</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/left-join">left join</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/navigation-property">navigation property</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/broken">broken</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about EF Core 3.1 breaks left join with no navigation property" href="/2020/01/02/ef-core-31-breaks-left-join-with-no-navigation-property"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2018/06/24/vsts-and-ef-core-migrations">VSTS and EF Core Migrations</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2018-06-24T00:00:00.000Z" itemprop="datePublished">June 24, 2018</time> Â· <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Let me start by telling you a dirty secret. I have an ASP.Net Core project that I build with VSTS. It is deployed to Azure through a CI / CD setup in VSTS. That part I&#x27;m happy with. Proud of even. Now to the sordid hiddenness: try as I might, I&#x27;ve never found a nice way to deploy Entity Framework database migrations as part of the deployment flow. So I have <!-- -->[blushes with embarrassment]<!-- --> been using the <code>Startup</code> of my ASP.Net core app to run the migrations on my database. There. I said it. You all know. Absolutely filthy. Don&#x27;t judge me.</p><p>If you care to google, you&#x27;ll find various discussions around this, and various ways to tackle it. Most of which felt like too much hard work and so I never attempted.</p><p>It&#x27;s also worth saying that being on VSTS made me less likely to give these approaches a go. Why? Well, the feedback loop for debugging a CI / CD setup is truly sucky. Make a change. Wait for it to trickle through the CI / CD flow (10 mins at least). Spot a problem, try and fix. Start waiting again. Repeat until you succeed. Or, if you&#x27;re using the free tier of VSTS, repeat until you run out of build minutes. You have a limited number of build minutes per month with VSTS. Last time I fiddled with the build, I bled my way through a full month&#x27;s minutes in 2 days. I have now adopted the approach of only playing with the setup in the last week of the month. That way if I end up running out of minutes, at least I&#x27;ll roll over to the new allowance in a matter of days.</p><p>Digression over. I could take the guilt of my EF migrations secret no longer, I decided to try and tackle it another way. I used the approach suggested by <a href="https://github.com/broersa" target="_blank" rel="noopener noreferrer">Andre Broers</a><a href="https://github.com/aspnet/EntityFrameworkCore/issues/9841#issuecomment-395712061" target="_blank" rel="noopener noreferrer">here</a>:</p><blockquote><p>I worked around by adding a dotnetcore consoleapp project where I run the migration via the Context. In the Build I build this consoleapp in the release I execute it.</p></blockquote><h2 class="anchor anchorWithStickyNavbar_mojV" id="console-yourself">Console Yourself<a class="hash-link" href="#console-yourself" title="Direct link to heading">â€‹</a></h2><p>First things first, we need a console app added to our solution. Fire up PowerShell in the root of your project and:</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx console"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">md MyAwesomeProject.MigrateDatabase</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cd .\MyAwesomeProject.MigrateDatabase\</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet new console</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Next we need that project to know about Entity Framework and also our DbContext (which I store in a dedicated project):</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx console"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet add package Microsoft.EntityFrameworkCore.Design</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet add package Microsoft.EntityFrameworkCore.SqlServer</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet add reference ..\MyAwesomeProject.Database\MyAwesomeProject.Database.csproj</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Add our new project to our solution: (I always forget to do this)</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx console"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">cd ../</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet sln add .\MyAwesomeProject.MigrateDatabase\MyAwesomeProject.MigrateDatabase.csproj</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You should now be the proud possessor of a <code>.csproj</code> file that looks like this:</p><div class="codeBlockContainer_I0IT language-xml theme-code-block"><div class="codeBlockContent_wNvx xml"><pre tabindex="0" class="prism-code language-xml codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">Project</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">Sdk</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">Microsoft.NET.Sdk</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">PropertyGroup</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">OutputType</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">Exe</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(127, 219, 202)">OutputType</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">TargetFramework</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">netcoreapp2.1</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(127, 219, 202)">TargetFramework</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(127, 219, 202)">PropertyGroup</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">ItemGroup</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">PackageReference</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">Microsoft.EntityFrameworkCore.Design</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">2.1.1</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">PackageReference</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">Microsoft.EntityFrameworkCore.SqlServer</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">2.1.1</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(127, 219, 202)">ItemGroup</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">ItemGroup</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">ProjectReference</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">..\MyAwesomeProject.Database\MyAwesomeProject.Database.csproj</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(127, 219, 202)">ItemGroup</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(127, 219, 202)">Project</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Replace the contents of the <code>Program.cs</code> file with this:</p><div class="codeBlockContainer_I0IT language-cs theme-code-block"><div class="codeBlockContent_wNvx cs"><pre tabindex="0" class="prism-code language-cs codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.IO;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using MyAwesomeProject.Database;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.EntityFrameworkCore;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace MyAwesomeProject.MigrateDatabase {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    class Program {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // Example usage:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // dotnet MyAwesomeProject.MigrateDatabase.dll &quot;Server=(localdb)\\mssqllocaldb;Database=MyAwesomeProject;Trusted_Connection=True;&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        static void Main(string[] args) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (args.Length == 0)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                throw new Exception(&quot;No connection string supplied!&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var myAwesomeProjectConnectionString = args[0];</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // Totally optional debug information</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Console.WriteLine(&quot;About to migrate this database:&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var connectionBits = myAwesomeProjectConnectionString.Split(&quot;;&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            foreach (var connectionBit in connectionBits) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (!connectionBit.StartsWith(&quot;Password&quot;, StringComparison.CurrentCultureIgnoreCase))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    Console.WriteLine(connectionBit);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var optionsBuilder = new DbContextOptionsBuilder&lt;MyAwesomeProjectContext&gt;();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                optionsBuilder.UseSqlServer(myAwesomeProjectConnectionString);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                using(var context = new MyAwesomeProjectContext(optionsBuilder.Options)) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    context.Database.Migrate();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                Console.WriteLine(&quot;This database is migrated like it&#x27;s the Serengeti!&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            } catch (Exception exc) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var failedToMigrateException = new Exception(&quot;Failed to apply migrations!&quot;, exc);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                Console.WriteLine($&quot;Didn&#x27;t succeed in applying migrations: {exc.Message}&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                throw failedToMigrateException;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This code takes the database connection string passed as an argument, spins up a db context with that, and migrates like it&#x27;s the Serengeti.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="build-it">Build It!<a class="hash-link" href="#build-it" title="Direct link to heading">â€‹</a></h2><p>The next thing we need is to ensure that this is included as part of the build process in VSTS. The following commands need to be run during the build to include the MigrateDatabase project in the build output in a <code>MigrateDatabase</code> folder:</p><div class="codeBlockContainer_I0IT language-cs theme-code-block"><div class="codeBlockContent_wNvx cs"><pre tabindex="0" class="prism-code language-cs codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">cd MyAwesomeProject.MigrateDatabase</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet build</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet publish --configuration Release --output $(build.artifactstagingdirectory)/MigrateDatabase</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>There&#x27;s various ways to accomplish this which I wont reiterate now. <a href="/2018/06/16/vsts-yaml-up">I recommend YAML</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="deploy-it">Deploy It!<a class="hash-link" href="#deploy-it" title="Direct link to heading">â€‹</a></h2><p>Now to execute our console app as part of the deployment process we need to add a CommandLine task to our VSTS build definition. It should execute the following command:</p><div class="codeBlockContainer_I0IT language-cs theme-code-block"><div class="codeBlockContent_wNvx cs"><pre tabindex="0" class="prism-code language-cs codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet MyAwesomeProject.MigrateDatabase.dll &quot;$(ConnectionStrings.MyAwesomeProjectDatabaseConnection)&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In the following folder:</p><div class="codeBlockContainer_I0IT language-cs theme-code-block"><div class="codeBlockContent_wNvx cs"><pre tabindex="0" class="prism-code language-cs codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">$(System.DefaultWorkingDirectory)/my-awesome-project-YAML/drop/MigrateDatabase</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Do note that the command uses the <code>ConnectionStrings.MyAwesomeProjectDatabaseConnection</code> variable which you need to create and set to the value of your connection string.</p><p><img loading="lazy" src="/assets/images/Screenshot%2B2018-06-24%2B10.55.27-f0c7b9b2c883fa52102f4068fd74476c.png" width="640" height="293"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="give-it-a-whirl">Give It A Whirl<a class="hash-link" href="#give-it-a-whirl" title="Direct link to heading">â€‹</a></h2><p>Let&#x27;s find out what happens when the rubber hits the road. I&#x27;ll add a new entity to my database project:</p><div class="codeBlockContainer_I0IT language-cs theme-code-block"><div class="codeBlockContent_wNvx cs"><pre tabindex="0" class="prism-code language-cs codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace MyAwesomeProject.Database.Entities {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class NewHotness {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public Guid NewHotnessId { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>And reference it in my DbContext:</p><div class="codeBlockContainer_I0IT language-cs theme-code-block"><div class="codeBlockContent_wNvx cs"><pre tabindex="0" class="prism-code language-cs codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">using MyAwesomeProject.Database.Entities;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.EntityFrameworkCore;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace MyAwesomeProject.Database {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class MyAwesomeProjectContext : DbContext {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public MyAwesomeProjectContext(DbContextOptions&lt;MyAwesomeProjectContext&gt; options) : base(options) { }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public DbSet&lt;NewHotness&gt; NewHotnesses { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Let&#x27;s let EF know by adding a migration to my project:</p><div class="codeBlockContainer_I0IT language-cs theme-code-block"><div class="codeBlockContent_wNvx cs"><pre tabindex="0" class="prism-code language-cs codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet ef migrations add TestOurMigrationsApproach</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Commit my change, push it to VSTS, wait for the build to run and a deployment to take place.... Okay. It&#x27;s done. Looks good.</p><p><img loading="lazy" src="/assets/images/Screenshot%2B2018-06-24%2B09.02.22-c4b944686bdce306d6683b8fc8574a8a.png" width="640" height="269"></p><p>Let&#x27;s take a look in the database:</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx console"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">select * from NewHotnesses</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">go</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><img loading="lazy" src="/assets/images/Screenshot%2B2018-06-24%2B08.59.00-596350d6de2dd1470c084af061e4f746.png" width="640" height="436"></p><p>It&#x27;s there! We are migrating our database upon deployment; and not in our ASP.Net Core app itself. I feel a burden lifted.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="wrapping-up">Wrapping Up<a class="hash-link" href="#wrapping-up" title="Direct link to heading">â€‹</a></h2><p>The EF Core team are aware of the lack of guidance around deploying migrations and have recently announced plans to fix that in the docs. You can track the progress of this issue <a href="https://github.com/aspnet/EntityFramework.Docs/issues/691" target="_blank" rel="noopener noreferrer">here</a>. There&#x27;s good odds that once they come out with this I&#x27;ll find there&#x27;s a better way than the approach I&#x27;ve outlined in this post. Until that glorious day!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/vsts">vsts</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/entity-framework">Entity Framework</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ef-core">ef core</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about VSTS and EF Core Migrations" href="/2018/06/24/vsts-and-ef-core-migrations"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2015/06/19/Back-to-the-Future-with-Code-First-Migrations">Back to the Future with Code First Migrations</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2015-06-19T00:00:00.000Z" itemprop="datePublished">June 19, 2015</time> Â· <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Code First Migrations. They look a little like this in Visual Studio:</p><p><img loading="lazy" src="data:image/png;base64,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" width="333" height="221"></p><p>The thing I want you to notice about the image above is not the pithily named migrations. It isn&#x27;t the natty opacity on everything but the migration files (which I can assure you took me to the very limits of my <a href="http://www.gimp.org/" target="_blank" rel="noopener noreferrer">GIMP</a> expertise). No, whilst exciting in themselves what I want you to think about is <em>the order in which migrations are applied</em>. Essentially how the <code>__MigrationHistory</code> table in SQL Server ends up being populated in this manner:</p><p><img loading="lazy" src="/assets/images/MigrationHistory-4f2b0f63416be1b3f0284b8387c0ea51.png" width="640" height="207"></p><p>Because, myself, I didn&#x27;t really think about this until it came time for me to try and change the ordering of some migrations manually. Do you know how migrations end up the order they do? I bet you don&#x27;t. But either way, let&#x27;s watch and see what happens to the pre-enlightenment me as I attempt to take a migration which appears <em>before</em> a migration I have created locally and move it to <em>after</em> that same migration.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="great-scott-its-clearly-filename-driven">Great Scott! It&#x27;s clearly filename driven<a class="hash-link" href="#great-scott-its-clearly-filename-driven" title="Direct link to heading">â€‹</a></h2><p>That&#x27;s right - it&#x27;s blindingly obvious to me. All I need do is take the migration I want to move forwards in time and rename it in Visual Studio. So take our old migration (&quot;2014 is so passÃ© darling&quot;):</p><p><img loading="lazy" src="data:image/png;base64,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" width="302" height="115"></p><p>And rename it to make it new and shiny (&quot;2015! Gorgeous - I love it sweetie!&quot;):</p><p><img loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAWcAAACqCAMAAABGZ35hAAABelBMVEX///8zmf/+/rWt1v+N2v4AAABkADRWneW1/v7+2o00jdr+tWTajTRktf8AZLVkAGT+/tra/v5kAAD4+PiNNAC1ZAA6jzU0NI00AGQ0AAAAAGQANI0AADQhpORERETeuoONNDQeHh6s1dMUPWaB1f7JgBo0ADQsLCzKyso0jY38/Py1tbVQPaIzkumsqqLYrXYAVqH6+flkNDRpwP6t1eiXkoUAZGTkMyONtf4UedNjlcCSvZCswLszYbjmrqgANGRQqv+BeWb19fSexJxuqGtQPYU0NWTtEwCX1f5oXWary6lSnU5GlkInJyfz8fCN2rX+tY1kjY2KyOYvqONpXIWKioq1ZDRkZDQkJB73+/8UPaKOjo5kNI3atWSNjWS1tf6307X+tbXD2uUUXLva/rUUeaIzPaKQspIAZI1QPWZpqv7n0bDixJbc3Nza/trw5NO1/rWBeYUzPYWNNGTw6N61/tqN2tpktdqsqtMzedPp2cFQkrva2o212o1VMrZMAAAM20lEQVR42uydiZMLQRTGmyQkk50QZINQxCqhHFWIq9z3fSv3fd9KUapQ/nfvmnk9eo0gIcP7MNN58zrhl87b3felw5lMJpPJZDKZ/hO9WZbImUaoly/ms4TzzHkNOk8sKddWld10wrgpT69cVstAZ77hPKtXJtxLAph82Rj/UKt733JmxFnOVyI41bfOMs6/ivl0dxDOZ+dU3dzlZ2eVkWltUWUNjq4srrYqlcbMeXCQeCWG5NuVSuTmLsAbphTzQJzLrdjV2g+J88x5MVRqOEV0jdlzHMs0FvP64mq94Uw+5m5QnkVnfM61drMVw5mHCV1Xr1SW0AjjC6vOQZLcWhQ5U4o54Pwi5fzC5zx3+ZN2M+AMaOcun56zcxNWN1ivet2Q8xld0O89zrByIzxr3aBgpwmVQusGgk84A2hb0Tl6mXJ+6XOe+64qnLFYrKERfrHbu6nsWunXwSVlJ5whaXHVmXJ/GBR9Es6haguN4W9q4yBJrU7TmUYqKBZWEkwmk8lkMv26VjvTn9DpQUG3sPfp6nTE9hzZLZ2mRDSePYb5E/g9Isclgpo5p6o+jZz+qV53tzct6J2Tk5MH3ST8EtW2478YcGCLacFWwIJ2S6fJEfotcf8Y5rtW7JzEMRJwZrT/nKfQXeuB7l9cerHPmE8e3Hl3EqWp0KirN6hZJFgmzrebHKm1CaDE9Rjmu8uATeIU+V84Ow/00gv3LyzFweSpA3jS9SwsgA0wEiy13YCXI/AUQCjkHObjz5aRxDGinNmWQSsnsWvQuxHO7NYU2LLpOnejd+bb6OQhOqI02Ioy3IBtyhk7d7ELOYf5vELTZ8fjLLaM2jXq3SBmLOcFtmy64MuuTdczaNr1LP9S5cYMU87fqxthPj9hHNcIJghd5azeTdIuLLBl00XMynk+cz6E9fkEjrQ4a12V5VcBdW5hRLiFnMP8JnKOKb5GI9NyZu/G51xgy6YLmEPOBw5BxVDOQtiJe5KQxNXIkTrQakUh5zCfv2VL4rnrmbwbuc11o8CWzVXFrHUjEC4kUIQv5dj53ChClxsu5Bzm47KOJf49zmLXsHcjIZpXYMtmrTP9F4KFWtxVajKZTCaTyTQ+Mj8lR8XxUzRHxtLaVFdFH6ChHWc5wffWlBGqjhfo3HmISbEaMDRT/saYpUE+/JQK4qf4OTK+Qz0h31Vh1Y5sKgec6Qdun7+ovqRMDUR8x6q8XViTNJEGY8J5RH5KmMNjueC7KiRp+oWchaFPDRDH2tSSP+POeUR+SpjDY8abcVVI0vOXrTB0Is4MNd0VgxcWV4EwTUHnJcKkeoOfliuVCnkxTxZVopSz7KIRzlS4+G5ow80PvJpi+Cl+jpCcAFiyvnzOcAkSXLoVhk/CWVc3QaWXD12QTh4w43Ie4YnqUx1CwlZ20QhnfEC5G8z/gVdTHD8lzeExF1ffVdG+8kSDMr7ZEQP41VnBtVlpJOs5QS8c/SqiZcLb3ZFso5G7wVC+V1MQP8XPWeP7KY6OXn3mzMXVgDNhUGcFmYT1GQM/4gx3QGPyZPDMl3O9msL4KX4Oj+/RKzzjqqDgDghfWDdwqLti5KUOVYGGg6xn2UVD75RvNQgoVwzOy/dqiuKnaI6M5YuSuipp7XdYOGQrjJwwDYuM7opxOL+BM2Eqk5Ik4YxJWc4wRe6EXk7kyWBM8vK9GvNTTOanmEwmk8lkMg0s81OKpmH6KZKjfgp3HOXoz53gbgZn+t5Hzqcx1XFGYT9xbJh+Cuf4fgq7J3LUudJN0HHu/gh9Zy48QFE1TD+Fc7L9Db2hczU+c3DO9WJ/YMJw/RShp0NK5yNnajxyIeeW2H272fBId6iAScgtNopAXw+5P4Q47WlhF2a897EM0U+RHJ8zuSd8zHLG2QFnul7v4cOw4ZH4KB8ALBKEo3gi0rmXPS3cRh3rfSzD9FMox+cs1jQfM5xxyYac8Q4vP2m/Xl5mwyPxUa7CVGpwxhzBUn+zqR1nfPgx38cyTD8FcwLOgXsitT0OOZO1evP1uy/tJvMSH2VeLzG3GhzhR8xyHvN9LMP0UzjH58zuCR8zcwFWyBn5YNU4HrFvoj4KlKNz9I4NjvCbPZQz142x3scyTD9FcpQzW/py9OdKSsgZINIfNjzIR2F89LajRuKsoAGlnNl+Ge99LAX1U1qxfSDZiP0UeSHZB5KNWlA8lpTtA8n+Y834Pc3+1zVjOPptzs6VRib392Wcp5VxNs6/KOW8f2pqfam0AY9wur6yVNoyNQWnDUF8vzeGrAfHgqsyt398ampfKWfbhLb28/9nkdAo4Jnjz9mpmPOu56UVhzevWLcSjv3jj9YhsX3AjiP0W+KYKWO8/uzBMc7xr8rc7aVdj1fmbJvIb+1rbjjmmWPHeZ8OiWzGT0nqRv/S5g07YCmuB0LI8O1mCHJk1+5jgI7jnJmMt3zefYxz/Ks8l5+mnG0T3Nr/Fc4wcwzrRnxNU/cc3QNHz09hzswEaAFZJtY/jhWAI4AOQilJHe/6CE8B5/hXeS4/TXnbJrS1n1yhG9LN50+sespN/2Z2k0Q4k52D0AoYPWfF7DR12za44fefU877maoSwwogkV1HoNJynDJlDPyVs16VuVClIZqzbcJv7Wsrn7tyupWCm/7ZTRLhTE6NQitg9JwVs5M8h8uZOKufIpz7xwGPT4yRccSvG5xJY8xXzpmrgntDZ3POtgm/tS8hubGwqpy56Z998344U5yD0AoYPWfF7JLFDMJxuJ77l7Qae5z3fWXvClajCIJoG/ViENEkp8AcjCthwWwW0WCI4En8Ab8goHgTQfTgx9szVTuvl7fTsKRT9G7XA9fd7q4kvB16eurxqmQkZVJWyh3yx1nE7XeJwqzGymvGNpGm9nVIPqQ869ZOPHNknCGbhAXPoDmMm/NwOT9QPSU5b0QWI26+9SeHkeebX29l5OI2Xs/KpKzEmo9fNAqzGvv3Vb97ZGwTaWpfh+RDum/oUWXdJMGRutmTFGDE86eB5pDuzhErPQXn53dnEW/6k7Duw/HE1r/XkTj9QcdlZcrzKgqzEnvzuX/N2iaQ2tch+SDZfK1YJUfvdZPEhkhYJUgKMD8/j5QHQWXPg5TKp6R/JrKCc90kDHh+mUvzcyo/l/TPRzbO88M79hZB0j8fWcNzymZ4/nkLKM+OLJznnUJwOBxruL68Do6SOJ8muuu+Bsc9OlYuB1zPI9E5x4pW8aLxE3K10KzEIitsKmWhrpiF+YUdK8wziGbHij4AUwUwXcmulnRWYsXJYi5loa6YDdixIilp3TfmR11EmHSsSBUvqgCmK9nVks5KbJAhYykLKVUrwLECXF2NNPfoJh0rWsWLKoDpSna1pLMSG2TYWspa1buSAflJ+JXwwJQsEQbHCi7nAUIzeCbHil4ZVAFMV7KrJZnVWHGyGEtZ4FkGYnS6Sj0wBUuEsWNFFJYe3ZGim3SsKPVUAUxXsqslmdVYcbLYSlnwbOhAL2mtF8PCYioRVsaxIgoL88yOFbhRZCRhUleyq2V9Fk4WYykL6xJJi3guWyIMjhXszsRzzrHy+hFVANOV7GpJZiVWnSzmUpbWFYv/RkkL+4byXK5EGBwrDOaZHStaxYsqgOlKdrWksxIrtyxjKQt1xWRgOGjD9aLUFi8RJjRneK4JpaSsatrwdyPCfeOgAinLXS/lpCxvw+9wOBwO11Nqg+spxdGcnlIN9lxPqQIN6ClVoAk9Jaoko5by5/iJ3bfSlp4Sv4NUS3n2M/5dJmhPT0m0lHBoVcWqQT0lkUjMeG5TT4GWYrRvtKenxPfQUn4fx9uOwX3Q9ZSt4XqKKyXV6ykOh8OxG1jO58vgIBSnebFwokvifILm2cyJBor7U0CzEL1choYFD6CsPwU0K8/DNt2m4AGU9acAK5pDRL9Ntyl4AOX9KeAZWMwNBY/93UrUn8J3wRBmYQGerQSPyhoaFAL8KXyqE57jG1PBo76eM4U7qvBTyqzfnsNRsBI8Ks1dFu+oAshxbob7oJHgsa+bRupPYeA+aCZ47O++AZoZeh9sWfC4b/DTtwsehLLZJBc8JuHZUYfD4XA4vB+9OaCebHNKoyPt4ePTf1wZa2e7xmdg0o9ec2mkd8Q8RD6l7xxv2Y8+Jow2E+k8F+xHj2yDih9SBOvgRf8CLUWKgAxuj14WGTJDMo2YUHPX+Aws+tEjIaHiR1oEa6LCzfAO04ipuWs8w64fPa5n/V977nOf8mRQZBEdQEztXeMzsOpHf/x0G55FFiGea+8azzDrR48T3HDeUPEDlCb7Rv9dHMpVLLIIphFTddf4DAz60eMGePpcxY91nhNJ5b0MqixyovdBxNTdNX4TKutH37D8UQ5eGasKNC9/OBwOh2O30QkugqM42L3t5bz+jzIAAKK1sOhnpvggAAAAAElFTkSuQmCC" width="359" height="170"></p><p>Perfection right? Wrong! What you&#x27;ve done makes not the slightest jot of difference.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="whoa-this-is-heavy-gimme-the-project-file">Whoa, this is heavy! Gimme the project file<a class="hash-link" href="#whoa-this-is-heavy-gimme-the-project-file" title="Direct link to heading">â€‹</a></h2><p>How could I be so dim? I mean it makes perfect sense - before the days of <a href="http://blog.icanmakethiswork.io/2015/02/hey-tsconfigjson-where-have-you-been.html" target="_blank" rel="noopener noreferrer">TypeScript&#x27;s tsconfig.json </a> the default ordering of <code>*.ts</code> files being passed to the TypeScript compiler was determined by the ordering of the <code>*.ts</code> files in the <code>.csproj</code> file. It must be the same for Code First Migrations.</p><p>So, simply spin up <a href="https://notepad-plus-plus.org/" target="_blank" rel="noopener noreferrer">Notepad++</a> and let&#x27;s play hack the XML until each file is referenced in the required order.</p><p>Well, I&#x27;m glad we sorted that out. A quick test to reassure myself of my astuteness. Drum roll.... Fail!! Things are just as they were. Shame on you John Reilly, shame on you.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="designercs-your-kids-are-gonna-love-it">Designer.cs... Your kids are gonna love it<a class="hash-link" href="#designercs-your-kids-are-gonna-love-it" title="Direct link to heading">â€‹</a></h2><p><img loading="lazy" src="/assets/images/Screenshot%2B2015-06-19%2B13.35.40-5cbe8ef3f28ec8727b516fcea753133d.png" width="640" height="398"></p><p>I want you to look very carefully at this and tell me what you see. We&#x27;re looking at the mysterious <code>201508121401253_AddSagacityToSage.Designer.cs</code> file that sits underneath the main <code>201508121401253_AddSagacityToSage.cs</code> file. What could it be.... Give in?</p><p>The <code>IMigrationMetadata.Id</code> property is returning <code>&lt;u&gt;201408121401253&lt;/u&gt;_AddSagacityToSage</code>. That is the <em>old</em> date! Remember? The passÃ© one. If you change that property to line up with the file name change you&#x27;re done. It works.</p><p><img loading="lazy" src="/assets/images/where-were-going-4912e0319dd6de9c3f33d13c810fc7d1.jpg" width="1368" height="764"></p><p>Let&#x27;s say it together: &quot;Automatic Migrations? Where we&#x27;re going, we don&#x27;t need Automatic Migrations.&quot;</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/emmett-brown">Emmett Brown</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/entity-framework">Entity Framework</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/code-first-migrations">Code First Migrations</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Back to the Future with Code First Migrations" href="/2015/06/19/Back-to-the-Future-with-Code-First-Migrations"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2012/10/03/unit-testing-and-entity-framework-filth">Unit Testing and Entity Framework: The Filth and the Fury</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2012-10-03T00:00:00.000Z" itemprop="datePublished">October 3, 2012</time> Â· <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Just recently I&#x27;ve noticed that there appears to be something of a controversy around Unit Testing and Entity Framework. I first came across it as I was Googling around for useful posts on using MOQ in conjunction with EF. I&#x27;ve started to notice the topic more and more and as I have mixed feelings on the subject (that is to say I don&#x27;t have a settled opinion) I thought I&#x27;d write about this and see if I came to any kind of conclusion...</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-setup">The Setup<a class="hash-link" href="#the-setup" title="Direct link to heading">â€‹</a></h2><p>It started as I was working on a new project. We were using ASP.NET MVC 3 and Entity Framework with DbContext as our persistence layer. Rather than crowbarring the tests in afterwards the intention was to write tests to support the ongoing development. Not quite test driven development but certainly <a href="http://blog.troyd.net/Test+Supported+Development+TSD+Is+NOT+Test+Driven+Development+TDD.aspx" target="_blank" rel="noopener noreferrer">test supported development</a>. (Let&#x27;s not get into the internecine conflict as to whether this is black belt testable code or not - it isn&#x27;t but he who pays the piper etc.) Oh and we were planning to use MOQ as our mocking library.</p><p>It was the first time I&#x27;d used DbContext rather than ObjectContext and so I thought I&#x27;d do a little research on how people were using DbContext with regards to testability. I had expected to find that there was some kind of consensus and an advised way forwards. I didn&#x27;t get that at all. Instead I found a number of conflicting opinions.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="using-the-repository--unit-of-work-patterns">Using the Repository / Unit of Work Patterns<a class="hash-link" href="#using-the-repository--unit-of-work-patterns" title="Direct link to heading">â€‹</a></h2><p>One thread of advice that came out was that people advised using the Repository / Unit of Work patterns as wrappers when it came to making testable code. This is kind of interesting in itself as to the best of my understanding ObjectSet / ObjectContext and DbSet / DbContext are both in themselves implementations of the Repository / Unit of Work patterns. So the advice was to build a Repository / Unit of Work pattern to wrap an existing Repository / Unit of Work pattern.</p><p>Not as mad as it sounds. The reason for the extra abstraction is that ObjectContext / DbContext in the raw are not MOQ-able.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="or-maybe-im-wrong-maybe-you-can-moq-dbcontext">Or maybe I&#x27;m wrong, maybe you can MOQ DbContext?<a class="hash-link" href="#or-maybe-im-wrong-maybe-you-can-moq-dbcontext" title="Direct link to heading">â€‹</a></h2><p>No you can&#x27;t. Well that&#x27;s not true. You can and it&#x27;s documented <a href="http://romiller.com/2012/02/14/testing-with-a-fake-dbcontext/" target="_blank" rel="noopener noreferrer">here</a> but there&#x27;s a &quot;but&quot;. You need to be using Entity Frameworks Code First approach; actually coding up your DbContext yourself. Before I&#x27;d got on board the project had already begun and we were already some way down the road of using the Database First approach. So this didn&#x27;t seem to be a go-er really.</p><p>The best article I found on testability and Entity Framework was <a href="http://msdn.microsoft.com/en-us/library/ff714955.aspx" target="_blank" rel="noopener noreferrer">this one</a> by <a href="http://odetocode.com/" target="_blank" rel="noopener noreferrer">K. Scott Allen</a> which essentially detailed how you could implement the Repository / Unit of Work patterns on top of ObjectSet / ObjectContext. In the end I adapted this to do the same thing sat on top of DbSet / DbContext instead.</p><p>With this in place I had me my testable code. I was quite happy with this as it seemed quite intelligible. My new approach looked similar to the existing DbSet / DbContext code and so there wasn&#x27;t a great deal of re-writing to do. Sorted, right?</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="here-come-the-nagging-doubts">Here come the nagging doubts...<a class="hash-link" href="#here-come-the-nagging-doubts" title="Direct link to heading">â€‹</a></h2><p>I did wonder, given that I found a number of articles about applying the Repository / Unit of Work patterns on top of ObjectSet / ObjectContext that there didn&#x27;t seem to be many examples to do the same for DbSet / DbContext. (I did find a few examples of this but none that felt satisfactory to me for a variety of reasons.) This puzzled me.</p><p>I also started to notice that a 1 man war was being waged against the approach I was using by <a href="http://www.ladislavmrnka.com/about/" target="_blank" rel="noopener noreferrer">Ladislav Mrnka</a>. Here are a couple of examples of his crusade:</p><ul><li><a href="http://stackoverflow.com/a/6904479/761388" target="_blank" rel="noopener noreferrer">An answer on StackOverflow</a> (there&#x27;s quite a few similar answers around on StackOverflow saying similar)</li><li><a href="http://romiller.com/2012/02/14/testing-with-a-fake-dbcontext/#div-comment-1620" target="_blank" rel="noopener noreferrer">A comment on Rowan Millers post about fake DbContexts</a></li></ul><p>Ladislav is quite strongly of the opinion that wrapping DbSet / DbContext (and I presume ObjectSet / ObjectContext too) in a further Repository / Unit of Work is an antipattern. To quote him: <em>&quot;The reason why I donâ€™t like it is leaky abstraction in Linq-to-entities queries ... In your test you have Linq-to-Objects which is superset of Linq-to-entities and only subset of queries written in L2O is translatable to L2E&quot;</em>. It&#x27;s worth looking at <a href="http://www.youtube.com/watch?v=gNeSZYke-_Q" target="_blank" rel="noopener noreferrer">Jon Skeets explanation of &quot;leaky abstractions&quot;</a> which he did for TekPub.</p><p>As much as I didn&#x27;t want to admit it - I have come to the conclusion Ladislav probably has a point for a number of reasons:</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-just-because-it-compiles-and-passes-unit-tests-dont-imagine-that-means-it-works">1<!-- -->.<!-- --> Just because it compiles and passes unit tests don&#x27;t imagine that means it works...<a class="hash-link" href="#1-just-because-it-compiles-and-passes-unit-tests-dont-imagine-that-means-it-works" title="Direct link to heading">â€‹</a></h3><p>Unfortunately, a LINQ query that looks right, compiles and has passing unit tests written for it doesn&#x27;t necessarily work. You can take a query that fails when executed against Entity Framework and come up with test data that will pass that unit test. As Ladislav rightly points out: <code>LINQ-to-Objects != LINQ-to-Entities</code>.</p><p>So in this case unit tests of this sort don&#x27;t provide you with any security. What you need are <!-- -->*<!-- -->*<u>integration</u></p><p>*<!-- -->*<!-- --> tests. Tests that run against an instance of the database and demonstrate that LINQ will actually translate queries / operations into valid SQL.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-complex-queries">2<!-- -->.<!-- --> Complex queries<a class="hash-link" href="#2-complex-queries" title="Direct link to heading">â€‹</a></h3><p>You can write some pretty complex LINQ queries if you want. This is made particularly easy if you&#x27;re using <a href="https://blogs.msdn.com/b/ericlippert/archive/2009/12/07/query-transformations-are-syntactic.aspx" target="_blank" rel="noopener noreferrer">comprehension syntax</a>. Whilst these queries may be simple to write it can be uphill work to generate test data to satisfy this. So much so that at times it can feel you&#x27;ve made a rod for your own back using this approach.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="3-lazy-loading">3<!-- -->.<!-- --> Lazy Loading<a class="hash-link" href="#3-lazy-loading" title="Direct link to heading">â€‹</a></h3><p>By default Entity Framework employs lazy loading. This a useful approach which reduces the amount of data that is transported. Sometimes this approach forces you to specify up front if you require a particular entity through use of <code>Include</code> statements. This again doesn&#x27;t lend itself to testing particularly well.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="where-does-this-leave-us">Where does this leave us?<a class="hash-link" href="#where-does-this-leave-us" title="Direct link to heading">â€‹</a></h2><p>Having considered all of the above for a while and tried out various different approaches I think I&#x27;m coming to the conclusion that Ladislav is probably right. Implementing the Repository / Unit of Work patterns on top of ObjectSet / ObjectContext or DbSet / DbContext doesn&#x27;t seem a worthwhile effort in the end.</p><p>So what&#x27;s a better idea? I think that in the name of simplicity you might as well have a simple class which wraps all of your Entity Framework code. This class could implement an interface and hence be straightforwardly MOQ-able (or alternatively all methods could be virtual and you could forego the interface). Along with this you should have integration tests in place which test the execution of the actual Entity Framework code against a test database.</p><p>Now I should say this approach is not necessarily my final opinion. It seems sensible and practical. I think it is likely to simplify the tests that are written around a project. It will certainly be more reliable than just having unit tests in place.</p><p>In terms of the project I&#x27;m working on at the moment we&#x27;re kind of doing this in a halfway house sense. That is to say, we&#x27;re still using our Repository / Unit of Work wrappers for DbSet / DbContext but where things move away from simple operations we&#x27;re adding extra methods to our Unit of Work class or Repository classes which wrap this functionality and then testing it using our integration tests.</p><p>I&#x27;m open to the possibility that my opinion may be modified further. And I&#x27;d be very interested to know what other people think on the subject.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="update">Update<a class="hash-link" href="#update" title="Direct link to heading">â€‹</a></h2><p>It turns out that I&#x27;m not alone in thinking about this issue and indeed others have expressed this rather better than me - take a look at Jimmy Bogard&#x27;s post for an example: <a href="http://lostechies.com/jimmybogard/2012/09/20/limiting-your-abstractions/" target="_blank" rel="noopener noreferrer">http://lostechies.com/jimmybogard/2012/09/20/limiting-your-abstractions/</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="update-2">Update 2<a class="hash-link" href="#update-2" title="Direct link to heading">â€‹</a></h2><p>I&#x27;ve also recently watched the following Pluralsight course by Julie Lerman: <a href="http://pluralsight.com/training/Courses/TableOfContents/efarchitecture#efarchitecture-m3-archrepo" target="_blank" rel="noopener noreferrer">http://pluralsight.com/training/Courses/TableOfContents/efarchitecture#efarchitecture-m3-archrepo</a>. In this course Julie talks about different implementations of the Repository and Unit of Work patterns in conjunction with Entity Framework. Julie is in favour of using this approach but in this module she elaborates on different &quot;flavours&quot; of these patterns that you might want to use for different reasons (bounded contexts / reference contexts etc). She makes a compelling case and helpfully she is open enough to say that this a point of contention in the community. At the end of watching this I think I felt happy that our &quot;halfway house&quot; approach seems to fit and seems to work. More than anything else Julie made clear that there isn&#x27;t one definitively &quot;true&quot; approach. Rather many different but similar approaches for achieving the same goal. Good stuff Julie!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/unit-testing">unit testing</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/entity-framework">Entity Framework</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/anti-pattern">anti-pattern</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/moq">MOQ</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Unit Testing and Entity Framework: The Filth and the Fury" href="/2012/10/03/unit-testing-and-entity-framework-filth"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" rel="noopener" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" loading="lazy" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.e8b5d5f0.js"></script>
<script src="/assets/js/main.e341d18b.js"></script>
</body>
</html>