<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#3578e5">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">4 posts tagged with &quot;MOQ&quot; | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="4 posts tagged with &quot;MOQ&quot; | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/tags/moq"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-react-helmet="true" name="robots" content="max-image-preview:large"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/tags/moq"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/moq" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/moq" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.763f33af.css">
<link rel="preload" href="/assets/js/runtime~main.e1a9c30a.js" as="script">
<link rel="preload" href="/assets/js/main.1c481cdf.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://polywork.johnnyreilly.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Polywork<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/12/19/azure-container-apps-bicep-and-github-actions">Azure Container Apps, Bicep and GitHub Actions</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/12/12/open-graph-sharing-previews-guide">Open Graph: a guide to sharable social media previews</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/12/05/azure-static-web-app-deploy-previews-with-azure-devops">Azure Static Web App Deploy Previews with Azure DevOps</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/22/typescript-vs-jsdoc-javascript">TypeScript vs JSDoc JavaScript</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/18/azure-standard-tests-with-bicep">Azure standard availability tests with Bicep</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>4 posts tagged with &quot;MOQ&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2014/10/03/he-tasks-me-he-heaps-me-i-will-wreak">He tasks me; he heaps me.... I will wreak that MOQ upon him.</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2014-10-03T00:00:00.000Z" itemprop="datePublished">October 3, 2014</time> Â· <!-- -->4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Enough with the horrific misquotes - this is about Moq and async (that&#x27;s my slight justification for robbing Herman Melville).</p><p>It&#x27;s pretty straightforward to use Moq to do async testing thanks to it&#x27;s marvellous <code>ReturnsAsync</code> method. That means it&#x27;s really easy to test a class that consumes an async API. Below is an example of a class that does just that: (it so happens that this class is a Web API controller but that&#x27;s pretty irrelevant to be honest)</p><div class="codeBlockContainer_K1bP language-cs theme-code-block"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace Proverb.Web.Controllers</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // ISageService included inline for ease of explanation</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public interface ISageService</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        Task&lt;int&gt; DeleteAsync(int id);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class SageController : ApiController</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        ISageService _sageService;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public SageController(ISageService userService)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageService = userService;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public async Task&lt;IHttpActionResult&gt; Delete(int id)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            int deleteCount = await _sageService.DeleteAsync(id);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (deleteCount == 0)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return NotFound();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            else</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return Ok();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To mock the <code>_sageService.DeleteAsync</code> method it&#x27;s as easy as this:</p><div class="codeBlockContainer_K1bP language-cs theme-code-block"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace Proverb.Web.Tests.ASPNet.Controllers</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    [TestClass]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class SageControllerTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private Mock&lt;ISageService&gt; _sageServiceMock;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private SageController _controller;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [TestInitialize]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public void Initialise()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageServiceMock = new Mock&lt;ISageService&gt;();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _controller = new SageController(_sageServiceMock.Object);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [TestMethod]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public async Task Delete_returns_a_NotFound()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageServiceMock</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .Setup(x =&gt; x.DeleteAsync(_sage.Id))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .ReturnsAsync(0); // This makes me *so* happy...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            IHttpActionResult result = await _controller.Delete(_sage.Id);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var notFound = result as NotFoundResult;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Assert.IsNotNull(notFound);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageServiceMock.Verify(x =&gt; x.DeleteAsync(_sage.Id));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [TestMethod]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public async Task Delete_returns_an_Ok()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageServiceMock</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .Setup(x =&gt; x.DeleteAsync(_sage.Id))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .ReturnsAsync(1); // I&#x27;m still excited now!</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            IHttpActionResult result = await _controller.Delete(_sage.Id);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var ok = result as OkResult;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Assert.IsNotNull(ok);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageServiceMock.Verify(x =&gt; x.DeleteAsync(_sage.Id));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="but-wait-what-if-theres-like-nothing">But wait.... What if there&#x27;s like... Nothing?<a class="hash-link" href="#but-wait-what-if-theres-like-nothing" title="Direct link to heading">â€‹</a></h2><p>Nope, I&#x27;m not getting into metaphysics. Something more simple. What if the <code>async</code> API you&#x27;re consuming returns just a <code>Task</code>? Not a <code>Task</code> of <code>int</code> but a simple old humble <code>Task</code>.</p><p>So to take our example we&#x27;re going from this:</p><div class="codeBlockContainer_K1bP language-cs theme-code-block"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">public interface ISageService</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        Task&lt;int&gt; DeleteAsync(int id);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To this:</p><div class="codeBlockContainer_K1bP language-ts theme-code-block"><div class="codeBlockContent_hGly ts"><pre tabindex="0" class="prism-code language-ts codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">interface</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 139)">ISageService</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token maybe-class-name">Task</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">DeleteAsync</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">int id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Your initial thought might be &quot;well that&#x27;s okay, I&#x27;ll just lop off the <code>ReturnsAsync</code> statements and I&#x27;m home free&quot;. That&#x27;s what I thought anyway.... And I was <!-- -->*<strong>WRONG</strong>*<!-- -->! A moments thought and you realise that there&#x27;s still a return type - it&#x27;s just <code>Task</code> now. What you want to do is something like this:</p><div class="codeBlockContainer_K1bP language-cs theme-code-block"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">_sageServiceMock</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .Setup(x =&gt; x.DeleteAsync(_sage.Id))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .ReturnsAsync(void); // This&#x27;ll definitely work... Probably</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>No it won&#x27;t - <code>void</code> is not a real type and much as you might like it to, this is not going to work.</p><p>So right now you&#x27;re thinking, well Moq probably has my back - it&#x27;ll have something like <code>ReturnsTask</code>, right? Wrong! It&#x27;s intentional it turns out - there&#x27;s a discussion on <a href="https://github.com/Moq/moq4/issues/117" target="_blank" rel="noopener noreferrer">GitHub about the issue</a>. And in that discussion there&#x27;s just what we need. We can use <code>Task.Delay</code> or <code>Task.FromResult</code> alongside Moq&#x27;s good old <code>Returns</code> method and we&#x27;re home free!</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="heres-one-i-made-earlier">Here&#x27;s one I made earlier...<a class="hash-link" href="#heres-one-i-made-earlier" title="Direct link to heading">â€‹</a></h2><div class="codeBlockContainer_K1bP language-cs theme-code-block"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace Proverb.Web.Controllers</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // ISageService again included inline for ease of explanation</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public interface ISageService</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        Task DeleteAsync(int id);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class SageController : ApiController</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        ISageService _sageService;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public SageController(ISageService userService)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageService = userService;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public async Task&lt;IHttpActionResult&gt; Delete(int id)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            await _sageService.DeleteAsync(id);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return Ok();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP language-cs theme-code-block"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace Proverb.Web.Tests.ASPNet.Controllers</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    [TestClass]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class SageControllerTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private Mock&lt;ISageService&gt; _sageServiceMock;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private SageController _controller;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        readonly Task TaskOfNowt = Task.Delay(0);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // Or you could use this equally valid but slightly more verbose approach:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        //readonly Task TaskOfNowt = Task.FromResult&lt;object&gt;(null);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [TestInitialize]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public void Initialise()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageServiceMock = new Mock&lt;ISageService&gt;();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _controller = new SageController(_sageServiceMock.Object);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [TestMethod]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public async Task Delete_returns_an_Ok()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageServiceMock</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .Setup(x =&gt; x.DeleteAsync(_sage.Id))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .Returns(TaskOfNowt); // Feels good doesn&#x27;t it?</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            IHttpActionResult result = await _controller.Delete(_sage.Id);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var ok = result as OkResult;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Assert.IsNotNull(ok);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _sageServiceMock.Verify(x =&gt; x.DeleteAsync(_sage.Id));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/unit-testing">unit testing</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/async">async</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/moq">MOQ</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/metaphysics">metaphysics</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about He tasks me; he heaps me.... I will wreak that MOQ upon him." href="/2014/10/03/he-tasks-me-he-heaps-me-i-will-wreak"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2013/02/18/unit-testing-mvc-controllers-mocking">Unit testing MVC controllers / Mocking UrlHelper</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2013-02-18T00:00:00.000Z" itemprop="datePublished">February 18, 2013</time> Â· <!-- -->3 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_31ik" id="i-have-put-a-name-to-my-pain">I have put a name to my pain...<a class="hash-link" href="#i-have-put-a-name-to-my-pain" title="Direct link to heading">â€‹</a></h2><p>And it is unit testing ASP.Net MVC controllers.</p><p>Well perhaps that&#x27;s unfair. I have no problem unit testing MVC controllers.... <strong>until</strong> it comes to making use of the &quot;innards&quot; of MVC. Let me be more specific. This week I had a controller action that I needed to test. It looked a little like this:</p><script src="https://gist.github.com/johnnyreilly/4959924.js?file=DemoController.cs"></script><p>Looks fine right? It&#x27;s an action that takes a simple object as an argument. That&#x27;s ok. It returns a JsonResult. No worries. The JsonResult consists of an anonymous class. De nada. The anonymous class has one property that is driven by the controllers <code>UrlHelper</code>. Yeah that shouldn&#x27;t be an issue... <strong>Hold your horses sunshine - you&#x27;re going nowhere!</strong></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="getting-disillusioned">Getting disillusioned<a class="hash-link" href="#getting-disillusioned" title="Direct link to heading">â€‹</a></h2><p>Yup, the minute you start pumping in asserts around that <code>UrlHelper</code> driven property you&#x27;re going to be mighty disappointed. What, you didn&#x27;t expect the result to be <code>null</code>? Damn shame.</p><p>Despite <a href="http://msdn.microsoft.com/en-us/magazine/dd942838.aspx" target="_blank" rel="noopener noreferrer">articles</a> on MSDN about how the intention is for MVC to be deliberately testable the sad fact of the matter is that there is a yawning hole around the testing support for controllers in ASP.Net MVC. Whenever you try to test something that makes use of controller &quot;gubbins&quot; you have <strong>serious</strong> problems. And unfortunately I didn&#x27;t find anyone out there who could offer the whole solution.</p><p>After what I can best describe as a day of pain I found a way to scratch my particular itch. I found a way to write unit tests for controllers that made use of UrlHelper. As a bonus I managed to include the unit testing of Routes and Areas (well kind of) too.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="mvcmockcontrollers-updated">MvcMockControllers updated<a class="hash-link" href="#mvcmockcontrollers-updated" title="Direct link to heading">â€‹</a></h2><p>This solution is heavily based on the work of Scott Hanselman who <a href="http://www.hanselman.com/blog/ASPNETMVCSessionAtMix08TDDAndMvcMockHelpers.aspx" target="_blank" rel="noopener noreferrer">wrote and blogged about <code>MvcMockHelpers</code></a> back in 2008. Essentially I&#x27;ve taken this and tweaked it so I could achieve my ends. My version of <code>MvcMockHelpers</code> looks a little like this:</p><script src="https://gist.github.com/johnnyreilly/4959924.js?file=MvcMockHelpers.cs"></script><h2 class="anchor anchorWithStickyNavbar_31ik" id="what-i-want-to-test">What I want to test<a class="hash-link" href="#what-i-want-to-test" title="Direct link to heading">â€‹</a></h2><p>I want to be able to unit test the controller <code>Edit</code> method I mentioned earlier. This method calls the <code>Action</code> method on the controllers <code>Url</code> member (which is, in turn, a <code>UrlHelper</code>) to generate a URL for passing pack to the client. The URL generated should fit with the routing mechanism I have set up. In this case the route we expect a URL for was mapped by the following area registration:</p><script src="https://gist.github.com/johnnyreilly/4959924.js?file=DemoAreaRegistration.cs"></script><h2 class="anchor anchorWithStickyNavbar_31ik" id="enough-of-the-waffle---show-me-a-unit-test">Enough of the waffle - show me a unit test<a class="hash-link" href="#enough-of-the-waffle---show-me-a-unit-test" title="Direct link to heading">â€‹</a></h2><p>Now to the meat; here&#x27;s a unit test which demonstrates how this is used:</p><script src="https://gist.github.com/johnnyreilly/4959924.js?file=UnitTestingAnAreaUsingUrlHelper.cs"></script><p>Let&#x27;s go through this unit test and breakdown what&#x27;s happening:</p><ol><li>Arrange</li><li>Act</li><li>Assert</li></ol><p>The most interesting thing you&#x27;ll note is the controller&#x27;s UrlHelper is now generating a URL as we might have hoped. The URL is generated making use of our routing, yay! Finally we&#x27;re also managing to unit test a route registered by our area.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/mvc">MVC</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/unit-testing">unit testing</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/area-registration-register-all-areas">AreaRegistration.RegisterAllAreas()</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/moq">MOQ</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/url-helper">UrlHelper</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Unit testing MVC controllers / Mocking UrlHelper" href="/2013/02/18/unit-testing-mvc-controllers-mocking"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2012/10/03/unit-testing-and-entity-framework-filth">Unit Testing and Entity Framework: The Filth and the Fury</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2012-10-03T00:00:00.000Z" itemprop="datePublished">October 3, 2012</time> Â· <!-- -->8 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Just recently I&#x27;ve noticed that there appears to be something of a controversy around Unit Testing and Entity Framework. I first came across it as I was Googling around for useful posts on using MOQ in conjunction with EF. I&#x27;ve started to notice the topic more and more and as I have mixed feelings on the subject (that is to say I don&#x27;t have a settled opinion) I thought I&#x27;d write about this and see if I came to any kind of conclusion...</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="the-setup">The Setup<a class="hash-link" href="#the-setup" title="Direct link to heading">â€‹</a></h2><p>It started as I was working on a new project. We were using ASP.NET MVC 3 and Entity Framework with DbContext as our persistence layer. Rather than crowbarring the tests in afterwards the intention was to write tests to support the ongoing development. Not quite test driven development but certainly <a href="http://blog.troyd.net/Test+Supported+Development+TSD+Is+NOT+Test+Driven+Development+TDD.aspx" target="_blank" rel="noopener noreferrer">test supported development</a>. (Let&#x27;s not get into the internecine conflict as to whether this is black belt testable code or not - it isn&#x27;t but he who pays the piper etc.) Oh and we were planning to use MOQ as our mocking library.</p><p>It was the first time I&#x27;d used DbContext rather than ObjectContext and so I thought I&#x27;d do a little research on how people were using DbContext with regards to testability. I had expected to find that there was some kind of consensus and an advised way forwards. I didn&#x27;t get that at all. Instead I found a number of conflicting opinions.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="using-the-repository--unit-of-work-patterns">Using the Repository / Unit of Work Patterns<a class="hash-link" href="#using-the-repository--unit-of-work-patterns" title="Direct link to heading">â€‹</a></h2><p>One thread of advice that came out was that people advised using the Repository / Unit of Work patterns as wrappers when it came to making testable code. This is kind of interesting in itself as to the best of my understanding ObjectSet / ObjectContext and DbSet / DbContext are both in themselves implementations of the Repository / Unit of Work patterns. So the advice was to build a Repository / Unit of Work pattern to wrap an existing Repository / Unit of Work pattern.</p><p>Not as mad as it sounds. The reason for the extra abstraction is that ObjectContext / DbContext in the raw are not MOQ-able.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="or-maybe-im-wrong-maybe-you-can-moq-dbcontext">Or maybe I&#x27;m wrong, maybe you can MOQ DbContext?<a class="hash-link" href="#or-maybe-im-wrong-maybe-you-can-moq-dbcontext" title="Direct link to heading">â€‹</a></h2><p>No you can&#x27;t. Well that&#x27;s not true. You can and it&#x27;s documented <a href="http://romiller.com/2012/02/14/testing-with-a-fake-dbcontext/" target="_blank" rel="noopener noreferrer">here</a> but there&#x27;s a &quot;but&quot;. You need to be using Entity Frameworks Code First approach; actually coding up your DbContext yourself. Before I&#x27;d got on board the project had already begun and we were already some way down the road of using the Database First approach. So this didn&#x27;t seem to be a go-er really.</p><p>The best article I found on testability and Entity Framework was <a href="http://msdn.microsoft.com/en-us/library/ff714955.aspx" target="_blank" rel="noopener noreferrer">this one</a> by <a href="http://odetocode.com/" target="_blank" rel="noopener noreferrer">K. Scott Allen</a> which essentially detailed how you could implement the Repository / Unit of Work patterns on top of ObjectSet / ObjectContext. In the end I adapted this to do the same thing sat on top of DbSet / DbContext instead.</p><p>With this in place I had me my testable code. I was quite happy with this as it seemed quite intelligible. My new approach looked similar to the existing DbSet / DbContext code and so there wasn&#x27;t a great deal of re-writing to do. Sorted, right?</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="here-come-the-nagging-doubts">Here come the nagging doubts...<a class="hash-link" href="#here-come-the-nagging-doubts" title="Direct link to heading">â€‹</a></h2><p>I did wonder, given that I found a number of articles about applying the Repository / Unit of Work patterns on top of ObjectSet / ObjectContext that there didn&#x27;t seem to be many examples to do the same for DbSet / DbContext. (I did find a few examples of this but none that felt satisfactory to me for a variety of reasons.) This puzzled me.</p><p>I also started to notice that a 1 man war was being waged against the approach I was using by <a href="http://www.ladislavmrnka.com/about/" target="_blank" rel="noopener noreferrer">Ladislav Mrnka</a>. Here are a couple of examples of his crusade:</p><ul><li><a href="http://stackoverflow.com/a/6904479/761388" target="_blank" rel="noopener noreferrer">An answer on StackOverflow</a> (there&#x27;s quite a few similar answers around on StackOverflow saying similar)</li><li><a href="http://romiller.com/2012/02/14/testing-with-a-fake-dbcontext/#div-comment-1620" target="_blank" rel="noopener noreferrer">A comment on Rowan Millers post about fake DbContexts</a></li></ul><p>Ladislav is quite strongly of the opinion that wrapping DbSet / DbContext (and I presume ObjectSet / ObjectContext too) in a further Repository / Unit of Work is an antipattern. To quote him: <em>&quot;The reason why I donâ€™t like it is leaky abstraction in Linq-to-entities queries ... In your test you have Linq-to-Objects which is superset of Linq-to-entities and only subset of queries written in L2O is translatable to L2E&quot;</em>. It&#x27;s worth looking at <a href="http://www.youtube.com/watch?v=gNeSZYke-_Q" target="_blank" rel="noopener noreferrer">Jon Skeets explanation of &quot;leaky abstractions&quot;</a> which he did for TekPub.</p><p>As much as I didn&#x27;t want to admit it - I have come to the conclusion Ladislav probably has a point for a number of reasons:</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="1-just-because-it-compiles-and-passes-unit-tests-dont-imagine-that-means-it-works">1<!-- -->.<!-- --> Just because it compiles and passes unit tests don&#x27;t imagine that means it works...<a class="hash-link" href="#1-just-because-it-compiles-and-passes-unit-tests-dont-imagine-that-means-it-works" title="Direct link to heading">â€‹</a></h3><p>Unfortunately, a LINQ query that looks right, compiles and has passing unit tests written for it doesn&#x27;t necessarily work. You can take a query that fails when executed against Entity Framework and come up with test data that will pass that unit test. As Ladislav rightly points out: <code>LINQ-to-Objects != LINQ-to-Entities</code>.</p><p>So in this case unit tests of this sort don&#x27;t provide you with any security. What you need are <!-- -->*<!-- -->*<u>integration</u></p><p>*<!-- -->*<!-- --> tests. Tests that run against an instance of the database and demonstrate that LINQ will actually translate queries / operations into valid SQL.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="2-complex-queries">2<!-- -->.<!-- --> Complex queries<a class="hash-link" href="#2-complex-queries" title="Direct link to heading">â€‹</a></h3><p>You can write some pretty complex LINQ queries if you want. This is made particularly easy if you&#x27;re using <a href="https://blogs.msdn.com/b/ericlippert/archive/2009/12/07/query-transformations-are-syntactic.aspx" target="_blank" rel="noopener noreferrer">comprehension syntax</a>. Whilst these queries may be simple to write it can be uphill work to generate test data to satisfy this. So much so that at times it can feel you&#x27;ve made a rod for your own back using this approach.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="3-lazy-loading">3<!-- -->.<!-- --> Lazy Loading<a class="hash-link" href="#3-lazy-loading" title="Direct link to heading">â€‹</a></h3><p>By default Entity Framework employs lazy loading. This a useful approach which reduces the amount of data that is transported. Sometimes this approach forces you to specify up front if you require a particular entity through use of <code>Include</code> statements. This again doesn&#x27;t lend itself to testing particularly well.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="where-does-this-leave-us">Where does this leave us?<a class="hash-link" href="#where-does-this-leave-us" title="Direct link to heading">â€‹</a></h2><p>Having considered all of the above for a while and tried out various different approaches I think I&#x27;m coming to the conclusion that Ladislav is probably right. Implementing the Repository / Unit of Work patterns on top of ObjectSet / ObjectContext or DbSet / DbContext doesn&#x27;t seem a worthwhile effort in the end.</p><p>So what&#x27;s a better idea? I think that in the name of simplicity you might as well have a simple class which wraps all of your Entity Framework code. This class could implement an interface and hence be straightforwardly MOQ-able (or alternatively all methods could be virtual and you could forego the interface). Along with this you should have integration tests in place which test the execution of the actual Entity Framework code against a test database.</p><p>Now I should say this approach is not necessarily my final opinion. It seems sensible and practical. I think it is likely to simplify the tests that are written around a project. It will certainly be more reliable than just having unit tests in place.</p><p>In terms of the project I&#x27;m working on at the moment we&#x27;re kind of doing this in a halfway house sense. That is to say, we&#x27;re still using our Repository / Unit of Work wrappers for DbSet / DbContext but where things move away from simple operations we&#x27;re adding extra methods to our Unit of Work class or Repository classes which wrap this functionality and then testing it using our integration tests.</p><p>I&#x27;m open to the possibility that my opinion may be modified further. And I&#x27;d be very interested to know what other people think on the subject.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="update">Update<a class="hash-link" href="#update" title="Direct link to heading">â€‹</a></h2><p>It turns out that I&#x27;m not alone in thinking about this issue and indeed others have expressed this rather better than me - take a look at Jimmy Bogard&#x27;s post for an example: <a href="http://lostechies.com/jimmybogard/2012/09/20/limiting-your-abstractions/" target="_blank" rel="noopener noreferrer">http://lostechies.com/jimmybogard/2012/09/20/limiting-your-abstractions/</a>.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="update-2">Update 2<a class="hash-link" href="#update-2" title="Direct link to heading">â€‹</a></h2><p>I&#x27;ve also recently watched the following Pluralsight course by Julie Lerman: <a href="http://pluralsight.com/training/Courses/TableOfContents/efarchitecture#efarchitecture-m3-archrepo" target="_blank" rel="noopener noreferrer">http://pluralsight.com/training/Courses/TableOfContents/efarchitecture#efarchitecture-m3-archrepo</a>. In this course Julie talks about different implementations of the Repository and Unit of Work patterns in conjunction with Entity Framework. Julie is in favour of using this approach but in this module she elaborates on different &quot;flavours&quot; of these patterns that you might want to use for different reasons (bounded contexts / reference contexts etc). She makes a compelling case and helpfully she is open enough to say that this a point of contention in the community. At the end of watching this I think I felt happy that our &quot;halfway house&quot; approach seems to fit and seems to work. More than anything else Julie made clear that there isn&#x27;t one definitively &quot;true&quot; approach. Rather many different but similar approaches for achieving the same goal. Good stuff Julie!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/unit-testing">unit testing</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/entity-framework">Entity Framework</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/anti-pattern">anti-pattern</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/moq">MOQ</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Unit Testing and Entity Framework: The Filth and the Fury" href="/2012/10/03/unit-testing-and-entity-framework-filth"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2012/04/16/simple-technique-for-initialising">A Simple Technique for Initialising Properties with Internal Setters for Unit Testing</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2012-04-16T00:00:00.000Z" itemprop="datePublished">April 16, 2012</time> Â· <!-- -->6 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>I was recently working with my colleagues on refactoring a legacy application. We didn&#x27;t have an immense amount of time available for this but the plan was to try and improve what was there as much as possible. In its initial state the application had no unit tests in place at all and so the plan was to refactor the code base in such a way as to make testing it a realistic proposition. To that end the <a href="http://en.wikipedia.org/wiki/Domain_layer" target="_blank" rel="noopener noreferrer">domain layer</a> was being heavily adjusted and the GUI was being migrated from WebForms to MVC 3. The intention was to build up a pretty solid collection of unit tests. However, as we were working on this we realised we had a problem with properties on our models with <a href="http://msdn.microsoft.com/en-us/library/7c5ka91b(v=vs.80).aspx" target="_blank" rel="noopener noreferrer"><code>internal</code></a> setters...</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="background">Background<a class="hash-link" href="#background" title="Direct link to heading">â€‹</a></h2><p>The entities of the project in question used an approach which would store pertinent bits of <a href="http://en.wikipedia.org/wiki/Database_normalization" target="_blank" rel="noopener noreferrer">normalised</a> data for read-only purposes in related entities. I&#x27;ve re-read that sentence and realise it&#x27;s as clear as mud. Here is an example to clarify:</p><div class="codeBlockContainer_K1bP language-cs theme-code-block"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">public class Person</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public int Id { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public string FirstName { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public string LastName { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public string Address { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public DateTime DateOfBirth { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  /* Other fascinating properties... */</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">public class Order</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public int Id { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public string ProductOrdered { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public string OrderedById { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public string OrderedByFirstName { get; internal set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public string OrderedByLastName { get; internal set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In the example above you have 2 types of entity: <code>Person</code> and <code>Order</code>. The <code>Order</code> entity makes use of the the <code>Id</code>, <code>FirstName</code> and <code>LastName</code> properties of the <code>Person</code> entity in the properties <code>OrderedById</code>, <code>OrderedByFirstName</code> and <code>OrderedByLastName</code>. For persistence (ie saving to the database) purposes the only necessary <code>Person</code> property is <code>OrderedById</code> identity. <code>OrderedByFirstName</code> and <code>OrderedByLastName</code> are just &quot;nice to haves&quot; - essentially present to make implementing the GUI more straightforward.</p><p>To express this behaviour / intention in the object model the setters for <code>OrderedByFirstName</code> and <code>OrderedByLastName</code> are marked as <code>internal</code>. The implication of this is that properties like this can only be initialised within the current assembly - or any explicitly associated &quot;friend&quot; assemblies. In practice this meant that internally set properties were only populated when an object was read in from the database. It wasn&#x27;t possible to set these properties in other assemblies which meant less code was written (<u>a good thing</u></p><p>) - after all, why set a property when you don&#x27;t need to?</p><p>Background explanation over. It may still be a little unclear but I hope you get the gist.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="whats-our-problem">What&#x27;s our problem?<a class="hash-link" href="#whats-our-problem" title="Direct link to heading">â€‹</a></h2><p>I was writing unit tests for the controllers in our main web application and was having problems with my arrangements. I was mocking the database calls in my controllers much in the manner that you might expect:</p><div class="codeBlockContainer_K1bP language-ts theme-code-block"><div class="codeBlockContent_hGly ts"><pre tabindex="0" class="prism-code language-ts codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// Arrange</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">var</span><span class="token plain"> orderDb </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 139)">Mock</span><span class="token class-name operator" style="color:rgb(127, 219, 202)">&lt;</span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 139)">IOrderDb</span><span class="token class-name operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  orderDb</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access maybe-class-name" style="color:rgb(130, 170, 255)">Setup</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x </span><span class="token arrow operator" style="color:rgb(127, 219, 202)">=&gt;</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access maybe-class-name" style="color:rgb(130, 170, 255)">GetOrder</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token maybe-class-name">It</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token generic-function function" style="color:rgb(130, 170, 255)">IsAny</span><span class="token generic-function generic class-name operator" style="color:rgb(127, 219, 202)">&lt;</span><span class="token generic-function generic class-name" style="color:rgb(255, 203, 139)">int</span><span class="token generic-function generic class-name operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access maybe-class-name" style="color:rgb(130, 170, 255)">Returns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 139)">Order</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token maybe-class-name">Id</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">123</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token maybe-class-name">ProductOrdered</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Packet of coffee&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token maybe-class-name">OrderedById</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">987456</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token maybe-class-name">OrderedByFirstName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;John&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token maybe-class-name">OrderedByLastName</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Reilly&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>All looks fine doesn&#x27;t it? It&#x27;s not. Because <code>OrderedByFirstName</code> and <code>OrderedByLastName</code> have internal setters we are <u>unable</u></p><p>to initialise them from within the context of our test project. So what to do?</p><p>We toyed with 3 approaches and since each has merits I thought it worth going through each of them:</p><ol><li><p>To the MOQumentation Batman!: <a href="http://code.google.com/p/moq/wiki/QuickStart" target="_blank" rel="noopener noreferrer">http://code.google.com/p/moq/wiki/QuickStart</a>! Looking at the MOQ documentation it states the following:</p><p><em>Mocking internal types of another project: add the following assembly attributes (typically to the AssemblyInfo.cs) to the project containing the internal types:</em></p><div class="codeBlockContainer_K1bP language-cs theme-code-block"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">// This assembly is the default dynamic assembly generated Castle DynamicProxy,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// used by Moq. Paste in a single line.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">[assembly:InternalsVisibleTo(&quot;DynamicProxyGenAssembly2,PublicKey=0024000004800000940000000602000000240000525341310004000001000100c547cac37abd99c8db225ef2f6c8a3602f3b3606cc9891605d02baa56104f4cfc0734aa39b93bf7852f7d9266654753cc297e7d2edfe0bac1cdcf9f717241550e0a7b191195b7667bb4f64bcb8e2121380fd1d9d46ad2d92d2d15605093924cceaf74c4861eff62abf69b9291ed0a340e113be11e6a7d3113e92484cf7045cc7&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">[assembly: InternalsVisibleTo(&quot;The.NameSpace.Of.Your.Unit.Test&quot;)] //I&#x27;d hope it was shorter than that...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This looked to be exactly what we needed and in most situations it would make sense to go with this. Unfortunately for us there was a gotcha. Certain core shared parts of our application platform were <a href="http://en.wikipedia.org/wiki/Global_Assembly_Cache" target="_blank" rel="noopener noreferrer">GAC</a>&#x27;d. A requirement for GAC-ing an assembly is that it is <a href="http://msdn.microsoft.com/en-us/library/xc31ft41.aspx" target="_blank" rel="noopener noreferrer">signed</a>.</p><p>The upshot of this was that if we wanted to use the <code>InternalsVisibleTo</code> approach then we would need to sign our web application test project. We weren&#x27;t particularly averse to that and initially did so without much thought. It was then we remembered that every assembly referenced by a signed assembly must also be signed as well. We didn&#x27;t really want to sign our main web application purely for testing purposes. We could and if there weren&#x27;t viable alternatives we well might have. But it just seemed like the wrong reason to be taking that decision. Like using a sledgehammer to crack a nut.</p></li><li><p>The next approach we took was using mock objects. Instead of using our objects straight we would mock them as below:</p><div class="codeBlockContainer_K1bP language-cs theme-code-block"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">//Create mock and set internal properties</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      var orderMock = new Mock&lt;Order&gt;();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      orderMock.SetupGet(x =&gt; x.OrderedByFirstName).Returns(&quot;John&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      orderMock.SetupGet(x =&gt; x.OrderedByLastName).Returns(&quot;Reilly&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      //Set up standard properties</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      orderMock.SetupAllProperties();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      var orderStub = orderMock.Object;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      orderStub.Id = 123;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      orderStub.ProductOrdered = &quot;Packet of coffee&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      orderStub.OrderedById = 987456;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now this approach worked fine but had a couple of snags:</p><ul><li><p>As you can see it&#x27;s pretty verbose and much less clear to read than it was previously.</p></li><li><p>It required that we add the <code>virtual</code> keyword to all our internally set properties like so:</p><div class="codeBlockContainer_K1bP language-cs theme-code-block"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">public class Order</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  // ....</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public virtual string OrderedByFirstName { get; internal set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public virtual string OrderedByLastName { get; internal set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li><li><p>Our standard constructor already initialised the value of our internally set properties. So adding <code>virtual</code> to the internally set properties generated <a href="http://www.jetbrains.com/resharper/" target="_blank" rel="noopener noreferrer">ReSharper</a> warnings aplenty about virtual properties being initialised in the constructor. Fair enough.</p></li></ul><p>Because of the snags it still felt like we were in nutcracking territory...</p></li><li><p>... and this took us to the approach that we ended up adopting: a special mocking constructor for each class we wanted to test, for example:</p><div class="codeBlockContainer_K1bP language-cs theme-code-block"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">/// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">/// Mocking constructor used to initialise internal properties</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">/// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">public Order(string orderedByFirstName = null, string orderedByLastName = null)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">: this()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">OrderedByFirstName = orderedByFirstName;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">OrderedByLastName = orderedByLastName;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Thanks to the ever lovely <a href="http://msdn.microsoft.com/en-us/library/dd264739.aspx" target="_blank" rel="noopener noreferrer">Named and Optional Arguments</a> feature of C# combined with <a href="http://msdn.microsoft.com/en-us/library/bb397680.aspx" target="_blank" rel="noopener noreferrer">Object Initializers</a> it meant it was possible to write quite expressive, succinct code using this approach; for example:</p><div class="codeBlockContainer_K1bP language-cs theme-code-block"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">var order = new Order(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        orderedByFirstName: &quot;John&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        orderedByLastName: &quot;Reilly&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        Id = 123,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        ProductOrdered = &quot;Packet of coffee&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        OrderedById = 987456</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      };</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Here we&#x27;re calling the mocking constructor to set the internally set properties and subsequently initialising the other properties using the object initialiser mechanism.</p><p>Implementing these custom constructors wasn&#x27;t a massive piece of work and so we ended up settling on this technique for initialising internal properties.</p></li></ol></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/unit-testing">unit testing</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/internals-visible-to">InternalsVisibleTo</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/moq">MOQ</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/mocking">mocking</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about A Simple Technique for Initialising Properties with Internal Setters for Unit Testing" href="/2012/04/16/simple-technique-for-initialising"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.e1a9c30a.js"></script>
<script src="/assets/js/main.1c481cdf.js"></script>
</body>
</html>