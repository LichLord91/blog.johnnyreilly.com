<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">9 posts tagged with &quot;Bicep&quot; | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="9 posts tagged with &quot;Bicep&quot; | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/tags/bicep"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-react-helmet="true" name="robots" content="max-image-preview:large"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/tags/bicep"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/bicep" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/bicep" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ff16c2af.css">
<link rel="preload" href="/assets/js/runtime~main.4bb9d4be.js" as="script">
<link rel="preload" href="/assets/js/main.14ca547e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog-archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://polywork.johnnyreilly.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Polywork<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/12/05/azure-static-web-app-deploy-previews-with-azure-devops">Azure Static Web App Deploy Previews with Azure DevOps</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/22/typescript-vs-jsdoc-javascript">TypeScript vs JSDoc JavaScript</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/18/azure-standard-tests-with-bicep">Azure standard availability tests with Bicep</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/31/nswag-generated-c-sharp-client-property-name-clash">NSwag generated C# client: Open API property name clashes and decimal types rather than double</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/18/docusaurus-meta-tags-and-google-discover">Docusaurus, meta tags and Google Discover</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>9 posts tagged with &quot;Bicep&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2021/11/18/azure-standard-tests-with-bicep">Azure standard availability tests with Bicep</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-11-18T00:00:00.000Z" itemprop="datePublished">November 18, 2021</time> Â· <!-- -->6 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/blog/2021-11-18-azure-standard-tests-with-bicep/title-image.png"><div class="markdown" itemprop="articleBody"><p>Azure standard tests are a tremendous way to monitor the uptime of your services in Azure. Sometimes also called availability tests, web tests and ping tests, this post goes through how to deploy one using Bicep. It also looks at some of the gotchas that you may encounter as you&#x27;re setting it up.</p><p><img alt="title image reading &amp;quot;Azure standard availability tests with Bicep&amp;quot; with a Bicep logo and Azure logos" src="/assets/images/title-image-f703ae98e6d7082e00e80758597026cf.png"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="what-are-standard-tests">What are standard tests?<a aria-hidden="true" class="hash-link" href="#what-are-standard-tests" title="Direct link to heading">â€‹</a></h2><p>To quote the <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/app/availability-standard-tests" target="_blank" rel="noopener noreferrer">docs</a>:</p><blockquote><p>Standard tests are a single request test that is similar to the URL ping test but more advanced. In addition to validating whether an endpoint is responding and measuring the performance, Standard tests also includes SSL certificate validity, proactive lifetime check, HTTP request verb (for example GET,HEAD,POST, etc.), custom headers, and custom data associated with your HTTP request.</p></blockquote><p>So we can use these to:</p><ul><li>send requests to a URL</li><li>from a variety of geographic locations</li><li>and determine if it is responding with a 200 status code</li></ul><p>The URL may be one of our own service URLs, but it could be checking any kind of URL. It&#x27;s web specific, not Azure specific.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="standard-test-bicep">Standard test Bicep<a aria-hidden="true" class="hash-link" href="#standard-test-bicep" title="Direct link to heading">â€‹</a></h2><p>Now we&#x27;re going to write a Bicep module that provisions a standard test named <code>standard-test.bicep</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Tags that our resources need&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param tags object</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;The resource id of the app insights which the webtest will reference&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param appInsightsResourceId string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;The name of the webtest to create&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param standardTestName string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;URL to test&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param urlToTest string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Interval in seconds between test runs for this WebTest. Default value is 300.&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param frequency int = 300</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Seconds until this WebTest will timeout and fail. Default value is 30.&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param timeout int = 30</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// useful reference:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// https://docs.microsoft.com/en-us/azure/azure-monitor/app/monitor-web-app-availability#azure</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@allowed([</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-au-syd-edge&#x27; // Australiaâ€¯East</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;latam-br-gru-edge&#x27; // Brazil South</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;us-fl-mia-edge&#x27; // Central US</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;apac-hk-hkn-azr&#x27; // East Asia</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;us-va-ash-azr&#x27; // East US</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-ch-zrh-edge&#x27; // France South (Formerly France Central)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-fr-pra-edge&#x27; // France Central</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;apac-jp-kaw-edge&#x27; // Japan East</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-gb-db3-azr&#x27; // North Europe</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;us-il-ch1-azr&#x27; // North Central US</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;us-tx-sn1-azr&#x27; // South Central US</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;apac-sg-sin-azr&#x27; // Southeast Asia</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-se-sto-edge&#x27; // UK West</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-nl-ams-azr&#x27; // West Europe</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;us-ca-sjc-azr&#x27; // West US</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-ru-msa-edge&#x27; // UK South</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">])</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;The populations (locations) for the test&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param testPopulations array = [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-se-sto-edge&#x27; // UK West</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-ru-msa-edge&#x27; // UK South</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-gb-db3-azr&#x27; // North Europe</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;us-va-ash-azr&#x27; // East US</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;apac-sg-sin-azr&#x27; // Southeast Asia</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var tagsWithHiddenLink = union({</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;hidden-link:${appInsightsResourceId}&#x27;: &#x27;Resource&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}, tags)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource standardWebTest &#x27;Microsoft.Insights/webtests@2018-05-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: standardTestName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: tagsWithHiddenLink</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;ping&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    SyntheticMonitorId: urlToTest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Name: urlToTest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Description: null</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Enabled: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Frequency: frequency</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Timeout: timeout</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Kind: &#x27;standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    RetryEnabled: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Locations: [for testPopulation in testPopulations: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      Id: testPopulation</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Configuration: null</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Request: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      RequestUrl: urlToTest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      Headers: null</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      HttpVerb: &#x27;GET&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      RequestBody: null</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ParseDependentRequests: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      FollowRedirects: null</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ValidationRules: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ExpectedHttpStatusCode: 200</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      IgnoreHttpsStatusCode: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ContentValidation: null</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      SSLCheck: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      SSLCertRemainingLifetimeCheck: 7</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output standardWebTestName string = standardWebTest.name</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output standardWebTestId string = standardWebTest.id</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_31ik" id="locations--populations">Locations / populations<a aria-hidden="true" class="hash-link" href="#locations--populations" title="Direct link to heading">â€‹</a></h3><p>You&#x27;ll note that a parameter to the Bicep module is <code>testPopulations</code>. These are the geographical places where requests will be sent from. You&#x27;ll note we have a default value of five populations, but these could be any of the (presently) sixteen valid values. If you were wondering where those are sourced from, <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/app/availability-standard-tests#location-population-tags" target="_blank" rel="noopener noreferrer">here is the link to the Azure docs</a>.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="the-hidden-link-tag">The <code>hidden-link</code> tag<a aria-hidden="true" class="hash-link" href="#the-hidden-link-tag" title="Direct link to heading">â€‹</a></h3><p>Another significant call out should go to the <code>hidden-link</code> tag. The <code>hidden-link</code> tag is a mandatory tag that connects the test (known in Azure as a &quot;webtest&quot;) to an app insights instance.</p><p>If you do not provide a <code>hidden-link</code> tag, or if you try to specify a resource group other than the app insights resource group, Azure will fail to deploy your test and you may find yourself presented with an error like this in the deployments section of the Azure Portal.</p><blockquote><p>Resource should exist in the same resource group as the linked component</p></blockquote><p><img alt="screenshot of the Azure Portal Deployments section saying &amp;quot;Resource should exist in the same resource group as the linked component&amp;quot;" src="/assets/images/screenshot-azure-portal-deployments-resource-should-exist-in-the-same-resource-group-2dd50b98491bb7a0b657a9b1a266435a.png"></p><p>In our module we set both the <code>hidden-link</code> tag as well as the tags that have been supplied via the <code>tags</code> parameter.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="app-insights-and-standard-tests-share-a-resource-group">App insights and standard tests share a resource group<a aria-hidden="true" class="hash-link" href="#app-insights-and-standard-tests-share-a-resource-group" title="Direct link to heading">â€‹</a></h3><p>Another thing that can cause issues is the deployment of your app insights resource. It&#x27;s not unusual to spin up Azure resources on demand, for a given branch of your source code. Those resources will be named in relation to the branch and will depend upon one another. I&#x27;ve never managed to successfully create an app insights resource, and reference it from a standard test within the same Bicep file. It appears to be necessary to separate the two actions, such that Azure recognises the existence of the app insights resource when the standard test is deployed.</p><p>If you are working with long-lived app insights it won&#x27;t be an issue for you, but if you aren&#x27;t it&#x27;s worth being aware of.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="using-standard-testbicep">Using <code>standard-test.bicep</code><a aria-hidden="true" class="hash-link" href="#using-standard-testbicep" title="Direct link to heading">â€‹</a></h2><p>Our Bicep module can be invoked from another Bicep module named <code>ping-them.bicep</code> like so:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Tags that our resources need&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param tags object</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;The name of the app insights&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param appInsightsName string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;An object where the keys are the name of the web test and the values are the URL eg {&quot;my-standard-test&quot;: &quot;https://status.azure.com/en-gb/status&quot;} &#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param standardTests object</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var appInsightsResourceId = resourceId(&#x27;Microsoft.Insights/components&#x27;, appInsightsName)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">module standardTestsToCreate &#x27;standard-test.bicep&#x27; = [for standardTest in items(standardTests): {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: standardTest.key</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  params: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    tags: tags</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    appInsightsResourceId: appInsightsResourceId</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    standardTestName: standardTest.key</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    urlToTest: standardTest.value</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>As you can see, this module itself takes a number of parameters, and will typically be invoked from some kind of continuous integration mechanism such as Azure Pipelines or GitHub Actions.</p><p>This module is written in the expectation that multiple URLs will need to be pinged, and so it has a parameter named <code>standardTests</code> which is effectively a dictionary of key-value pairs, where the key is the name of the standard test, and the value is the URL to test.</p><p>The module makes use of the <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/bicep-functions-array#items" target="_blank" rel="noopener noreferrer"><code>items</code></a> array helper in Bicep to convert the object into an array that can be iterated over.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="azure-pipelines-test">Azure Pipelines test<a aria-hidden="true" class="hash-link" href="#azure-pipelines-test" title="Direct link to heading">â€‹</a></h2><p>We&#x27;re going to use Azure Pipelines to test this out. Here&#x27;s an <code>azure-pipelines.yml</code> file:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yml"><pre tabindex="0" class="prism-code language-yml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">trigger</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">pool</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">vmImage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">checkout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> self</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">submodules</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> az bicep build </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">file ping</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">them.bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Compile Bicep to ARM&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureResourceManagerTemplateDeployment@3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DeploySharedWebTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy Shared Web Tests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">deploymentScope</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">azureResourceManagerConnection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> variables.serviceConnection </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">subscriptionId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(subscriptionId)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Create Or Update Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(resourceGroup)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(location)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">templateLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Linked artifact</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">csmFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;ping-them.json&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># created by bash script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">overrideParameters</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">tags </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token key atrule">&quot;owner&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;@johnny_reilly&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token key atrule">&quot;branch&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;$(Build.SourceBranchName)&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">appInsightsName $(appInsightsName)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">standardTests </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token key atrule">&quot;my-standard-test&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://status.azure.com/en-gb/status&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">deploymentMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Incremental</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>When run, it invokes our <code>ping-them.bicep</code> module, passing two URLs to test.</p><p>When executed, you end up with a delightful &quot;availability test&quot; (which is your standard test) in Azure:</p><p><img alt="screenshot of an Availability test in the Azure Portal" src="/assets/images/screenshot-azure-portal-availability-e940ec4429edeb830e5f7d55e355cad4.png"></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure">Azure</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/bicep">Bicep</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/standard-tests">standard tests</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Azure standard availability tests with Bicep" href="/2021/11/18/azure-standard-tests-with-bicep"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2021/09/12/permissioning-azure-pipelines-bicep-role-assignments">Permissioning Azure Pipelines with Bicep and Azure RBAC Role Assignments</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-09-12T00:00:00.000Z" itemprop="datePublished">September 12, 2021</time> Â· <!-- -->9 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/blog/2021-09-12-permissioning-azure-pipelines-bicep-role-assignments/permissioning-azure-pipelines-with-bicep-and-role-assignments.png"><div class="markdown" itemprop="articleBody"><p>How can we deploy resources to Azure, and then run an integration test through them in the context of an Azure Pipeline? This post will show how to do this by permissioning our Azure Pipeline to access these resources using Azure RBAC role assignments. It will also demonstrate a dotnet test that runs in the context of the pipeline and makes use of those role assignments.</p><p><img alt="title image reading &amp;quot;Permissioning Azure Pipelines with Bicep and Role Assignments&amp;quot; and some Azure logos" src="/assets/images/permissioning-azure-pipelines-with-bicep-and-role-assignments-f310e0c6ab1c5ecb98495cd7c278fea1.png"></p><p>We&#x27;re following this approach as an alternative to <a href="/2021/07/07/output-connection-strings-and-keys-from-azure-bicep">exporting connection strings</a>, as these can be viewed in the Azure Portal; which may be an security issue if you have many people who are able to access the portal and view deployment outputs.</p><p>We&#x27;re going to demonstrate this approach using Event Hubs. It&#x27;s worth calling out that this is a generally useful approach which can be applied to any Azure resources that support Azure RBAC Role Assignments. So wherever in this post you read &quot;Event Hubs&quot;, imagine substituting other Azure resources you&#x27;re working with.</p><p>The post will do the following:</p><ul><li>Add Event Hubs to our Azure subscription</li><li>Permission our service connection / service principal</li><li>Deploy to Azure with Bicep</li><li>Write an integration test</li><li>Write a pipeline to bring it all together</li></ul><h2 class="anchor anchorWithStickyNavbar_31ik" id="add-event-hubs-to-your-subscription">Add Event Hubs to your subscription<a aria-hidden="true" class="hash-link" href="#add-event-hubs-to-your-subscription" title="Direct link to heading">â€‹</a></h2><p>First of all, we may need to add Event Hubs to our Azure subscription.</p><p>Without this in place, we may encounter errors of the type:</p><blockquote><p>##<!-- -->[error]<!-- -->MissingSubscriptionRegistration: The subscription is not registered to use namespace &#x27;Microsoft.EventHub&#x27;. See <a href="https://aka.ms/rps-not-found" target="_blank" rel="noopener noreferrer">https://aka.ms/rps-not-found</a> for how to register subscriptions.</p></blockquote><p>We do this by going to &quot;Resource Providers&quot; in the <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer">Azure Portal</a> and registering the resources you need. Lots are registered by default, but not all.</p><p><img alt="Screenshot of the Azure Portal, subscriptions -&amp;gt; resource providers section, showing that Event Hubs have been registered" src="/assets/images/screenshot-azure-portal-subscription-resource-providers-be88a0731905bb2e97e82996628789df.png"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="permission-our-service-connection--service-principal">Permission our service connection / service principal<a aria-hidden="true" class="hash-link" href="#permission-our-service-connection--service-principal" title="Direct link to heading">â€‹</a></h2><p>In order that we can run pipelines related to Azure, we mostly need to have an Azure Resource Manager service connection set up in Azure DevOps. Once that exists, we also need to give it a role assignment to allow it to create role assignments of its own when pipelines are running.</p><p>Without this in place, we may encounter errors of the type:</p><blockquote><p>##<!-- -->[error]<!-- -->The template deployment failed with error: &#x27;Authorization failed for template resource &#x27;{GUID-THE-FIRST}&#x27; of type &#x27;Microsoft.Authorization/roleAssignments&#x27;. The client &#x27;{GUID-THE-SECOND}&#x27; with object id &#x27;{GUID-THE-SECOND}&#x27; does not have permission to perform action &#x27;Microsoft.Authorization/roleAssignments/write&#x27; at scope &#x27;/subscriptions/<!-- -->*<!-- -->*<!-- -->*<!-- -->/resourceGroups/johnnyreilly/providers/Microsoft.EventHub/namespaces/evhns-demo/providers/Microsoft.Authorization/roleAssignments/{GUID-THE-FIRST}&#x27;.&#x27;.</p></blockquote><p>Essentially, we want to be able to run pipelines that say &quot;hey Azure, we want to give permissions to our service connection&quot;. We are doing this <em>with</em> the self same service connection, so (chicken and egg) we first need to give it permission to give those commands in future. This is a little confusing; but let&#x27;s role with it. (Pun most definitely intended. ðŸ˜‰)</p><p>To grant that permission / add that role assignment, we go to the service connection in Azure Devops:</p><p><img alt="Screenshot of the service connection in Azure DevOps" src="/assets/images/screenshot-azure-devops-service-connection-f50cd8d004453beb7caf005a82cb3766.png"></p><p>We can see there&#x27;s two links here; first we&#x27;ll click on &quot;Manage Service Principal&quot;, which will take us to the service principal in the Azure Portal:</p><p><img alt="Screenshot of the service principal in the Azure Portal" src="/assets/images/screenshot-azure-portal-service-principal-a98fc857ed6ab3e718e29ff22cd3a02f.png"></p><p>Take note of the display name of the service principal; we&#x27;ll need that as we click on the &quot;Manage service connection roles&quot; link, which will take us to the resource groups IAM page in the Azure Portal:</p><p><img alt="Screenshot of the resource groups IAM page in the Azure Portal" src="/assets/images/screenshot-azure-portal-service-principal-access-control-7bc28b09e72342ec1bd95791c075aa2d.png"></p><p>Here we can click on &quot;Add role assignment&quot;, select &quot;Owner&quot;:</p><p><img alt="Screenshot of the add role assignment IAM page in the Azure Portal" src="/assets/images/screenshot-azure-portal-add-role-assignment-5a94eea687c534ad44496e905d5ef6cf.png"></p><p>Then when selecting members we should be able to look up the service principal to assign it:</p><p><img alt="Screenshot of the add role assignment select member IAM page in the Azure Portal" src="/assets/images/screenshot-azure-portal-add-role-assignment-member-1ef19f40155c3538e9a3ad90a4a281f7.png"></p><p>We now have a service connection which we should be able to use for granting permissions / role assignments, which is what we need.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="event-hub-and-role-assignment-with-bicep">Event Hub and Role Assignment with Bicep<a aria-hidden="true" class="hash-link" href="#event-hub-and-role-assignment-with-bicep" title="Direct link to heading">â€‹</a></h2><p>Next we want a Bicep file that will, when run, provision an Event Hub and a role assignment which will allow our Azure Pipeline (via its service connection) to interact with it.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Name of the eventhub namespace&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param eventHubNamespaceName string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Name of the eventhub name&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param eventHubName string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;The service principal&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param principalId string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Create an Event Hub namespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHubNamespace &#x27;Microsoft.EventHub/namespaces@2021-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: eventHubNamespaceName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name: &#x27;Standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    tier: &#x27;Standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    capacity: 1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    zoneRedundant: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Create an Event Hub inside the namespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHub &#x27;Microsoft.EventHub/namespaces/eventhubs@2021-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  parent: eventHubNamespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: eventHubName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    messageRetentionInDays: 7</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    partitionCount: 1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// give Azure Pipelines Service Principal permissions against the Event Hub</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var roleDefinitionAzureEventHubsDataOwner = subscriptionResourceId(&#x27;Microsoft.Authorization/roleDefinitions&#x27;, &#x27;f526a384-b230-433a-b45c-95f59c4a2dec&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource integrationTestEventHubReceiverNamespaceRoleAssignment &#x27;Microsoft.Authorization/roleAssignments@2018-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: guid(principalId, eventHub.id, roleDefinitionAzureEventHubsDataOwner)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  scope: eventHubNamespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    roleDefinitionId: roleDefinitionAzureEventHubsDataOwner</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    principalId: principalId</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Do note that our bicep template takes the service principal id as a parameter. We&#x27;re going to supply this later from our Azure Pipeline.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="our-test">Our test<a aria-hidden="true" class="hash-link" href="#our-test" title="Direct link to heading">â€‹</a></h2><p>We&#x27;re now going to write a dotnet integration test which will make use of the infrastructure deployed by our Bicep template. Let&#x27;s create a new test project:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">mkdir src</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cd src</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet new xunit -o IntegrationTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cd IntegrationTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet add package Azure.Identity</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet add package Azure.Messaging.EventHubs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet add package FluentAssertions</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet add package Microsoft.Extensions.Configuration.EnvironmentVariables</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We&#x27;ll create a test file called <code>EventHubTest.cs</code> with these contents:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Collections.Generic;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Linq;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Text;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Threading;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Threading.Tasks;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Azure.Identity;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Azure.Messaging.EventHubs;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Azure.Messaging.EventHubs.Consumer;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Azure.Messaging.EventHubs.Producer;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using FluentAssertions;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.Configuration;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Newtonsoft.Json;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Xunit;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Xunit.Abstractions;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace IntegrationTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public record EchoMessage(string Id, string Message, DateTime Timestamp);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class EventHubTest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private readonly ITestOutputHelper _output;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public EventHubTest(ITestOutputHelper output)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _output = output;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [Fact]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public async Task Can_post_message_to_event_hub_and_read_it_back()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // ARRANGE</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var configuration = new ConfigurationBuilder()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .AddEnvironmentVariables()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .Build();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // populated by variables specified in the Azure Pipeline</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var eventhubNamespaceName = configuration[&quot;EVENTHUBNAMESPACENAME&quot;];</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            eventhubNamespaceName.Should().NotBeNull();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var eventhubName = configuration[&quot;EVENTHUBNAME&quot;];</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            eventhubName.Should().NotBeNull();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var tenantId = configuration[&quot;TENANTID&quot;];</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            tenantId.Should().NotBeNull();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // populated as a consequence of the addSpnToEnvironment in the azure-pipelines.yml</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var servicePrincipalId = configuration[&quot;SERVICEPRINCIPALID&quot;];</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            servicePrincipalId.Should().NotBeNull();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var servicePrincipalKey = configuration[&quot;SERVICEPRINCIPALKEY&quot;];</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            servicePrincipalKey.Should().NotBeNull();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var fullyQualifiedNamespace = $&quot;{eventhubNamespaceName}.servicebus.windows.net&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var clientCredential = new ClientSecretCredential(tenantId, servicePrincipalId, servicePrincipalKey);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var eventHubClient = new EventHubProducerClient(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                fullyQualifiedNamespace: fullyQualifiedNamespace,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                eventHubName: eventhubName,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                credential: clientCredential</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var ourGuid = Guid.NewGuid().ToString();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var now = DateTime.UtcNow;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var sentEchoMessage = new EchoMessage(Id: ourGuid, Message: $&quot;Test message&quot;, Timestamp: now);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var sentEventData = new EventData(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                Encoding.UTF8.GetBytes(JsonConvert.SerializeObject(sentEchoMessage))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // ACT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            await eventHubClient.SendAsync(new List&lt;EventData&gt; { sentEventData }, CancellationToken.None);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var eventHubConsumerClient = new EventHubConsumerClient(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                consumerGroup: EventHubConsumerClient.DefaultConsumerGroupName,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                fullyQualifiedNamespace: fullyQualifiedNamespace,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                eventHubName: eventhubName,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                credential: clientCredential</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            List&lt;PartitionEvent&gt; partitionEvents = new();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            await foreach (var partitionEvent in eventHubConsumerClient.ReadEventsAsync(new ReadEventOptions</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                MaximumWaitTime = TimeSpan.FromSeconds(10)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (partitionEvent.Data == null) break;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                _output.WriteLine(Encoding.UTF8.GetString(partitionEvent.Data.EventBody.ToArray()));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                partitionEvents.Add(partitionEvent);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // ASSERT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            partitionEvents.Count.Should().BeGreaterOrEqualTo(1);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var firstOne = partitionEvents.FirstOrDefault(evnt =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              ExtractTypeFromEventBody&lt;EchoMessage&gt;(evnt, _output)?.Id == ourGuid</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var receivedEchoMessage = ExtractTypeFromEventBody&lt;EchoMessage&gt;(firstOne, _output);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            receivedEchoMessage.Should().BeEquivalentTo(sentEchoMessage, because: &quot;the event body should be the same one posted to the message queue&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private static T ExtractTypeFromEventBody&lt;T&gt;(PartitionEvent evnt, ITestOutputHelper _output)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            try</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return JsonConvert.DeserializeObject&lt;T&gt;(Encoding.UTF8.GetString(evnt.Data.EventBody.ToArray()));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            catch (JsonException)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                _output.WriteLine(&quot;[&quot; + Encoding.UTF8.GetString(evnt.Data.EventBody.ToArray()) + &quot;] is probably not JSON&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return default(T);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Let&#x27;s talk through what happens in the test above:</p><ol><li>We read in Event Hub connection configuration for the test from environment variables. (These will be supplied by an Azure Pipeline that we will create shortly.)</li><li>We post a message to the Event Hub.</li><li>We read a message back from the Event Hub.</li><li>We confirm that the message we read back matches the one we posted.</li></ol><p>Now that we have our test, we want to be able to execute it. For that we need an Azure Pipeline!</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="azure-pipeline">Azure Pipeline<a aria-hidden="true" class="hash-link" href="#azure-pipeline" title="Direct link to heading">â€‹</a></h2><p>We&#x27;re going to add an <code>azure-pipelines.yml</code> file which Azure DevOps can use to power a pipeline:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yml"><pre tabindex="0" class="prism-code language-yml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">variables</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> eventHubNamespaceName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> evhns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">demo</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> eventHubName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> evh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">demo</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">pool</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">vmImage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Get Service Principal Id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(serviceConnection)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> bash</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> inlineScript</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">addSpnToEnvironment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        PRINCIPAL_ID=$(az ad sp show --id $servicePrincipalId --query objectId -o tsv)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        echo &quot;##vso[task.setvariable variable=PIPELINE_PRINCIPAL_ID;]$PRINCIPAL_ID&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> az bicep build </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">file infra/main.bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Compile Bicep to ARM&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureResourceManagerTemplateDeployment@3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DeployEventHubInfra</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy Event Hub infra</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">deploymentScope</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">azureResourceManagerConnection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(serviceConnection)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">subscriptionId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(subscriptionId)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Create Or Update Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(azureResourceGroup)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(location)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">templateLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Linked artifact</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">csmFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;infra/main.json&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># created by bash script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">overrideParameters</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">eventHubNamespaceName $(eventHubNamespaceName)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">eventHubName $(eventHubName)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">principalId $(PIPELINE_PRINCIPAL_ID)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">deploymentMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Incremental</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> UseDotNet@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Install .NET SDK 5.0.x&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">packageType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;sdk&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 5.0.x</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dotnet integration test</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(serviceConnection)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> pscore</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> inlineScript</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">addSpnToEnvironment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># allows access to service principal details in script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        cd $(Build.SourcesDirectory)/src/IntegrationTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        dotnet test</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>When the pipeline is run, it does the following:</p><ol><li>Gets the service principal id from the service connection.</li><li>Compiles our Bicep into an ARM template</li><li>Deploys the compiled ARM template to Azure</li><li>Installs the dotnet SDK</li><li>Uses the <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/azure-cli?view=azure-devops" target="_blank" rel="noopener noreferrer">Azure CLI task</a> which allows us to access service principal details in the pipeline to run our dotnet test.</li></ol><p>We&#x27;ll create a pipeline in Azure DevOps pointing to this file, and we&#x27;ll also create the variables that it depends upon:</p><ul><li><code>azureResourceGroup</code> - the name of your resource group in Azure where the app will be deployed</li><li><code>location</code> - where your app is deployed, eg <code>northeurope</code></li><li><code>serviceConnection</code> - the name of your AzureRM service connection in Azure DevOps</li><li><code>subscriptionId</code> - your Azure subscription id from the <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer">Azure Portal</a></li><li><code>tenantId</code> - the Azure tenant id from the <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer">Azure Portal</a></li></ul><h2 class="anchor anchorWithStickyNavbar_31ik" id="running-the-pipeline">Running the pipeline<a aria-hidden="true" class="hash-link" href="#running-the-pipeline" title="Direct link to heading">â€‹</a></h2><p>Now we&#x27;re ready to run our pipeline:</p><p><img alt="screenshot of pipeline running successfully" src="/assets/images/screenshot-azure-pipelines-tests-passing-83fbc25d889d3ef3f2af50edc01ed509.png"></p><p>Here we can see that the pipeline runs and the test passes. That means we&#x27;ve successfully provisioned the Event Hub and permissioned our pipeline to be able to access it using Azure RBAC role assignments. We then wrote a test which used the pipeline credentials to interact with the Event Hub. To see the repo that demostrates this, <a href="https://dev.azure.com/johnnyreilly/blog-demos/_git/permissioning-azure-pipelines-bicep-role-assignments" target="_blank" rel="noopener noreferrer">look here</a>.</p><p>Just to reiterate: we&#x27;ve demonstrated this approach using Event Hubs. This is a generally useful approach which can be applied to any Azure resources that support Azure RBAC Role Assignments.</p><p>Thanks to <a href="https://twitter.com/foldr" target="_blank" rel="noopener noreferrer">Jamie McCrindle</a> for helping out with permissioning the service connection / service principal. <a href="https://foldr.uk/rotating-azure-credentials-in-github-with-terraform" target="_blank" rel="noopener noreferrer">His post on rotating <code>AZURE_CREDENTIALS</code> in GitHub with Terraform</a> provides useful background for those who would like to do similar permissioning using Terraform.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/role-assignments">Role Assignments</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/bicep">Bicep</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure-dev-ops">Azure DevOps</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure-pipelines">Azure Pipelines</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Permissioning Azure Pipelines with Bicep and Azure RBAC Role Assignments" href="/2021/09/12/permissioning-azure-pipelines-bicep-role-assignments"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2021/08/19/bicep-syntax-highlighting-with-prismjs">Bicep: syntax highlighting with PrismJS (and Docusaurus)</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-08-19T00:00:00.000Z" itemprop="datePublished">August 19, 2021</time> Â· <!-- -->3 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/blog/2021-08-19-bicep-syntax-highlighting-with-prismjs/bicep-syntax-highlighting-with-prismjs.png"><div class="markdown" itemprop="articleBody"><p>Bicep is an amazing language, it&#x27;s also very new. If you want to write attractive code snippets about Bicep, you can by using PrismJS (and Docusaurus). This post shows you how.</p><p><img alt="title image reading &amp;quot;Publish Azure Static Web Apps with Bicep and Azure DevOps&amp;quot; and some Azure logos" src="/assets/images/bicep-syntax-highlighting-with-prismjs-b32630666b634e8da4c354198806679d.png"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="syntax-highlighting">Syntax highlighting<a aria-hidden="true" class="hash-link" href="#syntax-highlighting" title="Direct link to heading">â€‹</a></h2><p>I&#x27;ve been writing blog posts about Bicep for a little while. I was frustrated that the code snippets were entirely unhighlighted. I&#x27;m keen my posts are as readable as possible, and so I <a href="https://github.com/PrismJS/prism/pull/3027" target="_blank" rel="noopener noreferrer">looked into adding support to PrismJS</a> which is what <a href="https://docusaurus.io/" target="_blank" rel="noopener noreferrer">Docusaurus</a> uses to power syntax highlighting.</p><p>Whilst my regex fu is amateur at best, happily <a href="https://github.com/RunDevelopment" target="_blank" rel="noopener noreferrer">Michael Schmidt</a> of the PrismJS family is considerably better. He took the support I added and <a href="https://github.com/PrismJS/prism/pull/3028" target="_blank" rel="noopener noreferrer">made it much better</a>.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="docusaurus-meet-bicep">Docusaurus meet Bicep<a aria-hidden="true" class="hash-link" href="#docusaurus-meet-bicep" title="Direct link to heading">â€‹</a></h2><p>If you have any code snippets that start with three backticks and the word <code>bicep</code>...</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">```bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// code goes here...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>... then ideally you&#x27;d like to see some syntax highlighting in your post. Since Bicep isn&#x27;t &quot;in the box&quot; for Docusaurus you need to <a href="https://docusaurus.io/docs/next/markdown-features/code-blocks#supported-languages" target="_blank" rel="noopener noreferrer">explicitly opt into support like so:</a></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">    prism</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      additionalLanguages</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;powershell&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;csharp&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;docker&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;bicep&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Above you can see a snippet from my own <a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/blob/b2df93efb72adc32d9f45de4f727e890e59a4919/blog-website/docusaurus.config.js#L185" target="_blank" rel="noopener noreferrer"><code>docusaurus.config.js</code></a> which adds Bicep, alongside the other additional languages I use.</p><p>With this in place, you would typically get all the syntax highlighting support you need.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="early-adoption-workaround">Early adoption workaround<a aria-hidden="true" class="hash-link" href="#early-adoption-workaround" title="Direct link to heading">â€‹</a></h2><p>I&#x27;m writing this post before the latest version of PrismJS has shipped. As such, Bicep support isn&#x27;t available by default yet. But if you&#x27;re an early adopter, you can get support right now. The secret is adding a <code>resolutions</code> section to your <code>package.json</code> which points to the GitHub Repo <a href="https://github.com/PrismJS/prism" target="_blank" rel="noopener noreferrer">where Prism lives</a>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;resolutions&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;prismjs&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;PrismJS/prism&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This will mean that Yarn (if you&#x27;re using Docusaurus you&#x27;re probably using Yarn) pulls <code>prismjs</code> directly from GitHub, as demonstrated by the <code>yarn.lock</code> file:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">prismjs@PrismJS/prism, prismjs@^1.23.0:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  version &quot;1.24.1&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  resolved &quot;https://codeload.github.com/PrismJS/prism/tar.gz/59f449d33dc9fd19302f21aad95fc0b5028ac830&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="what-does-it-look-like">What does it look like?<a aria-hidden="true" class="hash-link" href="#what-does-it-look-like" title="Direct link to heading">â€‹</a></h2><p>Finally, let&#x27;s see if works. Here&#x27;s a Bicep code snippet that I borrowed from <a href="/2021/08/19/bicep-syntax-highlighting-with-prismjs">an earlier post</a>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">param repositoryUrl string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param repositoryBranch string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param location string = &#x27;westeurope&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param skuName string = &#x27;Free&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param skuTier string = &#x27;Free&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param appName string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource staticWebApp &#x27;Microsoft.Web/staticSites@2020-12-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: appName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: tagsObj</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name: skuName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    tier: skuTier</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // The provider, repositoryUrl and branch fields are required for successive deployments to succeed</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // for more details see: https://github.com/Azure/static-web-apps/issues/516</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    provider: &#x27;DevOps&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    repositoryUrl: repositoryUrl</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    branch: repositoryBranch</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    buildProperties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      skipGithubActionWorkflowGeneration: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output deployment_token string = listSecrets(staticWebApp.id, staticWebApp.apiVersion).properties.apiKey</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>As you can see, it&#x27;s delightfully highlighted by PrismJS. Enjoy!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/bicep">Bicep</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/prism-js">PrismJS</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Bicep: syntax highlighting with PrismJS (and Docusaurus)" href="/2021/08/19/bicep-syntax-highlighting-with-prismjs"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2021/08/15/bicep-azure-static-web-apps-azure-devops">Publish Azure Static Web Apps with Bicep and Azure DevOps</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-08-15T00:00:00.000Z" itemprop="datePublished">August 15, 2021</time> Â· <!-- -->5 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/blog/2021-08-15-bicep-azure-static-web-apps-azure-devops/title-image.png"><div class="markdown" itemprop="articleBody"><p>This post demonstrates how to deploy <a href="https://docs.microsoft.com/en-us/azure/static-web-apps/overview" target="_blank" rel="noopener noreferrer">Azure Static Web Apps</a> using Bicep and Azure DevOps. It includes a few workarounds for the <a href="https://github.com/Azure/static-web-apps/issues/516" target="_blank" rel="noopener noreferrer">&quot;Provider is invalid. Cannot change the Provider. Please detach your static site first if you wish to use to another deployment provider.&quot; issue</a>.</p><p><img alt="title image reading &amp;quot;Publish Azure Static Web Apps with Bicep and Azure DevOps&amp;quot; and some Azure logos" src="/assets/images/title-image-d24b3ab999e590da3ebe6fda7dc7c31c.png"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="bicep-template">Bicep template<a aria-hidden="true" class="hash-link" href="#bicep-template" title="Direct link to heading">â€‹</a></h2><p>The first thing we&#x27;re going to do is create a folder where our Bicep file for deploying our Azure Static Web App will live:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token function" style="color:rgb(130, 170, 255)">mkdir</span><span class="token plain"> infra/static-web-app -p</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Then we&#x27;ll create a <code>main.bicep</code> file:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">param repositoryUrl string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param repositoryBranch string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param location string = &#x27;westeurope&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param skuName string = &#x27;Free&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param skuTier string = &#x27;Free&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param appName string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource staticWebApp &#x27;Microsoft.Web/staticSites@2020-12-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: appName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name: skuName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    tier: skuTier</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // The provider, repositoryUrl and branch fields are required for successive deployments to succeed</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // for more details see: https://github.com/Azure/static-web-apps/issues/516</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    provider: &#x27;DevOps&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    repositoryUrl: repositoryUrl</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    branch: repositoryBranch</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    buildProperties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      skipGithubActionWorkflowGeneration: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output deployment_token string = listSecrets(staticWebApp.id, staticWebApp.apiVersion).properties.apiKey</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>There&#x27;s some things to draw attention to in the code above:</p><ol><li>The <code>provider</code>, <code>repositoryUrl</code> and <code>branch</code> fields are required for successive deployments to succeed. In our case we&#x27;re deploying via Azure DevOps and so our provider is <code>&#x27;DevOps&#x27;</code>. For more details, <a href="https://github.com/Azure/static-web-apps/issues/516" target="_blank" rel="noopener noreferrer">look at this issue</a>.</li><li>We&#x27;re creating a <code>deployment_token</code> which we&#x27;ll need in order that we can deploy into the Azure Static Web App resource.</li></ol><h2 class="anchor anchorWithStickyNavbar_31ik" id="static-web-app">Static Web App<a aria-hidden="true" class="hash-link" href="#static-web-app" title="Direct link to heading">â€‹</a></h2><p>In order that we can test out Azure Static Web Apps, what we need is a static web app. You could use pretty much anything here; we&#x27;re going to use Docusaurus. We&#x27;ll execute this single command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">npx @docusaurus/init@latest init static-web-app classic</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Which will scaffold a Docusaurus site in a folder named <code>static-web-app</code>. We don&#x27;t need to change it any further; let&#x27;s just see if we can deploy it.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="azure-pipeline">Azure Pipeline<a aria-hidden="true" class="hash-link" href="#azure-pipeline" title="Direct link to heading">â€‹</a></h2><p>We&#x27;re going to add an <code>azure-pipelines.yml</code> file which Azure DevOps can use to power a pipeline:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yml"><pre tabindex="0" class="prism-code language-yml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">trigger</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">pool</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">vmImage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">checkout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> self</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">submodules</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> az bicep build </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">file infra/static</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">web</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">app/main.bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Compile Bicep to ARM&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureResourceManagerTemplateDeployment@3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DeployStaticWebAppInfra</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy Static Web App infra</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">deploymentScope</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">azureResourceManagerConnection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(serviceConnection)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">subscriptionId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(subscriptionId)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Create Or Update Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(azureResourceGroup)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(location)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">templateLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Linked artifact</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">csmFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;infra/static-web-app/main.json&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># created by bash script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">overrideParameters</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">repositoryUrl $(repo)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">repositoryBranch $(Build.SourceBranchName)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">appName $(staticWebAppName)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">deploymentMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Incremental</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">deploymentOutputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> deploymentOutputs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> PowerShell@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;SetDeploymentOutputVariables&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Set Deployment Output Variables&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">targetType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> inline</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">script</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        $armOutputObj = &#x27;$(deploymentOutputs)&#x27; | ConvertFrom-Json</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        $armOutputObj.PSObject.Properties | ForEach-Object {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">          $keyname = $_.Name</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">          $value = $_.Value.value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Creates a standard pipeline variable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          Write</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">Output &quot;</span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">##vso[task.setvariable variable=$keyName;issecret=true]$value&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Display keys in pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">Write-Output &quot;output variable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $keyName&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">pwsh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureStaticWebApp@0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DeployStaticWebApp</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy Static Web App</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">app_location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;static-web-app&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># api_location: &#x27;api&#x27; # we don&#x27;t have an API</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">output_location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;build&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">azure_static_web_apps_api_token</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(deployment_token) </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># captured from deploymentOutputs</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>When the pipeline is run, it does the following:</p><ol><li>Compiles our Bicep into an ARM template</li><li>Deploys the compiled ARM template to Azure</li><li>Captures the deployment outputs (essentially the <code>deployment_token</code>) and converts them into variables to use in the pipeline</li><li>Deploys our Static Web App using the <code>deployment_token</code></li></ol><p>The pipeline depends upon a number of variables:</p><ul><li><code>azureResourceGroup</code> - the name of your resource group in Azure where the app will be deployed</li><li><code>location</code> - where your app is deployed, eg <code>northeurope</code></li><li><code>repo</code> - the URL of your repository in Azure DevOps, eg <a href="https://dev.azure.com/johnnyreilly/_git/azure-static-web-apps" target="_blank" rel="noopener noreferrer">https://dev.azure.com/johnnyreilly/_git/azure-static-web-apps</a></li><li><code>serviceConnection</code> - the name of your AzureRM service connection in Azure DevOps</li><li><code>staticWebAppName</code> - the name of your static web app, eg <code>azure-static-web-apps-johnnyreilly</code></li><li><code>subscriptionId</code> - your Azure subscription id from the <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer">Azure Portal</a></li></ul><p>A successful pipeline looks something like this:</p><p><img alt="Screenshot of successfully running Azure Pipeline" src="/assets/images/successful-azure-pipelines-run-screenshot-bf1d896067834091a095faf736f00cb7.png"></p><p>What you might notice is that the <code>AzureStaticWebApp</code> is itself installing and building our application. This is handled by <a href="https://github.com/Microsoft/Oryx" target="_blank" rel="noopener noreferrer">Microsoft Oryx</a>. The upshot of this is that we don&#x27;t need to manually run <code>npm install</code> and <code>npm build</code> ourselves; the <code>AzureStaticWebApp</code> task will take care of it for us.</p><p>Finally, let&#x27;s see if we&#x27;ve deployed something successfully...</p><p><img alt="Screenshot of deployed Azure Static Web App" src="/assets/images/deployed-azure-static-web-app-screenshot-1ebda27d7f0537e14647e234282d6930.png"></p><p>We have! It&#x27;s worth noting that you&#x27;ll likely want to give your Azure Static Web App a lovelier URL, and perhaps even put it behind Azure Front Door as well.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="provider-is-invalid-workaround-2"><code>Provider is invalid</code> workaround 2<a aria-hidden="true" class="hash-link" href="#provider-is-invalid-workaround-2" title="Direct link to heading">â€‹</a></h2><p><a href="https://www.linkedin.com/in/shaneneff/" target="_blank" rel="noopener noreferrer">Shane Neff</a> was attempting to follow the instructions in this post and encountered issues. He shared his struggles with me as he encountered the <a href="https://github.com/Azure/static-web-apps/issues/516" target="_blank" rel="noopener noreferrer">&quot;Provider is invalid. Cannot change the Provider. Please detach your static site first if you wish to use to another deployment provider.&quot; issue</a>.</p><p>He was good enough to share his solution as well, which is inserting this task at the start of the pipeline (before the <code>az bicep build</code> step):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yml"><pre tabindex="0" class="prism-code language-yml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;&lt;name of your service connection&gt;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;bash&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;inlineScript&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;az staticwebapp disconnect -n &lt;name of your app&gt;&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>I haven&#x27;t had the problems that Shane has had myself, but I wanted to share his fix for the people out there who almost certainly are bumping on this.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure-static-web-app">Azure Static Web App</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/bicep">Bicep</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure-dev-ops">Azure DevOps</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure-pipelines">Azure Pipelines</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Publish Azure Static Web Apps with Bicep and Azure DevOps" href="/2021/08/15/bicep-azure-static-web-apps-azure-devops"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2021/07/07/output-connection-strings-and-keys-from-azure-bicep">Output connection strings and keys from Azure Bicep</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-07-07T00:00:00.000Z" itemprop="datePublished">July 7, 2021</time> Â· <!-- -->7 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/blog/2021-07-07-output-connection-strings-and-keys-from-azure-bicep/title-image.jpg"><div class="markdown" itemprop="articleBody"><p>If we&#x27;re provisioning resources in Azure with Bicep, we may have a need to acquire the connection strings and keys of our newly deployed infrastructure. For example, the connection strings of an event hub or the access keys of a storage account. Perhaps we&#x27;d like to use them to run an end-to-end test, perhaps we&#x27;d like to store these secrets somewhere for later consumption. This post shows how to do that using Bicep and the <code>listKeys</code> helper. Optionally it shows how we could consume this in Azure Pipelines.</p><p>Please note that exporting keys / connection strings etc from Bicep / ARM templates is generally considered to be a less secure approach.  This is because these values will be visible inside the deployments section of the Azure Portal.  Anyone who has access to this will be able to see them. An alternative approach would be permissioning our pipeline to access the resources directly. You can read about that approach <a href="/2021/09/12/permissioning-azure-pipelines-bicep-role-assignments">here</a>.</p><p><img alt="image which contains the blog title" src="/assets/images/title-image-560e43b3f4b04cc9ba7d030395601c5e.jpg"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="event-hub-connection-string">Event Hub connection string<a aria-hidden="true" class="hash-link" href="#event-hub-connection-string" title="Direct link to heading">â€‹</a></h2><p>First of all, let&#x27;s provision an Azure Event Hub. This involves deploying an event hub namespace, an event hub in that namespace and an authorization rule. The following Bicep will do this for us:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">// Create an event hub namespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var eventHubNamespaceName = &#x27;evhns-demo&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHubNamespace &#x27;Microsoft.EventHub/namespaces@2021-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: eventHubNamespaceName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name: &#x27;Standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    tier: &#x27;Standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    capacity: 1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    zoneRedundant: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Create an event hub inside the namespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var eventHubName = &#x27;evh-demo&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHubNamespaceName_eventHubName &#x27;Microsoft.EventHub/namespaces/eventhubs@2021-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  parent: eventHubNamespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: eventHubName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    messageRetentionInDays: 7</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    partitionCount: 1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Grant Listen and Send on our event hub</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHubNamespaceName_eventHubName_ListenSend &#x27;Microsoft.EventHub/namespaces/eventhubs/authorizationRules@2021-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  parent: eventHubNamespaceName_eventHubName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: &#x27;ListenSend&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    rights: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      &#x27;Listen&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      &#x27;Send&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  dependsOn: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    eventHubNamespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>When this is deployed to Azure, it will result in creating something like this:</p><p><img alt="screenshot of event hub connection strings in the Azure Portal" src="/assets/images/event-hub-connection-string-2d44f1ac3d7999f12344c2d8865717b3.png"></p><p>As we can see, there are connection strings available which can be used to access the event hub. How do we get a connection string that we can play with? It&#x27;s easily achieved by appending the following to our Bicep:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">// Determine our connection string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var eventHubNamespaceConnectionString = listKeys(eventHubNamespaceName_eventHubName_ListenSend.id, eventHubNamespaceName_eventHubName_ListenSend.apiVersion).primaryConnectionString</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Output our variables</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output eventHubNamespaceConnectionString string = eventHubNamespaceConnectionString</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output eventHubName string = eventHubName</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>What we&#x27;re doing here is using the <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/bicep-functions-resource#list" target="_blank" rel="noopener noreferrer"><code>listKeys</code></a> helper on our authorization rule and retrieving the handy <code>primaryConnectionString</code>, which is then exposed as an output variable.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="storage-account-connection-string">Storage Account connection string<a aria-hidden="true" class="hash-link" href="#storage-account-connection-string" title="Direct link to heading">â€‹</a></h2><p>We&#x27;d like to obtain a connection string for a storage account also. Let&#x27;s put together a Bicep file that creates a storage account and a container therein. (Incidentally, it&#x27;s fairly common to have a storage account provisioned alongside an event hub to facilitate reading from an event hub.)</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">// Create a storage account</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var storageAccountName = &#x27;stdemo&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHubNamespaceName_storageAccount &#x27;Microsoft.Storage/storageAccounts@2021-02-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: storageAccountName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name: &#x27;Standard_LRS&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    tier: &#x27;Standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;StorageV2&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    networkAcls: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      bypass: &#x27;AzureServices&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      defaultAction: &#x27;Allow&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    accessTier: &#x27;Hot&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    allowBlobPublicAccess: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    minimumTlsVersion: &#x27;TLS1_2&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    allowSharedKeyAccess: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// create a container inside that storage account</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var blobContainerName = &#x27;test-container&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource storageAccountName_default_containerName &#x27;Microsoft.Storage/storageAccounts/blobServices/containers@2021-02-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: &#x27;${storageAccountName}/default/${blobContainerName}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  dependsOn: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    eventHubNamespaceName_storageAccount</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>When this is deployed to Azure, it will result in creating something like this:</p><p><img alt="screenshot of storage account access keys in the Azure Portal" src="/assets/images/storage-account-access-keys-038ca09af4f15ec365ed563b853ef1c7.png"></p><p>Again we can see, there are connection strings available in the Azure Portal, which can be used to access the storage account. However, things aren&#x27;t quite as simple as previously; in that there doesn&#x27;t seem to be a way to directly acquire a connection string. What we can do, is acquire a key; and construct ourselves a connection string with that. Here&#x27;s how:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">// Determine our connection string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var blobStorageConnectionString = &#x27;DefaultEndpointsProtocol=https;AccountName=${eventHubNamespaceName_storageAccount.name};EndpointSuffix=${environment().suffixes.storage};AccountKey=${listKeys(eventHubNamespaceName_storageAccount.id, eventHubNamespaceName_storageAccount.apiVersion).keys[0].value}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Output our variable</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output blobStorageConnectionString string = blobStorageConnectionString</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output blobContainerName string = blobContainerName</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If you just wanted to know how to acquire connection strings from Bicep then you can stop now; we&#x27;re done! But if you&#x27;re curious on how the Bicep might connect to <del>the shoulder</del> Azure Pipelines... Read on.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="from-bicep-to-azure-pipelines">From Bicep to Azure Pipelines<a aria-hidden="true" class="hash-link" href="#from-bicep-to-azure-pipelines" title="Direct link to heading">â€‹</a></h2><p>If we put together our snippets above into a single Bicep file it would look like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">// Create an event hub namespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var eventHubNamespaceName = &#x27;evhns-demo&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHubNamespace &#x27;Microsoft.EventHub/namespaces@2021-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: eventHubNamespaceName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name: &#x27;Standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    tier: &#x27;Standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    capacity: 1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    zoneRedundant: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Create an event hub inside the namespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var eventHubName = &#x27;evh-demo&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHubNamespaceName_eventHubName &#x27;Microsoft.EventHub/namespaces/eventhubs@2021-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  parent: eventHubNamespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: eventHubName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    messageRetentionInDays: 7</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    partitionCount: 1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Grant Listen and Send on our event hub</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHubNamespaceName_eventHubName_ListenSend &#x27;Microsoft.EventHub/namespaces/eventhubs/authorizationRules@2021-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  parent: eventHubNamespaceName_eventHubName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: &#x27;ListenSend&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    rights: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      &#x27;Listen&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      &#x27;Send&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  dependsOn: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    eventHubNamespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Create a storage account</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var storageAccountName = &#x27;stdemo&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHubNamespaceName_storageAccount &#x27;Microsoft.Storage/storageAccounts@2021-02-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: storageAccountName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name: &#x27;Standard_LRS&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    tier: &#x27;Standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;StorageV2&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    networkAcls: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      bypass: &#x27;AzureServices&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      defaultAction: &#x27;Allow&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    accessTier: &#x27;Hot&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    allowBlobPublicAccess: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    minimumTlsVersion: &#x27;TLS1_2&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    allowSharedKeyAccess: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// create a container inside that storage account</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var blobContainerName = &#x27;test-container&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource storageAccountName_default_containerName &#x27;Microsoft.Storage/storageAccounts/blobServices/containers@2021-02-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: &#x27;${storageAccountName}/default/${blobContainerName}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  dependsOn: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    eventHubNamespaceName_storageAccount</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Determine our connection strings</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var blobStorageConnectionString       = &#x27;DefaultEndpointsProtocol=https;AccountName=${eventHubNamespaceName_storageAccount.name};EndpointSuffix=${environment().suffixes.storage};AccountKey=${listKeys(eventHubNamespaceName_storageAccount.id, eventHubNamespaceName_storageAccount.apiVersion).keys[0].value}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var eventHubNamespaceConnectionString = listKeys(eventHubNamespaceName_eventHubName_ListenSend.id, eventHubNamespaceName_eventHubName_ListenSend.apiVersion).primaryConnectionString</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Output our variables</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output blobStorageConnectionString string = blobStorageConnectionString</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output blobContainerName string = blobContainerName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output eventHubNamespaceConnectionString string = eventHubNamespaceConnectionString</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output eventHubName string = eventHubName</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This might be consumed in an Azure Pipeline that looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yml"><pre tabindex="0" class="prism-code language-yml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> az bicep build </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">file infra/our</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">test</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">app/main.bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Compile Bicep to ARM&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureResourceManagerTemplateDeployment@3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DeploySharedInfra</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy Shared ARM Template</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">deploymentScope</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">azureResourceManagerConnection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> parameters.serviceConnection </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">subscriptionId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(subscriptionId)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Create Or Update Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(azureResourceGroup)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(location)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">templateLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Linked artifact</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">csmFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;infra/our-test-app/main.json&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># created by bash script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">deploymentMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Incremental</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">deploymentOutputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> deployOutputs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> PowerShell@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;SetOutputVariables&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Set Output Variables&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">targetType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> inline</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">script</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">      $armOutputObj = &#x27;$(deployOutputs)&#x27; | ConvertFrom-Json</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">      $armOutputObj.PSObject.Properties | ForEach-Object {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        $keyname = $_.Name</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        $value = $_.Value.value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Creates a standard pipeline variable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        Write</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">Output &quot;</span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">##vso[task.setvariable variable=$keyName;]$value&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Creates an output variable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        Write</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">Output &quot;</span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">##vso[task.setvariable variable=$keyName;issecret=true;isOutput=true]$value&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Display keys in pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">Write-Output &quot;output variable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $keyName&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">pwsh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Above we can see:</p><ul><li>the Bicep get compiled to ARM</li><li>the ARM is deployed to Azure, with <code>deploymentOutputs</code> being passed out at the end</li><li>the outputs are turned into secret output variables inside the pipeline (the names of which are printed to the console)</li></ul><p>With the above in place, we now have all of our variables in place; <code>blobStorageConnectionString</code>, <code>blobContainerName</code>, <code>eventHubNamespaceConnectionString</code> and <code>eventHubName</code>. These could now be consumed in whatever way is useful. Consider the following:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yml"><pre tabindex="0" class="prism-code language-yml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> UseDotNet@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Install .NET Core SDK 3.1.x&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">packageType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;sdk&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 3.1.x</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DotNetCoreCLI@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;dotnet run eventhub test&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;run&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;eventhub test --eventHubNamespaceConnectionString &quot;$(eventHubNamespaceConnectionString)&quot; --eventHubName &quot;$(eventHubName)&quot; --blobStorageConnectionString &quot;$(blobStorageConnectionString)&quot; --blobContainerName &quot;$(blobContainerName)&quot;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">workingDirectory</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;$(Build.SourcesDirectory)/OurTestApp&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Here we run a .NET application and pass it our connection strings. Please note, there&#x27;s nothing .NET specific about what we&#x27;re doing above - it could be any kind of application, bash script or similar that consumes our connection strings. The significant thing is that we can acquire connection strings in an automated fashion, for use in whichever manner pleases us.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/bicep">Bicep</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure">Azure</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/connection-string">connection string</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/keys">keys</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Output connection strings and keys from Azure Bicep" href="/2021/07/07/output-connection-strings-and-keys-from-azure-bicep"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2021/06/11/azure-functions-dotnet-5-query-params-di-bicep">Azure Functions and .NET 5: Query params, Dependency Injection, Bicep &amp; Build</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-06-11T00:00:00.000Z" itemprop="datePublished">June 11, 2021</time> Â· <!-- -->4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/blog/2021-06-11-azure-functions-dotnet-5-query-params-di-bicep/title-image.png"><div class="markdown" itemprop="articleBody"><p>The upgrade of Azure Functions from .NET Core 3.1 to .NET 5 is significant. There&#x27;s an excellent <a href="https://codetraveler.io/2021/05/28/creating-azure-functions-using-net-5/" target="_blank" rel="noopener noreferrer">guide</a> for the general steps required to perform the upgrade. However there&#x27;s a number of (unrelated) items which are not covered by that post:</p><ul><li>Query params</li><li>Dependency Injection</li><li>Bicep</li><li>Build</li></ul><p>This post will show how to tackle these.</p><p><img alt="title image showing name of post and the Azure Functions logo" src="/assets/images/title-image-c4f0d7e74861f2c25b98e4e2f12a0464.png"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="query-params">Query params<a aria-hidden="true" class="hash-link" href="#query-params" title="Direct link to heading">â€‹</a></h2><p>As part of the move to .NET 5 functions, we say goodbye to <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httprequest?view=aspnetcore-5.0" target="_blank" rel="noopener noreferrer"><code>HttpRequest</code></a> and hello to <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.functions.worker.http.httprequestdata?view=azure-dotnet" target="_blank" rel="noopener noreferrer"><code>HttpRequestData</code></a>. Now <code>HttpRequest</code> had a useful <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httprequest.query?view=aspnetcore-5.0#Microsoft_AspNetCore_Http_HttpRequest_Query" target="_blank" rel="noopener noreferrer"><code>Query</code></a> property which allowed for the simple extraction of query parameters like so.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">var from = req.Query[&quot;from&quot;]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>HttpRequestData</code> has no such property. However, it&#x27;s straightforward to make our own. It&#x27;s simply a matter of using <a href="https://docs.microsoft.com/en-us/dotnet/api/system.web.httputility.parsequerystring?view=net-5.0" target="_blank" rel="noopener noreferrer"><code>System.Web.HttpUtility.ParseQueryString</code></a> on <code>req.Url.Query</code> and using that:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">var query = System.Web.HttpUtility.ParseQueryString(req.Url.Query);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var from = query[&quot;from&quot;]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="dependency-injection-local-development-and-azure-application-settings">Dependency Injection, local development and Azure Application Settings<a aria-hidden="true" class="hash-link" href="#dependency-injection-local-development-and-azure-application-settings" title="Direct link to heading">â€‹</a></h2><p>Dependency Injection is a much more familiar shape in .NET 5 if you&#x27;re familiar with .NET Core web apps. Once again we have a <code>Program.cs</code> file. To get the configuration built in such a way to support both local development and when deployed to Azure, there&#x27;s a few things to do. When deployed to Azure you&#x27;ll likely want to read from Azure Application Settings:</p><p><img alt="screenshot of Azure Application Settings" src="/assets/images/application-settings-ced1eaae9f8e34fe22390d59949bfe97.png"></p><p>To tackle both of these, you&#x27;ll want to use <code>AddJsonFile</code> and <code>AddEnvironmentVariables</code> in <code>ConfigureAppConfiguration</code>. A final <code>Program.cs</code> might look something like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Threading.Tasks;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.Configuration;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.Hosting;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace MyApp</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class Program</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static Task Main(string[] args)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var host = new HostBuilder()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .ConfigureAppConfiguration(configurationBuilder =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    configurationBuilder</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        .AddCommandLine(args)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        // below is for local development</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        .AddJsonFile(&quot;local.settings.json&quot;, optional: true, reloadOnChange: true)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        // below is what you need to read Application Settings in Azure</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        .AddEnvironmentVariables()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                )</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .ConfigureFunctionsWorkerDefaults()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .ConfigureServices(services =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    services.AddLogging();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    services.AddHttpClient();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                })</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .Build();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return host.RunAsync();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>With this approach in place, when the application runs, it should construct a configuration driven by all the providers required to run our application.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="bicep">Bicep<a aria-hidden="true" class="hash-link" href="#bicep" title="Direct link to heading">â€‹</a></h2><p>When it comes to deploying to Azure via <a href="https://github.com/Azure/bicep" target="_blank" rel="noopener noreferrer">Bicep</a>, there&#x27;s some small tweaks required:</p><ul><li><code>appSettings.FUNCTIONS_WORKER_RUNTIME</code> becomes <code>dotnet-isolated</code></li><li><code>linuxFxVersion</code> becomes <code>DOTNET-ISOLATED|5.0</code></li></ul><p>Applied to the resource itself the diff looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly diff"><pre tabindex="0" class="prism-code language-diff codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">resource functionAppName_resource &#x27;Microsoft.Web/sites@2018-11-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> name: functionAppName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> tags: tags_var</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> kind: &#x27;functionapp,linux&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> identity: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   type: &#x27;SystemAssigned&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   serverFarmId: appServicePlanName_resource.id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   siteConfig: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     http20Enabled: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     remoteDebuggingEnabled: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     minTlsVersion: &#x27;1.2&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     appSettings: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">         name: &#x27;FUNCTIONS_EXTENSION_VERSION&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">         value: &#x27;~3&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">         name: &#x27;FUNCTIONS_WORKER_RUNTIME&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56);font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56);font-style:italic">          value: &#x27;dotnet&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">          value: &#x27;dotnet-isolated&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">         name: &#x27;AzureWebJobsStorage&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">         value: &#x27;DefaultEndpointsProtocol=https;AccountName=${storageAccountName};AccountKey=${listKeys(resourceId(&#x27;Microsoft.Storage/storageAccounts&#x27;, storageAccountName), &#x27;2019-06-01&#x27;).keys[0].value};EndpointSuffix=${environment().suffixes.storage}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     connectionStrings: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">         name: &#x27;TableStorageConnectionString&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">         connectionString: &#x27;DefaultEndpointsProtocol=https;AccountName=${storageAccountName};AccountKey=${listKeys(resourceId(&#x27;Microsoft.Storage/storageAccounts&#x27;, storageAccountName), &#x27;2019-06-01&#x27;).keys[0].value};EndpointSuffix=${environment().suffixes.storage}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56);font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56);font-style:italic">      linuxFxVersion: &#x27;DOTNETCORE|LTS&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">      linuxFxVersion: &#x27;DOTNET-ISOLATED|5.0&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     ftpsState: &#x27;Disabled&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     managedServiceIdentityId: 1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   clientAffinityEnabled: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   httpsOnly: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="building-net-5-functions">Building .NET 5 functions<a aria-hidden="true" class="hash-link" href="#building-net-5-functions" title="Direct link to heading">â€‹</a></h2><p>Before signing off, there&#x27;s one more thing to slip in. When attempting to build .NET 5 Azure Functions with the .NET SDK <em>alone</em>, you&#x27;ll encounter this error:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">The framework &#x27;Microsoft.NETCore.App&#x27;, version &#x27;3.1.0&#x27; was not found.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Docs on this seem to be pretty short. The closest I came to docs was <a href="https://stackoverflow.com/questions/66938752/net-5-the-framework-microsoft-netcore-app-version-3-1-0-was-not-found/66938753#66938753" target="_blank" rel="noopener noreferrer">this comment on Stack Overflow</a>:</p><blockquote><p>To build .NET 5 functions, the .NET Core 3 SDK is required. So this must be installed alongside the 5.0.x sdk.</p></blockquote><p>So with Azure Pipelines you might have have something that looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yml"><pre tabindex="0" class="prism-code language-yml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">stages</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">stage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> build</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> build</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">pool</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">vmImage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;ubuntu-latest&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> BuildAndTest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Build and Test&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># we need .NET Core SDK 3.1 too!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> UseDotNet@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Install .NET Core SDK 3.1&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">packageType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;sdk&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 3.1.x</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> UseDotNet@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Install .NET SDK 5.0&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">packageType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;sdk&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 5.0.x</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DotNetCoreCLI@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;function app test&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> test</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DotNetCoreCLI@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;function app build&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> build</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;--configuration Release --output $(Build.ArtifactStagingDirectory)/MyApp&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DotNetCoreCLI@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;function app publish&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> publish</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;--configuration Release --output $(Build.ArtifactStagingDirectory)/MyApp /p:SourceRevisionId=$(Build.SourceVersion)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">publishWebProjects</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">modifyOutputPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">zipAfterPublish</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">publish</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(Build.ArtifactStagingDirectory)/MyApp</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">artifact</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> functionapp</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Have fun building .NET 5 functions!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure-functions">Azure Functions</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/net-5">.NET 5</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/querystring">querystring</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/query-params">query params</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/dependency-injection">dependency injection</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/bicep">Bicep</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Azure Functions and .NET 5: Query params, Dependency Injection, Bicep &amp; Build" href="/2021/06/11/azure-functions-dotnet-5-query-params-di-bicep"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2021/04/10/hello-world-bicep">Hello World Bicep</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-04-10T00:00:00.000Z" itemprop="datePublished">April 10, 2021</time> Â· <!-- -->3 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/blog/2021-04-10-hello-world-bicep/hello-world-bicep.png"><div class="markdown" itemprop="articleBody"><p>Bicep makes Azure Resource Management a great deal simpler than ARM templates. The selling point here is grokkability. This post takes a look at the <a href="https://github.com/Azure/bicep/pull/2011" target="_blank" rel="noopener noreferrer">&quot;Hello World&quot; example recently added to the Bicep repo</a> to appreciate quite what a difference it makes.</p><p><img alt="hello world bicep" src="/assets/images/hello-world-bicep-91a0d8f9326169e5272b1f1eb7dbdbee.png"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="more-than-configuration">More than configuration<a aria-hidden="true" class="hash-link" href="#more-than-configuration" title="Direct link to heading">â€‹</a></h2><p>The <a href="https://github.com/Azure/bicep/tree/187d4d2047dc83c69695ba79761f552bcb00c319/docs/examples/000/01-hello-world" target="_blank" rel="noopener noreferrer">&quot;Hello World&quot;</a> added to the Bicep repo by <a href="https://github.com/ChristopherGLewis" target="_blank" rel="noopener noreferrer">Chris Lewis</a> illustrates the simplest usage of Bicep:</p><blockquote><p>This bicep file takes a <code>yourName</code> parameter and adds that to a <code>hello</code> variable and returns the concatenated string as an ARM output.</p></blockquote><p>This is, when you consider it, the very essence of a computer program. Taking an input, doing some computation and providing an output. When I think about ARM templates, (and because Bicep is transpiled into ARM templates I mentally bracket the two together) I tend to think about resources being deployed. I focus on <em>configuration</em>, not <em>computation</em></p><p>This is an imperfect mental model. ARM templates can do so much more than deploy by slinging strings and numbers. Thanks to the wealth of <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/template-functions" target="_blank" rel="noopener noreferrer">template functions</a> that exist they have much more power. They can do computation.</p><p>The Hello World example focuses just on computation.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="from-terse-to-verbose">From terse to verbose<a aria-hidden="true" class="hash-link" href="#from-terse-to-verbose" title="Direct link to heading">â€‹</a></h2><p>The Hello World example is made up of two significant files:</p><ol><li><code>main.bicep</code> - the bicep code</li><li><code>main.json</code> - the ARM template compiled from the Bicep file</li></ol><p>The <a href="https://github.com/Azure/bicep/blob/187d4d2047dc83c69695ba79761f552bcb00c319/docs/examples/000/01-hello-world/main.bicep" target="_blank" rel="noopener noreferrer"><code>main.bicep</code></a> file amounts to 3 lines of code (I have omitted the comment line):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">param yourName string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var hello = &#x27;Hello World! - Hi&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output helloWorld string = &#x27;${hello} ${yourName}&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>the first line takes the <em>input</em> of <code>yourName</code></li><li>the second line declares a <code>hello</code> variable</li><li>the third line <em>computes</em> the new value of <code>helloWorld</code> based upon <code>hello</code> and <code>yourName</code>, then passes it as <em>output</em></li></ul><p>Gosh is it ever simple. It&#x27;s easy to read and it&#x27;s simple to understand. Even if you don&#x27;t know Bicep, if you&#x27;ve experience in another language you can likely guess what&#x27;s happening.</p><p>Let&#x27;s compare this with the <a href="https://github.com/Azure/bicep/blob/187d4d2047dc83c69695ba79761f552bcb00c319/docs/examples/000/01-hello-world/main.json" target="_blank" rel="noopener noreferrer"><code>main.json</code></a> that <code>main.bicep</code> is transpiled into:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;$schema&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;contentVersion&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;1.0.0.0&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;metadata&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;_generator&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;name&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;bicep&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;version&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;dev&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;templateHash&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;6989941473549654446&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;parameters&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;yourName&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;string&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;functions&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;variables&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;hello&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Hello World! - Hi&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;resources&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;outputs&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;helloWorld&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;string&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;[format(&#x27;{0} {1}&#x27;, variables(&#x27;hello&#x27;), parameters(&#x27;yourName&#x27;))]&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The above ARM template expresses exactly the same thing as the Bicep alternative. But that 3 lines of logic has become 27 lines of JSON. We&#x27;ve lost something in the transition. Intent is no longer clear. We&#x27;ve gone from something easy to reason about, to something that is hard to reason about. You need to think a lot less to write the Bicep alternative and that&#x27;s a <em>good</em> thing.</p><p>I was chatting to someone recently who expressed it well by saying:</p><blockquote><p>ARM is the format that the resource providers understand, so really itâ€™s the Azure equivalent of Assembler â€“ and I donâ€™t know anyone who enjoys coding in Assembler.</p></blockquote><p>This is a great example of the value that Bicep provides. If you&#x27;d like to play with the Hello World a little, why not <a href="https://aka.ms/bicepdemo#eJzT1w9OzC3ISVXISM3JyVcozy/KSeEqSCxKzFWozC8t8kvMTVUoLinKzEvnKkssgqqyVVD3ADPCQcoVFXQVPDLVubjyS0sKSksgasAyUJ0g9SrVYOFaBZVqmLm16gCvlitr" target="_blank" rel="noopener noreferrer">take it for a spin in the Bicep playground</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/bicep">Bicep</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/arm-templates">ARM templates</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Hello World Bicep" href="/2021/04/10/hello-world-bicep"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2021/03/23/bicep-meet-azure-pipelines-2">Bicep meet Azure Pipelines 2</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-03-23T00:00:00.000Z" itemprop="datePublished">March 23, 2021</time> Â· <!-- -->2 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/blog/2021-03-23-bicep-meet-azure-pipelines-2/bicep-meet-azure-pipelines.png"><div class="markdown" itemprop="articleBody"><p><a href="/2021/03/20/bicep-meet-azure-pipelines">Last time</a> I wrote about how to use the Azure CLI to run Bicep within the context of an Azure Pipeline. The solution was relatively straightforward, and involved using <code>az deployment group create</code> in a task. There&#x27;s an easier way.</p><p><img alt="Bicep meet Azure Pipelines" src="/assets/images/bicep-meet-azure-pipelines-cfcdd6693ae17634089935e5cb24c972.png"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="the-easier-way">The easier way<a aria-hidden="true" class="hash-link" href="#the-easier-way" title="Direct link to heading">â€‹</a></h2><p>The target reader of the previous post was someone who was already using <code>AzureResourceManagerTemplateDeployment@3</code> in an Azure Pipeline to deploy an ARM template. Rather than replacing your existing <code>AzureResourceManagerTemplateDeployment@3</code> tasks, all you need do is insert a prior <code>bash</code> step that compiles the Bicep to ARM, which your existing template can then process. It looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yml"><pre tabindex="0" class="prism-code language-yml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> az bicep build </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">file infra/app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service/azuredeploy.bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Compile Bicep to ARM&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This will take your Bicep template of <code>azuredeploy.bicep</code>, transpile it into an ARM template named <code>azuredeploy.json</code> which a subsequent <code>AzureResourceManagerTemplateDeployment@3</code> task can process. Since this is just exercising the Azure CLI, using <code>bash</code> is not required; powershell etc would also be fine; it&#x27;s just required that the Azure CLI is available in a pipeline.</p><p>In fact this simple task could even be a one-liner if you didn&#x27;t fancy using the <code>displayName</code>. (Though I say keep it; optimising for readability is generally a good shout.) A full pipeline could look like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yml"><pre tabindex="0" class="prism-code language-yml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> az bicep build </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">file infra/app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service/azuredeploy.bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Compile Bicep to ARM&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureResourceManagerTemplateDeployment@3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Deploy Hello Azure ARM&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">azureResourceManagerConnection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;$(azureSubscription)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Create Or Update Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;$(resourceGroupName)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;North Europe&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">templateLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Linked artifact</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">csmFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;infra/app-service/azuredeploy.json&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># created by bash script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">csmParametersFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;infra/app-service/azuredeploy.parameters.json&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">deploymentMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Incremental</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">deploymentOutputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> resourceGroupDeploymentOutputs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">overrideParameters</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">applicationName $(Build.Repository.Name)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">pwsh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">    $outputs = ConvertFrom-Json &#x27;$(resourceGroupDeploymentOutputs)&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">    foreach ($output in $outputs.PSObject.Properties) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        Write-Host &quot;##vso[task.setvariable variable=RGDO_$($output.Name)]$($output.Value.value)&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">    }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Turn ARM outputs into variables&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>And when it&#x27;s run, it may result in something along these lines:</p><p><img alt="Bicep in an Azure Pipeline" src="/assets/images/azure-pipeline-with-bicep-30469eb1b11c83b0402a81e7ccbee5e2.png"></p><p>So if you want to get using Bicep right now with minimal effort, this an on ramp that could work for you! Props to <a href="https://twitter.com/foldr" target="_blank" rel="noopener noreferrer">Jamie McCrindle</a> for suggesting this.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/bicep">Bicep</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/arm-templates">ARM templates</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure-pipelines">Azure Pipelines</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure-cli">Azure CLI</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Bicep meet Azure Pipelines 2" href="/2021/03/23/bicep-meet-azure-pipelines-2"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2021/03/20/bicep-meet-azure-pipelines">Bicep meet Azure Pipelines</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-03-20T00:00:00.000Z" itemprop="datePublished">March 20, 2021</time> Â· <!-- -->5 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/blog/2021-03-20-bicep-meet-azure-pipelines/bicep-meet-azure-pipelines.png"><div class="markdown" itemprop="articleBody"><p><a href="https://github.com/Azure/bicep" target="_blank" rel="noopener noreferrer">Bicep</a> is a terser and more readable alternative language to ARM templates. Running ARM templates in Azure Pipelines is straightforward. However, there isn&#x27;t yet a first class experience for running Bicep in Azure Pipelines. This post demonstrates an approach that can be used until a Bicep task is available.</p><p><img alt="Bicep meet Azure Pipelines" src="/assets/images/bicep-meet-azure-pipelines-cfcdd6693ae17634089935e5cb24c972.png"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="bicep-mostly-armless">Bicep: mostly ARMless<a aria-hidden="true" class="hash-link" href="#bicep-mostly-armless" title="Direct link to heading">â€‹</a></h2><p>If you&#x27;ve been working with Azure and infrastructure as code, you&#x27;ll likely have encountered <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview" target="_blank" rel="noopener noreferrer">ARM templates</a>. They&#x27;re a domain specific language that lives inside JSON, used to define the infrastructure that is deployed to Azure; App Services, Key Vaults and the like.</p><p>ARM templates are quite verbose and not the easiest thing to read. This is a consequence of being effectively a language nestled inside another language. Bicep is an alternative language which is far more readable. Bicep transpiles down to ARM templates, in the same way that TypeScript transpiles down to JavaScript.</p><p>Bicep is quite new, but already it enjoys feature parity with ARM templates (as of <a href="https://github.com/Azure/bicep/releases/tag/v0.3.1" target="_blank" rel="noopener noreferrer">v0.3</a>) and ships as part of the <a href="https://github.com/MicrosoftDocs/azure-docs-cli/blob/master/docs-ref-conceptual/release-notes-azure-cli.md#arm-1" target="_blank" rel="noopener noreferrer">Azure CLI</a>. However, as Bicep is new, it doesn&#x27;t yet have a dedicated Azure Pipelines task for deployment. This should exist in future, perhaps as soon as the <a href="https://github.com/Azure/bicep/issues/1341" target="_blank" rel="noopener noreferrer">v0.4 release</a>. In the meantime there&#x27;s an alternative way to achieve this which we&#x27;ll go through.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="app-service-with-bicep">App Service with Bicep<a aria-hidden="true" class="hash-link" href="#app-service-with-bicep" title="Direct link to heading">â€‹</a></h2><p>Let&#x27;s take a simple Bicep file, <code>azuredeploy.bicep</code>, which is designed to deploy an App Service resource to Azure. It looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Tags that our resources need&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param tags object = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  costCenter: &#x27;todo: replace&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  environment: &#x27;todo: replace&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  application: &#x27;todo: replace with app name&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  description: &#x27;todo: replace&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  managedBy: &#x27;ARM&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@minLength(2)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Base name of the resource such as web app name and app service plan&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param applicationName string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Location for all resources.&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param location string = resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;The SKU of App Service Plan&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param sku string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var appServicePlanName_var = &#x27;plan-${applicationName}-${tags.environment}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var linuxFxVersion = &#x27;DOTNETCORE|5.0&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var fullApplicationName_var = &#x27;app-${applicationName}-${uniqueString(applicationName)}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource appServicePlanName &#x27;Microsoft.Web/serverfarms@2019-08-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: appServicePlanName_var</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name: sku</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;linux&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    CostCenter: tags.costCenter</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Environment: tags.environment</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Description: tags.description</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ManagedBy: tags.managedBy</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    reserved: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource fullApplicationName &#x27;Microsoft.Web/sites@2018-11-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: fullApplicationName_var</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;app&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    CostCenter: tags.costCenter</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Environment: tags.environment</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Description: tags.description</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ManagedBy: tags.managedBy</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    serverFarmId: appServicePlanName.id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    clientAffinityEnabled: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    siteConfig: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      appSettings: []</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      linuxFxVersion: linuxFxVersion</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      alwaysOn: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ftpsState: &#x27;Disabled&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      http20Enabled: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      minTlsVersion: &#x27;1.2&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      remoteDebuggingEnabled: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    httpsOnly: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  identity: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    type: &#x27;SystemAssigned&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output fullApplicationName string = fullApplicationName_var</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>When transpiled down to an ARM template, this Bicep file more than doubles in size:</p><ul><li><code>azuredeploy.bicep</code> - 1782 bytes</li><li><code>azuredeploy.json</code> - 3863 bytes</li></ul><p>This tells you something of the advantage of Bicep. The template comes with an associated <code>azuredeploy.parameters.json</code> file:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;$schema&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;contentVersion&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;1.0.0.0&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;parameters&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;tags&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;costCenter&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;8888&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;environment&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;stg&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;application&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;hello-azure&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;description&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;App Service for hello-azure&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;managedBy&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;ARM&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;sku&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;B1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>It&#x27;s worth remembering that you can use the same parameters files with Bicep that you can use with ARM templates. This is great for minimising friction when it comes to migrating.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="bicep-in-azure-pipelinesyml">Bicep in <code>azure-pipelines.yml</code><a aria-hidden="true" class="hash-link" href="#bicep-in-azure-pipelinesyml" title="Direct link to heading">â€‹</a></h2><p>Now we have our Bicep file, we want to execute it from the context of an Azure Pipeline. If we were working directly with the ARM template we&#x27;d likely have something like this in place:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yml"><pre tabindex="0" class="prism-code language-yml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureResourceManagerTemplateDeployment@3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Deploy Hello Azure ARM&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">azureResourceManagerConnection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;$(azureSubscription)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Create Or Update Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;$(resourceGroupName)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;North Europe&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">templateLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Linked artifact</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">csmFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;infra/app-service/azuredeploy.json&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">csmParametersFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;infra/app-service/azuredeploy.parameters.json&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">deploymentMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Incremental</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">deploymentOutputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> resourceGroupDeploymentOutputs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">overrideParameters</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">applicationName $(Build.Repository.Name)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">pwsh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">    $outputs = ConvertFrom-Json &#x27;$(resourceGroupDeploymentOutputs)&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">    foreach ($output in $outputs.PSObject.Properties) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        Write-Host &quot;##vso[task.setvariable variable=RGDO_$($output.Name)]$($output.Value.value)&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">    }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Turn ARM outputs into variables&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>There&#x27;s two tasks above. The first is the native task for ARM deployments which takes our ARM template and our parameters and deploys them. The second task takes the output variables from the first task and converts them into Azure Pipeline variables such that they can be referenced later in the pipeline. In this case this variablifies our <code>fullApplicationName</code> output.</p><p>There is, as yet, no <code>BicepTemplateDeployment@1</code>. <a href="https://github.com/Azure/bicep/issues/1341" target="_blank" rel="noopener noreferrer">Though it&#x27;s coming</a>. In the meantime, the marvellous <a href="https://twitter.com/adotfrank" target="_blank" rel="noopener noreferrer">Alex Frankel</a> <a href="https://github.com/Azure/bicep/issues/1341#issuecomment-802010110" target="_blank" rel="noopener noreferrer">advised</a>:</p><blockquote><p>I&#x27;d recommend using the <a href="https://docs.microsoft.com/azure/devops/pipelines/tasks/deploy/azure-cli?view=azure-devops" target="_blank" rel="noopener noreferrer">Azure CLI task</a> to deploy. As long as that task is updated to Az CLI version 2.20 or later, it will automatically install the bicep CLI when calling <code>az deployment group create -f main.bicep</code>.</p></blockquote><p>Let&#x27;s give it a go!</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yml"><pre tabindex="0" class="prism-code language-yml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Deploy Hello Azure Bicep&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;$(azureSubscription)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> bash</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> inlineScript</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">      az --version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      echo &quot;az deployment group create </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">resource</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">group &#x27;$(resourceGroupName)&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">name appservicedeploy&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      az deployment group create </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">resource</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">group &#x27;$(resourceGroupName)&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">name appservicedeploy \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">template</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">file infra/app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service/azuredeploy.bicep \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">parameters infra/app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service/azuredeploy.parameters.json \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">parameters applicationName=&#x27;$(Build.Repository.Name)&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      echo &quot;az deployment group show </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">resource</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">group &#x27;$(resourceGroupName)&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">name appservicedeploy&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      deploymentoutputs=$(az deployment group show </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">resource</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">group &#x27;$(resourceGroupName)&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">name appservicedeploy \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">query properties.outputs)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      echo &#x27;convert outputs to variables&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      echo $deploymentoutputs </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> jq </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">c &#x27;. </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> to_entries</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">.key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> .value.value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        while IFS=$&quot;\n&quot; read </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">r c; do</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          outputname=$(echo &quot;$c&quot; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> jq </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">r &#x27;.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          outputvalue=$(echo &quot;$c&quot; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> jq </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">r &#x27;.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          echo &quot;setting variable RGDO_$outputname=$outputvalue&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          echo &quot;</span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">##vso[task.setvariable variable=RGDO_$outputname]$outputvalue&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        done</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The above is just a single Azure CLI task (as advised). It invokes <code>az deployment group create</code> passing the relevant parameters. It then acquires the output properties using <code>az deployment group show</code>. Finally it once again converts these outputs to Azure Pipeline variables with some <a href="https://stedolan.github.io/jq/" target="_blank" rel="noopener noreferrer"><code>jq</code></a> smarts.</p><p>This works right now, and running it results in something like the output below. So if you&#x27;re excited about Bicep and don&#x27;t want to wait for 0.4 to start moving on this, then this can get you going. To track the progress of the custom task, <a href="https://github.com/Azure/bicep/issues/1341" target="_blank" rel="noopener noreferrer">keep an eye on this issue</a>.</p><p><img alt="Bicep in an Azure Pipeline" src="/assets/images/bicep-in-a-pipeline-626bfeeb531b0312a2840c4a38b9545e.png"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="update-an-even-simpler-alternative">Update: an even simpler alternative<a aria-hidden="true" class="hash-link" href="#update-an-even-simpler-alternative" title="Direct link to heading">â€‹</a></h2><p>There is even a simpler way to do this which I discovered subsequent to writing this. <a href="/2021/03/23/bicep-meet-azure-pipelines-2">Have a read</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/bicep">Bicep</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/arm-templates">ARM templates</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure-pipelines">Azure Pipelines</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure-cli">Azure CLI</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Bicep meet Azure Pipelines" href="/2021/03/20/bicep-meet-azure-pipelines"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.4bb9d4be.js"></script>
<script src="/assets/js/main.14ca547e.js"></script>
</body>
</html>