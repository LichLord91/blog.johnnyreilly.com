<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=297675200"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","297675200",{})</script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#3578e5">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">11 posts tagged with &quot;Bicep&quot; | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="11 posts tagged with &quot;Bicep&quot; | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/tags/bicep"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-react-helmet="true" name="robots" content="max-image-preview:large"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/tags/bicep"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/bicep" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/bicep" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.85320736.css">
<link rel="preload" href="/assets/js/runtime~main.a83f38a5.js" as="script">
<link rel="preload" href="/assets/js/main.e22f0193.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://polywork.johnnyreilly.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Polywork<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_q+wC thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_9G5K margin-bottom--md">Recent posts</div><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/2021/12/29/preload-fonts-with-docusaurus">Preload fonts with Docusaurus</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/2021/12/28/azure-cli-show-query-output-properties">Query deployment outputs with the Azure CLI</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/2021/12/27/azure-container-apps-build-and-deploy-with-bicep-and-github-actions">Azure Container Apps: build and deploy with Bicep and GitHub Actions</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/2021/12/19/azure-container-apps-bicep-and-github-actions">Azure Container Apps, Bicep and GitHub Actions</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/2021/12/12/open-graph-sharing-previews-guide">Open Graph: a guide to sharable social media previews</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>11 posts tagged with &quot;Bicep&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/2021/12/27/azure-container-apps-build-and-deploy-with-bicep-and-github-actions">Azure Container Apps: build and deploy with Bicep and GitHub Actions</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-12-27T00:00:00.000Z" itemprop="datePublished">December 27, 2021</time> Â· <!-- -->14 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/assets/images/title-image-3da5757ae1c7fd02de2618a79f791be9.png"><div class="markdown" itemprop="articleBody"><p>This post shows how to build and deploy a simple web application to Azure Container Apps using Bicep and GitHub Actions. This includes the configuration and deployment of secrets.</p><p>This post follows on from the <a href="/2021/12/19/azure-container-apps-bicep-and-github-actions">previous post</a> which deployed infrastructure and a &quot;hello world&quot; container, this time introducing the building of an image and storing it in the <a href="https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry" target="_blank" rel="noopener noreferrer">GitHub container registry</a> so it can be deployed.</p><p><img alt="title image reading &amp;quot;Azure Container Apps: build and deploy with Bicep and GitHub Actions&amp;quot; with the Bicep, Azure Container Apps and GitHub Actions logos" src="/assets/images/title-image-3da5757ae1c7fd02de2618a79f791be9.png"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="the-containerised-convent">The containerised convent<a class="hash-link" href="#the-containerised-convent" title="Direct link to heading">â€‹</a></h2><p>I learn the most about a technology when I&#x27;m using it to build something. It so happens that I have an aunt that&#x27;s a nun, and long ago she persuaded me to build her convent a website. I&#x27;m a good nephew and I complied. Since that time I&#x27;ve been merrily overengineering it for fun and non-profit.</p><p>My aunts website is a pretty vanilla node app. Significantly it is already containerised and runs on <a href="https://azure.microsoft.com/en-gb/services/app-service/containers/" target="_blank" rel="noopener noreferrer">Azure App Service Web App for Containers</a>. Given it lives in the context of a container, this makes it a great candidate for porting to Azure Container Apps.</p><p>So that&#x27;s what we&#x27;ll do in this post. But where I&#x27;m building and deploying my aunt&#x27;s container, you could equally be substituting your own; with some minimal changes.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="bicep">Bicep<a class="hash-link" href="#bicep" title="Direct link to heading">â€‹</a></h2><p>Let&#x27;s begin with the Bicep required to deploy our Azure Container App.</p><p>In our repository we&#x27;ll create an <code>infra</code> directory, into which we&#x27;ll place a <code>main.bicep</code> file which will contain our Bicep template:</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">param nodeImage string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param nodePort int</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param nodeIsExternalIngress bool</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param containerRegistry string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param containerRegistryUsername string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@secure()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param containerRegistryPassword string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param tags object</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@secure()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param APPSETTINGS_API_KEY string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param APPSETTINGS_DOMAIN string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param APPSETTINGS_FROM_EMAIL string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param APPSETTINGS_RECIPIENT_EMAIL string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var location = resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var environmentName = &#x27;env-${uniqueString(resourceGroup().id)}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var minReplicas = 0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var nodeServiceAppName = &#x27;node-app&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var workspaceName = &#x27;${nodeServiceAppName}-log-analytics&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var appInsightsName = &#x27;${nodeServiceAppName}-app-insights&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var containerRegistryPasswordRef = &#x27;container-registry-password&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var mailgunApiKeyRef = &#x27;mailgun-api-key&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource workspace &#x27;Microsoft.OperationalInsights/workspaces@2020-08-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: workspaceName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: tags</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      name: &#x27;PerGB2018&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    retentionInDays: 30</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    workspaceCapping: {}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource appInsights &#x27;Microsoft.Insights/components@2020-02-02-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: appInsightsName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: tags</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;web&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Application_Type: &#x27;web&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Flow_Type: &#x27;Bluefield&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource environment &#x27;Microsoft.Web/kubeEnvironments@2021-03-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: environmentName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: tags</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    type: &#x27;managed&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    internalLoadBalancerEnabled: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    appLogsConfiguration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      destination: &#x27;log-analytics&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      logAnalyticsConfiguration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        customerId: workspace.properties.customerId</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        sharedKey: listKeys(workspace.id, workspace.apiVersion).primarySharedKey</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    containerAppsConfiguration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      daprAIInstrumentationKey: appInsights.properties.InstrumentationKey</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource containerApp &#x27;Microsoft.Web/containerapps@2021-03-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: nodeServiceAppName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;containerapps&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: tags</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    kubeEnvironmentId: environment.id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    configuration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      secrets: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          name: containerRegistryPasswordRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          value: containerRegistryPassword</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          name: mailgunApiKeyRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          value: APPSETTINGS_API_KEY</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      registries: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          server: containerRegistry</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          username: containerRegistryUsername</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          passwordSecretRef: containerRegistryPasswordRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ingress: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        &#x27;external&#x27;: nodeIsExternalIngress</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        &#x27;targetPort&#x27;: nodePort</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    template: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      containers: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          image: nodeImage</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          name: nodeServiceAppName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          transport: &#x27;auto&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          env: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              name: &#x27;APPSETTINGS_API_KEY&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              secretref: mailgunApiKeyRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              name: &#x27;APPSETTINGS_DOMAIN&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              value: APPSETTINGS_DOMAIN</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              name: &#x27;APPSETTINGS_FROM_EMAIL&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              value: APPSETTINGS_FROM_EMAIL</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              name: &#x27;APPSETTINGS_RECIPIENT_EMAIL&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              value: APPSETTINGS_RECIPIENT_EMAIL</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      scale: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        minReplicas: minReplicas</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Let&#x27;s talk through this template. The environment, workspace and app insights resources are fairly self explanatory. The <code>containerApp</code> resource is where the action is. We&#x27;ll drill into that resource and the parameters used to configure it.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="the-node-container-app">The node container app<a class="hash-link" href="#the-node-container-app" title="Direct link to heading">â€‹</a></h3><p>We&#x27;re going to create a single container app for our node web application. This is configured with these parameters:</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">param nodeImage string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param nodePort int</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param nodeIsExternalIngress bool</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The above parameters relate to the node application that represents the website. The <code>nodeImage</code> is the container image which should be deployed to a container app. The <code>nodePort</code> is the port from the app which should be exposed (<code>3000</code> in our case). <code>nodeIsExternalIngress</code> is <a href="https://docs.microsoft.com/en-us/azure/container-apps/ingress?tabs=bash#configuration" target="_blank" rel="noopener noreferrer">whether the container should be accessible on the internet</a>. (Always <code>true</code> incidentally.)</p><p>When these parameters are applied to the <code>containerApp</code> resource, it looks like this:</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">var nodeServiceAppName = &#x27;node-app&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource containerApp &#x27;Microsoft.Web/containerapps@2021-03-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ingress: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        &#x27;external&#x27;: nodeIsExternalIngress</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        &#x27;targetPort&#x27;: nodePort</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    template: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      containers: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          image: nodeImage</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          name: nodeServiceAppName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="accessing-the-github-container-registry">Accessing the GitHub Container Registry<a class="hash-link" href="#accessing-the-github-container-registry" title="Direct link to heading">â€‹</a></h3><p>Given that we&#x27;ve told Bicep to deploy an <code>image</code>, we&#x27;re going to need to tell it what registry it can use to acquire that image. Our template takes these parameters:</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">param containerRegistry string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param containerRegistryUsername string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@secure()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param containerRegistryPassword string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param tags object</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>With the exception of the <code>tags</code> object which is metadata to apply to resources, these parameters are related to the container registry where our images will be stored. GitHub&#x27;s in our case. Remember, what we deploy to Azure Container Apps are container images. To get something running in an ACA, it first has to reside in a container registry. There&#x27;s a multitude of container registries out there and we&#x27;re using the one directly available in GitHub. As an alternative, we could use an <a href="https://azure.microsoft.com/en-us/services/container-registry/" target="_blank" rel="noopener noreferrer">Azure Container Registry</a>, or <a href="https://hub.docker.com/" target="_blank" rel="noopener noreferrer">Docker Hub</a> - or something else entirely.</p><p>Do note the <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/parameters#secure-parameters" target="_blank" rel="noopener noreferrer"><code>@secure()</code></a> decorator. This marks the <code>containerRegistryPassword</code> parameter as secure. The value for a secure parameter isn&#x27;t saved to the deployment history and isn&#x27;t logged. Typically you&#x27;ll want to mark secrets with the <code>@secure()</code> decorator for this very reason.</p><p>We use the parameters to configure the <code>registries</code> property of our container app. This tells the ACA where it can go to collect the image it needs. You can also see our first usage of secrets here. We declare the <code>containerRegistryPassword</code> as a secret which is stored against the ref <code>&#x27;container-registry-password&#x27;</code>; captured as the variable <code>containerRegistryPasswordRef</code>. That variable is then referenced in the <code>passwordSecretRef</code> property - thus telling ACA where it can find the password.</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">var containerRegistryPasswordRef = &#x27;container-registry-password&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource containerApp &#x27;Microsoft.Web/containerapps@2021-03-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    configuration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      secrets: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          name: containerRegistryPasswordRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          value: containerRegistryPassword</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      registries: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          server: containerRegistry</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          username: containerRegistryUsername</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          passwordSecretRef: containerRegistryPasswordRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="secrets--configuration">Secrets / Configuration<a class="hash-link" href="#secrets--configuration" title="Direct link to heading">â€‹</a></h3><p>The final collection of parameters are unrelated to the infrastructure of deployment, rather they are the things required to configure our running application:</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">@secure()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param APPSETTINGS_API_KEY string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param APPSETTINGS_DOMAIN string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param APPSETTINGS_FROM_EMAIL string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param APPSETTINGS_RECIPIENT_EMAIL string</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Again we&#x27;ve got a secret marked with <code>@secure()</code> in the form of our <code>APPSETTINGS_API_KEY</code>. Just as we did with <code>containerRegistryPassword</code>, we declare <code>APPSETTINGS_API_KEY</code> to be a secret, which is stored against the ref <code>&#x27;mailgun-api-key&#x27;</code>; captured as the variable <code>mailgunApiKeyRef</code>.</p><p>All of our configuration is exposed to the running application through environment variables. By and large this is achieved through the mechanism of key / value pairs (well technically <code>name</code> / <code>value</code>) with a slight variation for secrets. Similar to the <code>passwordSecretRef</code> mechanism we used for the registry password, we use a <code>secretref</code> in place of <code>value</code> when passing a secret, and the value will be the ref that was set up in the <code>secrets</code> section; <code>mailgunApiKeyRef</code> in this case.</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">var mailgunApiKeyRef = &#x27;mailgun-api-key&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource containerApp &#x27;Microsoft.Web/containerapps@2021-03-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    configuration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      secrets: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          name: mailgunApiKeyRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          value: APPSETTINGS_API_KEY</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    template: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      containers: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          env: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              name: &#x27;APPSETTINGS_API_KEY&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              secretref: mailgunApiKeyRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              name: &#x27;APPSETTINGS_DOMAIN&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              value: APPSETTINGS_DOMAIN</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              name: &#x27;APPSETTINGS_FROM_EMAIL&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              value: APPSETTINGS_FROM_EMAIL</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              name: &#x27;APPSETTINGS_RECIPIENT_EMAIL&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              value: APPSETTINGS_RECIPIENT_EMAIL</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="setting-up-a-resource-group">Setting up a resource group<a class="hash-link" href="#setting-up-a-resource-group" title="Direct link to heading">â€‹</a></h2><p>With our Bicep in place, we&#x27;re going to need a resource group to send it to. Right now, Azure Container Apps aren&#x27;t available everywhere. So we&#x27;re going to create ourselves a resource group in North Europe which does support ACAs:</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">az group create -g rg-aca -l northeurope</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="secrets-for-github-actions">Secrets for GitHub Actions<a class="hash-link" href="#secrets-for-github-actions" title="Direct link to heading">â€‹</a></h2><p>We&#x27;re aiming to set up a GitHub Action to handle our deployment. This will depend upon a number of secrets:</p><p><img alt="Screenshot of the secrets in the GitHub website that we need to create" src="/assets/images/screenshot-github-secrets-99b5553140a144c164a434c95dd7e4e1.png"></p><p>We&#x27;ll need to create each of these secrets.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="azure_credentials---github-logging-into-azure"><code>AZURE_CREDENTIALS</code> - GitHub logging into Azure<a class="hash-link" href="#azure_credentials---github-logging-into-azure" title="Direct link to heading">â€‹</a></h3><p>So GitHub Actions can interact with Azure on our behalf, we need to provide it with some credentials. We&#x27;ll use the Azure CLI to create these:</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">az ad sp create-for-rbac --name </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;myApp&quot;</span><span class="token plain"> --role contributor </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    --scopes /subscriptions/</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">subscription-id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">/resourceGroups/</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">resource-group</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    --sdk-auth</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Remember to replace the <code>{subscription-id}</code> with your subscription id and <code>{resource-group}</code> with the name of your resource group (<code>rg-aca</code> if you&#x27;re following along). This command will pump out a lump of JSON that looks something like this:</p><div class="codeBlockContainer_J+bg language-json theme-code-block"><div class="codeBlockContent_csEI json"><pre tabindex="0" class="prism-code language-json codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;clientId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-client-id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;clientSecret&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-client-secret&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;subscriptionId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-subscription-id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;tenantId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-tenant-id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;activeDirectoryEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://login.microsoftonline.com&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;resourceManagerEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://management.azure.com/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;activeDirectoryGraphResourceId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://graph.windows.net/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;sqlManagementEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://management.core.windows.net:8443/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;galleryEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://gallery.azure.com/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;managementEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://management.core.windows.net/&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Take this and save it as the <code>AZURE_CREDENTIALS</code> secret in Azure.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="packages_token---azure-accessing-the-github-container-registry"><code>PACKAGES_TOKEN</code> - Azure accessing the GitHub container registry<a class="hash-link" href="#packages_token---azure-accessing-the-github-container-registry" title="Direct link to heading">â€‹</a></h3><p>We also need a secret for accessing packages from Azure. We&#x27;re going to be publishing packages to the GitHub container registry. Azure is going to need to be able to access this when we&#x27;re deploying. ACA deployment works by telling Azure where to look for an image and providing any necessary credentials to do the acquisition. To facilitate this we&#x27;ll set up a <code>PACKAGES_TOKEN</code> secret. This is a GitHub personal access token with the <code>read:packages</code> scope. <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token" target="_blank" rel="noopener noreferrer">Follow the instructions here to create the token.</a></p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="secrets-for-the-app">Secrets for the app<a class="hash-link" href="#secrets-for-the-app" title="Direct link to heading">â€‹</a></h3><p>Alongside these infrastructure / deployment related secrets, we&#x27;ll need ones to configure the app at runtime:</p><ul><li><code>APPSETTINGS_API_KEY</code> - an API key for Mailgun which will be used to send emails</li><li><code>APPSETTINGS_DOMAIN</code> - the domain for the email eg <code>mg.poorclaresarundel.org</code></li><li><code>APPSETTINGS_FROM_EMAIL</code> - who automated emails should come from eg <code>noreply@mg.poorclaresarundel.org</code></li><li><code>APPSETTINGS_RECIPIENT_EMAIL</code> - the email address emails should be sent to</li></ul><p>Strictly speaking, only the API key is a secret. But to simplify this post we&#x27;ll configure all of these as secrets in GitHub.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="deploying-with-github-actions">Deploying with GitHub Actions<a class="hash-link" href="#deploying-with-github-actions" title="Direct link to heading">â€‹</a></h2><p>With our secrets configured, we&#x27;re now well placed to write our GitHub Action. We&#x27;ll create a <code>.github/workflows/deploy.yaml</code> file in our repository and populate it thusly:</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># yaml-language-server: $schema=./build.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Build and Deploy</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">on</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Trigger the workflow on push or pull request,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># but only for the main branch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">push</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">pull_request</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Publish semver tags as releases.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">tags</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;v*.*.*&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">workflow_dispatch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">RESOURCE_GROUP</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> rg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">aca</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">REGISTRY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ghcr.io</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">IMAGE_NAME</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> github.repository </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">matrix</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token key atrule">&#x27;imageName&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;node-service&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token key atrule">&#x27;directory&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;./node-service&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">permissions</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">contents</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> read</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">packages</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> write</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">outputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">containerImage-node</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> steps.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">tag.outputs.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Checkout repository</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> actions/checkout@v2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Login against a Docker registry except on PR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># https://github.com/docker/login-action</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Log into registry $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> github.event_name </span><span class="token tag" style="color:rgb(127, 219, 202)">!=</span><span class="token plain"> &#x27;pull_request&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> docker/login</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">action@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">registry</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">username</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> github.actor </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">password</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> secrets.GITHUB_TOKEN </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Extract metadata (tags, labels) for Docker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># https://github.com/docker/metadata-action</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Extract Docker metadata</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> meta</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> docker/metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">action@v3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">images</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">/$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.IMAGE_NAME </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">/$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> matrix.services.imageName </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">tags</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            type=semver,pattern={{version}}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            type=semver,pattern={{major}}.{{minor}}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            type=semver,pattern={{major}}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            type=ref,event=branch</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            type=sha</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Build and push Docker image with Buildx (don&#x27;t push on PR)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># https://github.com/docker/build-push-action</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Build and push Docker image</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> docker/build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">push</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">action@v2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">context</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> matrix.services.directory </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">push</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> github.event_name </span><span class="token tag" style="color:rgb(127, 219, 202)">!=</span><span class="token plain"> &#x27;pull_request&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">tags</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> steps.meta.outputs.tags </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> steps.meta.outputs.labels </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Output image tag</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">tag</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> echo &quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">output name=image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> matrix.services.imageName </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">/$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.IMAGE_NAME </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">/$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> matrix.services.imageName </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">sha</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">$(git rev</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">parse </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">short HEAD)&quot; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> tr &#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">upper</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">&#x27; &#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">lower</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">deploy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">needs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Checkout repository</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> actions/checkout@v2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Azure Login</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azure/login@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">creds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> secrets.AZURE_CREDENTIALS </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azure/CLI@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> github.event_name </span><span class="token tag" style="color:rgb(127, 219, 202)">!=</span><span class="token plain"> &#x27;pull_request&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            tags=&#x27;{&quot;owner&quot;:&quot;johnnyreilly&quot;, &quot;email&quot;:&quot;johnny_reilly@hotmail.com&quot;}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            az deployment group create \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">              --resource-group ${{ env.RESOURCE_GROUP }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">              --template-file ./infra/main.bicep \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">              --parameters \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  nodeImage=&#x27;${{ needs.build.outputs.containerImage-node }}&#x27; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  nodePort=3000 \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  nodeIsExternalIngress=true \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  containerRegistry=${{ env.REGISTRY }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  containerRegistryUsername=${{ github.actor }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  containerRegistryPassword=${{ secrets.PACKAGES_TOKEN }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  tags=&quot;$tags&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  APPSETTINGS_API_KEY=&quot;${{ secrets.APPSETTINGS_API_KEY }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  APPSETTINGS_DOMAIN=&quot;${{ secrets.APPSETTINGS_DOMAIN }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  APPSETTINGS_FROM_EMAIL=&quot;${{ secrets.APPSETTINGS_FROM_EMAIL }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  APPSETTINGS_RECIPIENT_EMAIL=&quot;${{ secrets.APPSETTINGS_RECIPIENT_EMAIL }}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> What</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">if bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azure/CLI@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> github.event_name == &#x27;pull_request&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            tags=&#x27;{&quot;owner&quot;:&quot;johnnyreilly&quot;, &quot;email&quot;:&quot;johnny_reilly@hotmail.com&quot;}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            az deployment group what-if \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">              --resource-group ${{ env.RESOURCE_GROUP }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">              --template-file ./infra/main.bicep \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">              --parameters \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  nodeImage=&#x27;${{ needs.build.outputs.containerImage-node }}&#x27; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  nodePort=3000 \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  nodeIsExternalIngress=true \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  containerRegistry=${{ env.REGISTRY }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  containerRegistryUsername=${{ github.actor }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  containerRegistryPassword=${{ secrets.PACKAGES_TOKEN }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  tags=&quot;$tags&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  APPSETTINGS_API_KEY=&quot;${{ secrets.APPSETTINGS_API_KEY }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  APPSETTINGS_DOMAIN=&quot;${{ secrets.APPSETTINGS_DOMAIN }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  APPSETTINGS_FROM_EMAIL=&quot;${{ secrets.APPSETTINGS_FROM_EMAIL }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  APPSETTINGS_RECIPIENT_EMAIL=&quot;${{ secrets.APPSETTINGS_RECIPIENT_EMAIL }}&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>There&#x27;s a lot in this workflow. Let&#x27;s dig into the <code>build</code> and <code>deploy</code> jobs to see what&#x27;s happening.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="build---building-our-image"><code>build</code> - building our image<a class="hash-link" href="#build---building-our-image" title="Direct link to heading">â€‹</a></h3><p>The <code>build</code> job is all about building our container images and pushing then to the GitHub registry. It&#x27;s heavily inspired by <a href="https://twitter.com/jeffhollan" target="_blank" rel="noopener noreferrer">Jeff Hollan</a>&#x27;s <a href="https://github.com/Azure-Samples/container-apps-store-api-microservice" target="_blank" rel="noopener noreferrer">Azure sample app GHA</a>. When we look at the <code>strategy</code> we can see a <code>matrix</code> of <code>services</code> consisting of a single service; our node app:</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">matrix</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token key atrule">&#x27;imageName&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;node-service&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token key atrule">&#x27;directory&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;./node-service&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This is a matrix because a typical use case of an Azure Container App will be multi-container, so we&#x27;re starting generic from the beginning. The <code>outputs</code> pumps out the details of our <code>containerImage-node</code> image to be used later:</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">outputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">containerImage-node</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> steps.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">tag.outputs.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>With that understanding in place, let&#x27;s examine what each of the steps in the <code>build</code> job does</p><ul><li><code>Log into registry</code> - logs into the GitHub container registry</li><li><code>Extract Docker metadata</code> - acquire tags which will be used for versioning</li><li><code>Build and push Docker image</code> - build the docker image and if this is not a PR: tag, label and push it to the registry</li><li><code>Output image tag</code> - write out the image tag for usage in deployment</li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="deploy---shipping-our-image-to-azure"><code>deploy</code> - shipping our image to Azure<a class="hash-link" href="#deploy---shipping-our-image-to-azure" title="Direct link to heading">â€‹</a></h3><p>The <code>deploy</code> job does two possible things with our Bicep template; <code>main.bicep</code>.</p><p>In the case of a pull request, it runs the <a href="https://docs.microsoft.com/en-us/cli/azure/deployment/group?view=azure-cli-latest#az_deployment_group_what_if" target="_blank" rel="noopener noreferrer"><code>az deployment group what-if</code></a> - this allows us to see what the effect would be of applying a PR to our infrastructure.</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> What</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">if bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azure/CLI@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> github.event_name == &#x27;pull_request&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">      tags=&#x27;{&quot;owner&quot;:&quot;johnnyreilly&quot;, &quot;email&quot;:&quot;johnny_reilly@hotmail.com&quot;}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">      az deployment group what-if \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        --resource-group ${{ env.RESOURCE_GROUP }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        --template-file ./infra/main.bicep \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        --parameters \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            nodeImage=&#x27;${{ needs.build.outputs.containerImage-node }}&#x27; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            nodePort=3000 \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            nodeIsExternalIngress=true \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            containerRegistry=${{ env.REGISTRY }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            containerRegistryUsername=${{ github.actor }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            containerRegistryPassword=${{ secrets.PACKAGES_TOKEN }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            tags=&quot;$tags&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            APPSETTINGS_API_KEY=&quot;${{ secrets.APPSETTINGS_API_KEY }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            APPSETTINGS_DOMAIN=&quot;${{ secrets.APPSETTINGS_DOMAIN }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            APPSETTINGS_FROM_EMAIL=&quot;${{ secrets.APPSETTINGS_FROM_EMAIL }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            APPSETTINGS_RECIPIENT_EMAIL=&quot;${{ secrets.APPSETTINGS_RECIPIENT_EMAIL }}&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When it&#x27;s not a pull request, it runs the <a href="https://docs.microsoft.com/en-us/cli/azure/deployment/group?view=azure-cli-latest#az_deployment_group_create" target="_blank" rel="noopener noreferrer"><code>az deployment group create</code></a> command which performs a deployment of our <code>main.bicep</code> file.</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azure/CLI@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> github.event_name </span><span class="token tag" style="color:rgb(127, 219, 202)">!=</span><span class="token plain"> &#x27;pull_request&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">      tags=&#x27;{&quot;owner&quot;:&quot;johnnyreilly&quot;, &quot;email&quot;:&quot;johnny_reilly@hotmail.com&quot;}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">      az deployment group create \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        --resource-group ${{ env.RESOURCE_GROUP }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        --template-file ./infra/main.bicep \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        --parameters \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            nodeImage=&#x27;${{ needs.build.outputs.containerImage-node }}&#x27; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            nodePort=3000 \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            nodeIsExternalIngress=true \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            containerRegistry=${{ env.REGISTRY }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            containerRegistryUsername=${{ github.actor }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            containerRegistryPassword=${{ secrets.PACKAGES_TOKEN }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            tags=&quot;$tags&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            APPSETTINGS_API_KEY=&quot;${{ secrets.APPSETTINGS_API_KEY }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            APPSETTINGS_DOMAIN=&quot;${{ secrets.APPSETTINGS_DOMAIN }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            APPSETTINGS_FROM_EMAIL=&quot;${{ secrets.APPSETTINGS_FROM_EMAIL }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            APPSETTINGS_RECIPIENT_EMAIL=&quot;${{ secrets.APPSETTINGS_RECIPIENT_EMAIL }}&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In either case we pass the same set of parameters:</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token assign-left variable" style="color:rgb(214, 222, 235)">nodeImage</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;</span><span class="token string variable" style="color:rgb(214, 222, 235)">${{ needs.build.outputs.containerImage-node }</span><span class="token string" style="color:rgb(173, 219, 103)">}&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">nodePort</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">3000</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">nodeIsExternalIngress</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">true </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">containerRegistry</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token variable" style="color:rgb(214, 222, 235)">${{ env.REGISTRY }</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">containerRegistryUsername</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token variable" style="color:rgb(214, 222, 235)">${{ github.actor }</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">containerRegistryPassword</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token variable" style="color:rgb(214, 222, 235)">${{ secrets.PACKAGES_TOKEN }</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">tags</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;</span><span class="token string variable" style="color:rgb(214, 222, 235)">$tags</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">APPSETTINGS_API_KEY</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;</span><span class="token string variable" style="color:rgb(214, 222, 235)">${{ secrets.APPSETTINGS_API_KEY }</span><span class="token string" style="color:rgb(173, 219, 103)">}&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">APPSETTINGS_DOMAIN</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;</span><span class="token string variable" style="color:rgb(214, 222, 235)">${{ secrets.APPSETTINGS_DOMAIN }</span><span class="token string" style="color:rgb(173, 219, 103)">}&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">APPSETTINGS_FROM_EMAIL</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;</span><span class="token string variable" style="color:rgb(214, 222, 235)">${{ secrets.APPSETTINGS_FROM_EMAIL }</span><span class="token string" style="color:rgb(173, 219, 103)">}&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">APPSETTINGS_RECIPIENT_EMAIL</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;</span><span class="token string variable" style="color:rgb(214, 222, 235)">${{ secrets.APPSETTINGS_RECIPIENT_EMAIL }</span><span class="token string" style="color:rgb(173, 219, 103)">}&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>These are either:</p><ul><li>secrets we set up earlier</li><li>environment variables declared at the start of the script or</li><li>outputs from the build step - this is where we acquire our node image</li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="running-it">Running it<a class="hash-link" href="#running-it" title="Direct link to heading">â€‹</a></h2><p>When the GitHub Action has been run you&#x27;ll find that Azure Container App is now showing up inside the Azure Portal in your resource group, alongside the other resources:</p><p><img alt="screenshot of the Azure Container App&amp;#39;s resource group in the Azure Portal" src="/assets/images/screenshot-azure-portal-container-app-ee70db004700ddaac1de8e411a9b87da.png"></p><p>And when we take a closer look at the container app, we find a URL we can navigate to:</p><p><img alt="screenshot of the Azure Container App in the Azure Portal revealing it&amp;#39;s URL" src="/assets/images/screenshot-azure-portal-container-app-url-ed4d07a3928693eb95afb4707dd78ce5.png"></p><p>Congratulations! You&#x27;ve built and deployed a simple web app to Azure Container Apps with Bicep and GitHub Actions and secrets.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/azure-container-apps">Azure Container Apps</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/bicep">Bicep</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/git-hub-actions">GitHub Actions</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/git-hub-container-registry">GitHub container registry</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Azure Container Apps: build and deploy with Bicep and GitHub Actions" href="/2021/12/27/azure-container-apps-build-and-deploy-with-bicep-and-github-actions"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/2021/12/19/azure-container-apps-bicep-and-github-actions">Azure Container Apps, Bicep and GitHub Actions</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-12-19T00:00:00.000Z" itemprop="datePublished">December 19, 2021</time> Â· <!-- -->4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/assets/images/title-image-151d61532e1cffb9c37053af7da126fc.png"><div class="markdown" itemprop="articleBody"><p>Azure Container Apps are an exciting way to deploy containers to Azure. This post shows how to deploy the infrastructure for an Azure Container App to Azure using Bicep and GitHub Actions. The <a href="https://docs.microsoft.com/en-us/azure/container-apps/" target="_blank" rel="noopener noreferrer">Azure Container App documentation</a> features quickstarts for deploying your first container app using both the Azure Portal and the Azure CLI. These are great, but there&#x27;s a gap if you prefer to deploy using Bicep and you&#x27;d like to get your CI/CD setup right from the beginning. This post aims to fill that gap.</p><p>If you&#x27;re interested in building your own containers as well, it&#x27;s worth looking at <a href="/2021/12/27/azure-container-apps-build-and-deploy-with-bicep-and-github-actions">this follow up post</a>.</p><p><img alt="title image reading &amp;quot;Azure Container Apps, Bicep and GitHub Actions&amp;quot; with the Bicep, Azure Container Apps and GitHub Actions logos" src="/assets/images/title-image-151d61532e1cffb9c37053af7da126fc.png"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="bicep">Bicep<a class="hash-link" href="#bicep" title="Direct link to heading">â€‹</a></h2><p>Let&#x27;s begin with the Bicep required to deploy an Azure Container App.</p><p>In our new repository we&#x27;ll create an <code>infra</code> directory, into which we&#x27;ll place a <code>main.bicep</code> file which will contain our Bicep template.</p><p>I&#x27;ve pared this down to the simplest Bicep template that I can; it only requires a name parameter:</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">param name string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param secrets array = []</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var location = resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var environmentName = &#x27;Production&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var workspaceName = &#x27;${name}-log-analytics&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource workspace &#x27;Microsoft.OperationalInsights/workspaces@2020-08-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: workspaceName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      name: &#x27;PerGB2018&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    retentionInDays: 30</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    workspaceCapping: {}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource environment &#x27;Microsoft.Web/kubeEnvironments@2021-03-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: environmentName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    type: &#x27;managed&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    internalLoadBalancerEnabled: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    appLogsConfiguration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      destination: &#x27;log-analytics&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      logAnalyticsConfiguration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        customerId: workspace.properties.customerId</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        sharedKey: listKeys(workspace.id, workspace.apiVersion).primarySharedKey</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource containerApp &#x27;Microsoft.Web/containerapps@2021-03-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: name</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;containerapps&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    kubeEnvironmentId: environment.id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    configuration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      secrets: secrets</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      registries: []</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ingress: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        &#x27;external&#x27;:true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        &#x27;targetPort&#x27;:80</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    template: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      containers: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          &#x27;name&#x27;:&#x27;simple-hello-world-container&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          &#x27;image&#x27;:&#x27;mcr.microsoft.com/azuredocs/containerapps-helloworld:latest&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          &#x27;command&#x27;:[]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          &#x27;resources&#x27;:{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            &#x27;cpu&#x27;:&#x27;.25&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            &#x27;memory&#x27;:&#x27;.5Gi&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Some things to note from the template:</p><ul><li>We&#x27;re deploying three resources; a container app, a kube environment and an operational insights.</li><li>Just like the official quickstarts we&#x27;re going to use the <code>containerapps-helloworld</code> image.</li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="setting-up-a-resource-group">Setting up a resource group<a class="hash-link" href="#setting-up-a-resource-group" title="Direct link to heading">â€‹</a></h2><p>In order that you can deploy your Bicep, we&#x27;re going to need a resource group to send it to. Right now, Azure Container Apps aren&#x27;t available everywhere. So we&#x27;re going to create ourselves a resource group in North Europe which does support ACAs:</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">az group create -g rg-aca -l northeurope</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="deploying-with-the-azure-cli">Deploying with the Azure CLI<a class="hash-link" href="#deploying-with-the-azure-cli" title="Direct link to heading">â€‹</a></h2><p>With this resource group in place, we could simply deploy using the Azure CLI like so:</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">az deployment group create </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --resource-group rg-aca </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --template-file ./infra/main.bicep </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --parameters </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">name</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;container-app&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="deploying-with-github-actions">Deploying with GitHub Actions<a class="hash-link" href="#deploying-with-github-actions" title="Direct link to heading">â€‹</a></h2><p>However, we&#x27;re aiming to set up a GitHub Action to do this for us. We&#x27;ll create a <code>.github/workflows/deploy.yaml</code> file in our repository:</p><div class="codeBlockContainer_J+bg language-yaml theme-code-block"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">on</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">push</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">main</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">workflow_dispatch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">RESOURCE_GROUP</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> rg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">aca</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">deploy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Checkout repository</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> actions/checkout@v2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Azure Login</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azure/login@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">creds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> secrets.AZURE_CREDENTIALS </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azure/CLI@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            az deployment group create \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">              --resource-group ${{ env.RESOURCE_GROUP }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">              --template-file ./infra/main.bicep \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">              --parameters \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                name=&#x27;container-app&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The above GitHub action is very simple. It:</p><ol><li>Logs into Azure using some <code>AZURE_CREDENTIALS</code> we&#x27;ll set up in a moment.</li><li>Invokes the Azure CLI to deploy our Bicep template.</li></ol><p>Let&#x27;s create that <code>AZURE_CREDENTIALS</code> secret in GitHub:</p><p><img alt="Screenshot of `AZURE_CREDENTIALS` secret in the GitHub website that we need to create" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABgQAAADrCAMAAACRiA1YAAAC2VBMVEX2+Pr////Y3uTQ197V19okKS8afzf29/b5+vxXYGrPIi8afz5XYXehx6ckKTf//+T5//9p1//w8fIvfzcyKS/1vXb/3IP39+RcYGrRtlBipHHw+Prc/v/h4+X+0Zudmzni+PthgjcqKS/p+Pvq6+7//uycdGsifzfG+v1hYWr///r24KPi7+ZqYmoagFH///MkK0LTIi7y//8agWVQLC9djcr/97pWY5ImXq1YY4VXYG58Qi/2+M5+s4rb3d8+gcyh4f1BLS/C8f62gmtlm9XU//9Wb6Npruv7+tv/+9LouIf29+40brl1ZWqEYWkkKknLg0hHgjjl5+p1xvrn/v//9cmp8//Z9/vp7/v678RfdIl4f4clQYSPaWmHzfr93avPMnboymvQJ0K47v2Qzvn037/87Lgbg3CX1P5Ux+bx49n0yohMT1ZmOC+w5v78/Pxjp+P78NahXDNsvPnCw8gjl6MkN3PjpmOFxPStsbX/66DUnHXlWzOy9/7y5uXdo3ttc3Y3QUyvazo4gDe03fdQnd9chL5be6zKk3LYLi7S7/tDuNjRZbcoUpoakJPstG+if23Rik98uuo1rckoPWTG3c0mNlXb6fPvzqKQkpXghY20p0ZNQTp8jzh23Pf05rHSqYnWSlGOUzjW09G82cV5l63ZZHRKl1wsiUaE5v/m3Pl3nsSKiokbjIOa7P+anaCikYP12oDxn2HPJmDYmlhxXkzKztQmn7E5mngkKlu8eERfTkPF4/SDeHJZnWDpd02BqtPhwbaKvZzgyvTasPOg0fCgwuDd4tletrTTtplogJnpwpZFYIjbq+HWltnOysmbqrvS0py6koA3UnOprKl4h5+1wpneQjBj0e6RudpJj9Pr1M3Vp27PvGOAw7vjoqrPRJBIW3C75uXAz+B8z97Tf866vLu4n5Cgzs+1nm6bbVOiybPYeKaW4OhcqoPlg3J+nVPj8seXwYLxQ9okAAAgBklEQVR42uzbsW3DMBRFUZqvUGr16jQRF/H+XRTEcRxkA79zKpILXBAff9wAqCUCAMVEAKDYawTuKwAUWPd/ERgzAJSY428Ezq+3tW8DgLe2nWsmOV8jcCRzHwBU2JMcvxFY120AUONI1k8Edg0AKHMk2yMCM3MAUCWZ3xG4TuYBAGX25GPcLoePAECfmWPcLskaAJRZySMC5wCgzPmMgB0xgDrbMwIDgDoiAFBMBACKiQBAMREAKCYCAMVEAKCYCAAUEwGAYiIAUEwEAIqJAEAxEQAoJgIAxUQAoJgIABQTAYBiIgBQTAQAiokAQDERACgmAgDFRACgmAgAFBMB4JO9s3ltIgjD+KAsQZA9SCSHgEhSRPHSQ8ViBVsVFStUFPys9aAV0VSilkYRxYbWQkH8IFQFQan0pKCHRqhV0IPiF1SoClYvflCx4MH/wGcyb2e7LhUNlcbN8zs0O7v7vvv28jwzOzMJKWNoAoQQUsbQBAghpIyhCRBCSBlDEyCEkDKGJkAIIWUMTYAQQsqY6TaB96Ojo92KEELInzFtJhAbah3n7iU1VWx0HPeoIoQQ8kdMnwksrnI8erpWTrEJxFpbS2BEUBpVEELIpJSGCThO7rGaCp7t3LmzQ4FMonKzmnZKowpCCJmUaTUBt11zNeGAxpVqCokdcUpAfkujCkIImZxpNYHGhUYrv9XBENJKiMxRv1Bf4W/Pif/S3hbMLvI7WcqIDbH8PqdkCGQMJJTqglXMqVCEEBJuijABELmHocAGpWlecBWG8PFdXIH1qVTqYuwbzjTYSYPm83rk0LPjibQPFNqVs98lFTiBiCbEIcRpT73co8CjXTple1eHGs/ZtL030fBlLJX6WKs0y3tT5t5ATmmvGkw47vDNrV4Ntu0lbNJ+dn0wiid33VfKV0X9s7w2uhwuEEJIeCnGBEBGm0AcbvABUqlxN2iBPQcpXpI1ZxohpXKDvQOsRxpDdbedGM7IqYEtkOVsQloN6bjJ6aazaDVdwLlOpTkYxeNF8IM51YsWaTaKj4zXMNzhSwh3qJErub1qYhWHx+wU+EVFCCGhpUgT0Hq8QgtqHfSz73UeujqC5lzod3sidzofdUSlP+DIHTYnVuDEvhY9KrhyK59AOy4mMLEPXq8HGZUfTw8m8LFWcu6o05qtKzi7NbCwNJBzN9oNz18vQFC1vv0gDlxklIkML6FadwRXXr66g4C2PROr6NcDhzdXHuh/r1YRQkhYKcYEjMy6UOjlNUYktXK3HYK+FsR/PswBBwO4cE3rcRoRl6tM1xvd8IZjChFZo8gi5/g0b+Oh2GblUQT2AWU2ORO5hzNudMeOIOl+pR9rLgn+nChG7ANFVCL3ul60UUMM593OiQlVJmqsaTHKHLFVmJDq+TiYV6VDCCEkrPydCfT03QaFDrJztltey8TNRTdt9LWttrDMxrhEf8KMCOzYIQMvKIj9gZmXFPCZgAg5MnkpkFNCjLV0ilEgl+DPqY1H3Gp5r64Od+sBhBQJh/ISFlylVuY4ECJVaJcRE4jcmBFXhBASWorcJyBa34+DkQrwowZ6awS7OqnkygpVb4QciBQbBd7xSqZbgyawvUV0WVLonKLhuFhjDi+YUYXgz2mcqXoTitqU1dIueTwkobxHavtUAfr1U6UKcQdnuO/zNkUIIaGm2B3DZ7oVuOdMoNp0slfIKxrdC0dfHHJtw9tOqsM4A/RqoWTQBOS2hTYFHEXn3OBNRQzsx8sao+KCL6fEWdq2FIpMK4skDPxLeLxUIWMO4A73cXUQISTM/J0JNMxatGiRnrI9a3Q663ig013Q1xGjtFrB48trtGrb2VsosmrOO95SnaAJzLMzD0jmNxapoVP/9b+o9+fMOB7o3xeKXKs8JKE8zIIyPBOot4uaGlYnFSGEhJUiJoah7EaEzUig67jwJBkcCdTYkcA1MxJQKvJogbYRmVXwm4B9ivURyent6MUYIJMwL6Ms/pz60Y3Hx9kaGAlIQnlY7tVx4b5XBTjwNW98AHPKhBASVoowAf16X/r3snLf/6Ylbl/oQ7SNxksQwg2xR+fr9JWgCciAwabwNHt8anjge1Ymmy3+nHZiwr+cFVRsm2gC8rCTSvCqECLvv+Yd7TqKEEJCSjEmgBU8sgIfmuzT47myrNPMCKdFgMUVxB9ObTO3QrHT1gTk064J8o48zZapYfdpi7nVw59TVgcFJ4L3mQtewnUyZSHYKkBkU1yK0CGEEBJSijEByKyWeJHVgb2Ffn5luwi226nbVbhQa4IGHsvOAr07a6zOuAYifCMB7RZpJb7SuFK2+cJQ/Cag72uP6vOWQM7YEVud234mCePAoy+inSm8orIJxZkQihC3/eVKr4r1VxMDTUrMrJEjAUJIaCnKBCCnspO2Hwc9faN3qrzNYgl36evzVbJpLHJB3/BcTiRVZGNhi27r6J0WHSEmIHKMXQgdehNvYRPyrqhIudVsW4W0hWBOeIFT2XX8bYvsB8hECzuIx6K6aC+hmBhCZcezVwVcDjWMthZiRhQhhISV4kxgXa+IfCzrCD3HRLDX1DjAyLH5JiBhQ7ds4BLQO/dMYF7V+DLNZolHa0kyYALo5vtf4QRyms3GBnd1XMfcS3hfBORP+KLKVrd1YhV6cZBwlr8yQwgJL0WZgHS21+Kg/vpgQTeXdtg51+behO5f44Qmcn0QTay4f5hUGv0dozZCTMB+0VzPXnsHMjzxLeaxU8P+qdpgTvAib575RGp4Zopc0xFI2Iy+PsjdTCpfFZfzUcdcmK8IISS0eCZQNAeGWmVrregrzvh+hfjUUKu0bUDrzHhgdc+NoRnx8TvwO8aTiG9/wtsk8Jucp1CUrwYpMkj9DVudrULO6wuEEBJmpsAEAkvw/yWY5dUvmgghhJShCbzvdThTSwghZWkCmBSWHzcmhBBSpiaQe6wIIYSUogkcTKVSq9W/IrYqlVrWxxWbhBBSoiZACCHkv4ImQAghZQxNgBBCyhiaACGElDE0AUIIKWNoAoQQUsbQBMhP9uqYCAAABIDQaf/QbpZ4KAEQJgGAMAkAhEkAIEwCAGESAAiTAECYBADCJAAQJgGAMAkAhEkAIEwCAGESAAiTAECYBADCJAAQJgGAMAkAhEkAIEwCAGESAAiTAECYBADCJAAQJgGAMAkAhEkAIEwCAGESAAiTAECYBADCPoEFIEcCAGGfwACQIwGAMAkAhEkAIEwCAGESAAg79upAAAAAAECQv/Ugl0QSABiTAMCYBADGJAAwJgGAMQkAjEkAYEwCAGMSABiTAMCYBADGJAAwJgGAMQkAjEkAYEwCAGMSABiTAMCYBADGJAAQe3Vo5EAMBFFUruq6FTEZLqY4FIQS2bQ2CgMTp3XgyGlt6tWU5r8IPuoOjBMAgMA4AQAIjBMAgMA4AQAIjBMAgMA4AQAIjBMAsITdStOFWrHdV9EpjhMAEMfeNUHfvRUNcZwAgCBMUum25cts1osk81P0IY4TABBClZrly1mTqquicxwnACAAk3rKOV0s51Qkc1T0HscJAFjeJpU5g5tzkcxT0VscJwBgdUUtTdNUnBWNcZwAgMXtkqVpTMq+ik5xnACAtVW1nKbJTdVX0SmOEwCwtqKeJuoqzorGOE4AwNqkmiaqkrOiMY4TALA2aUsTbZKzoiHuOyfwej6O4/F83QBgNilNJXkr+uc7J3D/+XPcbwB+2Tn3tyiqMI47T+3QLAtsQAFiiZEgS8vG2o1Ny4xylah4Ag3pugWFJkU9pV3FMBXpQhpFoiiVRGEWdtFK0bSM8rEnuqD1pN3s9tj9L+h9552zexwP02wtPOLO94edc86c886Ziu/n3CZLYcqCgJGGAwRGykGNlCxZsmQpPFkQMNIwgADOA3qaExObeyBhzQUsWbIUpiwIGOnIh8D7YP3bKbkdVoSsfQFLloZMrllvbJbCV8qzx2T8l0aZ0vDQsRYEhg4C5Pw9LN2DPAhL/v64n0u1dFkcJyxdHXdwVPDWZK7Gwe+8VL6abwF1hSrvHzny9/30t8KHEDx1Mot58LnNTonk6uMfAqUJ/XEHL4IbmMIWtf1xvBZSEy5LGtsXdxDjs6A/eyVOGGYi9HP7d07JUlRr1rPHeEPOe+yxRnY99kLlTKcUtk7OcUzSR3qWe5Dw0SenFtRIw0P/33IrP9uZbkFAMiMy/maWbkYghKXrs+W8Ni19Yr0c0ktgs2nyTfdrt5Jij1cv7HZeL1g+1ggK64rkb82WUbG9GZIoBBWQ4CGhmON7Z5DTj5ZDuhPYdNYYObYabmAKWmC/eTXCH9RoPqvpnhIuAzUeJZCwgn317BGTJUvRrHuVs8dxdu27JnwIuBLTw4RA5RbFcbPEK+FCxXHj0QeBlJ/WLWTpd9ZtG8jp59rOyRgiCFSu0PT1bnFvjnwIdMpyIksnwnqQZFpksJ3yci9lqkYy9WTLd44SQ2CTej9JxgpYIxYKSL3jxE9AO4/7e4wsLy8VhKACpkksZk9JNmClRouQF6zQ60XrB0aNC0GgivWZ4hyQJM8+uI6BOJRFYdzObGwmhsA+aL6/ubn/z2x5Y6lkKYoVAQhcW1wYFgTGrslRdBBwTUs9KiEw4dz4KSz9ODi9eQj4X3lvUCBwQr6dKfCRCANHPgRkWdZnzOuekvF/1x82hE9olcevl0QQwAuqdjQOxrHG+On/OtXYeBFNCGL3CkJQAScWs/aXJPmlGwgCQAsmsn6IxSDADfSrdU/Oe4HLTl0V2zsmr00AAYqkPcTTmg2VLEWxIgCBXalhQaAySyl42Y0Q4DniS7UgwGv2BQ8NEgRefUfV1+12+0eCCkc5BNLkO/9ahV7My7UvO2+vZAABMs2NXkMIMOvFGJQCmxWEEEKAXDxJXu4UQiCvJxuKwoNAN8CuFQKKIXBiPWCFRa+WLEWxzELgOOehEHAdJ7HUEoWDACvmaukgMF9ZvPTaQyGQ0ORbe6kQArdy0IEchDOS8W3Xv7V2HkEQmGsbLAhcl0mpmK326648vMLRDQEw5moEQSmkebuMbXQaQ4Cc2RACzFyDvtuyf4YohBgCVAGeL4bAfhjThwcBTysgpzsbA4ohEIwUI1mKagkgkPBJxTzPB1tggaZrKZWXv+JWfB/uLNIg4KqEvOL4cKcXMtMq3IqjogI9fSw28s3clkGtKMbapToIrPnCKx0KAdf81MV/CSBQ+xM8ZiZUB7GHfr5TzbZUfE7dnrpOffSaim2eNW619x9syYFWa7lzTLouoyA0xFoI7brUkhToK7SCFx5cCPizCmpaLl254Nsv0rGsaM3bCxZcvFCDQGUT5L7tmgGpS1fanshZBIUpn1BZRCFAWt0Q2IHXyj/aA+0du9Mx2fFr+jTI/XrliJatgUDHi2rFWX+0NwTavwZilHdoRTEbOnbDpaUDKq/YMXwg0F0Pyz4n4g+nKhihj5KMIED42FhqCAHmxLzFi0KIIcAat4mXg9rSoK15CFCjvfhTLYZAVYm1FWBpYAhkKYVLFEcdeOnZk7G4shj8scLt62pSIeCCNX1fHd4+sxQDoLBdbRZWq4NWqgF7lihAh7rUs/sJArwQAlyuuKCm7HAIPHe1UlcH1lzoxWhrACjQCXhoBqIHukZ8ulSZp77GomlQ9Rq1Ew5s5ljGDez5LtMbYa1UxzLAmhfzV2PXoVXBe4MKASi4bOIZTyorbfFfpgMD3jol/lv3yieaVAhMu8C2QHk92fbI0hG5byfbTl9wScaIynNtT/pev8D2yOTIQ6C8IfAuLjw12Ns72vPtD0OHcvOvmxtox0xLQ3t7g/06tPyWBnugo0PNpNynLSFVAUCABPnY1B7YPWQQSNz+vHyYOk2eEqXRcSmacSNX6B+NS/FGECB8YCNjCFCIPI4wghBGEEBfF0Pg+HtKwOHNQoBy8C6uVpj1CCEwtlWWN/1sYcDSQBBwFOz0wkjerVpkQpPqjZ5d7hyAAHq2sigD93dTfcskYgYd8IFqTtVQF4/CwXqO0gXVapscqcYQ8GdBnMMh4KhbvBSbKwX4F7orx4fRPODmtzlFEJi5Ze33513pupc6UftJKjZj0ne5CWtBJUcdvBH2APLEAgg7uBCIP70wc0TMV8lv3owL/0/OAxQ8nqzdOh/8efWc+NtgpP2guhzkv912yVIYisMlM+IQmJ3/6os4H1A3iK9tCOxGCATA6qFSoB1y5Xvs8Dthj/1hmATU3oeY2GD/Rp3CPJYPV9hf2IEhIc5QQWC7LJRJCrCBcRrvh5408k5DCKT0lQApyON/n0jaLvpPxdWqo4Q+BJ0OmqhpEgcB2jVYrkJgPKuwn+0EqKs75iGAQXBZqjtp/Hrx6aCyVXhqddN+6zOBqJcYAmCVNJZHJz3ZTVnXfEW1zPlYSu6/yMsggKav2XhusW+euoFwMf5HB/auGEIAfHtRqQACysWjqCpG82dBJeoT+LQeAtgnuE/2jp3BNS1Y7GHSdxnfiLhFb7QLdqUZLKYMMgRsj8xAd38GTf4t2yXpWOsZvFXeNLOG6kGhBoHZyXfdgGW5Z9w1KdIQqNyjDv634i/aOtg7QABsH30fC/HeD9iCtg5yYfAPyFANvwhnBGxaEAPVhgoCnbJQz5tpS6Pj6Wif9XltobIkAMPAEJBjOzs7s/H4pmbYQYHjCiGAj2AShMCCoKoHgAATngwlCOC5pvUmIUB3Y9vI6htFEMCSvh7oE/TqgDUfiG6JIUAOi2Y5jzkoqKqY9gQ8iU7aEcYhP4OAh3LaISIvuDoUUzVjCOS6YQtYBAH0abwBCUIB3QDWiCCApQgBfLZe+i7PD70gvpEHeMW6DiwZZAjQhu/lYPVAgimUgVv8LnEmQYBqjVCZEX9HpCAQ6FDVno/rO+jk72I52XsuDeqZvW+wPxyihB/mBeT+VJl+KCbwY2ggAJ6VKCo0/ZHARi9c/atwlEzKLYHj/EYQUBW7CYfk4c8EBCH+40wAXBw6bR4CacQPF856BBAg+fsmluDXYhdJlqJYYggs8jKHvQ3cnVmkP4sgoMlFNzQI+OHCYsIcAGwb3Rk1zRACtbgYJIKA1mjq1coUjFGAWSLRFAEEME/TCkfXU5JQrMtg+ogCCg5vxN6L/eMYXAhobj4XZgQTzj39Cv500Kyftrhzct4OQgB/P12nag5kI/ydAOz+Yg8b7B0rUH/kB3YgBLCQyEAQiLmPxvmUIMPHG+mwnBRYoWorzC6GDgIGhYYi2+xtRtEpHG1R5FH4N26wHFR92ml9JQQNM3sC9MUBkyiE8Z5A4wB7Auqm9nSTEKDzqc0oOP3aJoYAybUaloWWW0tC0SwRBMgTySML2eiYVk9oJvDOK3U5qQqIQYBG7DMrSMUQE2PdyPzcAAKeeym6YGOYgwCa/A1SsE8CCCB3iCkKng36PpOLpe8yvpFXYhMHJ5u0sHWjQYUA+T5B4Kw5l3EQKFqCm8G33LIyBIGi221BfRmx5aBZKHWFH3RWg50p8C5uDOshQGN/lAqBclwUovuzgzyBs6bDAgLcWk7sXu4rMR4C0wV7Aq40cFKTENiHB3w46UIYQ6A7CfslhgAWN5qCAEWSmcDiB4YAzYteul+yFL3SQ+BGcnXOcBMQAtzHYnQABwx/XbEOAkGBY6P138yiGkCgxQ1uLoZADQcB7KYpCOARUQXk6JohMem7nEAQYG9EEx4SzDhqIgoBWvDR1nzSD4VA+Rx+JnBC8mWFmZThZgLnn6QpI7J7AqtxIxhUDtcHNKWLIcDPBGifILcBquHG8kms6YjhAAEYHec9T6qn85H0lRhvxwwJ3eTlmmGXgU+OMwEBct9G5q53b9aHMIaAi54vhgDuXtz0nEkIeFqDr1oCsxsRBFzHhdrBUy1Fr2gdhUTGTa4umAnQuBnzDjq7v0QHgcJTg3Ki9ZuYCUzN8nW9geor9m174xivGALUTRMQIM36cZ1bURYHKcB3WTcTUCFQxkEgsjOBlNtt53NJbmrwGlg9ZbQ9AdolpjsMAlg2WB+LbaDzn/495PckAQTA9eEntFEwG9aD1HLaQNA0LCDQnRTcD95Hvse+EuNstC2EA86wu/ETMFMQoP8dA4u2XhfCGAJV0LZ0AAgQxHrNQIB60ch9Gnw4BMr+rG+0IGBJt2BPiyE1tBxEHonuqF9Bp0V58Z4A9/dkbk8Ag3HC0b4YAjRCJ9dnewIsAA8BpgQ4SrqMZfRdxjcq5d4IfyO/J0Befwod78HjoJddo04NzkerL3oQkFAEXCA+AAQgA7aPR4U4CDx2ylXj1NYnZUYaAn5aEIph+75FL4ohgMeG2Nxhh0qNV8+7T01NwJ1i1AOnDgsIeFpxLM4vvlehYes+9yUo+GncToZNbQkPxhCg0TyYLvsGrVQXwhACU0dTDTEEyK1LTEGAkvwnajwE2MfJ01kS39VS9Aq8+rbQgX1ydbxwRn4vZ7hn4hA/OIrnIcBYwcTWWIxPB9W+/DQJxu4fPv3xKDEE2DklEKauCY3YoTciCLAjSiRdlzmrv5adDmIHmxAPkYRAORwJ3YyJXXPA6FUIPDFJPfOJSJh7yl01aPXJ2kwgE/z3rQWwUIQQ+FJtHv8QWnTLGcCSiEIAh/T0rRge9kfDzwcYiCBQRQtHQItv0qlwRQOltMlEylb7R8MBAnj0xsk8EC3RD6dwfjstqEy1OO+AV5JqW7MBEsywqTE5ZRrfJEP4GFh06s2QXH1jYDIhCEE7xXwIitncXyLHNno1V/4uWIP7TrhsjCwPAIEUqAlrWwfoPRhGuEnNWD6oU52Y3PQbXKUJo+FdrY3hf9i7vpcooijcqlspk4UFLliwCWpuTCtG0PpSJoiwmS+JovmQqcj2oi9RSCa5hRmEmD/WiCLWrUhhN8Je1NyIsFZBES1kCQkDC4T6EzrnnhmdKyOM6Nau3u/Fmbln7pwL7v3uveee7+5kYIqXmy7tq9lfUr1mZnDVIl1XbhUSqFGVP7HnJRJgm+3rlXqmR9jaEfWspVXrkwDBQEwAB+u5q3kCtHBFtxwJ1Pb5DpMTWrE73mXWohr1bbSiuQrRXMNW5glg923O+d7SMpxOSb8QExjq8d0IPDaftzKK6PL5q3Ja0llMILlwNjB86Ut+ycAihJF7QnPHIIs4eXJ6NjM/+U6ktIOcY0nVywsLY8gFeiSAiWHMIInIAmxIeY7lj71ZWHj0DOqJBRLA0TF3s1aWnzaMwq7+1qzdsGdISwIk7sYE5DR4aNLD8aNYBwRmTz7RqYLPEwAq0tR54v5FhaG4EwdUEgDLLH0S4M8T4Ipo1sNbYJDA/g3ceAkhA2griGYI7GRAfpRj3godZDhgwW6bksUK27FHvYDRAOyAC8+Bgac4m8KorD+2f3YMsv6YAsc0ynabsEAG0sCeNS8IdqkFFi4mYEsBeGSpBv6UGyQBrM3CdCBsEzLLGK7DFGDkmxZZQwL4HD5KzWKERuBdphaNYAKxhHMbuscGF3VsZcYwwdWRbwZ0DVgpUlzyowAeJBe2423tULrZ3BO8fOh02S5nEz6fdKfeTjefQb0I87WbQCJgAW8H0yIgG0EpYc5bX5MAzz/oLwcBJtCgmhlQoRoLaPx9D0uWX8XCchAb/HPTgtdrSQDw9E/WyvkvvPobruYYIAFA6a9WlhdwRbcKfRJA+0/0wrokgBeGSIAG/3zDeRKgph6k78LcR2Bnw1OcqOjqgLynklbry5Tm/IOyMkmYyAaxtb5RyylcYmHD5wp/X7HUCcIQoekyWxPq7gQZnUghKEjMY2o/RSglBMs8jn2yhgS4KAB03EZJYP8MftUPMm93D9MYHioHJ35WcSRgA4khx5wfnNUuTq11mbWoslKW5pX5ggdch7dkSDnb+pPF9rim3vbSJe0OcnrxnuCailc75ZXnzeX41ngcFTTD0wifLOYKh8uNG/BtC7vSYiUwbAwZ493dvZtcHrFDHVZT1APdjJlTXAUiicYl1i/nkcQmre80BizwKOSmwfsEGkgD1jbSiZhBwqj4eCBjxgIjZ9qa34AVBaAASpR6qI4Kd12xVL9ZEsBhPHvREaR/2iLFCXC2UxsTsL0fTSQ77Y9wrcs2D+qdhtwr4ti1zNe8uZHIHi9JJCDOGI5mEtgIMrz9PIQQj0CMwtacEB+XRtfqIn9GQnzvqoHLG5erHSwl0FjJmXKAvX6kXB1aeOPYJSEV6thKL73x8FneCR04x71ciZ7LKCSxl6SGVANwHfhFkEDMkUDKfyIBWp7h8UAIMAhsBzAS2OZwqntgecE4QQJRTgIv1hOQExAQECRgHKVVmNNA4eaz/5gESgQJbIIE+teTkhYQEBAkYBz2NpSZc7qWZE401CCircvdSSRg6n+nc6iM4AABAUECG0NRQSIBtCUECXCIchIQEBCIOPCM4aBpm8MW9oPcqW8x1yRIgIcgAQGBv+zYoQ0DQQxEUYORNtjc7OpwEdtI+meh2Qs5Zsf6r4KPPJIBRoARAIBnpGWFltSs6MtiBABMl3Ir5MpmRWccIwBgttC2QlvRrOiMYwQAzLYVVih0NSs64xgBALO55FbGpdWr6BbHCACY7Z1KK5OKd6+iWxwjAGA4l8KKhOS9iu5xjACA4eyqurkrpOvVqehB3IERAPD/1pay4AvvKe3Vqeg3jhH4tGPHNgjEQBBFLThpLyYncx0ugkbcfwYRASIgOqyb9xrwRP7SAqc3q2/bNu692mGq38fr0V5zlUVfx4kAEGCv29j+YNxqX2vR5zgRABLMqv4Yh367Yzx61Vxo0ZdxIgCEaPUHbblFP457EwHgJObe6lBtn4st+hgnAgCIAAAiAIAIACACAIgAQDYRAAgmAgDBRAAgmAgABBMBgGAiABBMBACCiQBAMBEACCYCAMFEACCYCAAEEwGAYCIAEEwEAIKJAEAwEQAIJgIAwUQAIJgIAAQTAYBgIgAQ7B2BCwBxRAAgmHMQQDARAAh2vT4BoSkwyfqpqrYAAAAASUVORK5CYII="></p><p>We&#x27;ll use the Azure CLI once more:</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">az ad sp create-for-rbac --name </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;myApp&quot;</span><span class="token plain"> --role contributor </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    --scopes /subscriptions/</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">subscription-id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">/resourceGroups/</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">resource-group</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    --sdk-auth</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Remember to replace the <code>{subscription-id}</code> with your subscription id and <code>{resource-group}</code> with the name of your resource group (<code>rg-aca</code> if you&#x27;re following along). This command will pump out a lump of JSON that looks something like this:</p><div class="codeBlockContainer_J+bg language-json theme-code-block"><div class="codeBlockContent_csEI json"><pre tabindex="0" class="prism-code language-json codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;clientId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-client-id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;clientSecret&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-client-secret&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;subscriptionId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-subscription-id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;tenantId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-tenant-id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;activeDirectoryEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://login.microsoftonline.com&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;resourceManagerEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://management.azure.com/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;activeDirectoryGraphResourceId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://graph.windows.net/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;sqlManagementEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://management.core.windows.net:8443/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;galleryEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://gallery.azure.com/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;managementEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://management.core.windows.net/&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Take this and save it as the <code>AZURE_CREDENTIALS</code> secret in Azure.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="running-it">Running it<a class="hash-link" href="#running-it" title="Direct link to heading">â€‹</a></h2><p>When the GitHub Action has been run you&#x27;ll find that Azure Container App is now showing up inside the Azure Portal:</p><p><img alt="screenshot of the Azure Container App in the Azure Portal" src="/assets/images/screenshot-azure-portal-container-app-ced5e322f67db533948a5bedea469a03.png"></p><p>You&#x27;ll see a URL is displayed, when you go that URL you&#x27;ll find the hello world image is running!</p><p><img alt="screenshot of the running Azure Container App" src="/assets/images/screenshot-of-running-container-app-9c2faf56fe8f79d635d7365293bc823a.png"></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/azure-container-apps">Azure Container Apps</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/bicep">Bicep</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/git-hub-actions">GitHub Actions</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Azure Container Apps, Bicep and GitHub Actions" href="/2021/12/19/azure-container-apps-bicep-and-github-actions"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/2021/11/18/azure-standard-tests-with-bicep">Azure standard availability tests with Bicep</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-11-18T00:00:00.000Z" itemprop="datePublished">November 18, 2021</time> Â· <!-- -->6 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/assets/images/title-image-9d3abe816d11b7674367fcf91c4cc60b.png"><div class="markdown" itemprop="articleBody"><p>Azure standard tests are a tremendous way to monitor the uptime of your services in Azure. Sometimes also called availability tests, web tests and ping tests, this post goes through how to deploy one using Bicep. It also looks at some of the gotchas that you may encounter as you&#x27;re setting it up.</p><p><img alt="title image reading &amp;quot;Azure standard availability tests with Bicep&amp;quot; with a Bicep logo and Azure logos" src="/assets/images/title-image-9d3abe816d11b7674367fcf91c4cc60b.png"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="what-are-standard-tests">What are standard tests?<a class="hash-link" href="#what-are-standard-tests" title="Direct link to heading">â€‹</a></h2><p>To quote the <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/app/availability-standard-tests" target="_blank" rel="noopener noreferrer">docs</a>:</p><blockquote><p>Standard tests are a single request test that is similar to the URL ping test but more advanced. In addition to validating whether an endpoint is responding and measuring the performance, Standard tests also includes SSL certificate validity, proactive lifetime check, HTTP request verb (for example GET,HEAD,POST, etc.), custom headers, and custom data associated with your HTTP request.</p></blockquote><p>So we can use these to:</p><ul><li>send requests to a URL</li><li>from a variety of geographic locations</li><li>and determine if it is responding with a 200 status code</li></ul><p>The URL may be one of our own service URLs, but it could be checking any kind of URL. It&#x27;s web specific, not Azure specific.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="standard-test-bicep">Standard test Bicep<a class="hash-link" href="#standard-test-bicep" title="Direct link to heading">â€‹</a></h2><p>Now we&#x27;re going to write a Bicep module that provisions a standard test named <code>standard-test.bicep</code>:</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Tags that our resources need&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param tags object</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;The resource id of the app insights which the webtest will reference&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param appInsightsResourceId string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;The name of the webtest to create&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param standardTestName string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;URL to test&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param urlToTest string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Interval in seconds between test runs for this WebTest. Default value is 300.&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param frequency int = 300</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Seconds until this WebTest will timeout and fail. Default value is 30.&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param timeout int = 30</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// useful reference:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// https://docs.microsoft.com/en-us/azure/azure-monitor/app/monitor-web-app-availability#azure</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@allowed([</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-au-syd-edge&#x27; // Australiaâ€¯East</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;latam-br-gru-edge&#x27; // Brazil South</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;us-fl-mia-edge&#x27; // Central US</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;apac-hk-hkn-azr&#x27; // East Asia</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;us-va-ash-azr&#x27; // East US</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-ch-zrh-edge&#x27; // France South (Formerly France Central)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-fr-pra-edge&#x27; // France Central</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;apac-jp-kaw-edge&#x27; // Japan East</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-gb-db3-azr&#x27; // North Europe</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;us-il-ch1-azr&#x27; // North Central US</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;us-tx-sn1-azr&#x27; // South Central US</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;apac-sg-sin-azr&#x27; // Southeast Asia</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-se-sto-edge&#x27; // UK West</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-nl-ams-azr&#x27; // West Europe</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;us-ca-sjc-azr&#x27; // West US</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-ru-msa-edge&#x27; // UK South</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">])</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;The populations (locations) for the test&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param testPopulations array = [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-se-sto-edge&#x27; // UK West</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-ru-msa-edge&#x27; // UK South</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;emea-gb-db3-azr&#x27; // North Europe</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;us-va-ash-azr&#x27; // East US</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;apac-sg-sin-azr&#x27; // Southeast Asia</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var tagsWithHiddenLink = union({</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  &#x27;hidden-link:${appInsightsResourceId}&#x27;: &#x27;Resource&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}, tags)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource standardWebTest &#x27;Microsoft.Insights/webtests@2018-05-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: standardTestName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: tagsWithHiddenLink</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;ping&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    SyntheticMonitorId: urlToTest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Name: urlToTest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Description: null</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Enabled: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Frequency: frequency</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Timeout: timeout</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Kind: &#x27;standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    RetryEnabled: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Locations: [for testPopulation in testPopulations: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      Id: testPopulation</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Configuration: null</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Request: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      RequestUrl: urlToTest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      Headers: null</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      HttpVerb: &#x27;GET&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      RequestBody: null</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ParseDependentRequests: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      FollowRedirects: null</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ValidationRules: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ExpectedHttpStatusCode: 200</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      IgnoreHttpsStatusCode: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ContentValidation: null</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      SSLCheck: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      SSLCertRemainingLifetimeCheck: 7</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output standardWebTestName string = standardWebTest.name</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output standardWebTestId string = standardWebTest.id</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="locations--populations">Locations / populations<a class="hash-link" href="#locations--populations" title="Direct link to heading">â€‹</a></h3><p>You&#x27;ll note that a parameter to the Bicep module is <code>testPopulations</code>. These are the geographical places where requests will be sent from. You&#x27;ll note we have a default value of five populations, but these could be any of the (presently) sixteen valid values. If you were wondering where those are sourced from, <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/app/availability-standard-tests#location-population-tags" target="_blank" rel="noopener noreferrer">here is the link to the Azure docs</a>.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="the-hidden-link-tag">The <code>hidden-link</code> tag<a class="hash-link" href="#the-hidden-link-tag" title="Direct link to heading">â€‹</a></h3><p>Another significant call out should go to the <code>hidden-link</code> tag. The <code>hidden-link</code> tag is a mandatory tag that connects the test (known in Azure as a &quot;webtest&quot;) to an app insights instance.</p><p>If you do not provide a <code>hidden-link</code> tag, or if you try to specify a resource group other than the app insights resource group, Azure will fail to deploy your test and you may find yourself presented with an error like this in the deployments section of the Azure Portal.</p><blockquote><p>Resource should exist in the same resource group as the linked component</p></blockquote><p><img alt="screenshot of the Azure Portal Deployments section saying &amp;quot;Resource should exist in the same resource group as the linked component&amp;quot;" src="/assets/images/screenshot-azure-portal-deployments-resource-should-exist-in-the-same-resource-group-ed53a9e33ef3b27d35cd9009b52ba0f6.png"></p><p>In our module we set both the <code>hidden-link</code> tag as well as the tags that have been supplied via the <code>tags</code> parameter.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="app-insights-and-standard-tests-share-a-resource-group">App insights and standard tests share a resource group<a class="hash-link" href="#app-insights-and-standard-tests-share-a-resource-group" title="Direct link to heading">â€‹</a></h3><p>Another thing that can cause issues is the deployment of your app insights resource. It&#x27;s not unusual to spin up Azure resources on demand, for a given branch of your source code. Those resources will be named in relation to the branch and will depend upon one another. I&#x27;ve never managed to successfully create an app insights resource, and reference it from a standard test within the same Bicep file. It appears to be necessary to separate the two actions, such that Azure recognises the existence of the app insights resource when the standard test is deployed.</p><p>If you are working with long-lived app insights it won&#x27;t be an issue for you, but if you aren&#x27;t it&#x27;s worth being aware of.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="using-standard-testbicep">Using <code>standard-test.bicep</code><a class="hash-link" href="#using-standard-testbicep" title="Direct link to heading">â€‹</a></h2><p>Our Bicep module can be invoked from another Bicep module named <code>ping-them.bicep</code> like so:</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Tags that our resources need&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param tags object</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;The name of the app insights&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param appInsightsName string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;An object where the keys are the name of the web test and the values are the URL eg {&quot;my-standard-test&quot;: &quot;https://status.azure.com/en-gb/status&quot;} &#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param standardTests object</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var appInsightsResourceId = resourceId(&#x27;Microsoft.Insights/components&#x27;, appInsightsName)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">module standardTestsToCreate &#x27;standard-test.bicep&#x27; = [for standardTest in items(standardTests): {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: standardTest.key</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  params: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    tags: tags</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    appInsightsResourceId: appInsightsResourceId</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    standardTestName: standardTest.key</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    urlToTest: standardTest.value</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As you can see, this module itself takes a number of parameters, and will typically be invoked from some kind of continuous integration mechanism such as Azure Pipelines or GitHub Actions.</p><p>This module is written in the expectation that multiple URLs will need to be pinged, and so it has a parameter named <code>standardTests</code> which is effectively a dictionary of key-value pairs, where the key is the name of the standard test, and the value is the URL to test.</p><p>The module makes use of the <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/bicep-functions-array#items" target="_blank" rel="noopener noreferrer"><code>items</code></a> array helper in Bicep to convert the object into an array that can be iterated over.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="azure-pipelines-test">Azure Pipelines test<a class="hash-link" href="#azure-pipelines-test" title="Direct link to heading">â€‹</a></h2><p>We&#x27;re going to use Azure Pipelines to test this out. Here&#x27;s an <code>azure-pipelines.yml</code> file:</p><div class="codeBlockContainer_J+bg language-yml theme-code-block"><div class="codeBlockContent_csEI yml"><pre tabindex="0" class="prism-code language-yml codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">trigger</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">pool</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">vmImage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">checkout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> self</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">submodules</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> az bicep build </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">file ping</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">them.bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Compile Bicep to ARM&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureResourceManagerTemplateDeployment@3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DeploySharedWebTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy Shared Web Tests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">deploymentScope</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">azureResourceManagerConnection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> variables.serviceConnection </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">subscriptionId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(subscriptionId)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Create Or Update Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(resourceGroup)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(location)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">templateLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Linked artifact</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">csmFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;ping-them.json&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># created by bash script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">overrideParameters</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">tags </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token key atrule">&quot;owner&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;@johnny_reilly&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token key atrule">&quot;branch&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;$(Build.SourceBranchName)&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">appInsightsName $(appInsightsName)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">standardTests </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token key atrule">&quot;my-standard-test&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://status.azure.com/en-gb/status&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">deploymentMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Incremental</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When run, it invokes our <code>ping-them.bicep</code> module, passing two URLs to test.</p><p>When executed, you end up with a delightful &quot;availability test&quot; (which is your standard test) in Azure:</p><p><img alt="screenshot of an Availability test in the Azure Portal" src="/assets/images/screenshot-azure-portal-availability-6078847f21e8488d05a694781e0c9e46.png"></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/azure">Azure</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/bicep">Bicep</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/standard-tests">standard tests</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Azure standard availability tests with Bicep" href="/2021/11/18/azure-standard-tests-with-bicep"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/2021/09/12/permissioning-azure-pipelines-bicep-role-assignments">Permissioning Azure Pipelines with Bicep and Azure RBAC Role Assignments</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-09-12T00:00:00.000Z" itemprop="datePublished">September 12, 2021</time> Â· <!-- -->9 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/assets/images/permissioning-azure-pipelines-with-bicep-and-role-assignments-a540df332b847efc72e71362340d3b89.png"><div class="markdown" itemprop="articleBody"><p>How can we deploy resources to Azure, and then run an integration test through them in the context of an Azure Pipeline? This post will show how to do this by permissioning our Azure Pipeline to access these resources using Azure RBAC role assignments. It will also demonstrate a dotnet test that runs in the context of the pipeline and makes use of those role assignments.</p><p><img alt="title image reading &amp;quot;Permissioning Azure Pipelines with Bicep and Role Assignments&amp;quot; and some Azure logos" src="/assets/images/permissioning-azure-pipelines-with-bicep-and-role-assignments-a540df332b847efc72e71362340d3b89.png"></p><p>We&#x27;re following this approach as an alternative to <a href="/2021/07/07/output-connection-strings-and-keys-from-azure-bicep">exporting connection strings</a>, as these can be viewed in the Azure Portal; which may be an security issue if you have many people who are able to access the portal and view deployment outputs.</p><p>We&#x27;re going to demonstrate this approach using Event Hubs. It&#x27;s worth calling out that this is a generally useful approach which can be applied to any Azure resources that support Azure RBAC Role Assignments. So wherever in this post you read &quot;Event Hubs&quot;, imagine substituting other Azure resources you&#x27;re working with.</p><p>The post will do the following:</p><ul><li>Add Event Hubs to our Azure subscription</li><li>Permission our service connection / service principal</li><li>Deploy to Azure with Bicep</li><li>Write an integration test</li><li>Write a pipeline to bring it all together</li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="add-event-hubs-to-your-subscription">Add Event Hubs to your subscription<a class="hash-link" href="#add-event-hubs-to-your-subscription" title="Direct link to heading">â€‹</a></h2><p>First of all, we may need to add Event Hubs to our Azure subscription.</p><p>Without this in place, we may encounter errors of the type:</p><blockquote><p>##<!-- -->[error]<!-- -->MissingSubscriptionRegistration: The subscription is not registered to use namespace &#x27;Microsoft.EventHub&#x27;. See <a href="https://aka.ms/rps-not-found" target="_blank" rel="noopener noreferrer">https://aka.ms/rps-not-found</a> for how to register subscriptions.</p></blockquote><p>We do this by going to &quot;Resource Providers&quot; in the <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer">Azure Portal</a> and registering the resources you need. Lots are registered by default, but not all.</p><p><img alt="Screenshot of the Azure Portal, subscriptions -&amp;gt; resource providers section, showing that Event Hubs have been registered" src="/assets/images/screenshot-azure-portal-subscription-resource-providers-8ae907f657d2d95ed7a03b89f65df866.png"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="permission-our-service-connection--service-principal">Permission our service connection / service principal<a class="hash-link" href="#permission-our-service-connection--service-principal" title="Direct link to heading">â€‹</a></h2><p>In order that we can run pipelines related to Azure, we mostly need to have an Azure Resource Manager service connection set up in Azure DevOps. Once that exists, we also need to give it a role assignment to allow it to create role assignments of its own when pipelines are running.</p><p>Without this in place, we may encounter errors of the type:</p><blockquote><p>##<!-- -->[error]<!-- -->The template deployment failed with error: &#x27;Authorization failed for template resource &#x27;{GUID-THE-FIRST}&#x27; of type &#x27;Microsoft.Authorization/roleAssignments&#x27;. The client &#x27;{GUID-THE-SECOND}&#x27; with object id &#x27;{GUID-THE-SECOND}&#x27; does not have permission to perform action &#x27;Microsoft.Authorization/roleAssignments/write&#x27; at scope &#x27;/subscriptions/<!-- -->*<!-- -->*<!-- -->*<!-- -->/resourceGroups/johnnyreilly/providers/Microsoft.EventHub/namespaces/evhns-demo/providers/Microsoft.Authorization/roleAssignments/{GUID-THE-FIRST}&#x27;.&#x27;.</p></blockquote><p>Essentially, we want to be able to run pipelines that say &quot;hey Azure, we want to give permissions to our service connection&quot;. We are doing this <em>with</em> the self same service connection, so (chicken and egg) we first need to give it permission to give those commands in future. This is a little confusing; but let&#x27;s role with it. (Pun most definitely intended. ðŸ˜‰)</p><p>To grant that permission / add that role assignment, we go to the service connection in Azure Devops:</p><p><img alt="Screenshot of the service connection in Azure DevOps" src="/assets/images/screenshot-azure-devops-service-connection-1704ec6d99f393b34e3b5e9fc1d44f28.png"></p><p>We can see there&#x27;s two links here; first we&#x27;ll click on &quot;Manage Service Principal&quot;, which will take us to the service principal in the Azure Portal:</p><p><img alt="Screenshot of the service principal in the Azure Portal" src="/assets/images/screenshot-azure-portal-service-principal-4355baaac9517574f9e87315436620af.png"></p><p>Take note of the display name of the service principal; we&#x27;ll need that as we click on the &quot;Manage service connection roles&quot; link, which will take us to the resource groups IAM page in the Azure Portal:</p><p><img alt="Screenshot of the resource groups IAM page in the Azure Portal" src="/assets/images/screenshot-azure-portal-service-principal-access-control-bef2f45bc0712f0ee2edd120ba61f3ba.png"></p><p>Here we can click on &quot;Add role assignment&quot;, select &quot;Owner&quot;:</p><p><img alt="Screenshot of the add role assignment IAM page in the Azure Portal" src="/assets/images/screenshot-azure-portal-add-role-assignment-23c9c5a473502e6dc9457c2872c42143.png"></p><p>Then when selecting members we should be able to look up the service principal to assign it:</p><p><img alt="Screenshot of the add role assignment select member IAM page in the Azure Portal" src="/assets/images/screenshot-azure-portal-add-role-assignment-member-aad27dad39826e3c65c771061c47a198.png"></p><p>We now have a service connection which we should be able to use for granting permissions / role assignments, which is what we need.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="event-hub-and-role-assignment-with-bicep">Event Hub and Role Assignment with Bicep<a class="hash-link" href="#event-hub-and-role-assignment-with-bicep" title="Direct link to heading">â€‹</a></h2><p>Next we want a Bicep file that will, when run, provision an Event Hub and a role assignment which will allow our Azure Pipeline (via its service connection) to interact with it.</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Name of the eventhub namespace&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param eventHubNamespaceName string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Name of the eventhub name&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param eventHubName string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;The service principal&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param principalId string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Create an Event Hub namespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHubNamespace &#x27;Microsoft.EventHub/namespaces@2021-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: eventHubNamespaceName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name: &#x27;Standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    tier: &#x27;Standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    capacity: 1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    zoneRedundant: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Create an Event Hub inside the namespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHub &#x27;Microsoft.EventHub/namespaces/eventhubs@2021-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  parent: eventHubNamespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: eventHubName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    messageRetentionInDays: 7</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    partitionCount: 1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// give Azure Pipelines Service Principal permissions against the Event Hub</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var roleDefinitionAzureEventHubsDataOwner = subscriptionResourceId(&#x27;Microsoft.Authorization/roleDefinitions&#x27;, &#x27;f526a384-b230-433a-b45c-95f59c4a2dec&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource integrationTestEventHubReceiverNamespaceRoleAssignment &#x27;Microsoft.Authorization/roleAssignments@2018-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: guid(principalId, eventHub.id, roleDefinitionAzureEventHubsDataOwner)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  scope: eventHubNamespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    roleDefinitionId: roleDefinitionAzureEventHubsDataOwner</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    principalId: principalId</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Do note that our bicep template takes the service principal id as a parameter. We&#x27;re going to supply this later from our Azure Pipeline.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="our-test">Our test<a class="hash-link" href="#our-test" title="Direct link to heading">â€‹</a></h2><p>We&#x27;re now going to write a dotnet integration test which will make use of the infrastructure deployed by our Bicep template. Let&#x27;s create a new test project:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">mkdir src</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cd src</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet new xunit -o IntegrationTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cd IntegrationTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet add package Azure.Identity</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet add package Azure.Messaging.EventHubs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet add package FluentAssertions</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet add package Microsoft.Extensions.Configuration.EnvironmentVariables</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>We&#x27;ll create a test file called <code>EventHubTest.cs</code> with these contents:</p><div class="codeBlockContainer_J+bg language-cs theme-code-block"><div class="codeBlockContent_csEI cs"><pre tabindex="0" class="prism-code language-cs codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Collections.Generic;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Linq;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Text;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Threading;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Threading.Tasks;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Azure.Identity;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Azure.Messaging.EventHubs;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Azure.Messaging.EventHubs.Consumer;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Azure.Messaging.EventHubs.Producer;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using FluentAssertions;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.Configuration;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Newtonsoft.Json;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Xunit;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Xunit.Abstractions;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace IntegrationTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public record EchoMessage(string Id, string Message, DateTime Timestamp);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class EventHubTest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private readonly ITestOutputHelper _output;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public EventHubTest(ITestOutputHelper output)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _output = output;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [Fact]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public async Task Can_post_message_to_event_hub_and_read_it_back()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // ARRANGE</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var configuration = new ConfigurationBuilder()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .AddEnvironmentVariables()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .Build();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // populated by variables specified in the Azure Pipeline</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var eventhubNamespaceName = configuration[&quot;EVENTHUBNAMESPACENAME&quot;];</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            eventhubNamespaceName.Should().NotBeNull();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var eventhubName = configuration[&quot;EVENTHUBNAME&quot;];</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            eventhubName.Should().NotBeNull();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var tenantId = configuration[&quot;TENANTID&quot;];</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            tenantId.Should().NotBeNull();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // populated as a consequence of the addSpnToEnvironment in the azure-pipelines.yml</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var servicePrincipalId = configuration[&quot;SERVICEPRINCIPALID&quot;];</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            servicePrincipalId.Should().NotBeNull();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var servicePrincipalKey = configuration[&quot;SERVICEPRINCIPALKEY&quot;];</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            servicePrincipalKey.Should().NotBeNull();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var fullyQualifiedNamespace = $&quot;{eventhubNamespaceName}.servicebus.windows.net&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var clientCredential = new ClientSecretCredential(tenantId, servicePrincipalId, servicePrincipalKey);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var eventHubClient = new EventHubProducerClient(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                fullyQualifiedNamespace: fullyQualifiedNamespace,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                eventHubName: eventhubName,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                credential: clientCredential</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var ourGuid = Guid.NewGuid().ToString();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var now = DateTime.UtcNow;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var sentEchoMessage = new EchoMessage(Id: ourGuid, Message: $&quot;Test message&quot;, Timestamp: now);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var sentEventData = new EventData(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                Encoding.UTF8.GetBytes(JsonConvert.SerializeObject(sentEchoMessage))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // ACT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            await eventHubClient.SendAsync(new List&lt;EventData&gt; { sentEventData }, CancellationToken.None);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var eventHubConsumerClient = new EventHubConsumerClient(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                consumerGroup: EventHubConsumerClient.DefaultConsumerGroupName,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                fullyQualifiedNamespace: fullyQualifiedNamespace,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                eventHubName: eventhubName,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                credential: clientCredential</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            List&lt;PartitionEvent&gt; partitionEvents = new();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            await foreach (var partitionEvent in eventHubConsumerClient.ReadEventsAsync(new ReadEventOptions</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                MaximumWaitTime = TimeSpan.FromSeconds(10)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (partitionEvent.Data == null) break;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                _output.WriteLine(Encoding.UTF8.GetString(partitionEvent.Data.EventBody.ToArray()));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                partitionEvents.Add(partitionEvent);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // ASSERT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            partitionEvents.Count.Should().BeGreaterOrEqualTo(1);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var firstOne = partitionEvents.FirstOrDefault(evnt =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              ExtractTypeFromEventBody&lt;EchoMessage&gt;(evnt, _output)?.Id == ourGuid</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var receivedEchoMessage = ExtractTypeFromEventBody&lt;EchoMessage&gt;(firstOne, _output);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            receivedEchoMessage.Should().BeEquivalentTo(sentEchoMessage, because: &quot;the event body should be the same one posted to the message queue&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private static T ExtractTypeFromEventBody&lt;T&gt;(PartitionEvent evnt, ITestOutputHelper _output)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            try</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return JsonConvert.DeserializeObject&lt;T&gt;(Encoding.UTF8.GetString(evnt.Data.EventBody.ToArray()));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            catch (JsonException)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                _output.WriteLine(&quot;[&quot; + Encoding.UTF8.GetString(evnt.Data.EventBody.ToArray()) + &quot;] is probably not JSON&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return default(T);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Let&#x27;s talk through what happens in the test above:</p><ol><li>We read in Event Hub connection configuration for the test from environment variables. (These will be supplied by an Azure Pipeline that we will create shortly.)</li><li>We post a message to the Event Hub.</li><li>We read a message back from the Event Hub.</li><li>We confirm that the message we read back matches the one we posted.</li></ol><p>Now that we have our test, we want to be able to execute it. For that we need an Azure Pipeline!</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="azure-pipeline">Azure Pipeline<a class="hash-link" href="#azure-pipeline" title="Direct link to heading">â€‹</a></h2><p>We&#x27;re going to add an <code>azure-pipelines.yml</code> file which Azure DevOps can use to power a pipeline:</p><div class="codeBlockContainer_J+bg language-yml theme-code-block"><div class="codeBlockContent_csEI yml"><pre tabindex="0" class="prism-code language-yml codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">variables</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> eventHubNamespaceName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> evhns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">demo</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> eventHubName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> evh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">demo</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">pool</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">vmImage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Get Service Principal Id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(serviceConnection)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> bash</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> inlineScript</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">addSpnToEnvironment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        PRINCIPAL_ID=$(az ad sp show --id $servicePrincipalId --query objectId -o tsv)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        echo &quot;##vso[task.setvariable variable=PIPELINE_PRINCIPAL_ID;]$PRINCIPAL_ID&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> az bicep build </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">file infra/main.bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Compile Bicep to ARM&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureResourceManagerTemplateDeployment@3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DeployEventHubInfra</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy Event Hub infra</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">deploymentScope</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">azureResourceManagerConnection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(serviceConnection)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">subscriptionId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(subscriptionId)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Create Or Update Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(azureResourceGroup)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(location)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">templateLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Linked artifact</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">csmFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;infra/main.json&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># created by bash script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">overrideParameters</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">eventHubNamespaceName $(eventHubNamespaceName)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">eventHubName $(eventHubName)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">principalId $(PIPELINE_PRINCIPAL_ID)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">deploymentMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Incremental</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> UseDotNet@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Install .NET SDK 5.0.x&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">packageType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;sdk&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 5.0.x</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dotnet integration test</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(serviceConnection)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> pscore</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> inlineScript</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">addSpnToEnvironment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># allows access to service principal details in script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        cd $(Build.SourcesDirectory)/src/IntegrationTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        dotnet test</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When the pipeline is run, it does the following:</p><ol><li>Gets the service principal id from the service connection.</li><li>Compiles our Bicep into an ARM template</li><li>Deploys the compiled ARM template to Azure</li><li>Installs the dotnet SDK</li><li>Uses the <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/azure-cli?view=azure-devops" target="_blank" rel="noopener noreferrer">Azure CLI task</a> which allows us to access service principal details in the pipeline to run our dotnet test.</li></ol><p>We&#x27;ll create a pipeline in Azure DevOps pointing to this file, and we&#x27;ll also create the variables that it depends upon:</p><ul><li><code>azureResourceGroup</code> - the name of your resource group in Azure where the app will be deployed</li><li><code>location</code> - where your app is deployed, eg <code>northeurope</code></li><li><code>serviceConnection</code> - the name of your AzureRM service connection in Azure DevOps</li><li><code>subscriptionId</code> - your Azure subscription id from the <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer">Azure Portal</a></li><li><code>tenantId</code> - the Azure tenant id from the <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer">Azure Portal</a></li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="running-the-pipeline">Running the pipeline<a class="hash-link" href="#running-the-pipeline" title="Direct link to heading">â€‹</a></h2><p>Now we&#x27;re ready to run our pipeline:</p><p><img alt="screenshot of pipeline running successfully" src="/assets/images/screenshot-azure-pipelines-tests-passing-fc0ce8dfda6f18a707ae21d369ad7f3b.png"></p><p>Here we can see that the pipeline runs and the test passes. That means we&#x27;ve successfully provisioned the Event Hub and permissioned our pipeline to be able to access it using Azure RBAC role assignments. We then wrote a test which used the pipeline credentials to interact with the Event Hub. To see the repo that demostrates this, <a href="https://dev.azure.com/johnnyreilly/blog-demos/_git/permissioning-azure-pipelines-bicep-role-assignments" target="_blank" rel="noopener noreferrer">look here</a>.</p><p>Just to reiterate: we&#x27;ve demonstrated this approach using Event Hubs. This is a generally useful approach which can be applied to any Azure resources that support Azure RBAC Role Assignments.</p><p>Thanks to <a href="https://twitter.com/foldr" target="_blank" rel="noopener noreferrer">Jamie McCrindle</a> for helping out with permissioning the service connection / service principal. <a href="https://foldr.uk/rotating-azure-credentials-in-github-with-terraform" target="_blank" rel="noopener noreferrer">His post on rotating <code>AZURE_CREDENTIALS</code> in GitHub with Terraform</a> provides useful background for those who would like to do similar permissioning using Terraform.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/role-assignments">Role Assignments</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/bicep">Bicep</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/azure-dev-ops">Azure DevOps</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/azure-pipelines">Azure Pipelines</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Permissioning Azure Pipelines with Bicep and Azure RBAC Role Assignments" href="/2021/09/12/permissioning-azure-pipelines-bicep-role-assignments"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/2021/08/19/bicep-syntax-highlighting-with-prismjs">Bicep: syntax highlighting with PrismJS (and Docusaurus)</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-08-19T00:00:00.000Z" itemprop="datePublished">August 19, 2021</time> Â· <!-- -->3 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/assets/images/bicep-syntax-highlighting-with-prismjs-200cd271d33385800a17b554c5c28345.png"><div class="markdown" itemprop="articleBody"><p>Bicep is an amazing language, it&#x27;s also very new. If you want to write attractive code snippets about Bicep, you can by using PrismJS (and Docusaurus). This post shows you how.</p><p><img alt="title image reading &amp;quot;Publish Azure Static Web Apps with Bicep and Azure DevOps&amp;quot; and some Azure logos" src="/assets/images/bicep-syntax-highlighting-with-prismjs-200cd271d33385800a17b554c5c28345.png"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="syntax-highlighting">Syntax highlighting<a class="hash-link" href="#syntax-highlighting" title="Direct link to heading">â€‹</a></h2><p>I&#x27;ve been writing blog posts about Bicep for a little while. I was frustrated that the code snippets were entirely unhighlighted. I&#x27;m keen my posts are as readable as possible, and so I <a href="https://github.com/PrismJS/prism/pull/3027" target="_blank" rel="noopener noreferrer">looked into adding support to PrismJS</a> which is what <a href="https://docusaurus.io/" target="_blank" rel="noopener noreferrer">Docusaurus</a> uses to power syntax highlighting.</p><p>Whilst my regex fu is amateur at best, happily <a href="https://github.com/RunDevelopment" target="_blank" rel="noopener noreferrer">Michael Schmidt</a> of the PrismJS family is considerably better. He took the support I added and <a href="https://github.com/PrismJS/prism/pull/3028" target="_blank" rel="noopener noreferrer">made it much better</a>.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="docusaurus-meet-bicep">Docusaurus meet Bicep<a class="hash-link" href="#docusaurus-meet-bicep" title="Direct link to heading">â€‹</a></h2><p>If you have any code snippets that start with three backticks and the word <code>bicep</code>...</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">```bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// code goes here...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>... then ideally you&#x27;d like to see some syntax highlighting in your post. Since Bicep isn&#x27;t &quot;in the box&quot; for Docusaurus you need to <a href="https://docusaurus.io/docs/next/markdown-features/code-blocks#supported-languages" target="_blank" rel="noopener noreferrer">explicitly opt into support like so:</a></p><div class="codeBlockContainer_J+bg language-js theme-code-block"><div class="codeBlockContent_csEI js"><pre tabindex="0" class="prism-code language-js codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">    prism</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      additionalLanguages</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;powershell&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;csharp&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;docker&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;bicep&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Above you can see a snippet from my own <a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/blob/b2df93efb72adc32d9f45de4f727e890e59a4919/blog-website/docusaurus.config.js#L185" target="_blank" rel="noopener noreferrer"><code>docusaurus.config.js</code></a> which adds Bicep, alongside the other additional languages I use.</p><p>With this in place, you would typically get all the syntax highlighting support you need.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="early-adoption-workaround">Early adoption workaround<a class="hash-link" href="#early-adoption-workaround" title="Direct link to heading">â€‹</a></h2><p>I&#x27;m writing this post before the latest version of PrismJS has shipped. As such, Bicep support isn&#x27;t available by default yet. But if you&#x27;re an early adopter, you can get support right now. The secret is adding a <code>resolutions</code> section to your <code>package.json</code> which points to the GitHub Repo <a href="https://github.com/PrismJS/prism" target="_blank" rel="noopener noreferrer">where Prism lives</a>:</p><div class="codeBlockContainer_J+bg language-json theme-code-block"><div class="codeBlockContent_csEI json"><pre tabindex="0" class="prism-code language-json codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;resolutions&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;prismjs&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;PrismJS/prism&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This will mean that Yarn (if you&#x27;re using Docusaurus you&#x27;re probably using Yarn) pulls <code>prismjs</code> directly from GitHub, as demonstrated by the <code>yarn.lock</code> file:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">prismjs@PrismJS/prism, prismjs@^1.23.0:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  version &quot;1.24.1&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  resolved &quot;https://codeload.github.com/PrismJS/prism/tar.gz/59f449d33dc9fd19302f21aad95fc0b5028ac830&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="what-does-it-look-like">What does it look like?<a class="hash-link" href="#what-does-it-look-like" title="Direct link to heading">â€‹</a></h2><p>Finally, let&#x27;s see if works. Here&#x27;s a Bicep code snippet that I borrowed from <a href="/2021/08/19/bicep-syntax-highlighting-with-prismjs">an earlier post</a>:</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">param repositoryUrl string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param repositoryBranch string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param location string = &#x27;westeurope&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param skuName string = &#x27;Free&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param skuTier string = &#x27;Free&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param appName string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource staticWebApp &#x27;Microsoft.Web/staticSites@2020-12-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: appName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: tagsObj</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name: skuName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    tier: skuTier</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // The provider, repositoryUrl and branch fields are required for successive deployments to succeed</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // for more details see: https://github.com/Azure/static-web-apps/issues/516</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    provider: &#x27;DevOps&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    repositoryUrl: repositoryUrl</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    branch: repositoryBranch</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    buildProperties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      skipGithubActionWorkflowGeneration: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output deployment_token string = listSecrets(staticWebApp.id, staticWebApp.apiVersion).properties.apiKey</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As you can see, it&#x27;s delightfully highlighted by PrismJS. Enjoy!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/bicep">Bicep</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/prism-js">PrismJS</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Bicep: syntax highlighting with PrismJS (and Docusaurus)" href="/2021/08/19/bicep-syntax-highlighting-with-prismjs"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/2021/08/15/bicep-azure-static-web-apps-azure-devops">Publish Azure Static Web Apps with Bicep and Azure DevOps</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-08-15T00:00:00.000Z" itemprop="datePublished">August 15, 2021</time> Â· <!-- -->5 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/assets/images/title-image-db30a378047c9d40f0ec1a9f332ccac9.png"><div class="markdown" itemprop="articleBody"><p>This post demonstrates how to deploy <a href="https://docs.microsoft.com/en-us/azure/static-web-apps/overview" target="_blank" rel="noopener noreferrer">Azure Static Web Apps</a> using Bicep and Azure DevOps. It includes a few workarounds for the <a href="https://github.com/Azure/static-web-apps/issues/516" target="_blank" rel="noopener noreferrer">&quot;Provider is invalid. Cannot change the Provider. Please detach your static site first if you wish to use to another deployment provider.&quot; issue</a>.</p><p><img alt="title image reading &amp;quot;Publish Azure Static Web Apps with Bicep and Azure DevOps&amp;quot; and some Azure logos" src="/assets/images/title-image-db30a378047c9d40f0ec1a9f332ccac9.png"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="bicep-template">Bicep template<a class="hash-link" href="#bicep-template" title="Direct link to heading">â€‹</a></h2><p>The first thing we&#x27;re going to do is create a folder where our Bicep file for deploying our Azure Static Web App will live:</p><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token function" style="color:rgb(130, 170, 255)">mkdir</span><span class="token plain"> infra/static-web-app -p</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Then we&#x27;ll create a <code>main.bicep</code> file:</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">param repositoryUrl string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param repositoryBranch string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param location string = &#x27;westeurope&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param skuName string = &#x27;Free&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param skuTier string = &#x27;Free&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param appName string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource staticWebApp &#x27;Microsoft.Web/staticSites@2020-12-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: appName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name: skuName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    tier: skuTier</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // The provider, repositoryUrl and branch fields are required for successive deployments to succeed</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // for more details see: https://github.com/Azure/static-web-apps/issues/516</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    provider: &#x27;DevOps&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    repositoryUrl: repositoryUrl</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    branch: repositoryBranch</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    buildProperties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      skipGithubActionWorkflowGeneration: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output deployment_token string = listSecrets(staticWebApp.id, staticWebApp.apiVersion).properties.apiKey</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>There&#x27;s some things to draw attention to in the code above:</p><ol><li>The <code>provider</code>, <code>repositoryUrl</code> and <code>branch</code> fields are required for successive deployments to succeed. In our case we&#x27;re deploying via Azure DevOps and so our provider is <code>&#x27;DevOps&#x27;</code>. For more details, <a href="https://github.com/Azure/static-web-apps/issues/516" target="_blank" rel="noopener noreferrer">look at this issue</a>.</li><li>We&#x27;re creating a <code>deployment_token</code> which we&#x27;ll need in order that we can deploy into the Azure Static Web App resource.</li></ol><h2 class="anchor anchorWithStickyNavbar_y2LR" id="static-web-app">Static Web App<a class="hash-link" href="#static-web-app" title="Direct link to heading">â€‹</a></h2><p>In order that we can test out Azure Static Web Apps, what we need is a static web app. You could use pretty much anything here; we&#x27;re going to use Docusaurus. We&#x27;ll execute this single command:</p><div class="codeBlockContainer_J+bg language-bash theme-code-block"><div class="codeBlockContent_csEI bash"><pre tabindex="0" class="prism-code language-bash codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">npx @docusaurus/init@latest init static-web-app classic</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Which will scaffold a Docusaurus site in a folder named <code>static-web-app</code>. We don&#x27;t need to change it any further; let&#x27;s just see if we can deploy it.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="azure-pipeline">Azure Pipeline<a class="hash-link" href="#azure-pipeline" title="Direct link to heading">â€‹</a></h2><p>We&#x27;re going to add an <code>azure-pipelines.yml</code> file which Azure DevOps can use to power a pipeline:</p><div class="codeBlockContainer_J+bg language-yml theme-code-block"><div class="codeBlockContent_csEI yml"><pre tabindex="0" class="prism-code language-yml codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">trigger</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">pool</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">vmImage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">checkout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> self</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">submodules</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> az bicep build </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">file infra/static</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">web</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">app/main.bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Compile Bicep to ARM&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureResourceManagerTemplateDeployment@3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DeployStaticWebAppInfra</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy Static Web App infra</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">deploymentScope</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">azureResourceManagerConnection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(serviceConnection)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">subscriptionId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(subscriptionId)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Create Or Update Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(azureResourceGroup)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(location)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">templateLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Linked artifact</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">csmFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;infra/static-web-app/main.json&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># created by bash script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">overrideParameters</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">repositoryUrl $(repo)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">repositoryBranch $(Build.SourceBranchName)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">appName $(staticWebAppName)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">deploymentMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Incremental</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">deploymentOutputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> deploymentOutputs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> PowerShell@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;SetDeploymentOutputVariables&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Set Deployment Output Variables&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">targetType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> inline</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">script</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        $armOutputObj = &#x27;$(deploymentOutputs)&#x27; | ConvertFrom-Json</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        $armOutputObj.PSObject.Properties | ForEach-Object {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">          $keyname = $_.Name</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">          $value = $_.Value.value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Creates a standard pipeline variable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          Write</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">Output &quot;</span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">##vso[task.setvariable variable=$keyName;issecret=true]$value&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Display keys in pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">Write-Output &quot;output variable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $keyName&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">pwsh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureStaticWebApp@0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DeployStaticWebApp</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy Static Web App</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">app_location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;static-web-app&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># api_location: &#x27;api&#x27; # we don&#x27;t have an API</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">output_location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;build&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">azure_static_web_apps_api_token</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(deployment_token) </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># captured from deploymentOutputs</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When the pipeline is run, it does the following:</p><ol><li>Compiles our Bicep into an ARM template</li><li>Deploys the compiled ARM template to Azure</li><li>Captures the deployment outputs (essentially the <code>deployment_token</code>) and converts them into variables to use in the pipeline</li><li>Deploys our Static Web App using the <code>deployment_token</code></li></ol><p>The pipeline depends upon a number of variables:</p><ul><li><code>azureResourceGroup</code> - the name of your resource group in Azure where the app will be deployed</li><li><code>location</code> - where your app is deployed, eg <code>northeurope</code></li><li><code>repo</code> - the URL of your repository in Azure DevOps, eg <a href="https://dev.azure.com/johnnyreilly/_git/azure-static-web-apps" target="_blank" rel="noopener noreferrer">https://dev.azure.com/johnnyreilly/_git/azure-static-web-apps</a></li><li><code>serviceConnection</code> - the name of your AzureRM service connection in Azure DevOps</li><li><code>staticWebAppName</code> - the name of your static web app, eg <code>azure-static-web-apps-johnnyreilly</code></li><li><code>subscriptionId</code> - your Azure subscription id from the <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer">Azure Portal</a></li></ul><p>A successful pipeline looks something like this:</p><p><img alt="Screenshot of successfully running Azure Pipeline" src="/assets/images/successful-azure-pipelines-run-screenshot-5063d3ceb69f12c033c16b71efc2dc97.png"></p><p>What you might notice is that the <code>AzureStaticWebApp</code> is itself installing and building our application. This is handled by <a href="https://github.com/Microsoft/Oryx" target="_blank" rel="noopener noreferrer">Microsoft Oryx</a>. The upshot of this is that we don&#x27;t need to manually run <code>npm install</code> and <code>npm build</code> ourselves; the <code>AzureStaticWebApp</code> task will take care of it for us.</p><p>Finally, let&#x27;s see if we&#x27;ve deployed something successfully...</p><p><img alt="Screenshot of deployed Azure Static Web App" src="/assets/images/deployed-azure-static-web-app-screenshot-9bf55a1397a8e23a5c7e9d4ce90b5c6c.png"></p><p>We have! It&#x27;s worth noting that you&#x27;ll likely want to give your Azure Static Web App a lovelier URL, and perhaps even put it behind Azure Front Door as well.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="provider-is-invalid-workaround-2"><code>Provider is invalid</code> workaround 2<a class="hash-link" href="#provider-is-invalid-workaround-2" title="Direct link to heading">â€‹</a></h2><p><a href="https://www.linkedin.com/in/shaneneff/" target="_blank" rel="noopener noreferrer">Shane Neff</a> was attempting to follow the instructions in this post and encountered issues. He shared his struggles with me as he encountered the <a href="https://github.com/Azure/static-web-apps/issues/516" target="_blank" rel="noopener noreferrer">&quot;Provider is invalid. Cannot change the Provider. Please detach your static site first if you wish to use to another deployment provider.&quot; issue</a>.</p><p>He was good enough to share his solution as well, which is inserting this task at the start of the pipeline (before the <code>az bicep build</code> step):</p><div class="codeBlockContainer_J+bg language-yml theme-code-block"><div class="codeBlockContent_csEI yml"><pre tabindex="0" class="prism-code language-yml codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;&lt;name of your service connection&gt;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;bash&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;inlineScript&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;az staticwebapp disconnect -n &lt;name of your app&gt;&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>I haven&#x27;t had the problems that Shane has had myself, but I wanted to share his fix for the people out there who almost certainly are bumping on this.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/azure-static-web-app">Azure Static Web App</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/bicep">Bicep</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/azure-dev-ops">Azure DevOps</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/azure-pipelines">Azure Pipelines</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Publish Azure Static Web Apps with Bicep and Azure DevOps" href="/2021/08/15/bicep-azure-static-web-apps-azure-devops"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/2021/07/07/output-connection-strings-and-keys-from-azure-bicep">Output connection strings and keys from Azure Bicep</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-07-07T00:00:00.000Z" itemprop="datePublished">July 7, 2021</time> Â· <!-- -->7 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/assets/images/title-image-0758bbeb6e877b1ae4d85a2321286408.jpg"><div class="markdown" itemprop="articleBody"><p>If we&#x27;re provisioning resources in Azure with Bicep, we may have a need to acquire the connection strings and keys of our newly deployed infrastructure. For example, the connection strings of an event hub or the access keys of a storage account. Perhaps we&#x27;d like to use them to run an end-to-end test, perhaps we&#x27;d like to store these secrets somewhere for later consumption. This post shows how to do that using Bicep and the <code>listKeys</code> helper. Optionally it shows how we could consume this in Azure Pipelines.</p><p>Please note that exporting keys / connection strings etc from Bicep / ARM templates is generally considered to be a less secure approach. This is because these values will be visible inside the deployments section of the Azure Portal. Anyone who has access to this will be able to see them. An alternative approach would be permissioning our pipeline to access the resources directly. You can read about that approach <a href="/2021/09/12/permissioning-azure-pipelines-bicep-role-assignments">here</a>.</p><p><img alt="image which contains the blog title" src="/assets/images/title-image-0758bbeb6e877b1ae4d85a2321286408.jpg"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="event-hub-connection-string">Event Hub connection string<a class="hash-link" href="#event-hub-connection-string" title="Direct link to heading">â€‹</a></h2><p>First of all, let&#x27;s provision an Azure Event Hub. This involves deploying an event hub namespace, an event hub in that namespace and an authorization rule. The following Bicep will do this for us:</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">// Create an event hub namespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var eventHubNamespaceName = &#x27;evhns-demo&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHubNamespace &#x27;Microsoft.EventHub/namespaces@2021-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: eventHubNamespaceName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name: &#x27;Standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    tier: &#x27;Standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    capacity: 1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    zoneRedundant: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Create an event hub inside the namespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var eventHubName = &#x27;evh-demo&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHubNamespaceName_eventHubName &#x27;Microsoft.EventHub/namespaces/eventhubs@2021-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  parent: eventHubNamespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: eventHubName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    messageRetentionInDays: 7</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    partitionCount: 1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Grant Listen and Send on our event hub</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHubNamespaceName_eventHubName_ListenSend &#x27;Microsoft.EventHub/namespaces/eventhubs/authorizationRules@2021-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  parent: eventHubNamespaceName_eventHubName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: &#x27;ListenSend&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    rights: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      &#x27;Listen&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      &#x27;Send&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  dependsOn: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    eventHubNamespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When this is deployed to Azure, it will result in creating something like this:</p><p><img alt="screenshot of event hub connection strings in the Azure Portal" src="/assets/images/event-hub-connection-string-3e5e58b0ef7ac64e48e7dd674d5ec555.png"></p><p>As we can see, there are connection strings available which can be used to access the event hub. How do we get a connection string that we can play with? It&#x27;s easily achieved by appending the following to our Bicep:</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">// Determine our connection string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var eventHubNamespaceConnectionString = listKeys(eventHubNamespaceName_eventHubName_ListenSend.id, eventHubNamespaceName_eventHubName_ListenSend.apiVersion).primaryConnectionString</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Output our variables</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output eventHubNamespaceConnectionString string = eventHubNamespaceConnectionString</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output eventHubName string = eventHubName</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>What we&#x27;re doing here is using the <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/bicep-functions-resource#list" target="_blank" rel="noopener noreferrer"><code>listKeys</code></a> helper on our authorization rule and retrieving the handy <code>primaryConnectionString</code>, which is then exposed as an output variable.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="storage-account-connection-string">Storage Account connection string<a class="hash-link" href="#storage-account-connection-string" title="Direct link to heading">â€‹</a></h2><p>We&#x27;d like to obtain a connection string for a storage account also. Let&#x27;s put together a Bicep file that creates a storage account and a container therein. (Incidentally, it&#x27;s fairly common to have a storage account provisioned alongside an event hub to facilitate reading from an event hub.)</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">// Create a storage account</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var storageAccountName = &#x27;stdemo&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHubNamespaceName_storageAccount &#x27;Microsoft.Storage/storageAccounts@2021-02-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: storageAccountName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name: &#x27;Standard_LRS&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    tier: &#x27;Standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;StorageV2&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    networkAcls: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      bypass: &#x27;AzureServices&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      defaultAction: &#x27;Allow&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    accessTier: &#x27;Hot&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    allowBlobPublicAccess: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    minimumTlsVersion: &#x27;TLS1_2&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    allowSharedKeyAccess: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// create a container inside that storage account</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var blobContainerName = &#x27;test-container&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource storageAccountName_default_containerName &#x27;Microsoft.Storage/storageAccounts/blobServices/containers@2021-02-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: &#x27;${storageAccountName}/default/${blobContainerName}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  dependsOn: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    eventHubNamespaceName_storageAccount</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When this is deployed to Azure, it will result in creating something like this:</p><p><img alt="screenshot of storage account access keys in the Azure Portal" src="/assets/images/storage-account-access-keys-4942555b2271379937b3ea352f064a5d.png"></p><p>Again we can see, there are connection strings available in the Azure Portal, which can be used to access the storage account. However, things aren&#x27;t quite as simple as previously; in that there doesn&#x27;t seem to be a way to directly acquire a connection string. What we can do, is acquire a key; and construct ourselves a connection string with that. Here&#x27;s how:</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">// Determine our connection string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var blobStorageConnectionString = &#x27;DefaultEndpointsProtocol=https;AccountName=${eventHubNamespaceName_storageAccount.name};EndpointSuffix=${environment().suffixes.storage};AccountKey=${listKeys(eventHubNamespaceName_storageAccount.id, eventHubNamespaceName_storageAccount.apiVersion).keys[0].value}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Output our variable</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output blobStorageConnectionString string = blobStorageConnectionString</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output blobContainerName string = blobContainerName</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>If you just wanted to know how to acquire connection strings from Bicep then you can stop now; we&#x27;re done! But if you&#x27;re curious on how the Bicep might connect to <del>the shoulder</del> Azure Pipelines... Read on.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="from-bicep-to-azure-pipelines">From Bicep to Azure Pipelines<a class="hash-link" href="#from-bicep-to-azure-pipelines" title="Direct link to heading">â€‹</a></h2><p>If we put together our snippets above into a single Bicep file it would look like this:</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">// Create an event hub namespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var eventHubNamespaceName = &#x27;evhns-demo&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHubNamespace &#x27;Microsoft.EventHub/namespaces@2021-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: eventHubNamespaceName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name: &#x27;Standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    tier: &#x27;Standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    capacity: 1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    zoneRedundant: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Create an event hub inside the namespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var eventHubName = &#x27;evh-demo&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHubNamespaceName_eventHubName &#x27;Microsoft.EventHub/namespaces/eventhubs@2021-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  parent: eventHubNamespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: eventHubName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    messageRetentionInDays: 7</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    partitionCount: 1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Grant Listen and Send on our event hub</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHubNamespaceName_eventHubName_ListenSend &#x27;Microsoft.EventHub/namespaces/eventhubs/authorizationRules@2021-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  parent: eventHubNamespaceName_eventHubName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: &#x27;ListenSend&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    rights: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      &#x27;Listen&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      &#x27;Send&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  dependsOn: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    eventHubNamespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Create a storage account</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var storageAccountName = &#x27;stdemo&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHubNamespaceName_storageAccount &#x27;Microsoft.Storage/storageAccounts@2021-02-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: storageAccountName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name: &#x27;Standard_LRS&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    tier: &#x27;Standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;StorageV2&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    networkAcls: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      bypass: &#x27;AzureServices&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      defaultAction: &#x27;Allow&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    accessTier: &#x27;Hot&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    allowBlobPublicAccess: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    minimumTlsVersion: &#x27;TLS1_2&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    allowSharedKeyAccess: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// create a container inside that storage account</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var blobContainerName = &#x27;test-container&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource storageAccountName_default_containerName &#x27;Microsoft.Storage/storageAccounts/blobServices/containers@2021-02-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: &#x27;${storageAccountName}/default/${blobContainerName}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  dependsOn: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    eventHubNamespaceName_storageAccount</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Determine our connection strings</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var blobStorageConnectionString       = &#x27;DefaultEndpointsProtocol=https;AccountName=${eventHubNamespaceName_storageAccount.name};EndpointSuffix=${environment().suffixes.storage};AccountKey=${listKeys(eventHubNamespaceName_storageAccount.id, eventHubNamespaceName_storageAccount.apiVersion).keys[0].value}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var eventHubNamespaceConnectionString = listKeys(eventHubNamespaceName_eventHubName_ListenSend.id, eventHubNamespaceName_eventHubName_ListenSend.apiVersion).primaryConnectionString</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Output our variables</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output blobStorageConnectionString string = blobStorageConnectionString</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output blobContainerName string = blobContainerName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output eventHubNamespaceConnectionString string = eventHubNamespaceConnectionString</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output eventHubName string = eventHubName</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This might be consumed in an Azure Pipeline that looks like this:</p><div class="codeBlockContainer_J+bg language-yml theme-code-block"><div class="codeBlockContent_csEI yml"><pre tabindex="0" class="prism-code language-yml codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> az bicep build </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">file infra/our</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">test</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">app/main.bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Compile Bicep to ARM&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureResourceManagerTemplateDeployment@3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DeploySharedInfra</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy Shared ARM Template</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">deploymentScope</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">azureResourceManagerConnection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> parameters.serviceConnection </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">subscriptionId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(subscriptionId)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Create Or Update Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(azureResourceGroup)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(location)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">templateLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Linked artifact</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">csmFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;infra/our-test-app/main.json&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># created by bash script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">deploymentMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Incremental</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">deploymentOutputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> deployOutputs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> PowerShell@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;SetOutputVariables&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Set Output Variables&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">targetType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> inline</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">script</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">      $armOutputObj = &#x27;$(deployOutputs)&#x27; | ConvertFrom-Json</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">      $armOutputObj.PSObject.Properties | ForEach-Object {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        $keyname = $_.Name</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        $value = $_.Value.value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Creates a standard pipeline variable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        Write</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">Output &quot;</span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">##vso[task.setvariable variable=$keyName;]$value&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Creates an output variable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        Write</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">Output &quot;</span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">##vso[task.setvariable variable=$keyName;issecret=true;isOutput=true]$value&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Display keys in pipeline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">Write-Output &quot;output variable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $keyName&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">pwsh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Above we can see:</p><ul><li>the Bicep get compiled to ARM</li><li>the ARM is deployed to Azure, with <code>deploymentOutputs</code> being passed out at the end</li><li>the outputs are turned into secret output variables inside the pipeline (the names of which are printed to the console)</li></ul><p>With the above in place, we now have all of our variables in place; <code>blobStorageConnectionString</code>, <code>blobContainerName</code>, <code>eventHubNamespaceConnectionString</code> and <code>eventHubName</code>. These could now be consumed in whatever way is useful. Consider the following:</p><div class="codeBlockContainer_J+bg language-yml theme-code-block"><div class="codeBlockContent_csEI yml"><pre tabindex="0" class="prism-code language-yml codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> UseDotNet@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Install .NET Core SDK 3.1.x&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">packageType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;sdk&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 3.1.x</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DotNetCoreCLI@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;dotnet run eventhub test&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;run&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;eventhub test --eventHubNamespaceConnectionString &quot;$(eventHubNamespaceConnectionString)&quot; --eventHubName &quot;$(eventHubName)&quot; --blobStorageConnectionString &quot;$(blobStorageConnectionString)&quot; --blobContainerName &quot;$(blobContainerName)&quot;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">workingDirectory</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;$(Build.SourcesDirectory)/OurTestApp&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Here we run a .NET application and pass it our connection strings. Please note, there&#x27;s nothing .NET specific about what we&#x27;re doing above - it could be any kind of application, bash script or similar that consumes our connection strings. The significant thing is that we can acquire connection strings in an automated fashion, for use in whichever manner pleases us.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/bicep">Bicep</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/azure">Azure</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/connection-string">connection string</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/keys">keys</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Output connection strings and keys from Azure Bicep" href="/2021/07/07/output-connection-strings-and-keys-from-azure-bicep"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/2021/06/11/azure-functions-dotnet-5-query-params-di-bicep">Azure Functions and .NET 5: Query params, Dependency Injection, Bicep &amp; Build</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-06-11T00:00:00.000Z" itemprop="datePublished">June 11, 2021</time> Â· <!-- -->4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/assets/images/title-image-25daaeb1b932de6ab532ce2710715904.png"><div class="markdown" itemprop="articleBody"><p>The upgrade of Azure Functions from .NET Core 3.1 to .NET 5 is significant. There&#x27;s an excellent <a href="https://codetraveler.io/2021/05/28/creating-azure-functions-using-net-5/" target="_blank" rel="noopener noreferrer">guide</a> for the general steps required to perform the upgrade. However there&#x27;s a number of (unrelated) items which are not covered by that post:</p><ul><li>Query params</li><li>Dependency Injection</li><li>Bicep</li><li>Build</li></ul><p>This post will show how to tackle these.</p><p><img alt="title image showing name of post and the Azure Functions logo" src="/assets/images/title-image-25daaeb1b932de6ab532ce2710715904.png"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="query-params">Query params<a class="hash-link" href="#query-params" title="Direct link to heading">â€‹</a></h2><p>As part of the move to .NET 5 functions, we say goodbye to <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httprequest?view=aspnetcore-5.0" target="_blank" rel="noopener noreferrer"><code>HttpRequest</code></a> and hello to <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.functions.worker.http.httprequestdata?view=azure-dotnet" target="_blank" rel="noopener noreferrer"><code>HttpRequestData</code></a>. Now <code>HttpRequest</code> had a useful <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httprequest.query?view=aspnetcore-5.0#Microsoft_AspNetCore_Http_HttpRequest_Query" target="_blank" rel="noopener noreferrer"><code>Query</code></a> property which allowed for the simple extraction of query parameters like so.</p><div class="codeBlockContainer_J+bg language-cs theme-code-block"><div class="codeBlockContent_csEI cs"><pre tabindex="0" class="prism-code language-cs codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">var from = req.Query[&quot;from&quot;]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>HttpRequestData</code> has no such property. However, it&#x27;s straightforward to make our own. It&#x27;s simply a matter of using <a href="https://docs.microsoft.com/en-us/dotnet/api/system.web.httputility.parsequerystring?view=net-5.0" target="_blank" rel="noopener noreferrer"><code>System.Web.HttpUtility.ParseQueryString</code></a> on <code>req.Url.Query</code> and using that:</p><div class="codeBlockContainer_J+bg language-cs theme-code-block"><div class="codeBlockContent_csEI cs"><pre tabindex="0" class="prism-code language-cs codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">var query = System.Web.HttpUtility.ParseQueryString(req.Url.Query);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var from = query[&quot;from&quot;]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="dependency-injection-local-development-and-azure-application-settings">Dependency Injection, local development and Azure Application Settings<a class="hash-link" href="#dependency-injection-local-development-and-azure-application-settings" title="Direct link to heading">â€‹</a></h2><p>Dependency Injection is a much more familiar shape in .NET 5 if you&#x27;re familiar with .NET Core web apps. Once again we have a <code>Program.cs</code> file. To get the configuration built in such a way to support both local development and when deployed to Azure, there&#x27;s a few things to do. When deployed to Azure you&#x27;ll likely want to read from Azure Application Settings:</p><p><img alt="screenshot of Azure Application Settings" src="/assets/images/application-settings-96cb3327508d49cdc1956846b487522f.png"></p><p>To tackle both of these, you&#x27;ll want to use <code>AddJsonFile</code> and <code>AddEnvironmentVariables</code> in <code>ConfigureAppConfiguration</code>. A final <code>Program.cs</code> might look something like this:</p><div class="codeBlockContainer_J+bg language-cs theme-code-block"><div class="codeBlockContent_csEI cs"><pre tabindex="0" class="prism-code language-cs codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Threading.Tasks;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.Configuration;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.Hosting;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace MyApp</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class Program</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static Task Main(string[] args)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var host = new HostBuilder()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .ConfigureAppConfiguration(configurationBuilder =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    configurationBuilder</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        .AddCommandLine(args)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        // below is for local development</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        .AddJsonFile(&quot;local.settings.json&quot;, optional: true, reloadOnChange: true)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        // below is what you need to read Application Settings in Azure</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        .AddEnvironmentVariables()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                )</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .ConfigureFunctionsWorkerDefaults()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .ConfigureServices(services =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    services.AddLogging();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    services.AddHttpClient();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                })</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .Build();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return host.RunAsync();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>With this approach in place, when the application runs, it should construct a configuration driven by all the providers required to run our application.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="bicep">Bicep<a class="hash-link" href="#bicep" title="Direct link to heading">â€‹</a></h2><p>When it comes to deploying to Azure via <a href="https://github.com/Azure/bicep" target="_blank" rel="noopener noreferrer">Bicep</a>, there&#x27;s some small tweaks required:</p><ul><li><code>appSettings.FUNCTIONS_WORKER_RUNTIME</code> becomes <code>dotnet-isolated</code></li><li><code>linuxFxVersion</code> becomes <code>DOTNET-ISOLATED|5.0</code></li></ul><p>Applied to the resource itself the diff looks like this:</p><div class="codeBlockContainer_J+bg language-diff theme-code-block"><div class="codeBlockContent_csEI diff"><pre tabindex="0" class="prism-code language-diff codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">resource functionAppName_resource &#x27;Microsoft.Web/sites@2018-11-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> name: functionAppName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> tags: tags_var</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> kind: &#x27;functionapp,linux&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> identity: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   type: &#x27;SystemAssigned&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   serverFarmId: appServicePlanName_resource.id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   siteConfig: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     http20Enabled: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     remoteDebuggingEnabled: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     minTlsVersion: &#x27;1.2&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     appSettings: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">         name: &#x27;FUNCTIONS_EXTENSION_VERSION&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">         value: &#x27;~3&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">         name: &#x27;FUNCTIONS_WORKER_RUNTIME&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56);font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56);font-style:italic">          value: &#x27;dotnet&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">          value: &#x27;dotnet-isolated&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">         name: &#x27;AzureWebJobsStorage&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">         value: &#x27;DefaultEndpointsProtocol=https;AccountName=${storageAccountName};AccountKey=${listKeys(resourceId(&#x27;Microsoft.Storage/storageAccounts&#x27;, storageAccountName), &#x27;2019-06-01&#x27;).keys[0].value};EndpointSuffix=${environment().suffixes.storage}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     connectionStrings: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">         name: &#x27;TableStorageConnectionString&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">         connectionString: &#x27;DefaultEndpointsProtocol=https;AccountName=${storageAccountName};AccountKey=${listKeys(resourceId(&#x27;Microsoft.Storage/storageAccounts&#x27;, storageAccountName), &#x27;2019-06-01&#x27;).keys[0].value};EndpointSuffix=${environment().suffixes.storage}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">       }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgba(239, 83, 80, 0.56);font-style:italic">-</span><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56);font-style:italic">      linuxFxVersion: &#x27;DOTNETCORE|LTS&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token deleted-sign deleted line" style="color:rgba(239, 83, 80, 0.56);font-style:italic"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(173, 219, 103);font-style:italic">+</span><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic">      linuxFxVersion: &#x27;DOTNET-ISOLATED|5.0&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token inserted-sign inserted line" style="color:rgb(173, 219, 103);font-style:italic"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     ftpsState: &#x27;Disabled&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">     managedServiceIdentityId: 1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   clientAffinityEnabled: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">   httpsOnly: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line"> }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token unchanged line"></span><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="building-net-5-functions">Building .NET 5 functions<a class="hash-link" href="#building-net-5-functions" title="Direct link to heading">â€‹</a></h2><p>Before signing off, there&#x27;s one more thing to slip in. When attempting to build .NET 5 Azure Functions with the .NET SDK <em>alone</em>, you&#x27;ll encounter this error:</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">The framework &#x27;Microsoft.NETCore.App&#x27;, version &#x27;3.1.0&#x27; was not found.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Docs on this seem to be pretty short. The closest I came to docs was <a href="https://stackoverflow.com/questions/66938752/net-5-the-framework-microsoft-netcore-app-version-3-1-0-was-not-found/66938753#66938753" target="_blank" rel="noopener noreferrer">this comment on Stack Overflow</a>:</p><blockquote><p>To build .NET 5 functions, the .NET Core 3 SDK is required. So this must be installed alongside the 5.0.x sdk.</p></blockquote><p>So with Azure Pipelines you might have have something that looks like this:</p><div class="codeBlockContainer_J+bg language-yml theme-code-block"><div class="codeBlockContent_csEI yml"><pre tabindex="0" class="prism-code language-yml codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">stages</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">stage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> build</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> build</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">pool</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">vmImage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;ubuntu-latest&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> BuildAndTest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Build and Test&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># we need .NET Core SDK 3.1 too!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> UseDotNet@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Install .NET Core SDK 3.1&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">packageType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;sdk&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 3.1.x</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> UseDotNet@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Install .NET SDK 5.0&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">packageType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;sdk&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 5.0.x</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DotNetCoreCLI@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;function app test&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> test</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DotNetCoreCLI@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;function app build&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> build</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;--configuration Release --output $(Build.ArtifactStagingDirectory)/MyApp&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DotNetCoreCLI@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;function app publish&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> publish</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;--configuration Release --output $(Build.ArtifactStagingDirectory)/MyApp /p:SourceRevisionId=$(Build.SourceVersion)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">publishWebProjects</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">modifyOutputPath</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">zipAfterPublish</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">publish</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(Build.ArtifactStagingDirectory)/MyApp</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">artifact</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> functionapp</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Have fun building .NET 5 functions!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/azure-functions">Azure Functions</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/net-5">.NET 5</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/querystring">querystring</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/query-params">query params</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/dependency-injection">dependency injection</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/bicep">Bicep</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Azure Functions and .NET 5: Query params, Dependency Injection, Bicep &amp; Build" href="/2021/06/11/azure-functions-dotnet-5-query-params-di-bicep"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/2021/04/10/hello-world-bicep">Hello World Bicep</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-04-10T00:00:00.000Z" itemprop="datePublished">April 10, 2021</time> Â· <!-- -->3 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/assets/images/hello-world-bicep-8cc1eb5adf0611f3d44220693bed4915.png"><div class="markdown" itemprop="articleBody"><p>Bicep makes Azure Resource Management a great deal simpler than ARM templates. The selling point here is grokkability. This post takes a look at the <a href="https://github.com/Azure/bicep/pull/2011" target="_blank" rel="noopener noreferrer">&quot;Hello World&quot; example recently added to the Bicep repo</a> to appreciate quite what a difference it makes.</p><p><img alt="hello world bicep" src="/assets/images/hello-world-bicep-8cc1eb5adf0611f3d44220693bed4915.png"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="more-than-configuration">More than configuration<a class="hash-link" href="#more-than-configuration" title="Direct link to heading">â€‹</a></h2><p>The <a href="https://github.com/Azure/bicep/tree/187d4d2047dc83c69695ba79761f552bcb00c319/docs/examples/000/01-hello-world" target="_blank" rel="noopener noreferrer">&quot;Hello World&quot;</a> added to the Bicep repo by <a href="https://github.com/ChristopherGLewis" target="_blank" rel="noopener noreferrer">Chris Lewis</a> illustrates the simplest usage of Bicep:</p><blockquote><p>This bicep file takes a <code>yourName</code> parameter and adds that to a <code>hello</code> variable and returns the concatenated string as an ARM output.</p></blockquote><p>This is, when you consider it, the very essence of a computer program. Taking an input, doing some computation and providing an output. When I think about ARM templates, (and because Bicep is transpiled into ARM templates I mentally bracket the two together) I tend to think about resources being deployed. I focus on <em>configuration</em>, not <em>computation</em></p><p>This is an imperfect mental model. ARM templates can do so much more than deploy by slinging strings and numbers. Thanks to the wealth of <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/template-functions" target="_blank" rel="noopener noreferrer">template functions</a> that exist they have much more power. They can do computation.</p><p>The Hello World example focuses just on computation.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="from-terse-to-verbose">From terse to verbose<a class="hash-link" href="#from-terse-to-verbose" title="Direct link to heading">â€‹</a></h2><p>The Hello World example is made up of two significant files:</p><ol><li><code>main.bicep</code> - the bicep code</li><li><code>main.json</code> - the ARM template compiled from the Bicep file</li></ol><p>The <a href="https://github.com/Azure/bicep/blob/187d4d2047dc83c69695ba79761f552bcb00c319/docs/examples/000/01-hello-world/main.bicep" target="_blank" rel="noopener noreferrer"><code>main.bicep</code></a> file amounts to 3 lines of code (I have omitted the comment line):</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">param yourName string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var hello = &#x27;Hello World! - Hi&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output helloWorld string = &#x27;${hello} ${yourName}&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>the first line takes the <em>input</em> of <code>yourName</code></li><li>the second line declares a <code>hello</code> variable</li><li>the third line <em>computes</em> the new value of <code>helloWorld</code> based upon <code>hello</code> and <code>yourName</code>, then passes it as <em>output</em></li></ul><p>Gosh is it ever simple. It&#x27;s easy to read and it&#x27;s simple to understand. Even if you don&#x27;t know Bicep, if you&#x27;ve experience in another language you can likely guess what&#x27;s happening.</p><p>Let&#x27;s compare this with the <a href="https://github.com/Azure/bicep/blob/187d4d2047dc83c69695ba79761f552bcb00c319/docs/examples/000/01-hello-world/main.json" target="_blank" rel="noopener noreferrer"><code>main.json</code></a> that <code>main.bicep</code> is transpiled into:</p><div class="codeBlockContainer_J+bg language-json theme-code-block"><div class="codeBlockContent_csEI json"><pre tabindex="0" class="prism-code language-json codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;$schema&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;contentVersion&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;1.0.0.0&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;metadata&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;_generator&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;name&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;bicep&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;version&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;dev&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;templateHash&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;6989941473549654446&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;parameters&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;yourName&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;string&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;functions&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;variables&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;hello&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Hello World! - Hi&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;resources&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;outputs&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;helloWorld&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;string&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;[format(&#x27;{0} {1}&#x27;, variables(&#x27;hello&#x27;), parameters(&#x27;yourName&#x27;))]&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The above ARM template expresses exactly the same thing as the Bicep alternative. But that 3 lines of logic has become 27 lines of JSON. We&#x27;ve lost something in the transition. Intent is no longer clear. We&#x27;ve gone from something easy to reason about, to something that is hard to reason about. You need to think a lot less to write the Bicep alternative and that&#x27;s a <em>good</em> thing.</p><p>I was chatting to someone recently who expressed it well by saying:</p><blockquote><p>ARM is the format that the resource providers understand, so really itâ€™s the Azure equivalent of Assembler â€“ and I donâ€™t know anyone who enjoys coding in Assembler.</p></blockquote><p>This is a great example of the value that Bicep provides. If you&#x27;d like to play with the Hello World a little, why not <a href="https://aka.ms/bicepdemo#eJzT1w9OzC3ISVXISM3JyVcozy/KSeEqSCxKzFWozC8t8kvMTVUoLinKzEvnKkssgqqyVVD3ADPCQcoVFXQVPDLVubjyS0sKSksgasAyUJ0g9SrVYOFaBZVqmLm16gCvlitr" target="_blank" rel="noopener noreferrer">take it for a spin in the Bicep playground</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/bicep">Bicep</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/arm-templates">ARM templates</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Hello World Bicep" href="/2021/04/10/hello-world-bicep"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/2021/03/23/bicep-meet-azure-pipelines-2">Bicep meet Azure Pipelines 2</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-03-23T00:00:00.000Z" itemprop="datePublished">March 23, 2021</time> Â· <!-- -->2 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/assets/images/bicep-meet-azure-pipelines-be44cb8e6656c7e7a9bc5d7e7f1ecf28.png"><div class="markdown" itemprop="articleBody"><p><a href="/2021/03/20/bicep-meet-azure-pipelines">Last time</a> I wrote about how to use the Azure CLI to run Bicep within the context of an Azure Pipeline. The solution was relatively straightforward, and involved using <code>az deployment group create</code> in a task. There&#x27;s an easier way.</p><p><img alt="Bicep meet Azure Pipelines" src="/assets/images/bicep-meet-azure-pipelines-be44cb8e6656c7e7a9bc5d7e7f1ecf28.png"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="the-easier-way">The easier way<a class="hash-link" href="#the-easier-way" title="Direct link to heading">â€‹</a></h2><p>The target reader of the previous post was someone who was already using <code>AzureResourceManagerTemplateDeployment@3</code> in an Azure Pipeline to deploy an ARM template. Rather than replacing your existing <code>AzureResourceManagerTemplateDeployment@3</code> tasks, all you need do is insert a prior <code>bash</code> step that compiles the Bicep to ARM, which your existing template can then process. It looks like this:</p><div class="codeBlockContainer_J+bg language-yml theme-code-block"><div class="codeBlockContent_csEI yml"><pre tabindex="0" class="prism-code language-yml codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> az bicep build </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">file infra/app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service/azuredeploy.bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Compile Bicep to ARM&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This will take your Bicep template of <code>azuredeploy.bicep</code>, transpile it into an ARM template named <code>azuredeploy.json</code> which a subsequent <code>AzureResourceManagerTemplateDeployment@3</code> task can process. Since this is just exercising the Azure CLI, using <code>bash</code> is not required; powershell etc would also be fine; it&#x27;s just required that the Azure CLI is available in a pipeline.</p><p>In fact this simple task could even be a one-liner if you didn&#x27;t fancy using the <code>displayName</code>. (Though I say keep it; optimising for readability is generally a good shout.) A full pipeline could look like this:</p><div class="codeBlockContainer_J+bg language-yml theme-code-block"><div class="codeBlockContent_csEI yml"><pre tabindex="0" class="prism-code language-yml codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> az bicep build </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">file infra/app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service/azuredeploy.bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Compile Bicep to ARM&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureResourceManagerTemplateDeployment@3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Deploy Hello Azure ARM&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">azureResourceManagerConnection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;$(azureSubscription)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Create Or Update Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;$(resourceGroupName)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;North Europe&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">templateLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Linked artifact</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">csmFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;infra/app-service/azuredeploy.json&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># created by bash script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">csmParametersFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;infra/app-service/azuredeploy.parameters.json&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">deploymentMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Incremental</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">deploymentOutputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> resourceGroupDeploymentOutputs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">overrideParameters</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">applicationName $(Build.Repository.Name)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">pwsh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">    $outputs = ConvertFrom-Json &#x27;$(resourceGroupDeploymentOutputs)&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">    foreach ($output in $outputs.PSObject.Properties) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        Write-Host &quot;##vso[task.setvariable variable=RGDO_$($output.Name)]$($output.Value.value)&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">    }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Turn ARM outputs into variables&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>And when it&#x27;s run, it may result in something along these lines:</p><p><img alt="Bicep in an Azure Pipeline" src="/assets/images/azure-pipeline-with-bicep-b8185cc3c548beb2e07c11ed6f7b5bfa.png"></p><p>So if you want to get using Bicep right now with minimal effort, this an on ramp that could work for you! Props to <a href="https://twitter.com/foldr" target="_blank" rel="noopener noreferrer">Jamie McCrindle</a> for suggesting this.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/bicep">Bicep</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/arm-templates">ARM templates</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/azure-pipelines">Azure Pipelines</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/azure-cli">Azure CLI</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Bicep meet Azure Pipelines 2" href="/2021/03/23/bicep-meet-azure-pipelines-2"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/2021/03/20/bicep-meet-azure-pipelines">Bicep meet Azure Pipelines</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-03-20T00:00:00.000Z" itemprop="datePublished">March 20, 2021</time> Â· <!-- -->5 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/assets/images/bicep-meet-azure-pipelines-be44cb8e6656c7e7a9bc5d7e7f1ecf28.png"><div class="markdown" itemprop="articleBody"><p><a href="https://github.com/Azure/bicep" target="_blank" rel="noopener noreferrer">Bicep</a> is a terser and more readable alternative language to ARM templates. Running ARM templates in Azure Pipelines is straightforward. However, there isn&#x27;t yet a first class experience for running Bicep in Azure Pipelines. This post demonstrates an approach that can be used until a Bicep task is available.</p><p><img alt="Bicep meet Azure Pipelines" src="/assets/images/bicep-meet-azure-pipelines-be44cb8e6656c7e7a9bc5d7e7f1ecf28.png"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="bicep-mostly-armless">Bicep: mostly ARMless<a class="hash-link" href="#bicep-mostly-armless" title="Direct link to heading">â€‹</a></h2><p>If you&#x27;ve been working with Azure and infrastructure as code, you&#x27;ll likely have encountered <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview" target="_blank" rel="noopener noreferrer">ARM templates</a>. They&#x27;re a domain specific language that lives inside JSON, used to define the infrastructure that is deployed to Azure; App Services, Key Vaults and the like.</p><p>ARM templates are quite verbose and not the easiest thing to read. This is a consequence of being effectively a language nestled inside another language. Bicep is an alternative language which is far more readable. Bicep transpiles down to ARM templates, in the same way that TypeScript transpiles down to JavaScript.</p><p>Bicep is quite new, but already it enjoys feature parity with ARM templates (as of <a href="https://github.com/Azure/bicep/releases/tag/v0.3.1" target="_blank" rel="noopener noreferrer">v0.3</a>) and ships as part of the <a href="https://github.com/MicrosoftDocs/azure-docs-cli/blob/master/docs-ref-conceptual/release-notes-azure-cli/index.md#arm-1" target="_blank" rel="noopener noreferrer">Azure CLI</a>. However, as Bicep is new, it doesn&#x27;t yet have a dedicated Azure Pipelines task for deployment. This should exist in future, perhaps as soon as the <a href="https://github.com/Azure/bicep/issues/1341" target="_blank" rel="noopener noreferrer">v0.4 release</a>. In the meantime there&#x27;s an alternative way to achieve this which we&#x27;ll go through.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="app-service-with-bicep">App Service with Bicep<a class="hash-link" href="#app-service-with-bicep" title="Direct link to heading">â€‹</a></h2><p>Let&#x27;s take a simple Bicep file, <code>azuredeploy.bicep</code>, which is designed to deploy an App Service resource to Azure. It looks like this:</p><div class="codeBlockContainer_J+bg language-bicep theme-code-block"><div class="codeBlockContent_csEI bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Tags that our resources need&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param tags object = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  costCenter: &#x27;todo: replace&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  environment: &#x27;todo: replace&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  application: &#x27;todo: replace with app name&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  description: &#x27;todo: replace&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  managedBy: &#x27;ARM&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@minLength(2)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Base name of the resource such as web app name and app service plan&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param applicationName string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Location for all resources.&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param location string = resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;The SKU of App Service Plan&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param sku string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var appServicePlanName_var = &#x27;plan-${applicationName}-${tags.environment}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var linuxFxVersion = &#x27;DOTNETCORE|5.0&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var fullApplicationName_var = &#x27;app-${applicationName}-${uniqueString(applicationName)}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource appServicePlanName &#x27;Microsoft.Web/serverfarms@2019-08-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: appServicePlanName_var</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name: sku</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;linux&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    CostCenter: tags.costCenter</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Environment: tags.environment</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Description: tags.description</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ManagedBy: tags.managedBy</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    reserved: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource fullApplicationName &#x27;Microsoft.Web/sites@2018-11-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: fullApplicationName_var</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;app&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    CostCenter: tags.costCenter</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Environment: tags.environment</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Description: tags.description</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ManagedBy: tags.managedBy</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    serverFarmId: appServicePlanName.id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    clientAffinityEnabled: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    siteConfig: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      appSettings: []</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      linuxFxVersion: linuxFxVersion</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      alwaysOn: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ftpsState: &#x27;Disabled&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      http20Enabled: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      minTlsVersion: &#x27;1.2&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      remoteDebuggingEnabled: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    httpsOnly: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  identity: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    type: &#x27;SystemAssigned&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output fullApplicationName string = fullApplicationName_var</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When transpiled down to an ARM template, this Bicep file more than doubles in size:</p><ul><li><code>azuredeploy.bicep</code> - 1782 bytes</li><li><code>azuredeploy.json</code> - 3863 bytes</li></ul><p>This tells you something of the advantage of Bicep. The template comes with an associated <code>azuredeploy.parameters.json</code> file:</p><div class="codeBlockContainer_J+bg language-json theme-code-block"><div class="codeBlockContent_csEI json"><pre tabindex="0" class="prism-code language-json codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;$schema&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;contentVersion&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;1.0.0.0&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;parameters&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;tags&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;costCenter&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;8888&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;environment&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;stg&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;application&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;hello-azure&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;description&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;App Service for hello-azure&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;managedBy&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;ARM&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;sku&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;B1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>It&#x27;s worth remembering that you can use the same parameters files with Bicep that you can use with ARM templates. This is great for minimising friction when it comes to migrating.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="bicep-in-azure-pipelinesyml">Bicep in <code>azure-pipelines.yml</code><a class="hash-link" href="#bicep-in-azure-pipelinesyml" title="Direct link to heading">â€‹</a></h2><p>Now we have our Bicep file, we want to execute it from the context of an Azure Pipeline. If we were working directly with the ARM template we&#x27;d likely have something like this in place:</p><div class="codeBlockContainer_J+bg language-yml theme-code-block"><div class="codeBlockContent_csEI yml"><pre tabindex="0" class="prism-code language-yml codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureResourceManagerTemplateDeployment@3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Deploy Hello Azure ARM&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">azureResourceManagerConnection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;$(azureSubscription)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Create Or Update Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;$(resourceGroupName)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;North Europe&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">templateLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Linked artifact</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">csmFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;infra/app-service/azuredeploy.json&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">csmParametersFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;infra/app-service/azuredeploy.parameters.json&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">deploymentMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Incremental</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">deploymentOutputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> resourceGroupDeploymentOutputs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">overrideParameters</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">applicationName $(Build.Repository.Name)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">pwsh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">    $outputs = ConvertFrom-Json &#x27;$(resourceGroupDeploymentOutputs)&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">    foreach ($output in $outputs.PSObject.Properties) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        Write-Host &quot;##vso[task.setvariable variable=RGDO_$($output.Name)]$($output.Value.value)&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">    }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Turn ARM outputs into variables&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>There&#x27;s two tasks above. The first is the native task for ARM deployments which takes our ARM template and our parameters and deploys them. The second task takes the output variables from the first task and converts them into Azure Pipeline variables such that they can be referenced later in the pipeline. In this case this variablifies our <code>fullApplicationName</code> output.</p><p>There is, as yet, no <code>BicepTemplateDeployment@1</code>. <a href="https://github.com/Azure/bicep/issues/1341" target="_blank" rel="noopener noreferrer">Though it&#x27;s coming</a>. In the meantime, the marvellous <a href="https://twitter.com/adotfrank" target="_blank" rel="noopener noreferrer">Alex Frankel</a> <a href="https://github.com/Azure/bicep/issues/1341#issuecomment-802010110" target="_blank" rel="noopener noreferrer">advised</a>:</p><blockquote><p>I&#x27;d recommend using the <a href="https://docs.microsoft.com/azure/devops/pipelines/tasks/deploy/azure-cli?view=azure-devops" target="_blank" rel="noopener noreferrer">Azure CLI task</a> to deploy. As long as that task is updated to Az CLI version 2.20 or later, it will automatically install the bicep CLI when calling <code>az deployment group create -f main.bicep</code>.</p></blockquote><p>Let&#x27;s give it a go!</p><div class="codeBlockContainer_J+bg language-yml theme-code-block"><div class="codeBlockContent_csEI yml"><pre tabindex="0" class="prism-code language-yml codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Deploy Hello Azure Bicep&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;$(azureSubscription)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> bash</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> inlineScript</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">      az --version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      echo &quot;az deployment group create </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">resource</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">group &#x27;$(resourceGroupName)&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">name appservicedeploy&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      az deployment group create </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">resource</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">group &#x27;$(resourceGroupName)&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">name appservicedeploy \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">template</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">file infra/app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service/azuredeploy.bicep \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">parameters infra/app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service/azuredeploy.parameters.json \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">parameters applicationName=&#x27;$(Build.Repository.Name)&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      echo &quot;az deployment group show </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">resource</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">group &#x27;$(resourceGroupName)&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">name appservicedeploy&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      deploymentoutputs=$(az deployment group show </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">resource</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">group &#x27;$(resourceGroupName)&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">name appservicedeploy \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">query properties.outputs)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      echo &#x27;convert outputs to variables&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      echo $deploymentoutputs </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> jq </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">c &#x27;. </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> to_entries</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">.key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> .value.value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        while IFS=$&quot;\n&quot; read </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">r c; do</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          outputname=$(echo &quot;$c&quot; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> jq </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">r &#x27;.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          outputvalue=$(echo &quot;$c&quot; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> jq </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">r &#x27;.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          echo &quot;setting variable RGDO_$outputname=$outputvalue&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          echo &quot;</span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">##vso[task.setvariable variable=RGDO_$outputname]$outputvalue&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        done</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The above is just a single Azure CLI task (as advised). It invokes <code>az deployment group create</code> passing the relevant parameters. It then acquires the output properties using <code>az deployment group show</code>. Finally it once again converts these outputs to Azure Pipeline variables with some <a href="https://stedolan.github.io/jq/" target="_blank" rel="noopener noreferrer"><code>jq</code></a> smarts.</p><p>This works right now, and running it results in something like the output below. So if you&#x27;re excited about Bicep and don&#x27;t want to wait for 0.4 to start moving on this, then this can get you going. To track the progress of the custom task, <a href="https://github.com/Azure/bicep/issues/1341" target="_blank" rel="noopener noreferrer">keep an eye on this issue</a>.</p><p><img alt="Bicep in an Azure Pipeline" src="/assets/images/bicep-in-a-pipeline-d4e71abc6bdf587b3877ba5d53dcdd25.png"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="update-an-even-simpler-alternative">Update: an even simpler alternative<a class="hash-link" href="#update-an-even-simpler-alternative" title="Direct link to heading">â€‹</a></h2><p>There is even a simpler way to do this which I discovered subsequent to writing this. <a href="/2021/03/23/bicep-meet-azure-pipelines-2">Have a read</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/bicep">Bicep</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/arm-templates">ARM templates</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/azure-pipelines">Azure Pipelines</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/azure-cli">Azure CLI</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Bicep meet Azure Pipelines" href="/2021/03/20/bicep-meet-azure-pipelines"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a83f38a5.js"></script>
<script src="/assets/js/main.e22f0193.js"></script>
</body>
</html>