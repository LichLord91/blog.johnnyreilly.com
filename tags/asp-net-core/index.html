<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#3578e5">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">8 posts tagged with &quot;ASP.Net Core&quot; | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="8 posts tagged with &quot;ASP.Net Core&quot; | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/tags/asp-net-core"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-react-helmet="true" name="robots" content="max-image-preview:large"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/tags/asp-net-core"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/asp-net-core" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/asp-net-core" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.58376e75.css">
<link rel="preload" href="/assets/js/runtime~main.699d7d58.js" as="script">
<link rel="preload" href="/assets/js/main.f167c9f1.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://polywork.johnnyreilly.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Polywork<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/12/19/azure-container-apps-bicep-and-github-actions">Azure Container Apps, Bicep and GitHub Actions</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/12/12/open-graph-sharing-previews-guide">Open Graph: a guide to sharable social media previews</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/12/05/azure-static-web-app-deploy-previews-with-azure-devops">Azure Static Web App Deploy Previews with Azure DevOps</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/22/typescript-vs-jsdoc-javascript">TypeScript vs JSDoc JavaScript</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/18/azure-standard-tests-with-bicep">Azure standard availability tests with Bicep</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>8 posts tagged with &quot;ASP.Net Core&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2020/05/21/autofac-webapplicationfactory-integration-tests">Autofac, WebApplicationFactory and integration tests</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2020-05-21T00:00:00.000Z" itemprop="datePublished">May 21, 2020</time> Â· <!-- -->4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/assets/images/autofac-webapplicationfactory-tests-7c8017cf9919642beee16f4f9b5a59b3.png"><div class="markdown" itemprop="articleBody"><p><strong>Updated 2nd Oct 2020:</strong> <em>for an approach that works with Autofac 6 and <code>ConfigureTestContainer</code> see <a href="/2020/10/02/autofac-6-integration-tests-and-generic-hosting">this post</a>.</em></p><p><img alt="A title image for the blog featuring the Autofac logo" src="/assets/images/autofac-webapplicationfactory-tests-7c8017cf9919642beee16f4f9b5a59b3.png"></p><p>This is one of those occasions where I&#x27;m not writing up my own work so much as my discovery after in depth googling.</p><p>Integration tests with ASP.NET Core are the best. They spin up an in memory version of your application and let you fire requests at it. They&#x27;ve gone through a number of iterations since ASP.NET Core has been around. You may also be familiar with the <code>TestServer</code> approach of earlier versions. For some time, the advised approach has been using <a href="https://docs.microsoft.com/en-us/aspnet/core/test/integration-tests?view=aspnetcore-3.1#basic-tests-with-the-default-webapplicationfactory" target="_blank" rel="noopener noreferrer"><code>WebApplicationFactory</code></a>.</p><p>What makes this approach particularly useful / powerful is that you can swap out dependencies of your running app with fakes / stubs etc. Just like unit tests! But potentially more useful because they run your whole app and hence give you a greater degree of confidence. What does this mean? Well, imagine you changed a piece of middleware in your application; this could potentially break functionality. Unit tests would probably not reveal this. Integration tests would.</p><p>There is a fly in the ointment. A hair in the gazpacho. ASP.NET Core ships with dependency injection in the box. It has its own Inversion of Control container which is perfectly fine. However, many people are accustomed to using other IOC containers such as <a href="https://autofac.org/" target="_blank" rel="noopener noreferrer">Autofac</a>.</p><p>What&#x27;s the problem? Well, swapping out dependencies registered using ASP.NET Core&#x27;s IOC requires using a hook called <a href="https://docs.microsoft.com/en-us/aspnet/core/test/integration-tests?view=aspnetcore-3.1#inject-mock-services" target="_blank" rel="noopener noreferrer"><code>ConfigureTestServices</code></a>. There&#x27;s an equivalent hook for swapping out services registered using a custom IOC container: <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.testhost.webhostbuilderextensions.configuretestcontainer?view=aspnetcore-3.0" target="_blank" rel="noopener noreferrer"><code>ConfigureTestContainer</code></a>. Unfortunately, there is a bug in ASP.NET Core as of version 3.0: <a href="https://github.com/dotnet/aspnetcore/issues/14907" target="_blank" rel="noopener noreferrer">When using GenericHost, in tests <code>ConfigureTestContainer</code> is not executed</a></p><p>This means you cannot swap out dependencies that have been registered with Autofac and the like. According to the tremendous <a href="https://www.twitter.com/davidfowl" target="_blank" rel="noopener noreferrer">David Fowler</a> of the ASP.NET team, <a href="https://github.com/dotnet/aspnetcore/issues/14907#issuecomment-592102145" target="_blank" rel="noopener noreferrer">this will hopefully be resolved</a>.</p><p>In the meantime, <a href="https://github.com/dotnet/aspnetcore/issues/14907#issuecomment-620750841" target="_blank" rel="noopener noreferrer">there&#x27;s a workaround thanks to various commenters on the thread</a>. Instead of using <code>WebApplicationFactory</code> directly, subclass it and create a custom <code>AutofacWebApplicationFactory</code> (the name is not important). This custom class overrides the behavior of <code>ConfigureServices</code> and <code>CreateHost</code> with a <code>CustomServiceProviderFactory</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace My.Web.Tests.Helpers {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// Based upon https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/test/integration-tests/samples/3.x/IntegrationTestsSample</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// &lt;typeparam name=&quot;TStartup&quot;&gt;&lt;/typeparam&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class AutofacWebApplicationFactory&lt;TStartup&gt; : WebApplicationFactory&lt;TStartup&gt; where TStartup : class {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        protected override void ConfigureWebHost(IWebHostBuilder builder) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            builder.ConfigureServices(services =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    services.AddSingleton&lt;IAuthorizationHandler&gt;(new PassThroughPermissionedRolesHandler());</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                })</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .ConfigureTestServices(services =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                }).ConfigureTestContainer&lt;Autofac.ContainerBuilder&gt;(builder =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    // called after Startup.ConfigureContainer</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        protected override IHost CreateHost(IHostBuilder builder) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            builder.UseServiceProviderFactory(new CustomServiceProviderFactory());</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return base.CreateHost(builder);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// Based upon https://github.com/dotnet/aspnetcore/issues/14907#issuecomment-620750841 - only necessary because of an issue in ASP.NET Core</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class CustomServiceProviderFactory : IServiceProviderFactory&lt;CustomContainerBuilder&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public CustomContainerBuilder CreateBuilder(IServiceCollection services) =&gt; new CustomContainerBuilder(services);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IServiceProvider CreateServiceProvider(CustomContainerBuilder containerBuilder) =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        new AutofacServiceProvider(containerBuilder.CustomBuild());</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class CustomContainerBuilder : Autofac.ContainerBuilder {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private readonly IServiceCollection services;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public CustomContainerBuilder(IServiceCollection services) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            this.services = services;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            this.Populate(services);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public Autofac.IContainer CustomBuild() {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var sp = this.services.BuildServiceProvider();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#pragma warning disable CS0612 // Type or member is obsolete</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var filters = sp.GetRequiredService&lt;IEnumerable&lt;IStartupConfigureContainerFilter&lt;Autofac.ContainerBuilder&gt;&gt;&gt;();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#pragma warning restore CS0612 // Type or member is obsolete</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            foreach (var filter in filters) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                filter.ConfigureContainer(b =&gt; { }) (this);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return this.Build();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>I&#x27;m going to level with you; I don&#x27;t understand all of this code. I&#x27;m not au fait with the inner workings of ASP.NET Core or Autofac but I can tell you what this allows. With this custom <code>WebApplicationFactory</code> in play you get <code>ConfigureTestContainer</code> back in the mix! You get to write code like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Net;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Net.Http.Headers;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Threading.Tasks;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using FakeItEasy;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using FluentAssertions;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.AspNetCore.TestHost;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Xunit;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.Options;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Autofac;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Net.Http;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Newtonsoft.Json;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace My.Web.Tests.Controllers</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class MyControllerTests : IClassFixture&lt;AutofacWebApplicationFactory&lt;My.Web.Startup&gt;&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private readonly AutofacWebApplicationFactory&lt;My.Web.Startup&gt; _factory;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public MyControllerTests(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            AutofacWebApplicationFactory&lt;My.Web.Startup&gt; factory</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        ) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _factory = factory;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [Fact]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public async Task My() {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var fakeSomethingService = A.Fake&lt;IMySomethingService&gt;();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var fakeConfig = Options.Create(new MyConfiguration {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                SomeConfig = &quot;Important thing&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                OtherConfigMaybeAnEmailAddress = &quot;johnny_reilly@hotmail.com&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            A.CallTo(() =&gt; fakeSomethingService.DoSomething(A&lt;string&gt;.Ignored))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .Returns(Task.FromResult(true));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            void ConfigureTestServices(IServiceCollection services) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                services.AddSingleton(fakeConfig);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            void ConfigureTestContainer(ContainerBuilder builder) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                builder.RegisterInstance(fakeSomethingService);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var client = _factory</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .WithWebHostBuilder(builder =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    builder.ConfigureTestServices(ConfigureTestServices);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    builder.ConfigureTestContainer&lt;Autofac.ContainerBuilder&gt;(ConfigureTestContainer);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                })</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .CreateClient();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // Act</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var request = StringContent(&quot;{\&quot;sommat\&quot;:\&quot;to see\&quot;}&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            request.Headers.ContentType = MediaTypeHeaderValue.Parse(&quot;application/json&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var response = await client.PostAsync(&quot;/something/submit&quot;, request);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // Assert</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            response.StatusCode.Should().Be(HttpStatusCode.OK);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            A.CallTo(() =&gt; fakeSomethingService.DoSomething(A&lt;string&gt;.Ignored))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .MustHaveHappened();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/autofac">autofac</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/web-application-factory">WebApplicationFactory</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/asp-net-core">ASP.Net Core</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/configure-test-container">ConfigureTestContainer</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/integration-testing">Integration Testing</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Autofac, WebApplicationFactory and integration tests" href="/2020/05/21/autofac-webapplicationfactory-integration-tests"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2020/04/04/up-to-clouds">Up to the clouds!</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2020-04-04T00:00:00.000Z" itemprop="datePublished">April 4, 2020</time> Â· <!-- -->11 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This last four months has been quite the departure for me. Most typically I find myself building applications; for this last period of time I&#x27;ve been taking the platform that I work on, and been migrating it from running on our on premise servers to running in the cloud.</p><p>This turned out to be much more difficult than I&#x27;d expected and for reasons that often surprised me. We knew where we wanted to get to, but not all of what we&#x27;d need to do to get there. So many things you can only learn by doing. Whilst these experiences are still fresh in my mind I wanted to document some of the challenges we faced.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="the-mission">The mission<a aria-hidden="true" class="hash-link" href="#the-mission" title="Direct link to heading">â€‹</a></h2><p>At the start of January, the team decided to make a concerted effort to take our humble ASP.NET Core application and migrate it to the cloud. We sat down with some friends from the DevOps team who are part of our organisation. We&#x27;re fortunate in that these marvellous people are very talented engineers indeed. It was going to be a collaboration between our two teams of budding cloudmongers that would make this happen.</p><p>Now our application is young. It is not much more than a year old. However it is growing <em>fast</em>. And as we did the migration from on premise to the cloud, that wasn&#x27;t going to stop. Development of the application was to continue as is, shipping new versions daily. Without impeding that, we were to try and get the application migrated to the cloud.</p><p>I would liken it to boarding a speeding train, fighting your way to the front, taking the driver hostage and then diverting the train onto a different track. It was challenging. Really, really challenging.</p><p>So many things had to change for us to get from on premise servers to the cloud, all the while keeping our application a going (and shipping) concern. Let&#x27;s go through them one by one.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="kubernetes-and-docker">Kubernetes and Docker<a aria-hidden="true" class="hash-link" href="#kubernetes-and-docker" title="Direct link to heading">â€‹</a></h2><p>Our application was built using ASP.NET Core. A technology that is entirely cloud friendly (that&#x27;s one of the reasons we picked it). We were running on a collection of hand installed, hand configured Windows servers. That had to change. We wanted to move our application to run on Kubernetes; so we didn&#x27;t have to manually configure servers. Rather k8s would manage the provisioning and deployment of containers running our application. Worth saying now: I knew <em>nothing</em> about Kubernetes. Or nearly nothing. I learned a bunch along the way, but, as I&#x27;ve said, this was a collaboration between our team and the mighty site reliability engineers of the DevOps team. They knew a <em>lot</em> about this k8s stuff and moreoften than not, our team stood back and let them work their magic.</p><p>In order that we could migrate to running in k8s, we first needed to containerise our application. We needed a <code>Dockerfile</code>. There followed a good amount of experimentation as we worked out how to build ourselves images. There&#x27;s an art to building an optimal Docker image.</p><p>So that we can cover a lot of ground, this post will remain relatively high level. So here&#x27;s a number of things that we encountered along the way that are worth considering:</p><ul><li>Multi-stage builds were an absolute necessity for us. We&#x27;d build the front end of our app (React / TypeScript) using one stage with a <a href="https://hub.docker.com/_/node" target="_blank" rel="noopener noreferrer">Node base image</a>. Then we&#x27;d build our app using a <a href="https://hub.docker.com/_/microsoft-dotnet-core-sdk/" target="_blank" rel="noopener noreferrer">.NET Core SDK base image</a>. Finally, we&#x27;d use a <a href="https://hub.docker.com/_/microsoft-dotnet-core-aspnet" target="_blank" rel="noopener noreferrer">ASP.Net</a> image to run the app; copying in the output of previous stages.</li><li>Our application accesses various SQL Server databases. We struggled to get our application to connect to them. The issue related to the SSL configuration of our runner image. The fix was simple but frustrating; use a <code>-bionic</code> image as it has the configuration you need. We found that gem <a href="https://github.com/dotnet/SqlClient/issues/222#issuecomment-535802822" target="_blank" rel="noopener noreferrer">here</a>.</li><li>Tests. Automated tests. We want to run them in our build; but how? Once more multi-stage builds to the rescue. We&#x27;d build our application, then in a separate stage we&#x27;d run the tests; copying in the app from the build stage. If the tests failed, the build failed. If they passed then the intermediate stage containing the tests would be discarded by Docker. No unnecessary bloat of the image; all that testing goodness still; now in containerised form!</li></ul><h2 class="anchor anchorWithStickyNavbar_31ik" id="jenkins">Jenkins<a aria-hidden="true" class="hash-link" href="#jenkins" title="Direct link to heading">â€‹</a></h2><p>Our on premise world used TeamCity for our continuous integration needs and Octopus for deployment. We liked these tools well enough; particularly Octopus. However, the DevOps team were very much of the mind that we should be use Jenkins instead. And <a href="https://jenkins.io/doc/book/pipeline/" target="_blank" rel="noopener noreferrer">Pipeline</a>. It was here that we initially struggled. To quote the docs:</p><blockquote><p>Jenkins Pipeline (or simply &quot;Pipeline&quot; with a capital &quot;P&quot;) is a suite of plugins which supports implementing and integrating continuous delivery pipelines into Jenkins.</p></blockquote><p>Whilst continuous delivery is super cool, and is something our team was interested in, we weren&#x27;t ready for it yet. We didn&#x27;t yet have the kind of automated testing in place that gave us the confidence that we&#x27;d need to move to it. One day, but not today. For now there was still some manual testing done on each release, prior to shipping. Octopus suited us very well here as it allowed us to deploy, on demand, a build of our choice to a given environment. So the question was: what to do? Fortunately the immensely talented Aby Egea came up with a mechanism that supported that very notion. A pipeline that would, optionally, deploy our build to a specified environment. So we were good!</p><p>One thing we got to really appreciate about Jenkins was that the build is scripted with a <a href="https://jenkins.io/doc/book/pipeline/jenkinsfile/" target="_blank" rel="noopener noreferrer">Jenkinsfile</a>. This was in contrast to our TeamCity world where it was all manually configured. <a href="https://jenkins.io/projects/jcasc/" target="_blank" rel="noopener noreferrer">Configuration as code</a> is truly a wonderful thing as your build pipeline becomes part of your codebase; open for everyone to see and understand. If anyone wants to change the build pipeline it has to get code reviewed like everything else. It was as code in our <code>Jenkinsfile</code> that the deployment mechanism lived.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="vault">Vault<a aria-hidden="true" class="hash-link" href="#vault" title="Direct link to heading">â€‹</a></h2><p>Another thing that we used Octopus for was secrets. Applications run on configuration; these are settings that drive the behaviour of your application. A subset of configuration is &quot;secrets&quot;. Secrets are configuration that can&#x27;t be stored in source code; they would represent a risk if they did. For instance a database connection string. We&#x27;d been merrily using Octopus for this; as Octopus deploys an application to a server it enriches the <code>appsettings.json</code> file with any required secrets.</p><p>Without Octopus in the mix, how were we to handle our secrets? The answer is with <a href="https://www.vaultproject.io/" target="_blank" rel="noopener noreferrer">Hashicorp Vault</a>. We&#x27;d store our secrets in there and, thanks to clever work by <a href="https://uk.linkedin.com/in/robert-grzankowski-53618114" target="_blank" rel="noopener noreferrer">Robski</a> of the DevOps team, when our container was brought up by Kubernetes, it would mount into the filesystem an <code>appsettings.Vault.json</code> file which we read thanks to our trusty friend <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-3.1#json-configuration-provider" target="_blank" rel="noopener noreferrer"><code>.AddJsonFile</code></a> with <code>optional: true</code>. (As the file didn&#x27;t exist in our development environment.)</p><p>Hey presto! Safe secrets in k8s.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="networking">Networking<a aria-hidden="true" class="hash-link" href="#networking" title="Direct link to heading">â€‹</a></h2><p>Our on premise servers sat on the company network. They could see <em>everything</em> that there was to see. All the other servers around them on the network, bleeping and blooping. The opposite was true in AWS. There was nothing to see. Nothing to access. As it should be. It&#x27;s safer that way should a machine become compromised. For each database and each API our application depended upon, we needed to specifically allowlist access.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="kerberos">Kerberos<a aria-hidden="true" class="hash-link" href="#kerberos" title="Direct link to heading">â€‹</a></h2><p>There&#x27;s always a fly in the ointment. A nasty surprise on a dark night. Ours was realising that our application depended upon an API that was secured using <a href="https://docs.microsoft.com/en-us/iis/configuration/system.webserver/security/authentication/windowsauthentication/" target="_blank" rel="noopener noreferrer">Windows Authentication</a>. Our application was accessing it by running under a service account which had been permissioned to access it. However, in AWS, our application wasn&#x27;t running as under a service account on the company network. Disappointingly, in the short term the API was not going to support an alternate authentication mechanism.</p><p>What to do? Honestly it wasn&#x27;t looking good. We were considering proxying through one of our Windows servers just to get access to that API. I was tremendously disappointed. At this point our hero arrived; one <a href="https://twitter.com/foldr" target="_blank" rel="noopener noreferrer">JMac</a> hacked together a Kerberos sidecar approach one weekend. You can see a similar approach <a href="https://github.com/edseymour/kinit-sidecar" target="_blank" rel="noopener noreferrer">here</a>. This got us to a point that allowed us to access the API we needed to.</p><p>I&#x27;m kind of amazed that there isn&#x27;t better documentation out there around have a Kerberos sidecar in a k8s setup. Tragically Windows Authentication is a widely used authentication mechanism. That being the case, having good docs to show how you can get a Kerberos sidecar in place would likely greatly advance the ability of enterprises to migrate to the cloud. The best docs I&#x27;ve found are <a href="https://blog.openshift.com/kerberos-sidecar-container/" target="_blank" rel="noopener noreferrer">here</a>. It is super hard though. <em>So hard!</em></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="hangfire">Hangfire<a aria-hidden="true" class="hash-link" href="#hangfire" title="Direct link to heading">â€‹</a></h2><p>We were using <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/hosted-services?view=aspnetcore-3.1&amp;tabs=visual-studio" target="_blank" rel="noopener noreferrer">Hosted Services</a> to perform background task running in our app. The nature of our background tasks meant that it was important to only run a single instance of a background task at a time. Or bad things would happen. This was going to become a problem since we had ambitions to be able to horizontally scale our application; to add new pods as running our app as demand determined.</p><p>So we started to use <a href="https://www.hangfire.io/" target="_blank" rel="noopener noreferrer">Hangfire</a> to perform task running in our app. With Hangfire, when a job is picked up it gets locked so other servers can&#x27;t pick it up. That&#x27;s what we need.</p><p>Hangfire is pretty awesome. However it turns out that there&#x27;s quirks when you move to a containerised environment. We have a number of recurring jobs that are scheduled to run at certain dates and times. In order that Hangfire can ascertain what time it is, it needs a timezone. It turns out that timezones on Windows != timezones in Docker / Linux.</p><p>This was a problem because, as we limbered up for the great migration, we were trying to run our cloud implementation side by side with our on premise one. And Windows picked a fight with Linux over timezones. You can see others bumping into this condition <a href="https://github.com/HangfireIO/Hangfire/issues/1268" target="_blank" rel="noopener noreferrer">here</a>. We learned this the hard way; jobs mysteriously stopping due to timezone related errors. Windows Hangfire not able to recognise Linux Hangfire timezones and vica versa.</p><p>The TL;DR is that we had to do a hard switch with Hangfire; it couldn&#x27;t run side by side. Not the end of the world, but surprising.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="azure-active-directory-single-sign-on">Azure Active Directory Single Sign-On<a aria-hidden="true" class="hash-link" href="#azure-active-directory-single-sign-on" title="Direct link to heading">â€‹</a></h2><p>Historically our application had used two modes of authentication; Windows Authentication and cookies. Windows Authentication doesn&#x27;t generally play nicely with Docker. It&#x27;s doable, but it&#x27;s not the hill you want to die on. So we didn&#x27;t; we swapped out Windows Authentication for <a href="https://docs.microsoft.com/en-us/azure/active-directory/manage-apps/what-is-single-sign-on" target="_blank" rel="noopener noreferrer">Azure AD SSO</a> and didn&#x27;t look back.</p><p>We also made some changes so our app would support cookies auth alongside Azure AD auth; <a href="https://blog.johnnyreilly.com/2020/03/dual-boot-authentication-with-aspnetcore.html" target="_blank" rel="noopener noreferrer">I&#x27;ve written about this previously</a>.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="do-the-right-thing-and-tell-people-about-it">Do the right thing and tell people about it<a aria-hidden="true" class="hash-link" href="#do-the-right-thing-and-tell-people-about-it" title="Direct link to heading">â€‹</a></h2><p>We&#x27;re there now; we&#x27;ve made the move. It was a difficult journey but one worth making; it sets up our platform for where we want to take it in the future. Having infrastructure as code makes all kinds of approaches possible that weren&#x27;t before. Here&#x27;s some things we&#x27;re hoping to get out of the move:</p><ul><li>blue green deployments - shipping without taking down our platform</li><li>provision environments on demand - currently we have a highly contended situation when it comes to test environments. With k8s and AWS we can look at spinning up environments as we need them and throwing them away also</li><li>autoscaling for need - we can start to look at spinning up new containers in times of high load and removing excessive containers in times of low load</li></ul><p>We&#x27;ve also become more efficient as a team. We are no longer maintaining servers, renewing certificates, installing software, RDPing onto boxes. All that time and effort we can plough back into making awesome experiences for our users.</p><p>There&#x27;s a long list of other benefits and it&#x27;s very exciting indeed! It&#x27;s not enough for us to have done this though. It&#x27;s important that we tell the story of what we&#x27;ve done and how and why we&#x27;ve done it. That way people have empathy for the work. Also they can start to think about how they could start to reap similar benefits themselves. By talking to others about the road we&#x27;ve travelled, we can save them time and help them to travel a similar road. This is good for them and it&#x27;s good for us; it helps our relationships and it helps us all to move forwards together.</p><p>A rising tide lifts all boats. By telling others about our journey, we raise the water level. Up to the clouds!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/docker">docker</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/kubernetes">kubernetes</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/asp-net-core">asp net core</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/aws">aws</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Up to the clouds!" href="/2020/04/04/up-to-clouds"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2019/08/02/asp-net-authentication-hard-coding-claims">ASP.NET Core authentication: hard-coding a claim in development</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2019-08-02T00:00:00.000Z" itemprop="datePublished">August 2, 2019</time> Â· <!-- -->3 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This post demonstrates how you can hard code user authentication claims in ASP.NET Core; a useful technique to facilate testing during development.</p><p>I was recently part of a hackathon team that put together an API in just 30 hours. We came second. (Not bitter, not bitter...)</p><p>We were moving pretty quickly during the hackathon and, when we came to the end of it, we had a working API which we were able to demo. The good news is that the API is going to graduate to be a product! We&#x27;re going to ship this. Before we can do that though, there&#x27;s a little tidy up to do.</p><p>The first thing I remembered / realised when I picked up the codebase again, was the shortcuts we&#x27;d made on the developer experience. We&#x27;d put the API together using ASP.Net Core. We&#x27;re handling authentication using JWTs which is nicely supported. When we&#x27;re deployed, an external facing proxy calls our application with the appropriate JWT and everything works as you&#x27;d hope.</p><p>The question is, what&#x27;s it like to develop against this on your laptop? Getting a JWT for when I&#x27;m debugging locally is too much friction. I want to be able to work on the problem at hand, going away to get a JWT each time is a timesuck. So what to do? Well, during the hackathon, we just commented out <code>[Authorize]</code> attributes and hardcoded user ids in our controllers. This works, but it&#x27;s a messy developer experience; it&#x27;s easy to forget to uncomment things you&#x27;ve commented and break things. There must be a better way.</p><p>The solution I landed on was this: in development mode (which we only use whilst debugging) we hardcode an authenticated user. The way our authentication works is that we have a claim on our principal called something like <code>&quot;our-user-id&quot;</code>, the value of which is our authenticated user id. So in the <code>ConfigureServices</code> method of our <code>Startup.cs</code> we have a conditional authentication registration like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">// Whilst developing, we don&#x27;t want to authenticate; we hardcode to a particular users id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">if (Env.IsDevelopment()) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    services.AddAuthentication(nameof(DevelopmentModeAuthenticationHandler))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        .AddScheme&lt;DevelopmentModeAuthenticationOptions, DevelopmentModeAuthenticationHandler&gt;(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            nameof(DevelopmentModeAuthenticationHandler),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            options =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                options.UserIdToSetInClaims = &quot;this-is-a-user-id&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">else {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // The application typically uses this</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        .AddJwtBearer(options =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>As you can see, we&#x27;re using a special <code>DevelopmentModeAuthenticationHandler</code> authentication scheme in development mode, instead of JWT. As we register that, we declare the user id that we want to use. Whenever the app runs using the <code>DevelopmentModeAuthenticationHandler</code> auth, all requests will arrive using a principal with an <code>&quot;our-user-id&quot;</code> claim with a value of <code>&quot;this-is-a-user-id&quot;</code> (or whatever you&#x27;ve set it to.)</p><p>The <code>DevelopmentModeAuthenticationHandler</code> looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Collections.Generic;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Security.Claims;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Text.Encodings.Web;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Threading.Tasks;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.AspNetCore.Authentication;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.Logging;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.Options;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace OurApp</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class DevelopmentModeAuthenticationOptions : AuthenticationSchemeOptions</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public string UserIdToSetInClaims { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class DevelopmentModeAuthenticationHandler : AuthenticationHandler&lt;DevelopmentModeAuthenticationOptions&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private readonly ILoggingService _loggingService;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public DevelopmentModeAuthenticationHandler(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            IOptionsMonitor&lt;DevelopmentModeAuthenticationOptions&gt; options,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            ILoggerFactory logger,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            UrlEncoder encoder,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            ISystemClock clock</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        ) : base(options, logger, encoder, clock) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        protected override Task&lt;AuthenticateResult&gt; HandleAuthenticateAsync() {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var claims = new List&lt;Claim&gt; { new Claim(&quot;our-user-id&quot;, Options.UserIdToSetInClaims) };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var identity = new ClaimsIdentity(claims, nameof(DevelopmentModeAuthenticationHandler));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var ticket = new AuthenticationTicket(new ClaimsPrincipal(identity), Scheme.Name);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return Task.FromResult(AuthenticateResult.Success(ticket));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now, developing locally is frictionless! We don&#x27;t comment out <code>[Authorize]</code> attributes, we don&#x27;t hard code user ids in controllers.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/asp-net-core">ASP.Net Core</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/authentication">Authentication</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about ASP.NET Core authentication: hard-coding a claim in development" href="/2019/08/02/asp-net-authentication-hard-coding-claims"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2019/03/22/google-analytics-api-and-aspnet-core">Google Analytics API and ASP.Net Core</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2019-03-22T00:00:00.000Z" itemprop="datePublished">March 22, 2019</time> Â· <!-- -->2 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>I recently had need to be able to access the API for Google Analytics from ASP.Net Core. Getting this up and running turned out to be surprisingly tough because of an absence of good examples. So here it is; an example of how you can access a simple page access stat using <a href="https://www.nuget.org/packages/Google.Apis.AnalyticsReporting.v4/" target="_blank" rel="noopener noreferrer">the API</a>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">async Task&lt;SomeKindOfDataStructure[]&gt; GetUsageFromGoogleAnalytics(DateTime startAtThisDate, DateTime endAtThisDate)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // Create the DateRange object. Here we want data from last week.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    var dateRange = new DateRange</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        StartDate = startAtThisDate.ToString(&quot;yyyy-MM-dd&quot;),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        EndDate = endAtThisDate.ToString(&quot;yyyy-MM-dd&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // Create the Metrics and dimensions object.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // var metrics = new List&lt;Metric&gt; { new Metric { Expression = &quot;ga:sessions&quot;, Alias = &quot;Sessions&quot; } };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // var dimensions = new List&lt;Dimension&gt; { new Dimension { Name = &quot;ga:pageTitle&quot; } };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    var metrics = new List&lt;Metric&gt; { new Metric { Expression = &quot;ga:uniquePageviews&quot; } };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    var dimensions = new List&lt;Dimension&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        new Dimension { Name = &quot;ga:date&quot; },</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        new Dimension { Name = &quot;ga:dimension1&quot; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // Get required View Id from configuration</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    var viewId = $&quot;ga:{&quot;[VIEWID]&quot;}&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // Create the Request object.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    var reportRequest = new ReportRequest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        DateRanges = new List&lt;DateRange&gt; { dateRange },</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        Metrics = metrics,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        Dimensions = dimensions,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        FiltersExpression = &quot;ga:pagePath==/index.html&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        ViewId = viewId</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    var getReportsRequest = new GetReportsRequest {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        ReportRequests = new List&lt;ReportRequest&gt; { reportRequest }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    //Invoke Google Analytics API call and get report</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    var analyticsService = GetAnalyticsReportingServiceInstance();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    var response = await (analyticsService.Reports.BatchGet(getReportsRequest)).ExecuteAsync();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    var logins = response.Reports[0].Data.Rows.Select(row =&gt; new SomeKindOfDataStructure {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        Date = new DateTime(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            year: Convert.ToInt32(row.Dimensions[0].Substring(0, 4)),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            month: Convert.ToInt32(row.Dimensions[0].Substring(4, 2)),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            day: Convert.ToInt32(row.Dimensions[0].Substring(6, 2))),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        NumberOfLogins = Convert.ToInt32(row.Metrics[0].Values[0])</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    .OrderByDescending(login =&gt; login.Date)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    .ToArray();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    return logins;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">/// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">/// Intializes and returns Analytics Reporting Service Instance</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">/// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">AnalyticsReportingService GetAnalyticsReportingServiceInstance() {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    var googleAuthFlow = new GoogleAuthorizationCodeFlow(new GoogleAuthorizationCodeFlow.Initializer {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        ClientSecrets = new ClientSecrets {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            ClientId = &quot;[CLIENTID]&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            ClientSecret = &quot;[CLIENTSECRET]&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    var responseToken = new TokenResponse {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        AccessToken = &quot;[ANALYTICSTOKEN]&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        RefreshToken = &quot;[REFRESHTOKEN]&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        Scope = AnalyticsReportingService.Scope.AnalyticsReadonly, //Read-only access to Google Analytics,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        TokenType = &quot;Bearer&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    var credential = new UserCredential(googleAuthFlow, &quot;&quot;, responseToken);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // Create the  Analytics service.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    return new AnalyticsReportingService(new BaseClientService.Initializer {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        HttpClientInitializer = credential,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        ApplicationName = &quot;my-super-applicatio&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You can see above that you need various credentials to be able to use the API. You can acquire these by logging into GA. Enjoy!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/asp-net-core">asp net core</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/google-analytics">google analytics</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Google Analytics API and ASP.Net Core" href="/2019/03/22/google-analytics-api-and-aspnet-core"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2019/02/22/aspnet-core-allowlist-proxying-http-requests">ASP.NET Core: Proxying HTTP Requests with an AllowList</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2019-02-22T00:00:00.000Z" itemprop="datePublished">February 22, 2019</time> Â· <!-- -->7 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/assets/images/hang-on-lads-ive-got-a-great-idea-d87277f50bf9435db73abbf57226631a.jpg"><div class="markdown" itemprop="articleBody"><p>This post demonstrates a mechanism for proxying HTTP requests in ASP.NET Core. It doesn&#x27;t proxy all requests; it only proxies requests that match entries on an &quot;allowlist&quot; - so we only proxy the traffic that we&#x27;ve actively decided is acceptable as determined by taking the form of an expected URL and HTTP verb (GET / POST etc).</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="why-do-we-need-to-proxy">Why do we need to proxy?<a aria-hidden="true" class="hash-link" href="#why-do-we-need-to-proxy" title="Direct link to heading">â€‹</a></h2><p>Once upon a time there lived a young team who were building a product. They were ready to go live with their beta and so they set off on a journey to a mystical land they had heard tales of. This magical kingdom was called &quot;Production&quot;. However, Production was a land with walls and but one gate. That gate was jealously guarded by a defender named &quot;InfoSec&quot;. InfoSec was there to make sure that only the the right people, noble of thought and pure of deed were allowed into the promised land. InfoSec would ask questions like &quot;are you serving over HTTPS&quot; and &quot;what are you doing about cross site scripting&quot;?</p><p>The team felt they had good answers to InfoSec&#x27;s questions. However, just as they were about to step through the gate, InfoSec held up their hand and said &quot;your application wants to access a database... database access needs to take place on our own internal network. Not over the publicly accessible internet.&quot;</p><p>The team, with one foot in the air, paused. They swallowed and said &quot;can you give us five minutes?&quot;</p><p><img alt="image taken from the end of the classic movie &amp;quot;The Italian Job&amp;quot; of the bus hanging half off a mountainside" src="/assets/images/hang-on-lads-ive-got-a-great-idea-d87277f50bf9435db73abbf57226631a.jpg"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="the-proxy-regroup">The Proxy Regroup<a aria-hidden="true" class="hash-link" href="#the-proxy-regroup" title="Direct link to heading">â€‹</a></h2><p>And so it came to pass that the teams product (which took the form of ASP.Net Core web application) had to be changed. Where once there had been a single application, there would now be two; one that lived on the internet (the <em>web</em> app) and one that lived on the companies private network (the <em>API</em> app). The API app would do all the database access. In fact the product team opted to move all significant operations into the API as well. This left the web app with two purposes:</p><ol><li>the straightforward serving of HTML, CSS, JS and images</li><li>the proxying of API calls through to the API app</li></ol><h2 class="anchor anchorWithStickyNavbar_31ik" id="proxy-part-1">Proxy Part 1<a aria-hidden="true" class="hash-link" href="#proxy-part-1" title="Direct link to heading">â€‹</a></h2><p>In the early days of this proxying the team reached for <a href="https://github.com/twitchax/AspNetCore.Proxy" target="_blank" rel="noopener noreferrer"><code>AspNetCore.Proxy</code></a>. It&#x27;s a great open source project that allows you to proxy HTTP requests. It gives you complete control over the construction of proxy requests, so that you can have a request come into your API and end up proxying it to a URL with a completely different path on the proxy server.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="proxy-part-2">Proxy Part 2<a aria-hidden="true" class="hash-link" href="#proxy-part-2" title="Direct link to heading">â€‹</a></h2><p>The approach offered by <code>AspNetCore.Proxy</code> is fantastically powerful in terms of control. However, we didn&#x27;t actually need that level of configurability. In fact, it resulted in us writing a great deal of boilerplate code. You see in our case we&#x27;d opted to proxy path for path, changing only the server name on each proxied request. So if a GET request came in going to <a href="https://web.app.com/api/version" target="_blank" rel="noopener noreferrer">https://web.app.com/api/version</a> then we would want to proxy it to a GET request to <a href="https://api.app.com/api/version" target="_blank" rel="noopener noreferrer">https://api.app.com/api/version</a>. You see? All we did was swap <a href="https://web.app.com" target="_blank" rel="noopener noreferrer">https://web.app.com</a> for <a href="https://api.app.com." target="_blank" rel="noopener noreferrer">https://api.app.com.</a> Nothing more. We did that as a rule. We knew we <em>always</em> wanted to do just this.</p><p>So we ended up spinning up our own solution which allowed just the specification of paths we wanted to proxy with their corresponding HTTP verbs. Let&#x27;s talk through it. Usage of our approach ended up as a middleware within our web app&#x27;s <code>Startup.cs</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">public void Configure(IApplicationBuilder app) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    app.UseProxyAllowList(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // where ServerToProxyToBaseUrl is the server you want requests to be proxied to</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // eg &quot;https://the-server-we-proxy-to&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        proxyAddressTweaker: (requestPath) =&gt; $&quot;{ServerToProxyToBaseUrl}{requestPath}&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        allowListProxyRoutes: new [] {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // An anonymous request</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            AllowListProxy.AnonymousRoute(&quot;api/version&quot;, HttpMethod.Get),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // An authenticated request; to send this we must know who the user is</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            AllowListProxy.Route(&quot;api/account/{accountId:int}/all-the-secret-info&quot;, HttpMethod.Get, HttpMethod.Post),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    app.UseMvc();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If you look at the code above you can see that we are proxing requests to a single server: <code>ServerToProxyToBaseUrl</code>. We&#x27;re also only proxying requests which match an entry on our allowlist (as represented by <code>allowListProxyRoutes</code>). So in this case we&#x27;re proxying two different requests:</p><ol><li><code>GET</code> requests to <code>api/version</code> are proxied through as <em>anonymous</em><code>GET</code> requests.</li><li><code>GET</code> and <code>POST</code> requests to <code>api/account/{accountId:int}/all-the-secret-info</code> are proxied through as <code>GET</code> and <code>POST</code> requests. These requests require that a user be authenticated first.</li></ol><p>The <code>AllowListProxy</code> proxy class we&#x27;ve been using looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Collections.Generic;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Net.Http;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace My.Web.Proxy {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class AllowListProxy {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public string Path { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IEnumerable&lt;HttpMethod&gt; Methods { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public bool IsAnonymous { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private AllowListProxy(string path, bool isAnonymous, params HttpMethod[] methods) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (methods == null || methods.Length == 0)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                throw new ArgumentException($&quot;You need at least a single HttpMethod to be specified for {path}&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Path = path;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            IsAnonymous = isAnonymous;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Methods = methods;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static AllowListProxy Route(string path, params HttpMethod[] methods) =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            new AllowListProxy(path, isAnonymous: false, methods: methods);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static AllowListProxy AnonymousRoute(string path, params HttpMethod[] methods) =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            new AllowListProxy(path, isAnonymous: true, methods: methods);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The middleware for proxying (our <code>UseProxyAllowList</code>) looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Collections.Generic;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.ComponentModel;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Linq;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Net.Http;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Reflection;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Threading.Tasks;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.AspNetCore.Authentication;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.AspNetCore.Builder;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.AspNetCore.Http;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.AspNetCore.Routing;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.DependencyModel;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Serilog;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace My.Web.Proxy {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static class ProxyRouteExtensions {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// Middleware which proxies the supplied allowlist routes</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static void UseProxyAllowList(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            this IApplicationBuilder app,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Func&lt;string, string&gt; proxyAddressTweaker,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Action&lt;HttpContext, HttpRequestMessage&gt; preSendProxyRequestAction,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            IEnumerable&lt;AllowListProxy&gt; allowListProxyRoutes</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        ) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            app.UseRouter(builder =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                foreach (var allowListProxy in allowListProxyRoutes) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    foreach (var method in allowListProxy.Methods) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        builder.MapMiddlewareVerb(method.ToString(), allowListProxy.Path, proxyApp =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                            proxyApp.UseProxy_Challenge(allowListProxy.IsAnonymous);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                            proxyApp.UseProxy_Run(proxyAddressTweaker, preSendProxyRequestAction);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private static void UseProxy_Challenge(this IApplicationBuilder app, bool allowAnonymous) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            app.Use((context, next) =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var routePath = context.Request.Path.Value;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var weAreAuthenticatedOrWeDontNeedToBe =</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    context.User.Identity.IsAuthenticated || allowAnonymous;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (weAreAuthenticatedOrWeDontNeedToBe)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    return next();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return context.ChallengeAsync();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private static void UseProxy_Run(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            this IApplicationBuilder app,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Func&lt;string, string&gt; proxyAddressTweaker,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Action&lt;HttpContext, HttpRequestMessage&gt; preSendProxyRequestAction</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            app.Run(async context =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var proxyAddress = &quot;&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    proxyAddress = proxyAddressTweaker(context.Request.Path.Value);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    var proxyRequest = context.Request.CreateProxyHttpRequest(proxyAddress);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    if (preSendProxyRequestAction != null)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        preSendProxyRequestAction(context, proxyRequest);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    var httpClients = context.RequestServices.GetService&lt;IHttpClients&gt;(); // IHttpClients is just a wrapper for HttpClient - insert your own here</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    var proxyResponse = await httpClients.SendRequestAsync(proxyRequest,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                            HttpCompletionOption.ResponseHeadersRead, context.RequestAborted)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        .ConfigureAwait(false);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    await context.CopyProxyHttpResponse(proxyResponse).ConfigureAwait(false);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                catch (OperationCanceledException ex) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    if (ex.CancellationToken.IsCancellationRequested)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        return;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    if (!context.Response.HasStarted)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        context.Response.StatusCode = 408;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        await context.Response</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                            .WriteAsync(&quot;Request timed out.&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                catch (Exception e) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    if (!context.Response.HasStarted)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        context.Response.StatusCode = 500;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        await context.Response</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                            .WriteAsync(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                                $&quot;Request could not be proxied.\n\n{e.Message}\n\n{e.StackTrace}.&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static void AddOrReplaceHeader(this HttpRequestMessage request, string headerName, string headerValue) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // It&#x27;s possible for there to be multiple headers with the same name; we only want a single header to remain.  Our one.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            while (request.Headers.TryGetValues(headerName, out var existingAuthorizationHeader)) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                request.Headers.Remove(headerName);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            request.Headers.TryAddWithoutValidation(headerName, headerValue);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static HttpRequestMessage CreateProxyHttpRequest(this HttpRequest request, string uriString) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var uri = new Uri(uriString + request.QueryString);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var requestMessage = new HttpRequestMessage();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var requestMethod = request.Method;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (!HttpMethods.IsGet(requestMethod) &amp;&amp;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                !HttpMethods.IsHead(requestMethod) &amp;&amp;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                !HttpMethods.IsDelete(requestMethod) &amp;&amp;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                !HttpMethods.IsTrace(requestMethod)) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var streamContent = new StreamContent(request.Body);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                requestMessage.Content = streamContent;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // Copy the request headers.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (requestMessage.Content != null)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                foreach (var header in request.Headers)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    if (!requestMessage.Headers.TryAddWithoutValidation(header.Key, header.Value.ToArray()))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        requestMessage.Content?.Headers.TryAddWithoutValidation(header.Key, header.Value.ToArray());</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            requestMessage.Headers.Host = uri.Authority;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            requestMessage.RequestUri = uri;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            requestMessage.Method = new HttpMethod(request.Method);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return requestMessage;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static async Task CopyProxyHttpResponse(this HttpContext context, HttpResponseMessage responseMessage) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var response = context.Response;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            response.StatusCode = (int) responseMessage.StatusCode;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            foreach (var header in responseMessage.Headers) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                response.Headers[header.Key] = header.Value.ToArray();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (responseMessage.Content != null) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                foreach (var header in responseMessage.Content.Headers) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    response.Headers[header.Key] = header.Value.ToArray();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            response.Headers.Remove(&quot;transfer-encoding&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            using(var responseStream = await responseMessage.Content.ReadAsStreamAsync().ConfigureAwait(false)) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                await responseStream.CopyToAsync(response.Body, 81920, context.RequestAborted).ConfigureAwait(false);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This works out to be a flexible and simple approach to allowlist proxying.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/asp-net-core">asp net core</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/proxy">proxy</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/http-requests">http requests</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/allowlist">allowlist</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about ASP.NET Core: Proxying HTTP Requests with an AllowList" href="/2019/02/22/aspnet-core-allowlist-proxying-http-requests"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2018/12/10/cache-rules-everything-around-me">Cache Rules Everything Around Me</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2018-12-10T00:00:00.000Z" itemprop="datePublished">December 10, 2018</time> Â· <!-- -->2 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>One thing that ASP.Net Core really got right was caching. <a href="https://docs.microsoft.com/en-us/aspnet/core/performance/caching/memory" target="_blank" rel="noopener noreferrer"><code>IMemoryCache</code></a> is a caching implementation that does just what I want. I love it. I take it everywhere. I&#x27;ve introduced it to my family.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="timespan-timespan-expiration-yall">TimeSpan, TimeSpan Expiration Y&#x27;all<a aria-hidden="true" class="hash-link" href="#timespan-timespan-expiration-yall" title="Direct link to heading">â€‹</a></h2><p>To make usage of the <code>IMemoryCache</code> <em>even</em> more lovely I&#x27;ve written an extension method. I follow pretty much one cache strategy: <code>SetAbsoluteExpiration</code> and I just vary the expiration by an amount of time. This extension method implements that in a simple way; I call it <code>GetOrCreateForTimeSpanAsync</code> - catchy right? It looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Threading.Tasks;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.Caching.Memory;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace My.Helpers {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static class CacheHelpers {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static async Task&lt;TItem&gt; GetOrCreateForTimeSpanAsync&lt;TItem&gt;(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            this IMemoryCache cache,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            string key,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Func&lt;Task&lt;TItem&gt;&gt; itemGetterAsync,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            TimeSpan timeToCache</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        ) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (!cache.TryGetValue(key, out object result)) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                result = await itemGetterAsync();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (result == null)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    return default(TItem);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var cacheEntryOptions = new MemoryCacheEntryOptions()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    .SetAbsoluteExpiration(timeToCache);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                cache.Set(key, result, cacheEntryOptions);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return (TItem) result;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Usage looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">private Task&lt;SuperInterestingThing&gt; GetSuperInterestingThingFromCache(Guid superInterestingThingId) =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    _cache.GetOrCreateForTimeSpanAsync(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        key: $&quot;{nameof(MyClass)}:GetSuperInterestingThing:{superInterestingThingId}&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        itemGetterAsync: () =&gt; GetSuperInterestingThing(superInterestingThingId),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        timeToCache: TimeSpan.FromMinutes(5)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    );</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This helper allows the consumer to provide three things:</p><ul><li>The <code>key</code> key for the item to be cached with</li><li>A <code>itemGetterAsync</code> which is the method that is used to retrieve a new value if an item cannot be found in the cache</li><li>A <code>timeToCache</code> which is the period of time that an item should be cached</li></ul><p>If an item can&#x27;t be looked up by the <code>itemGetterAsync</code> then <em>nothing</em> will be cached and a the <code>default</code> value of the expected type will be returned. This is important because lookups can fail, and there&#x27;s nothing worse than a lookup failing and you caching <code>null</code> as a result.</p><p>Go on, ask me how I know.</p><p>This is a simple, clear and helpful API which makes interacting with <code>IMemoryCache</code> even more lovely than it was. Peep it y&#x27;all.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/asp-net-core">asp net core</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/cache">cache</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/wu-tang">wu-tang</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Cache Rules Everything Around Me" href="/2018/12/10/cache-rules-everything-around-me"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2018/01/14/auth0-typescript-and-aspnet-core">Auth0, TypeScript and ASP.NET Core</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2018-01-14T00:00:00.000Z" itemprop="datePublished">January 14, 2018</time> Â· <!-- -->10 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Most applications I write have some need for authentication and perhaps authorisation too. In fact, most apps most people write fall into that bracket. Here&#x27;s the thing: Auth done well is a <!-- -->*<!-- -->big<!-- -->*<!-- --> chunk of work. And the minute you start thinking about that you almost invariably lose focus on the thing you actually want to build and ship.</p><p>So this Christmas I decided it was time to take a look into offloading that particular problem onto someone else. I knew there were third parties who provided Auth-As-A-Service - time to give them a whirl. On the recommendation of a friend, I made Auth0 my first port of call. Lest you be expecting a full breakdown of the various players in this space, let me stop you now; I liked Auth0 so much I strayed no further. Auth0 kicks AAAS. (I&#x27;m so sorry)</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="what-i-wanted-to-build">What I wanted to build<a aria-hidden="true" class="hash-link" href="#what-i-wanted-to-build" title="Direct link to heading">â€‹</a></h2><p>My criteria for &quot;auth success&quot; was this:</p><ul><li>I want to build a SPA, specifically a React SPA. Ideally, I shouldn&#x27;t need a back end of my own at all</li><li>I want to use TypeScript on my client.</li></ul><p>But, for when I do implement a back end:</p><ul><li>I want that to be able to use the client side&#x27;s Auth tokens to allow access to Auth routes on my server.</li><li>â€ŽI want to able to identify the user, given the token, to provide targeted data</li><li>Oh, and I want to use .NET Core 2 for my server.</li></ul><p>And in achieving all of the I want to add minimal code to my app. Not War and Peace. My code should remain focused on doing what it does.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="boil-a-plate">Boil a Plate<a aria-hidden="true" class="hash-link" href="#boil-a-plate" title="Direct link to heading">â€‹</a></h2><p>I ended up with unqualified ticks for all my criteria, but it took some work to find out. I will say that Auth0 do travel the extra mile in terms of getting you up and running. When you create a new Client in Auth0 you&#x27;re given the option to download a quick start using the technology of your choice.</p><p>This was a massive plus for me. I took the quickstart provided and ran with it to get me to the point of meeting my own criteria. You can use this boilerplate for your own ends. Herewith, a walkthrough:</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="the-walkthrough">The Walkthrough<a aria-hidden="true" class="hash-link" href="#the-walkthrough" title="Direct link to heading">â€‹</a></h2><p>Fork and clone the repo at this location: <a href="https://github.com/johnnyreilly/auth0-react-typescript-asp-net-core" target="_blank" rel="noopener noreferrer">https://github.com/johnnyreilly/auth0-react-typescript-asp-net-core</a>.</p><p>What have we got? 2 folders, ClientApp contains the React app, Web contains the ASP.NET Core app. Now we need to get setup with Auth0 and customise our config.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="setup-auth0">Setup Auth0<a aria-hidden="true" class="hash-link" href="#setup-auth0" title="Direct link to heading">â€‹</a></h2><p>Here&#x27;s how to get the app set up with Auth0; you&#x27;re going to need to sign up for a (free) Auth0 account. Then login into Auth0 and go to the management portal.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="client">Client<a aria-hidden="true" class="hash-link" href="#client" title="Direct link to heading">â€‹</a></h3><ul><li>Create a Client with the name of your choice and use the Single Page Web Applications template.</li><li>From the new Client Settings page take the Domain and Client ID and update the similarly named properties in the <code>appsettings.Development.json</code> and <code>appsettings.Production.json</code> files with these settings.</li><li>To the Allowed Callback URLs setting add the URLs: <code>http://localhost:3000/callback,http://localhost:5000/callback</code> <!-- -->-<!-- --> the first of these faciliates running in Debug mode, the second in Production mode. If you were to deploy this you&#x27;d need to add other callback URLs in here too.</li></ul><h3 class="anchor anchorWithStickyNavbar_31ik" id="api">API<a aria-hidden="true" class="hash-link" href="#api" title="Direct link to heading">â€‹</a></h3><ul><li>Create an API with the name of your choice (I recommend the same as the Client to avoid confusion), an identifier which can be anything you like; I like to use the URL of my app but it&#x27;s your call.</li><li>From the new API Settings page take the Identifier and update the Audience property in the <code>appsettings.Development.json</code> and <code>appsettings.Production.json</code> files with that value.</li></ul><h2 class="anchor anchorWithStickyNavbar_31ik" id="running-the-app">Running the App<a aria-hidden="true" class="hash-link" href="#running-the-app" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_31ik" id="production-build">Production build<a aria-hidden="true" class="hash-link" href="#production-build" title="Direct link to heading">â€‹</a></h3><p>Build the client app with <code>yarn build</code> in the <code>ClientApp</code> folder. (Don&#x27;t forget to <code>yarn install</code> first.) Then, in the <code>Web</code> folder <code>dotnet restore</code>, <code>dotnet run</code> and open your browser to <a href="http://localhost:5000" target="_blank" rel="noopener noreferrer"><code>http://localhost:5000</code></a></p><h3 class="anchor anchorWithStickyNavbar_31ik" id="debugging">Debugging<a aria-hidden="true" class="hash-link" href="#debugging" title="Direct link to heading">â€‹</a></h3><p>Run the client app using webpack-dev-server using <code>yarn start</code> in the <code>ClientApp</code> folder. Fire up VS Code in the root of the repo and hit F5 to debug the server. Then open your browser to <a href="http://localhost:3000" target="_blank" rel="noopener noreferrer"><code>http://localhost:3000</code></a></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="the-tour">The Tour<a aria-hidden="true" class="hash-link" href="#the-tour" title="Direct link to heading">â€‹</a></h2><p>When you fire up the app you&#x27;re presented with &quot;you are not logged in!&quot; message and the option to login. Do it, it&#x27;ll take you to the Auth0 &quot;lock&quot; screen where you can sign up / login. Once you do that you&#x27;ll be asked to confirm access:</p><p><img src="/assets/images/Screenshot%2B2018-01-13%2B18.40.21-8464aee2e4481446b6c2c72768bd5bac.png"></p><p>All this is powered by Auth0&#x27;s <a href="https://www.npmjs.com/package/auth0-js" target="_blank" rel="noopener noreferrer">auth0-js</a> npm package. (Excellent type definition files are available from Definitely Typed; I&#x27;m using the <a href="https://www.npmjs.com/package/@types/auth0-js" target="_blank" rel="noopener noreferrer">@types/auth0-js</a> package DT publishes.) Usage of which is super simple; it exposes an <code>authorize</code> method that when called triggers the Auth0 lock screen. Once you&#x27;ve &quot;okayed&quot; you&#x27;ll be taken back to the app which will use the <code>parseHash</code> method to extract the access token that Auth0 has provided. Take a look at how our <code>authStore</code> makes use of auth0-js: (don&#x27;t be scared; it uses mobx - but you could use anything)</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="authstorets">authStore.ts<a aria-hidden="true" class="hash-link" href="#authstorets" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ts"><pre tabindex="0" class="prism-code language-ts codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">Auth0UserProfile</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> </span><span class="token imports maybe-class-name">WebAuth</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;auth0-js&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> action</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> computed</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> observable</span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token imports"> runInAction </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;mobx&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">IAuth0Config</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;../../config&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">StorageFacade</span><span class="token imports"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;../storageFacade&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">interface</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 139)">IStorageToken</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  accessToken</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  idToken</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  expiresAt</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">const</span><span class="token plain"> </span><span class="token constant" style="color:rgb(130, 170, 255)">STORAGE_TOKEN</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;storage_token&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">export</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">class</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 139)">AuthStore</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  @observable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">ref</span><span class="token plain"> auth0</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token maybe-class-name">WebAuth</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  @observable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">ref</span><span class="token plain"> userProfile</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token maybe-class-name">Auth0UserProfile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  @observable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">ref</span><span class="token plain"> token</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token maybe-class-name">IStorageToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">constructor</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">config</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token maybe-class-name">IAuth0Config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">private</span><span class="token plain"> storage</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token maybe-class-name">StorageFacade</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">auth0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 139)">WebAuth</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      domain</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">domain</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      clientID</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">clientId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      redirectUri</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">redirectUri</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      audience</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">audience</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      responseType</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;token id_token&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      scope</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;openid email profile do:admin:thing&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// the do:admin:thing scope is custom and defined in the scopes section of our API in the Auth0 dashboard</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">initialise</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">const</span><span class="token plain"> token </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">parseToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">getItem</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token constant" style="color:rgb(130, 170, 255)">STORAGE_TOKEN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">token</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">setSession</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">token</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">addEventListener</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">onStorageChanged</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">parseToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">tokenString</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">const</span><span class="token plain"> token </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:rgb(255, 203, 139)">JSON</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">parse</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">tokenString </span><span class="token operator" style="color:rgb(127, 219, 202)">||</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;{}&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> token</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(130, 170, 255)">onStorageChanged</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">event</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token maybe-class-name">StorageEvent</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(127, 219, 202)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">key</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">===</span><span class="token plain"> </span><span class="token constant" style="color:rgb(130, 170, 255)">STORAGE_TOKEN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">setSession</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">parseToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">newValue</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  @computed </span><span class="token keyword" style="color:rgb(127, 219, 202)">get</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">isAuthenticated</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// Check whether the current time is past the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// access token&#x27;s expiry time</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">token</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">&amp;&amp;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name known-class-name class-name" style="color:rgb(255, 203, 139)">Date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">getTime</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">&lt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">token</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">expiresAt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(130, 170, 255)">login</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(127, 219, 202)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">auth0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">authorize</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(130, 170, 255)">handleAuthentication</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(127, 219, 202)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">auth0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">parseHash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">err</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> authResult</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(127, 219, 202)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">authResult </span><span class="token operator" style="color:rgb(127, 219, 202)">&amp;&amp;</span><span class="token plain"> authResult</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">accessToken</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">&amp;&amp;</span><span class="token plain"> authResult</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">idToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">const</span><span class="token plain"> token </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          accessToken</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> authResult</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">accessToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          idToken</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> authResult</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">idToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// Set the time that the access token will expire at</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          expiresAt</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> authResult</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">expiresIn</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1000</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name known-class-name class-name" style="color:rgb(255, 203, 139)">Date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">getTime</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">setSession</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">token</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">else</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">err</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// tslint:disable-next-line:no-console</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token console class-name" style="color:rgb(255, 203, 139)">console</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">log</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">err</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">alert</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token template-string template-punctuation string" style="color:rgb(173, 219, 103)">`</span><span class="token template-string string" style="color:rgb(173, 219, 103)">Error: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">${</span><span class="token template-string interpolation">err</span><span class="token template-string interpolation punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token template-string interpolation">error</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token template-string string" style="color:rgb(173, 219, 103)">. Check the console for further details.</span><span class="token template-string template-punctuation string" style="color:rgb(173, 219, 103)">`</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  @action</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">setSession</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">token</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token maybe-class-name">IStorageToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">token</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> token</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">setItem</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token constant" style="color:rgb(130, 170, 255)">STORAGE_TOKEN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:rgb(255, 203, 139)">JSON</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">stringify</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">token</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(130, 170, 255)">getAccessToken</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(127, 219, 202)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">const</span><span class="token plain"> accessToken </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">token</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">accessToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(127, 219, 202)">!</span><span class="token plain">accessToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token keyword" style="color:rgb(127, 219, 202)">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name known-class-name class-name" style="color:rgb(255, 203, 139)">Error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;No access token found&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> accessToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  @action</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(130, 170, 255)">loadProfile</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(127, 219, 202)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">const</span><span class="token plain"> accessToken </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">token</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">accessToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(127, 219, 202)">!</span><span class="token plain">accessToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">auth0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">userInfo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">accessToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">err</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> profile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(127, 219, 202)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">err</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">throw</span><span class="token plain"> err</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token keyword" style="color:rgb(127, 219, 202)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">profile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token function" style="color:rgb(130, 170, 255)">runInAction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(127, 219, 202)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">userProfile</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> profile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> profile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">undefined</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  @action</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(130, 170, 255)">logout</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(127, 219, 202)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// Clear access token and ID token from local storage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">removeItem</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token constant" style="color:rgb(130, 170, 255)">STORAGE_TOKEN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">token</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">this</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">userProfile</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Once you&#x27;re logged in the app offers you more in the way of navigation options. A &quot;Profile&quot; screen shows you the details your React app has retrieved from Auth0 about you. This is backed by the <code>client.userInfo</code> method on <code>auth0-js</code>. There&#x27;s also a &quot;Ping&quot; screen which is where your React app talks to your ASP.NET Core server. The screenshot below illustrates the result of hitting the &quot;Get Private Data&quot; button:</p><p><img src="/assets/images/Screenshot%2B2018-01-13%2B18.47.49-edbbe3ddefa26149f9a447bdd023c381.png"></p><p>The &quot;Get Server to Retrieve Profile Data&quot; button is interesting as it illustrates that the server can get access to your profile data as well. There&#x27;s nothing insecure here; it gets the details using the access token retrieved from Auth0 by the ClientApp and passed to the server. It&#x27;s the API we set up in Auth0 that is in play here. The app uses the Domain and the access token to talk to Auth0 like so:</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="usercontrollercs">UserController.cs<a aria-hidden="true" class="hash-link" href="#usercontrollercs" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">// Retrieve the access_token claim which we saved in the OnTokenValidated event</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    var accessToken = User.Claims.FirstOrDefault(c =&gt; c.Type == &quot;access_token&quot;).Value;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // If we have an access_token, then retrieve the user&#x27;s information</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    if (!string.IsNullOrEmpty(accessToken))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        var domain = _config[&quot;Auth0:Domain&quot;];</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        var apiClient = new AuthenticationApiClient(domain);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        var userInfo = await apiClient.GetUserInfoAsync(accessToken);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        return Ok(userInfo);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We can also access the <code>sub</code> claim, which uniquely identifies the user:</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="usercontrollercs-1">UserController.cs<a aria-hidden="true" class="hash-link" href="#usercontrollercs-1" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">// We&#x27;re not doing anything with this, but hey! It&#x27;s useful to know where the user id lives</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    var userId = User.Claims.FirstOrDefault(c =&gt; c.Type == System.Security.Claims.ClaimTypes.NameIdentifier).Value; // our userId is the sub value</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The reason our ASP.NET Core app works with Auth0 and that we have access to the access token here in the first place is because of our startup code:</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="startupcs">Startup.cs<a aria-hidden="true" class="hash-link" href="#startupcs" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">public void ConfigureServices(IServiceCollection services)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        var domain = $&quot;https://{Configuration[&quot;Auth0:Domain&quot;]}/&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        services.AddAuthentication(options =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }).AddJwtBearer(options =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            options.Authority = domain;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            options.Audience = Configuration[&quot;Auth0:Audience&quot;];</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            options.Events = new JwtBearerEvents</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                OnTokenValidated = context =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    if (context.SecurityToken is JwtSecurityToken token)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        if (context.Principal.Identity is ClaimsIdentity identity)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                            identity.AddClaim(new Claim(&quot;access_token&quot;, token.RawData));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    return Task.FromResult(0);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // ....</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="authorization">Authorization<a aria-hidden="true" class="hash-link" href="#authorization" title="Direct link to heading">â€‹</a></h2><p>We&#x27;re pretty much done now; just one magic button to investigate: &quot;Get Admin Data&quot;. If you presently try and access the admin data you&#x27;ll get a <code>403 Forbidden</code>. It&#x27;s forbidden because that endpoint relies on the <code>&quot;do:admin:thing&quot;</code> scope in our claims:</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="usercontrollercs-2">UserController.cs<a aria-hidden="true" class="hash-link" href="#usercontrollercs-2" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">[Authorize(Scopes.DoAdminThing)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    [HttpGet(&quot;api/userDoAdminThing&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public IActionResult GetUserDoAdminThing()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        return Ok(&quot;Admin endpoint&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_31ik" id="scopescs">Scopes.cs<a aria-hidden="true" class="hash-link" href="#scopescs" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">public static class Scopes</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">         // the do:admin:thing scope is custom and defined in the scopes section of our API in the Auth0 dashboard</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public const string DoAdminThing = &quot;do:admin:thing&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This wired up in our ASP.NET Core app like so:</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="startupcs-1">Startup.cs<a aria-hidden="true" class="hash-link" href="#startupcs-1" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">services.AddAuthorization(options =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        options.AddPolicy(Scopes.DoAdminThing, policy =&gt; policy.Requirements.Add(new HasScopeRequirement(Scopes.DoAdminThing, domain)));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // register the scope authorization handler</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    services.AddSingleton&lt;iauthorizationhandler, hasscopehandler=&quot;&quot;&gt;();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt;/iauthorizationhandler,&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_31ik" id="hasscopehandlercs">HasScopeHandler.cs<a aria-hidden="true" class="hash-link" href="#hasscopehandlercs" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">public class HasScopeHandler : AuthorizationHandler&lt;hasscoperequirement&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, HasScopeRequirement requirement)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // If user does not have the scope claim, get out of here</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (!context.User.HasClaim(c =&gt; c.Type == &quot;scope&quot; &amp;&amp; c.Issuer == requirement.Issuer))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return Task.CompletedTask;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // Split the scopes string into an array</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var scopes = context.User.FindFirst(c =&gt; c.Type == &quot;scope&quot; &amp;&amp; c.Issuer == requirement.Issuer).Value.Split(&#x27; &#x27;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // Succeed if the scope array contains the required scope</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (scopes.Any(s =&gt; s == requirement.Scope))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                context.Succeed(requirement);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return Task.CompletedTask;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">&lt;/hasscoperequirement&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The reason we&#x27;re 403ing at present is because when our <code>HasScopeHandler</code> executes, <code>requirement.Scope</code> has the value of <code>&quot;do:admin:thing&quot;</code> and our <code>scopes</code> do not contain that value. To add it, go to your API in the Auth0 management console and add it:</p><p><img src="/assets/images/Screenshot%2B2018-01-14%2B08.26.54-d103f9b230a5d0c8a2dd8caf419781a1.png"></p><p>Note that you can control how this scope is acquired using &quot;Rules&quot; in the Auth0 management portal.</p><p>You won&#x27;t be able to access the admin endpoint yet because you&#x27;re still rocking with the old access token; pre-newly-added scope. But when you next login to Auth0 you&#x27;ll see a prompt like this:</p><p><img src="/assets/images/Screenshot%2B2018-01-14%2B08.32.59-98ad4ec6b457e0b72613c69c16706b33.png"></p><p>Which demonstrates that you&#x27;re being granted an extra scope. With your new shiny access token you can now access the oh-so-secret Admin endpoint.</p><p>I had some more questions about Auth0 as I&#x27;m still new to it myself. To see my question (and the very helpful answer!) go here: <a href="https://community.auth0.com/questions/13786/get-user-data-server-side-what-is-a-good-approach" target="_blank" rel="noopener noreferrer">https://community.auth0.com/questions/13786/get-user-data-server-side-what-is-a-good-approach</a></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/asp-net-core">ASP.Net Core</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/auth-0">Auth0</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/type-script">TypeScript</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/o-auth">OAuth</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/react">React</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Auth0, TypeScript and ASP.NET Core" href="/2018/01/14/auth0-typescript-and-aspnet-core"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2017/03/28/debugging-aspnet-core-in-vs-or-code">Debugging ASP.Net Core in VS or Code</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2017-03-28T00:00:00.000Z" itemprop="datePublished">March 28, 2017</time> Â· <!-- -->4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>I&#x27;ve been using Visual Studio for a long time. Very good it is too. However, it is heavyweight; it does far more than I need. What I really want when I&#x27;m working is a fast snappy editor, with intellisense and debugging. What I&#x27;ve basically described is <a href="https://code.visualstudio.com/" target="_blank" rel="noopener noreferrer">VS Code</a>. It rocks and has long become my go-to editor for TypeScript.</p><p>Since I&#x27;m a big C# fan as well I was delighted that editing C# was also possible in Code. What I want now is to be able to debug ASP.Net Core in Visual Studio OR VS Code. Can it be done? Let&#x27;s see....</p><p>I fire up Visual Studio and <code>File -&amp;gt; New Project</code> (yes it&#x27;s a verb now). Select .NET Core and then ASP.Net Core Web Application. OK. We&#x27;ll go for a Web Application. Let&#x27;s not bother with authentication. OK. Wait a couple of seconds and Visual Studio serves up a new project. Hit F5 and we&#x27;re debugging in Visual Studio.</p><p>So far, so straightforward. What will VS Code make of this?</p><p>I cd my way to the root of my new ASP.Net Core Web Application and type the magical phrase &quot;code .&quot;. Up it fires. I feel lucky, let&#x27;s hit &quot;F5&quot;. Huh, a dropdown shows up saying <code>&quot;Select Environment&quot;</code> and offering me the options of Chrome and Node. Neither do I want. It&#x27;s about this time I remember this is a clean install of VS Code and doesn&#x27;t yet have the C# extension installed. In fact, if I open a C# file it up it tells me and recommends that I install. Well that&#x27;s nice. I take it up on the kind offer; install and reload.</p><p>When it comes back up I see the following entries in the &quot;output&quot; tab:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ts"><pre tabindex="0" class="prism-code language-ts codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token maybe-class-name">Updating</span><span class="token plain"> </span><span class="token constant" style="color:rgb(130, 170, 255)">C</span><span class="token plain"># dependencies</span><span class="token spread operator" style="color:rgb(127, 219, 202)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token maybe-class-name">Platform</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> win32</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">x86_64</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">win7</span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">x64</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token maybe-class-name">Downloading</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">package</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;OmniSharp (.NET 4.6 / x64)&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">20447</span><span class="token plain"> </span><span class="token constant" style="color:rgb(130, 170, 255)">KB</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token spread operator" style="color:rgb(127, 219, 202)">...</span><span class="token spread operator" style="color:rgb(127, 219, 202)">...</span><span class="token spread operator" style="color:rgb(127, 219, 202)">...</span><span class="token spread operator" style="color:rgb(127, 219, 202)">...</span><span class="token spread operator" style="color:rgb(127, 219, 202)">...</span><span class="token spread operator" style="color:rgb(127, 219, 202)">...</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"> </span><span class="token property-access maybe-class-name">Done</span><span class="token operator" style="color:rgb(127, 219, 202)">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token maybe-class-name">Downloading</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">package</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;.NET Core Debugger (Windows / x64)&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">39685</span><span class="token plain"> </span><span class="token constant" style="color:rgb(130, 170, 255)">KB</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token spread operator" style="color:rgb(127, 219, 202)">...</span><span class="token spread operator" style="color:rgb(127, 219, 202)">...</span><span class="token spread operator" style="color:rgb(127, 219, 202)">...</span><span class="token spread operator" style="color:rgb(127, 219, 202)">...</span><span class="token spread operator" style="color:rgb(127, 219, 202)">...</span><span class="token spread operator" style="color:rgb(127, 219, 202)">...</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"> </span><span class="token property-access maybe-class-name">Done</span><span class="token operator" style="color:rgb(127, 219, 202)">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token maybe-class-name">Installing</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">package</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;OmniSharp (.NET 4.6 / x64)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token maybe-class-name">Installing</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">package</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;.NET Core Debugger (Windows / x64)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token maybe-class-name">Finished</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Note that mention of &quot;debugger&quot; there? Sounds super-promising. There&#x27;s also some prompts: <code>&quot;There are unresolved dependencies from &#x27;WebApplication1/WebApplication1.csproj&#x27;. Please execute the restore command to continue&quot;</code></p><p>So it wants me to <code>dotnet restore</code>. It&#x27;s even offering to do that for me! Have at you; I let it.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ts"><pre tabindex="0" class="prism-code language-ts codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token maybe-class-name">Welcome</span><span class="token plain"> to </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token constant" style="color:rgb(130, 170, 255)">NET</span><span class="token plain"> </span><span class="token maybe-class-name">Core</span><span class="token operator" style="color:rgb(127, 219, 202)">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token maybe-class-name">Learn</span><span class="token plain"> more about </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token constant" style="color:rgb(130, 170, 255)">NET</span><span class="token plain"> </span><span class="token maybe-class-name">Core</span><span class="token plain"> @ https</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">aka</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">ms</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">dotnet</span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">docs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"> </span><span class="token property-access maybe-class-name">Use</span><span class="token plain"> dotnet </span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token plain">help to see available commands or go to https</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">aka</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">ms</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">dotnet</span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">cli</span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">docs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token property-access maybe-class-name">Telemetry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token maybe-class-name">The</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token constant" style="color:rgb(130, 170, 255)">NET</span><span class="token plain"> </span><span class="token maybe-class-name">Core</span><span class="token plain"> tools collect usage data </span><span class="token keyword" style="color:rgb(127, 219, 202)">in</span><span class="token plain"> order to improve your experience</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"> </span><span class="token property-access maybe-class-name">The</span><span class="token plain"> data </span><span class="token keyword" style="color:rgb(127, 219, 202)">is</span><span class="token plain"> anonymous and does not include command</span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">line arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"> </span><span class="token property-access maybe-class-name">The</span><span class="token plain"> data </span><span class="token keyword" style="color:rgb(127, 219, 202)">is</span><span class="token plain"> collected by </span><span class="token maybe-class-name">Microsoft</span><span class="token plain"> and shared </span><span class="token keyword" style="color:rgb(127, 219, 202)">with</span><span class="token plain"> the community</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token property-access maybe-class-name">You</span><span class="token plain"> can opt out </span><span class="token keyword" style="color:rgb(127, 219, 202)">of</span><span class="token plain"> telemetry by setting a </span><span class="token constant" style="color:rgb(130, 170, 255)">DOTNET_CLI_TELEMETRY_OPTOUT</span><span class="token plain"> environment variable to </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> using your favorite shell</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token property-access maybe-class-name">You</span><span class="token plain"> can read more about </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token constant" style="color:rgb(130, 170, 255)">NET</span><span class="token plain"> </span><span class="token maybe-class-name">Core</span><span class="token plain"> tools telemetry @ https</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">aka</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">ms</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">dotnet</span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">cli</span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">telemetry</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token property-access maybe-class-name">Configuring</span><span class="token spread operator" style="color:rgb(127, 219, 202)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">--</span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token constant" style="color:rgb(130, 170, 255)">A</span><span class="token plain"> command </span><span class="token keyword" style="color:rgb(127, 219, 202)">is</span><span class="token plain"> running to initially populate your local </span><span class="token keyword" style="color:rgb(127, 219, 202)">package</span><span class="token plain"> cache</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> to improve restore speed and enable offline access</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"> </span><span class="token property-access maybe-class-name">This</span><span class="token plain"> command will take up to a minute to complete and will only happen once</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token property-access maybe-class-name">Decompressing</span><span class="token plain"> </span><span class="token maybe-class-name">Decompressing</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100</span><span class="token operator" style="color:rgb(127, 219, 202)">%</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">4026</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token maybe-class-name">Expanding</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100</span><span class="token operator" style="color:rgb(127, 219, 202)">%</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">34814</span><span class="token plain"> ms</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token maybe-class-name">Restoring</span><span class="token plain"> packages </span><span class="token keyword" style="color:rgb(127, 219, 202)">for</span><span class="token plain"> c</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain">\</span><span class="token maybe-class-name">Source</span><span class="token plain">\</span><span class="token maybe-class-name">Debugging</span><span class="token plain">\</span><span class="token maybe-class-name">WebApplication1</span><span class="token plain">\</span><span class="token maybe-class-name">WebApplication1</span><span class="token plain">\</span><span class="token maybe-class-name">WebApplication1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">csproj</span><span class="token spread operator" style="color:rgb(127, 219, 202)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token maybe-class-name">Restoring</span><span class="token plain"> packages </span><span class="token keyword" style="color:rgb(127, 219, 202)">for</span><span class="token plain"> c</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain">\</span><span class="token maybe-class-name">Source</span><span class="token plain">\</span><span class="token maybe-class-name">Debugging</span><span class="token plain">\</span><span class="token maybe-class-name">WebApplication1</span><span class="token plain">\</span><span class="token maybe-class-name">WebApplication1</span><span class="token plain">\</span><span class="token maybe-class-name">WebApplication1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">csproj</span><span class="token spread operator" style="color:rgb(127, 219, 202)">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token maybe-class-name">Restore</span><span class="token plain"> completed </span><span class="token keyword" style="color:rgb(127, 219, 202)">in</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">734.05</span><span class="token plain"> ms </span><span class="token keyword" style="color:rgb(127, 219, 202)">for</span><span class="token plain"> c</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain">\</span><span class="token maybe-class-name">Source</span><span class="token plain">\</span><span class="token maybe-class-name">Debugging</span><span class="token plain">\</span><span class="token maybe-class-name">WebApplication1</span><span class="token plain">\</span><span class="token maybe-class-name">WebApplication1</span><span class="token plain">\</span><span class="token maybe-class-name">WebApplication1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">csproj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property-access maybe-class-name">Generating</span><span class="token plain"> </span><span class="token maybe-class-name">MSBuild</span><span class="token plain"> file c</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain">\</span><span class="token maybe-class-name">Source</span><span class="token plain">\</span><span class="token maybe-class-name">Debugging</span><span class="token plain">\</span><span class="token maybe-class-name">WebApplication1</span><span class="token plain">\</span><span class="token maybe-class-name">WebApplication1</span><span class="token plain">\obj\</span><span class="token maybe-class-name">WebApplication1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">csproj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">nuget</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">g</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">props</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property-access maybe-class-name">Writing</span><span class="token plain"> lock file to disk</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"> </span><span class="token property-access maybe-class-name">Path</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> c</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain">\</span><span class="token maybe-class-name">Source</span><span class="token plain">\</span><span class="token maybe-class-name">Debugging</span><span class="token plain">\</span><span class="token maybe-class-name">WebApplication1</span><span class="token plain">\</span><span class="token maybe-class-name">WebApplication1</span><span class="token plain">\obj\project</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">assets</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token maybe-class-name">Restore</span><span class="token plain"> completed </span><span class="token keyword" style="color:rgb(127, 219, 202)">in</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1.26</span><span class="token plain"> sec </span><span class="token keyword" style="color:rgb(127, 219, 202)">for</span><span class="token plain"> c</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain">\</span><span class="token maybe-class-name">Source</span><span class="token plain">\</span><span class="token maybe-class-name">Debugging</span><span class="token plain">\</span><span class="token maybe-class-name">WebApplication1</span><span class="token plain">\</span><span class="token maybe-class-name">WebApplication1</span><span class="token plain">\</span><span class="token maybe-class-name">WebApplication1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">csproj</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property-access maybe-class-name">NuGet</span><span class="token plain"> </span><span class="token maybe-class-name">Config</span><span class="token plain"> files used</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token constant" style="color:rgb(130, 170, 255)">C</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain">\</span><span class="token maybe-class-name">Users</span><span class="token plain">\johnr\</span><span class="token maybe-class-name">AppData</span><span class="token plain">\</span><span class="token maybe-class-name">Roaming</span><span class="token plain">\</span><span class="token maybe-class-name">NuGet</span><span class="token plain">\</span><span class="token maybe-class-name">NuGet</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">Config</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token constant" style="color:rgb(130, 170, 255)">C</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain">\</span><span class="token maybe-class-name">Program</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">Files</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x86</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">\</span><span class="token maybe-class-name">NuGet</span><span class="token plain">\</span><span class="token maybe-class-name">Config</span><span class="token plain">\</span><span class="token maybe-class-name">Microsoft</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">VisualStudio</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access maybe-class-name">Offline</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">config</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token maybe-class-name">Feeds</span><span class="token plain"> used</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      https</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">api</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">nuget</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">org</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">v3</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token constant" style="color:rgb(130, 170, 255)">C</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain">\</span><span class="token maybe-class-name">Program</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">Files</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x86</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">\</span><span class="token maybe-class-name">Microsoft</span><span class="token plain"> </span><span class="token maybe-class-name">SDKs</span><span class="token plain">\</span><span class="token maybe-class-name">NuGetPackages</span><span class="token plain">\</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token maybe-class-name">Done</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The other prompt says <code>&quot;Required assets to build and debug are missing from &#x27;WebApplication1&#x27;. Add them?&quot;</code>. This also sounds very promising and I give it the nod. This creates a <code>.vscode</code> directory and 2 enclosed files; <code>launch.json</code> and <code>tasks.json</code>.</p><p>So lets try that F5 thing again... http://localhost:5000/ is now serving the same app. That looks pretty good. So lets add a breakpoint to the <code>HomeController</code> and see if we can hit it:</p><p><img src="/assets/images/firstgo-3072a00af0157003bc667ee05673295f.png"></p><p>Well I can certainly add a breakpoint but all those red squigglies are unnerving me. Let&#x27;s clean the slate. If you want to simply do that in VS Code hold down <code>CTRL+SHIFT+P</code> and then type &quot;reload&quot;. Pick &quot;Reload window&quot;. A couple of seconds later we&#x27;re back in and Code is looking much happier. Can we hit our breakpoint?</p><p><img src="/assets/images/secondgo-bdaf2c0e127b63dcea3c224d1c8a7f49.png"></p><p>Yes we can! So you&#x27;re free to develop in either Code or VS; the choice is yours. I think that&#x27;s pretty awesome - and well done to all the peeople behind Code who&#x27;ve made this a pretty seamless experience!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/vs-code">VS Code</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/asp-net-core">ASP.Net Core</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/visual-studio">Visual Studio</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Debugging ASP.Net Core in VS or Code" href="/2017/03/28/debugging-aspnet-core-in-vs-or-code"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.699d7d58.js"></script>
<script src="/assets/js/main.f167c9f1.js"></script>
</body>
</html>