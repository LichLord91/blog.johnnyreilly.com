<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=297675200"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","297675200",{})</script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#3578e5">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">4 posts tagged with &quot;Authentication&quot; | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="4 posts tagged with &quot;Authentication&quot; | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/tags/authentication"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-react-helmet="true" name="robots" content="max-image-preview:large"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/tags/authentication"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/authentication" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/authentication" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.85320736.css">
<link rel="preload" href="/assets/js/runtime~main.2c8efce8.js" as="script">
<link rel="preload" href="/assets/js/main.c1b2d702.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://polywork.johnnyreilly.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Polywork<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_q+wC thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_9G5K margin-bottom--md">Recent posts</div><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/2021/12/29/preload-fonts-with-docusaurus">Preload fonts with Docusaurus</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/2021/12/28/azure-cli-show-query-output-properties">Query deployment outputs with the Azure CLI</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/2021/12/27/azure-container-apps-build-and-deploy-with-bicep-and-github-actions">Azure Container Apps: build and deploy with Bicep and GitHub Actions</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/2021/12/19/azure-container-apps-bicep-and-github-actions">Azure Container Apps, Bicep and GitHub Actions</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/2021/12/12/open-graph-sharing-previews-guide">Open Graph: a guide to sharable social media previews</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>4 posts tagged with &quot;Authentication&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/2021/01/14/azure-easy-auth-and-roles-with-dotnet-and-core">Azure Easy Auth and Roles with .NET (and .NET Core)</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-01-14T00:00:00.000Z" itemprop="datePublished">January 14, 2021</time> · <!-- -->6 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><em>If this post is interesting to you, you may also want to <a href="/2021/01/17/azure-easy-auth-and-roles-with-net-and-microsoft-identity-web">look at this one where we try to use Microsoft.Identity.Web for the same purpose.</a></em></p><p>Azure has a feature which is intended to allow Authentication and Authorization to be applied outside of your application code. It&#x27;s called <a href="https://docs.microsoft.com/en-us/azure/app-service/overview-authentication-authorization" target="_blank" rel="noopener noreferrer">&quot;Easy Auth&quot;</a>. Unfortunately, in the context of App Services it doesn&#x27;t work with .NET Core and .NET. Perhaps it would be better to say: of the various .NETs, it supports .NET Framework. <a href="https://docs.microsoft.com/en-us/azure/app-service/overview-authentication-authorization#userapplication-claims" target="_blank" rel="noopener noreferrer">To quote the docs</a>:</p><blockquote><p>At this time, ASP.NET Core does not currently support populating the current user with the Authentication/Authorization feature. However, some <a href="https://github.com/MaximRouiller/MaximeRouiller.Azure.AppService.EasyAuth" target="_blank" rel="noopener noreferrer">3rd party, open source middleware components</a> do exist to help fill this gap.</p></blockquote><p>Thanks to <a href="https://twitter.com/MaximRouiller" target="_blank" rel="noopener noreferrer">Maxime Rouiller</a> there&#x27;s a way forward here. However, as I was taking this for a spin today, I discovered another issue.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="where-are-our-roles">Where are our roles?<a class="hash-link" href="#where-are-our-roles" title="Direct link to heading">​</a></h2><p>Consider the following .NET controller:</p><div class="codeBlockContainer_J+bg language-cs theme-code-block"><div class="codeBlockContent_csEI cs"><pre tabindex="0" class="prism-code language-cs codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">[Authorize(Roles = &quot;Administrator,Reader&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">[HttpGet(&quot;api/admin-reader&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">public string GetWithAdminOrReader() =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    &quot;this is a secure endpoint that users with the Administrator or Reader role can access&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">[Authorize(Roles = &quot;Administrator&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">[HttpGet(&quot;api/admin&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">public string GetWithAdmin() =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    &quot;this is a secure endpoint that users with the Administrator role can access&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">[Authorize(Roles = &quot;Reader&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">[HttpGet(&quot;api/reader&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">public string GetWithReader() =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    &quot;this is a secure endpoint that users with the Reader role can access&quot;;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The three endpoints above restrict access based upon roles. However, even with Maxime&#x27;s marvellous shim in the mix, authorization doesn&#x27;t work when deployed to an Azure App Service. Why? Well, it comes down to how roles are mapped to claims.</p><p>Let&#x27;s back up a bit. First of all we&#x27;ve added a dependency to our project:</p><div class="codeBlockContainer_J+bg language-shell theme-code-block"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> package MaximeRouiller.Azure.AppService.EasyAuth</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Next we&#x27;ve updated our <code>Startup.ConfigureServices</code> such that it looks like this:</p><div class="codeBlockContainer_J+bg language-cs theme-code-block"><div class="codeBlockContent_csEI cs"><pre tabindex="0" class="prism-code language-cs codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">if (Env.IsDevelopment()) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    services.AddMicrosoftIdentityWebAppAuthentication(Configuration);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">else</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    services.AddAuthentication(&quot;EasyAuth&quot;).AddEasyAuthAuthentication((o) =&gt; { });</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>With the above in place, either the Microsoft Identity platform will directly be used for authentication, or Maxime&#x27;s package will be used as the default authentication scheme. The driver for this is <code>Env</code> which is an <code>IHostEnvironment</code> that was injected to the <code>Startup.cs</code>. Running locally, both authentication and authorization will work. However, deployed to an Azure App Service, only authentication will work.</p><p>It turns out that directly using the Microsoft Identity platform, we see roles claims coming through like so:</p><div class="codeBlockContainer_J+bg language-json theme-code-block"><div class="codeBlockContent_csEI json"><pre tabindex="0" class="prism-code language-json codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Administrator&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Reader&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>But in Azure we see roles claims showing up with a different <code>type</code>:</p><div class="codeBlockContainer_J+bg language-json theme-code-block"><div class="codeBlockContent_csEI json"><pre tabindex="0" class="prism-code language-json codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;roles&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Administrator&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;roles&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Reader&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This is the crux of the problem; .NET and .NET Core are looking in a different place for roles.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="role-up-role-up">Role up, role up!<a class="hash-link" href="#role-up-role-up" title="Direct link to heading">​</a></h2><p>There wasn&#x27;t an obvious way to make this work with Maxime&#x27;s package. So we ended up lifting the source code of Maxime&#x27;s package and tweaking it. Take a look:</p><div class="codeBlockContainer_J+bg language-cs theme-code-block"><div class="codeBlockContent_csEI cs"><pre tabindex="0" class="prism-code language-cs codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.AspNetCore.Authentication;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.Logging;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.Options;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Collections.Generic;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Linq;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Security.Claims;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Text.Encodings.Web;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Text.Json;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Text.Json.Serialization;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Threading.Tasks;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">/// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">/// Based on https://github.com/MaximRouiller/MaximeRouiller.Azure.AppService.EasyAuth</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">/// Essentially EasyAuth only supports .NET Framework: https://docs.microsoft.com/en-us/azure/app-service/app-service-authentication-how-to#access-user-claims</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">/// This allows us to get support for Authentication and Authorization (using roles) with .NET</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">/// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace EasyAuth {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static class EasyAuthAuthenticationBuilderExtensions {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static AuthenticationBuilder AddEasyAuthAuthentication(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            this IServiceCollection services) =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            services.AddAuthentication(&quot;EasyAuth&quot;).AddEasyAuthAuthenticationScheme(o =&gt; { });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static AuthenticationBuilder AddEasyAuthAuthenticationScheme(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            this AuthenticationBuilder builder,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Action&lt;EasyAuthAuthenticationOptions&gt; configure) =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                builder.AddScheme&lt;EasyAuthAuthenticationOptions, EasyAuthAuthenticationHandler&gt;(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    &quot;EasyAuth&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    &quot;EasyAuth&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    configure);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class EasyAuthAuthenticationOptions : AuthenticationSchemeOptions {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public EasyAuthAuthenticationOptions() {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Events = new object();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class EasyAuthAuthenticationHandler : AuthenticationHandler&lt;EasyAuthAuthenticationOptions&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public EasyAuthAuthenticationHandler(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            IOptionsMonitor&lt;EasyAuthAuthenticationOptions&gt; options,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            ILoggerFactory logger,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            UrlEncoder encoder,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            ISystemClock clock)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            : base(options, logger, encoder, clock) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        protected override Task&lt;AuthenticateResult&gt; HandleAuthenticateAsync() {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var easyAuthEnabled = string.Equals(Environment.GetEnvironmentVariable(&quot;WEBSITE_AUTH_ENABLED&quot;, EnvironmentVariableTarget.Process), &quot;True&quot;, StringComparison.InvariantCultureIgnoreCase);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (!easyAuthEnabled) return Task.FromResult(AuthenticateResult.NoResult());</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var easyAuthProvider = Context.Request.Headers[&quot;X-MS-CLIENT-PRINCIPAL-IDP&quot;].FirstOrDefault();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var msClientPrincipalEncoded = Context.Request.Headers[&quot;X-MS-CLIENT-PRINCIPAL&quot;].FirstOrDefault();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (string.IsNullOrWhiteSpace(easyAuthProvider) ||</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    string.IsNullOrWhiteSpace(msClientPrincipalEncoded))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    return Task.FromResult(AuthenticateResult.NoResult());</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var decodedBytes = Convert.FromBase64String(msClientPrincipalEncoded);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var msClientPrincipalDecoded = System.Text.Encoding.Default.GetString(decodedBytes);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var clientPrincipal = JsonSerializer.Deserialize&lt;MsClientPrincipal&gt;(msClientPrincipalDecoded);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (clientPrincipal == null) return Task.FromResult(AuthenticateResult.NoResult());</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var mappedRolesClaims = clientPrincipal.Claims</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    .Where(claim =&gt; claim.Type == &quot;roles&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    .Select(claim =&gt; new Claim(ClaimTypes.Role, claim.Value))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    .ToList();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var claims = clientPrincipal.Claims.Select(claim =&gt; new Claim(claim.Type, claim.Value)).ToList();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                claims.AddRange(mappedRolesClaims);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var principal = new ClaimsPrincipal();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                principal.AddIdentity(new ClaimsIdentity(claims, clientPrincipal.AuthenticationType, clientPrincipal.NameType, clientPrincipal.RoleType));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var ticket = new AuthenticationTicket(principal, easyAuthProvider);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var success = AuthenticateResult.Success(ticket);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                Context.User = principal;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return Task.FromResult(success);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            } catch (Exception ex) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return Task.FromResult(AuthenticateResult.Fail(ex));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class MsClientPrincipal {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [JsonPropertyName(&quot;auth_typ&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public string? AuthenticationType { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [JsonPropertyName(&quot;claims&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IEnumerable&lt;UserClaim&gt; Claims { get; set; } = Array.Empty&lt;UserClaim&gt;();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [JsonPropertyName(&quot;name_typ&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public string? NameType { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [JsonPropertyName(&quot;role_typ&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public string? RoleType { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class UserClaim {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [JsonPropertyName(&quot;typ&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public string Type { get; set; } = string.Empty;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [JsonPropertyName(&quot;val&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public string Value { get; set; } = string.Empty;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>There&#x27;s a number of changes in the above code to Maxime&#x27;s package. Three changes that are not significant and one that is. First the insignificant changes:</p><ol><li>It uses <a href="https://docs.microsoft.com/en-us/dotnet/standard/serialization/system-text-json-how-to?pivots=dotnet-5-0" target="_blank" rel="noopener noreferrer"><code>System.Text.Json</code></a> in place of JSON.NET</li><li>It uses <a href="/2020/12/20/nullable-reference-types-csharp-strictnullchecks">C#s nullable reference types</a></li><li>It changes the extension method signature such that instead of entering <code>services.AddAuthentication().AddEasyAuthAuthentication((o) =&gt; { })</code> we now need only enter <code>services.AddEasyAuthAuthentication()</code></li></ol><p>Now the significant change:</p><p>Where the middleware encounters claims in the <code>X-MS-CLIENT-PRINCIPAL</code> header with the <code>Type</code> of <code>&quot;roles&quot;</code> it creates brand new claims for each, with the same <code>Value</code> but with the official <code>Type</code> supplied by <code>ClaimsTypes.Role</code> of <code>&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</code>. The upshot of this, is that when the processed claims are inspected in Azure they now look more like this:</p><div class="codeBlockContainer_J+bg language-json theme-code-block"><div class="codeBlockContent_csEI json"><pre tabindex="0" class="prism-code language-json codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;roles&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Administrator&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;roles&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Reader&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Administrator&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Reader&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As you can see, we now have both the originally supplied roles <em>as well</em> as roles of the type that .NET and .NET Core expect. Consequently, roles based behaviour starts to work. Thanks to Maxime for his fine work on the initial solution. It would be tremendous if neither the code in this blog post nor Maxime&#x27;s shim were required. Still, until that glorious day!</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="update-potential-ways-forward">Update: Potential ways forward<a class="hash-link" href="#update-potential-ways-forward" title="Direct link to heading">​</a></h2><p>When I was tweeting this post, Maxime was good enough to respond and suggest that this may be resolved within Azure itself in future:</p><blockquote><p>Oh, so that&#x27;s why they removed the name? 😲😜 Jokes aside, we hope that this package won&#x27;t be necessary for the future. I know that <a href="https://twitter.com/mattchenderson?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">@mattchenderson</a> is part of a working group to update Easy Auth. Might want to make sure you follow him as well. 😁</p><p>— Maxime Rouiller (@MaximRouiller) <a href="https://twitter.com/MaximRouiller/status/1349804324713615366?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">January 14, 2021</a></p></blockquote><p>There&#x27;s a prospective PR that would add an event to Maxime&#x27;s API. If something along these lines was merged, then my workaround would no longer be necessary. Follow the PR <a href="https://github.com/MaximRouiller/MaximeRouiller.Azure.AppService.EasyAuth/pull/13" target="_blank" rel="noopener noreferrer">here</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/azure">Azure</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/app-service">App service</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/authorisation">authorisation</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/authentication">Authentication</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/azure-ad">azure AD</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Azure Easy Auth and Roles with .NET (and .NET Core)" href="/2021/01/14/azure-easy-auth-and-roles-with-dotnet-and-core"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/2020/03/22/dual-boot-authentication-with-aspnetcore">Dual boot authentication with ASP.NET</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2020-03-22T00:00:00.000Z" itemprop="datePublished">March 22, 2020</time> · <!-- -->9 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This is a post about having two kinds of authentication working at the same time in ASP.Net Core. But choosing which authentication method to use dynamically at runtime; based upon the criteria of your choice.</p><p>Already this sounds complicated; let&#x27;s fix that. Perhaps I should describe my situation to you. I&#x27;ve an app which has two classes of user. One class, let&#x27;s call them &quot;customers&quot; (because... uh... they&#x27;re customers). The customers access our application via a public facing website. Traffic rolls through Cloudflare and into our application. The public facing URL is something fancy like <a href="https://mega-app.com" target="_blank" rel="noopener noreferrer">https://mega-app.com</a>. That&#x27;s one class of user.</p><p>The other class of user we&#x27;ll call &quot;our peeps&quot;; because they are <em>us</em>. We use the app that we build. Traffic from &quot;us&quot; comes from a different hostname; only addressable on our network. So URLs from requests that we make are more along the lines of <a href="https://strictly4mypeeps.io" target="_blank" rel="noopener noreferrer">https://strictly4mypeeps.io</a>.</p><p>So far, so uncontroversial. Now it starts to get interesting. Our customers log into our application using their super secret credentials. It&#x27;s <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/cookie?view=aspnetcore-3.1#create-an-authentication-cookie" target="_blank" rel="noopener noreferrer">cookie based authentication</a>. But for our peeps we do something different. Having to enter your credentials each time you use the app is friction. It gets in the way. So for us we have <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/azure-active-directory/?view=aspnetcore-3.1" target="_blank" rel="noopener noreferrer">Azure AD</a> in the mix. Azure AD is how we authenticate ourselves; and that means we don&#x27;t spend 5% of each working day entering credentials.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="let-us-speak-of-the-past">Let us speak of the past<a class="hash-link" href="#let-us-speak-of-the-past" title="Direct link to heading">​</a></h2><p>Now our delightful little application grew up in a simpler time. A time where you went to the marketplace, picked out some healthy looking servers, installed software upon them, got them attached to the internet, deployed an app onto them and said &quot;hey presto, we&#x27;re live!&quot;.</p><p>Way back when, we had some servers on the internet, that&#x27;s how our customers got to our app. Our peeps, us, we went to other servers that lived on our network. So we had multiple instances of our app, deployed to different machines. The ones on the internet were configured to use cookie based auth, the ones on our internal network were Azure AD.</p><p>As I said, a simpler time.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="a-new-hope">A new hope<a class="hash-link" href="#a-new-hope" title="Direct link to heading">​</a></h2><p>We&#x27;ve been going through the process of cloudifying our app. Bye, bye servers, hello <a href="https://www.docker.com/" target="_blank" rel="noopener noreferrer">Docker</a> and <a href="https://kubernetes.io/" target="_blank" rel="noopener noreferrer">Kubernetes</a>. So exciting! As we change the way our app is built and deployed; we&#x27;ve been thinking about whether the choices we make still make sense.</p><p>When it came to authentication, my initial thoughts were to continue the same road we&#x27;re travelling; just in containers and pods. So where we had &quot;internal&quot; servers, we&#x27;d have &quot;internal&quot; pods, and where we&#x27;d have &quot;external&quot; servers we&#x27;d have external pods. I had the good fortune to be working with the amazingly talented <a href="https://uk.linkedin.com/in/robert-grzankowski-53618114" target="_blank" rel="noopener noreferrer">Robski</a>. Robski knows far more about K8s and networking than I&#x27;m ever likely to. He&#x27;d regularly say things like &quot;ingress&quot; and &quot;MTLS&quot; whilst I stared blankly at him. He definitely knows stuff.</p><p>Robski challenged my plans. &quot;We don&#x27;t need it. Have one pod that does both sorts of auth. If you do that, your implementation is simpler and scaling is more straightforward. You&#x27;ll only need half the pods because you won&#x27;t need internal <em>and</em> external ones; one pod can handle both sets of traffic. You&#x27;ll save money.&quot;</p><p>I loved the idea but I didn&#x27;t think that ASP.Net Core supported it. &quot;It&#x27;s just not a thing Robski; ASP.Net Core doesn&#x27;t suppport it.&quot; Robski didn&#x27;t believe me. That turned out to a <em>very good thing</em>. There followed a period of much googling and experimentation. One day of hunting in, I was still convinced there was no way to do it that would allow me to look in the mirror without self loathing. Then Robski sent me this:</p><p><img alt="screenshot of WhatsApp message with a link in it" src="/assets/images/robski-dynamic-auth-9ac401590462e2bece9156353b92d187.png"></p><p>It was a link to the amazing <a href="https://twitter.com/davidfowl" target="_blank" rel="noopener noreferrer">David Fowler</a> talking about <a href="https://github.com/aspnet/Security/issues/1469#issuecomment-335027005" target="_blank" rel="noopener noreferrer">some API I&#x27;d never heard of called <code>SchemeSelector</code></a>. It turned out that this was the starting point for exactly what we needed; a way to dynamically select an authentication scheme at runtime.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="show-me-the-code">Show me the code<a class="hash-link" href="#show-me-the-code" title="Direct link to heading">​</a></h2><p>This API did end up landing in ASP.Net Core, but with the name <code>ForwardDefaultSelector</code>. Not the most descriptive of names and I&#x27;ve struggled to find any documentation on it at all. What I did discover was <a href="https://stackoverflow.com/a/51897159/761388" target="_blank" rel="noopener noreferrer">an answer on StackOverflow by the marvellous Barbara Post</a>. I was able to take the approach Barbara laid out and use it to my own ends. I ended up with this snippet of code added to my <code>Startup.ConfigureServices</code>:</p><div class="codeBlockContainer_J+bg language-cs theme-code-block"><div class="codeBlockContent_csEI cs"><pre tabindex="0" class="prism-code language-cs codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">services</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    .AddAuthentication(sharedOptions =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        sharedOptions.DefaultScheme = &quot;WhichAuthDoWeUse&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        sharedOptions.DefaultAuthenticateScheme = &quot;WhichAuthDoWeUse&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        sharedOptions.DefaultChallengeScheme = &quot;WhichAuthDoWeUse&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    .AddPolicyScheme(&quot;WhichAuthDoWeUse&quot;, &quot;Azure AD or Cookies&quot;, options =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        options.ForwardDefaultSelector = context =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var (isExternalRequest, requestUrl) = context.Request.GetIsExternalRequestAndDomain();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (isExternalRequest) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                _logger.LogInformation(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    &quot;Request ({RequestURL}) has come from external domain ({Domain}) so using Cookie Authentication&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    requestUrl, ExternalBaseUrl);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return CookieAuthenticationDefaults.AuthenticationScheme;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">           }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">           _logger.LogInformation(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">               &quot;Request ({RequestURL}) has not come from external domain ({Domain}) so using Azure AD Authentication&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">               requestUrl, ExternalBaseUrl);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return AzureADDefaults.AuthenticationScheme;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    .AddAzureAD(options =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        Configuration.Bind(&quot;AzureAd&quot;, options);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    .AddCookie(options =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        options.Cookie.SecurePolicy = CookieSecurePolicy.Always;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        options.Cookie.SameSite = SameSiteMode.Strict;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        options.Cookie.HttpOnly = true;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        options.Events.OnRedirectToAccessDenied = (context) =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            context.Response.StatusCode = Microsoft.AspNetCore.Http.StatusCodes.Status401Unauthorized;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return Task.CompletedTask;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        options.Events.OnRedirectToLogin = (context) =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            context.Response.StatusCode = Microsoft.AspNetCore.Http.StatusCodes.Status401Unauthorized;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return Task.CompletedTask;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    });</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>If you look at this code it&#x27;s doing these things:</p><ol><li>Registering three types of authentication: Cookie, Azure AD and &quot;WhichAuthDoWeUse&quot;</li><li>Registers the default <code>Scheme</code> to be &quot;WhichAuthDoWeUse&quot;.</li></ol><p>&quot;WhichAuthDoWeUse&quot; is effectively an <code>if</code> statement that says, <em>&quot;if this is an external <code>Request</code> use Cookies authentication, otherwise use Azure AD&quot;</em>. Given that &quot;WhichAuthDoWeUse&quot; is the default scheme, this code runs for each request, to determine which authentication method to use.</p><p>Alongside this mechanism I added these extension methods:</p><div class="codeBlockContainer_J+bg language-cs theme-code-block"><div class="codeBlockContent_csEI cs"><pre tabindex="0" class="prism-code language-cs codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.AspNetCore.Http;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.AspNetCore.Http.Extensions;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace My.App.Auth {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static class AuthExtensions {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public const string ExternalBaseUrl = &quot;https://mega-app.com&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public const string InternalBaseUrl = &quot;https://strictly4mypeeps.io&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// Determines if a request is an &quot;external&quot; URL (eg begins &quot;https://mega-app.com&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// or an &quot;internal&quot; URL (eg begins &quot;https://strictly4mypeeps.io&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static (bool, string) GetIsExternalRequestAndDomain(this HttpRequest request) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var (requestUrl, domain) = GetRequestUrlAndDomain(request);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var isExternalUrl = domain == ExternalBaseUrl;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var isUnknownPath = domain == null; // This scenario is extremely unlikely but has been observed once during testing so we will cater for it</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var isExternalRequest = isExternalUrl || isUnknownPath; // If unknown we&#x27;ll treat as &quot;external&quot; for a safe fallback</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return (isExternalRequest, requestUrl);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// Determines if a request is an &quot;external&quot; URL (eg begins &quot;https://mega-app.com&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// or an &quot;internal&quot; URL (eg begins &quot;https://strictly4mypeeps.io&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static (bool, string) GetIsInternalRequestAndDomain(this HttpRequest request) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var (requestUrl, domain) = GetRequestUrlAndDomain(request);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var isInternalRequest = domain == InternalBaseUrl;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return (isInternalRequest, requestUrl);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private static (string, string) GetRequestUrlAndDomain(HttpRequest request) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            string requestUrl = null;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            string domain = null;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (request.Host.HasValue) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                requestUrl = request.GetEncodedUrl();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                domain = new Uri(requestUrl).GetLeftPart(UriPartial.Authority);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return (requestUrl, domain);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Finally, I updated the <code>SpaController.cs</code> (which serves initial requests to our Single Page Application) to cater for having two types of Auth in play:</p><div class="codeBlockContainer_J+bg language-cs theme-code-block"><div class="codeBlockContent_csEI cs"><pre tabindex="0" class="prism-code language-cs codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// ASP.NET will try and load the index.html using the FileServer if we don&#x27;t have a route</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// here to match `/`. These attributes can&#x27;t be on Index or the spa fallback doesn&#x27;t work</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// Note: this is almost perfect except that if someone actually calls /index.html they&#x27;ll get</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// the FileServer one, not the one from this file.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [HttpGet(&quot;/&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [AllowAnonymous]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public async Task&lt;IActionResult&gt; SpaFallback([FromQuery] string returnUrl) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var redirectUrlIfUserIsInternalAndNotAuthenticated = GetRedirectUrlIfUserIsInternalAndNotAuthenticated(returnUrl);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (redirectUrlIfUserIsInternalAndNotAuthenticated != null)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return LocalRedirect(redirectUrlIfUserIsInternalAndNotAuthenticated);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return await Index(); // Index just serves up our SPA index.html</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// SPA landing with authorisation - this endpoint will typically not be directly navigated to by a user;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// rather it will be redirected to from the IndexWithoutAuthorisation and SpaFallback actions above</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// in the case where a user is *not* authenticated but has come from an internal URL eg https://strictlyformypeeps.io</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [HttpGet(&quot;/login-with-azure-ad&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [Authorize]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public async Task&lt;IActionResult&gt; IndexWithAuthorisation()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return await Index(); // Index just serves up our SPA index.html</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// This method returns a RedirectURL if a request is coming from an internal URL</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// eg https://int.prd.our.cloud and is not authenticated.  In this case</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// we likely want to trigger authentication by redirecting to an authorized endpoint</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        string GetRedirectUrlIfUserIsInternalAndNotAuthenticated(string returnUrl)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // If a user is authenticated then we don&#x27;t need to trigger authentication</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var isAuthenticated = User?.Identity?.Name != null;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (isAuthenticated)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return null;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // This scenario is extremely unlikely but has been observed once during testing so we will cater for it</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var (isInternalRequest, requestUrl) = Request.GetIsInternalRequestAndDomain();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (isInternalRequest) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var redirectUrl = $&quot;/login-with-azure-ad{(string.IsNullOrEmpty(returnUrl) ? &quot;&quot; : &quot;?returnUrl=&quot; + WebUtility.UrlEncode(returnUrl))}&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                _logger.LogInformation(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    &quot;Request ({RequestURL}) has come from internal domain ({InternalDomain}) but is not authenticated; redirecting to {RedirectURL}&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    requestUrl, AuthExtensions.InternalBaseUrl, redirectUrl);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return redirectUrl;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return null;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The code above allows anonymous requests to land in our app through the <code>AllowAnonymous</code> attribute. However, it checks the request when it comes in to see if:</p><ol><li>It&#x27;s an internal request (i.e. the Request URL starts &quot;<a href="https://strictly4mypeeps.io/%22" target="_blank" rel="noopener noreferrer">https://strictly4mypeeps.io/&quot;</a>)</li><li>The current user is <em>not</em> authenticated.</li></ol><p>In this case the user is redirected to the <a href="https://strictly4mypeeps.io/login-with-azure-ad" target="_blank" rel="noopener noreferrer">https://strictly4mypeeps.io/login-with-azure-ad</a> route which is decorated with the <code>Authorize</code> attribute. This will trigger authentication for our unauthenticated internal users and drive them through the Azure AD login process.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="the-mystery-of-no-documentation">The mystery of no documentation<a class="hash-link" href="#the-mystery-of-no-documentation" title="Direct link to heading">​</a></h2><p>I&#x27;m so surprised that this approach hasn&#x27;t yet been better documented on the (generally superb) ASP.Net Core docs. It&#x27;s such a potentially useful approach; and in our case, money saving too! I hope the official docs feature something on this in future. If they do, and I&#x27;ve just missed it (possible!) then please hit me up in the comments.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/authentication">Authentication</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/dual-authentication">dual authentication</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/cookie">Cookie</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/azure-ad">Azure AD</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/forward-default-selector">ForwardDefaultSelector</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/asp-net">ASP.NET</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Dual boot authentication with ASP.NET" href="/2020/03/22/dual-boot-authentication-with-aspnetcore"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/2019/08/02/asp-net-authentication-hard-coding-claims">ASP.NET Core authentication: hard-coding a claim in development</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2019-08-02T00:00:00.000Z" itemprop="datePublished">August 2, 2019</time> · <!-- -->3 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This post demonstrates how you can hard code user authentication claims in ASP.NET Core; a useful technique to facilate testing during development.</p><p>I was recently part of a hackathon team that put together an API in just 30 hours. We came second. (Not bitter, not bitter...)</p><p>We were moving pretty quickly during the hackathon and, when we came to the end of it, we had a working API which we were able to demo. The good news is that the API is going to graduate to be a product! We&#x27;re going to ship this. Before we can do that though, there&#x27;s a little tidy up to do.</p><p>The first thing I remembered / realised when I picked up the codebase again, was the shortcuts we&#x27;d made on the developer experience. We&#x27;d put the API together using ASP.Net Core. We&#x27;re handling authentication using JWTs which is nicely supported. When we&#x27;re deployed, an external facing proxy calls our application with the appropriate JWT and everything works as you&#x27;d hope.</p><p>The question is, what&#x27;s it like to develop against this on your laptop? Getting a JWT for when I&#x27;m debugging locally is too much friction. I want to be able to work on the problem at hand, going away to get a JWT each time is a timesuck. So what to do? Well, during the hackathon, we just commented out <code>[Authorize]</code> attributes and hardcoded user ids in our controllers. This works, but it&#x27;s a messy developer experience; it&#x27;s easy to forget to uncomment things you&#x27;ve commented and break things. There must be a better way.</p><p>The solution I landed on was this: in development mode (which we only use whilst debugging) we hardcode an authenticated user. The way our authentication works is that we have a claim on our principal called something like <code>&quot;our-user-id&quot;</code>, the value of which is our authenticated user id. So in the <code>ConfigureServices</code> method of our <code>Startup.cs</code> we have a conditional authentication registration like this:</p><div class="codeBlockContainer_J+bg language-cs theme-code-block"><div class="codeBlockContent_csEI cs"><pre tabindex="0" class="prism-code language-cs codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">// Whilst developing, we don&#x27;t want to authenticate; we hardcode to a particular users id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">if (Env.IsDevelopment()) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    services.AddAuthentication(nameof(DevelopmentModeAuthenticationHandler))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        .AddScheme&lt;DevelopmentModeAuthenticationOptions, DevelopmentModeAuthenticationHandler&gt;(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            nameof(DevelopmentModeAuthenticationHandler),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            options =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                options.UserIdToSetInClaims = &quot;this-is-a-user-id&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">else {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // The application typically uses this</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        .AddJwtBearer(options =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As you can see, we&#x27;re using a special <code>DevelopmentModeAuthenticationHandler</code> authentication scheme in development mode, instead of JWT. As we register that, we declare the user id that we want to use. Whenever the app runs using the <code>DevelopmentModeAuthenticationHandler</code> auth, all requests will arrive using a principal with an <code>&quot;our-user-id&quot;</code> claim with a value of <code>&quot;this-is-a-user-id&quot;</code> (or whatever you&#x27;ve set it to.)</p><p>The <code>DevelopmentModeAuthenticationHandler</code> looks like this:</p><div class="codeBlockContainer_J+bg language-cs theme-code-block"><div class="codeBlockContent_csEI cs"><pre tabindex="0" class="prism-code language-cs codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Collections.Generic;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Security.Claims;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Text.Encodings.Web;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Threading.Tasks;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.AspNetCore.Authentication;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.Logging;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.Options;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace OurApp</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class DevelopmentModeAuthenticationOptions : AuthenticationSchemeOptions</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public string UserIdToSetInClaims { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class DevelopmentModeAuthenticationHandler : AuthenticationHandler&lt;DevelopmentModeAuthenticationOptions&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private readonly ILoggingService _loggingService;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public DevelopmentModeAuthenticationHandler(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            IOptionsMonitor&lt;DevelopmentModeAuthenticationOptions&gt; options,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            ILoggerFactory logger,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            UrlEncoder encoder,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            ISystemClock clock</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        ) : base(options, logger, encoder, clock) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        protected override Task&lt;AuthenticateResult&gt; HandleAuthenticateAsync() {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var claims = new List&lt;Claim&gt; { new Claim(&quot;our-user-id&quot;, Options.UserIdToSetInClaims) };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var identity = new ClaimsIdentity(claims, nameof(DevelopmentModeAuthenticationHandler));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var ticket = new AuthenticationTicket(new ClaimsPrincipal(identity), Scheme.Name);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return Task.FromResult(AuthenticateResult.Success(ticket));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Now, developing locally is frictionless! We don&#x27;t comment out <code>[Authorize]</code> attributes, we don&#x27;t hard code user ids in controllers.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/asp-net-core">ASP.Net Core</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/authentication">Authentication</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about ASP.NET Core authentication: hard-coding a claim in development" href="/2019/08/02/asp-net-authentication-hard-coding-claims"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_d4p0" itemprop="headline"><a itemprop="url" href="/2012/02/15/wcf-transport-windows-authentication">WCF Transport Windows authentication using NetTcpBinding in an Intranet environment</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2012-02-15T00:00:00.000Z" itemprop="datePublished">February 15, 2012</time> · <!-- -->5 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_y2LR" id="update">Update<a class="hash-link" href="#update" title="Direct link to heading">​</a></h2><p>Since I wrote this initial post I&#x27;ve taken thinks on a bit further. Take a look at this post to see what I mean: <a href="http://icanmakethiswork.blogspot.com/2012/03/wcf-moving-from-config-to-code-simple.html" target="_blank" rel="noopener noreferrer">http://icanmakethiswork.blogspot.com/2012/03/wcf-moving-from-config-to-code-simple.html</a> I know I said I&#x27;d write about JSON this time. I will get to that but not this time. This time WCF authentication quirks. I&#x27;ve been working on a project that uses .NET Remoting to have a single central point to which web applications and Windows services can call into. This is used in an intranet environment and all the websites and Windows services were hosted on the same single server along with our .NET Remoting Windows service. (They could quite easily have been on different servers but there was no need in this case.) It was decided to &quot;embrace the new&quot; by migrating this .NET Remoting project over to WCF. The plan wasn&#x27;t to do anything revolutionary, just to move from one approach to the other as easily as possible. I found the following useful article on MSDN: <a href="http://msdn.microsoft.com/en-us/library/aa730857%28v=vs.80%29.aspx" target="_blank" rel="noopener noreferrer">http://msdn.microsoft.com/en-us/library/aa730857%28v=vs.80%29.aspx</a> This particular article was helpful and following the steps enclosed I was quickly up and running with a basic WCF service hosted in a Windows service. It was at this point I started thinking about security. The existing .NET Remoting approach had no security in place. This wasn&#x27;t ideal but also probably wasn&#x27;t the worry you might think. It was hosted in an intranet environment and hence not so exposed to the rigours of the Wild Wild Web. However, since I was looking at WCF I thought it would be a good opportunity to get some basic security in place. This generally pleases auditors. I opted to use <a href="http://msdn.microsoft.com/en-us/library/ms733089.aspx" target="_blank" rel="noopener noreferrer">Windows Transport authentication</a> as this seemed pretty appropriate for an intranet environment. The idea being that we&#x27;d authenticate with Windows for an account in our domain. After headbutting Windows for some time I managed to get a successful client call going from the website running on my development machine to the (separate) development server that was hosting our WCF Window service using Transport Windows authentication. However, when deploying the website to the development server I discovered we would experience the following error when the website attempted to call the WCF service (on the same server).</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token plain">Event Type: Failure Audit</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Event Source: Security</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Event Category: Logon/Logoff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Event ID: 537</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Date: 15/02/2012</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Time: 16:32:04</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">User: NT AUTHORITY\SYSTEM</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Computer: MINE999</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Description:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Logon Failure:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Reason: An error occurred during logon</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Logon Type: 3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Logon Process: ^</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Authentication Package: NTLM</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Status code: 0xC000006D</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Not terribly helpful. At the end of the day it seemed we were suffering from a security &quot;feature&quot; introduced by Microsoft to prevent services calling services on the same box with a fully qualified name. An explanation of this can be found here: <a href="http://developers.de/blogs/damir_dobric/archive/2009/08/28/authentication-problems-by-using-of-ntlm.aspx" target="_blank" rel="noopener noreferrer">http://developers.de/blogs/damir_dobric/archive/2009/08/28/authentication-problems-by-using-of-ntlm.aspx</a> Using method 1 in the enclosed link I initially worked round this by amending the registry and rebooting the server: <a href="http://support.microsoft.com/kb/887993" target="_blank" rel="noopener noreferrer">http://support.microsoft.com/kb/887993</a> This was not a fantastic solution. Fortunately I subsequently found a better one but since the resources on the web are <!-- -->*<strong>ATROCIOUS</strong>*<!-- --> on this point I thought I should take the time to note down the full explanation since otherwise it&#x27;ll be lost in the mists of time. Here we go: The equivalent security to the previous .NET Remoting solution in WCF was to use this config setting on client and service:</p><div class="codeBlockContainer_J+bg language-xml theme-code-block"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">security</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">mode</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">None</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>As I&#x27;ve said, this is an intranet environment and so having this &quot;none&quot; security setting in place is made less worrying by the fact that the network itself is secured. But obviously this is not ideal and unlikely to be audit compliant. To use Windows security you need this netTcpBinding config setting on client and service:</p><div class="codeBlockContainer_J+bg language-xml theme-code-block"><div class="codeBlockContent_csEI xml"><pre tabindex="0" class="prism-code language-xml codeBlock_rtdJ thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#d6deeb"><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">security</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">mode</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">Transport</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">transport</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">clientCredentialType</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">Windows</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(127, 219, 202)">security</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>To call the service with this setting in place you will need to be an authenticated Windows user. (Or at the very least impersonating one - but you knew that.) <strong>NOW FOR THE MOST IMPORTANT BIT.....</strong> The endpoint addresses <!-- -->*<strong>must</strong>*<!-- --> be &quot;localhost&quot; for <em>both</em> client and service when both are deployed to the same server. If this is not the case then you will suffer from the aforementioned security &quot;feature&quot; which will provide you with unhelpful &quot;the server has rejected the client credentials&quot; messages and <!-- -->*<strong>nothing</strong>*<!-- --> else. <strong>OK FINISHED - MOVE ALONG NOW... NOTHING MORE TO SEE HERE</strong> With WCF Windows Transport authentication in place you can interrogate the calling user id within the service methods by simply evaluating ServiceSecurityContext.Current.PrimaryIdentity.Name (which will be something like &quot;myDomain\myUserName&quot;). So we you wanted to, we could have a simple step which evaluated if the calling user is on the &quot;approved&quot; / &quot;authorised&quot; list. I&#x27;m sure this could be made more sophisticated by using groups etc I guess - though I haven&#x27;t investigated it further as yet. In fact, I suspect Microsoft may have something even more sophisticated still available for use which I&#x27;m unaware of - if anyone knows a simple explanation of this then please do let me know! In closing, I do think Microsoft could work on providing more helpful error messages than &quot;the server has rejected the client credentials&quot;. Going by what I read as I researched this error many people seem to have struggled much as I did before eventually bailing out and ended up chancing it by turning security off in their applications. Clearly it is not desirable to have people so confused by errors that they give up and settle for a less secure solution.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/client-credential-type">clientCredentialType</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/security">Security</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/windows">Windows</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/wcf">WCF</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/authentication">Authentication</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/the-server-has-rejected-the-client-credentials">the server has rejected the client credentials</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/net-tcp-binding">NetTcpBinding</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about WCF Transport Windows authentication using NetTcpBinding in an Intranet environment" href="/2012/02/15/wcf-transport-windows-authentication"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.2c8efce8.js"></script>
<script src="/assets/js/main.c1b2d702.js"></script>
</body>
</html>