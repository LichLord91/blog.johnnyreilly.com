<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=297675200"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","297675200",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="I CAN MAKE THIS WORK" href="/opensearch.xml">
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#3578e5">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">3 posts tagged with &quot;Azure Container Apps&quot; | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="3 posts tagged with &quot;Azure Container Apps&quot; | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/tags/azure-container-apps"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><meta data-react-helmet="true" name="robots" content="max-image-preview:large"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/tags/azure-container-apps"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/azure-container-apps" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/azure-container-apps" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://J3MYR1INLT-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.10c1d3f1.css">
<link rel="preload" href="/assets/js/runtime~main.c49ac07e.js" as="script">
<link rel="preload" href="/assets/js/main.67d6d314.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://polywork.johnnyreilly.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Polywork<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/02/08/azure-static-web-apps-a-netlify-alternative">Azure Static Web Apps - a Netlify alternative</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/02/02/lazy-loading-images-with-docusaurus">Lazy loading images with Docusaurus</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/02/01/migrating-from-github-pages-to-azure-static-web-apps">Migrating from GitHub Pages to Azure Static Web Apps</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/01/22/azure-container-apps-dapr-bicep-github-actions-debug-devcontainer">Azure Container Apps: dapr, devcontainer, debug and deploy</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2021/12/29/preload-fonts-with-docusaurus">Preload fonts with Docusaurus</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>3 posts tagged with &quot;Azure Container Apps&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2022/01/22/azure-container-apps-dapr-bicep-github-actions-debug-devcontainer">Azure Container Apps: dapr, devcontainer, debug and deploy</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-01-22T00:00:00.000Z" itemprop="datePublished">January 22, 2022</time> Â· <!-- -->22 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/assets/images/title-image-ce3537156e15ded6dd344102c8a164b7.png"><div class="markdown" itemprop="articleBody"><p>This post shows how to build and deploy two Azure Container Apps using Bicep and GitHub Actions. These apps will communicate using <a href="https://docs.dapr.io/" target="_blank" rel="noopener noreferrer">dapr</a>, be built in <a href="https://code.visualstudio.com/docs/remote/containers" target="_blank" rel="noopener noreferrer">VS Code using a devcontainer</a>. It will be possible to debug in VS Code and run with <code>docker-compose</code>.</p><p>This follows on from the <a href="/2021/12/27/azure-container-apps-build-and-deploy-with-bicep-and-github-actions">previous post</a> which built and deployed a simple web application to Azure Container Apps using Bicep and GitHub Actions using the GitHub container registry.</p><p><img loading="lazy" alt="title image reading &amp;quot;Azure Container Apps dapr, devcontainer, debug and deploy&amp;quot;  with the dapr, Bicep, Azure Container Apps and GitHub Actions logos" src="/assets/images/title-image-ce3537156e15ded6dd344102c8a164b7.png" width="1600" height="900"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="what-were-going-to-build">What we&#x27;re going to build<a class="hash-link" href="#what-were-going-to-build" title="Direct link to heading">â€‹</a></h2><p>As an engineer, I&#x27;m productive when:</p><ul><li>Integrating different services together is a turnkey experience and</li><li>I&#x27;m able to easily debug my code</li></ul><p>I&#x27;ve found that using dapr and VS Code I&#x27;m able to achieve both of these goals. I can build an application made up of multiple services, compose them together using dapr and deploy them to Azure Container Apps with relative ease.</p><p>In this post we&#x27;re going to build an example of that from scratch, with a <a href="https://koajs.com/" target="_blank" rel="noopener noreferrer">koa/node.js</a> (built with TypeScript) front end that will communicate with a <a href="https://dotnet.microsoft.com/en-us/" target="_blank" rel="noopener noreferrer">dotnet</a> service via dapr.</p><p>All the work done in this post can be found in the <a href="https://github.com/johnnyreilly/dapr-devcontainer-debug-and-deploy" target="_blank" rel="noopener noreferrer"><code>dapr-devcontainer-debug-and-deploy</code></a> repo. As a note, if you&#x27;re interested in this topic it&#x27;s also worth looking at the <a href="https://github.com/Azure-Samples/container-apps-store-api-microservice" target="_blank" rel="noopener noreferrer"><code>Azure-Samples/container-apps-store-api-microservice</code></a> repo.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="setting-up-our-devcontainer">Setting up our devcontainer<a class="hash-link" href="#setting-up-our-devcontainer" title="Direct link to heading">â€‹</a></h2><p>The first thing we&#x27;ll do is set up our devcontainer. We&#x27;re going to use a tweaked version of the <a href="https://github.com/microsoft/vscode-dev-containers/tree/main/containers/docker-in-docker" target="_blank" rel="noopener noreferrer">docker-in-docker</a> image from the <a href="https://github.com/microsoft/vscode-dev-containers" target="_blank" rel="noopener noreferrer">vscode-dev-containers</a> repo.</p><p>In the root of our project we&#x27;ll create a <code>.devcontainer</code> folder, and within that a <code>library-scripts</code> folder. There&#x27;s a number of communal scripts from the <a href="https://github.com/microsoft/vscode-dev-containers" target="_blank" rel="noopener noreferrer"><code>vscode-dev-containers</code></a> repo which we&#x27;re going to lift and shift into in our <code>library-scripts</code> folder:</p><ul><li><a href="https://github.com/microsoft/vscode-dev-containers/blob/d93de4632781372d4b4da1699e27ae3a2404c96c/script-library/docker-in-docker-debian.sh" target="_blank" rel="noopener noreferrer">docker-in-docker-debian.sh</a> - for installing Docker in Docker</li><li><a href="https://github.com/microsoft/vscode-dev-containers/blob/d93de4632781372d4b4da1699e27ae3a2404c96c/script-library/azcli-debian.sh" target="_blank" rel="noopener noreferrer">azcli-debian.sh</a> - for installing the Azure CLI</li></ul><p>In the <code>.devcontainer</code> folder we want to create a <code>Dockerfile</code>:</p><div class="codeBlockContainer_I0IT language-docker theme-code-block"><div class="codeBlockContent_wNvx docker"><pre tabindex="0" class="prism-code language-docker codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain"># [Choice] .NET version: 6.0, 5.0, 3.1, 2.1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ARG VARIANT=3.1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">FROM mcr.microsoft.com/vscode/devcontainers/dotnet:0-${VARIANT}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">RUN su vscode -c &quot;umask 0002 &amp;&amp; dotnet tool install -g Microsoft.Tye --version \&quot;0.10.0-alpha.21420.1\&quot; 2&gt;&amp;1&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># [Choice] Node.js version: none, lts/*, 16, 14, 12, 10</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ARG NODE_VERSION=&quot;14&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">RUN if [ &quot;${NODE_VERSION}&quot; != &quot;none&quot; ]; then su vscode -c &quot;umask 0002 &amp;&amp; . /usr/local/share/nvm/nvm.sh &amp;&amp; nvm install ${NODE_VERSION} 2&gt;&amp;1&quot;; fi</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># [Option] Install Azure CLI</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ARG INSTALL_AZURE_CLI=&quot;false&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">COPY library-scripts/azcli-debian.sh /tmp/library-scripts/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">RUN if [ &quot;$INSTALL_AZURE_CLI&quot; = &quot;true&quot; ]; then bash /tmp/library-scripts/azcli-debian.sh; fi \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    &amp;&amp; apt-get clean -y &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/library-scripts \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    &amp;&amp; az bicep install</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># [Option] Enable non-root Docker access in container</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ARG ENABLE_NONROOT_DOCKER=&quot;true&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># [Option] Use the OSS Moby CLI instead of the licensed Docker CLI</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ARG USE_MOBY=&quot;true&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># [Option] Engine/CLI Version</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ARG DOCKER_VERSION=&quot;latest&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Enable new &quot;BUILDKIT&quot; mode for Docker CLI</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ENV DOCKER_BUILDKIT=1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ARG USERNAME=vscode</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Install needed packages and setup non-root user. Use a separate RUN statement to add your</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># own dependencies. A user of &quot;automatic&quot; attempts to reuse an user ID if one already exists.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">COPY library-scripts/docker-in-docker-debian.sh /tmp/library-scripts/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">RUN apt-get update \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    &amp;&amp; apt-get install python3-pip -y \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Use Docker script from script library to set things up</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    &amp;&amp; /bin/bash /tmp/library-scripts/docker-in-docker-debian.sh &quot;${ENABLE_NONROOT_DOCKER}&quot; &quot;${USERNAME}&quot; &quot;${USE_MOBY}&quot; &quot;${DOCKER_VERSION}&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Install Dapr</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">RUN wget -q https://raw.githubusercontent.com/dapr/cli/master/install/install.sh -O - | /bin/bash \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    # Clean up</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    &amp;&amp; apt-get autoremove -y &amp;&amp; apt-get clean -y &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/library-scripts/</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Add daprd to the path for the VS Code Dapr extension.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ENV PATH=&quot;${PATH}:/home/${USERNAME}/.dapr/bin&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Install Tye</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ENV PATH=/home/${USERNAME}/.dotnet/tools:$PATH</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">VOLUME [ &quot;/var/lib/docker&quot; ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Setting the ENTRYPOINT to docker-init.sh will configure non-root access</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># to the Docker socket. The script will also execute CMD as needed.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ENTRYPOINT [ &quot;/usr/local/share/docker-init.sh&quot; ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">CMD [ &quot;sleep&quot;, &quot;infinity&quot; ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># [Optional] Uncomment this section to install additional OS packages.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># RUN apt-get update &amp;&amp; export DEBIAN_FRONTEND=noninteractive \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#     &amp;&amp; apt-get -y install --no-install-recommends &lt;your-package-list-here&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The above is a loose riff on the <a href="https://github.com/microsoft/vscode-dev-containers/blob/main/containers/docker-in-docker/.devcontainer/Dockerfile" target="_blank" rel="noopener noreferrer">docker-in-docker Dockerfile</a>, lovingly mixed with the <a href="https://github.com/Azure-Samples/container-apps-store-api-microservice/blob/main/.devcontainer/Dockerfile" target="_blank" rel="noopener noreferrer">Azure-Samples container-apps Dockerfile</a>.</p><p>It installs the following:</p><ul><li>Dot Net</li><li>Node.js</li><li>the Azure CLI</li><li>Docker</li><li>Bicep</li><li>Dapr</li></ul><p>Now we have our <code>Dockerfile</code>, we need a <code>devcontainer.json</code> to go with it:</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// For format details, see https://aka.ms/devcontainer.json. For config options, see the README at:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// https://github.com/microsoft/vscode-dev-containers/tree/v0.205.0/containers/dapr-dotnet</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;name&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;dapr&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;build&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;dockerfile&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Dockerfile&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;args&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// Update &#x27;VARIANT&#x27; to pick a .NET Core version: 3.1, 5.0, 6.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;VARIANT&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;6.0&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// Options</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;NODE_VERSION&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;lts/*&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;INSTALL_AZURE_CLI&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;runArgs&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;--init&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;--privileged&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;mounts&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;source=dind-var-lib-docker,target=/var/lib/docker,type=volume&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;overrideCommand&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// Use this environment variable if you need to bind mount your local source code into a new container.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;remoteEnv&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;LOCAL_WORKSPACE_FOLDER&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;${localWorkspaceFolder}&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;PATH&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;/home/vscode/.dapr/bin/:/home/vscode/.dotnet/tools:$PATH${containerEnv:PATH}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// Set *default* container specific settings.json values on container create.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;settings&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// Add the IDs of extensions you want installed when the container is created.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;extensions&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;ms-azuretools.vscode-dapr&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;ms-azuretools.vscode-docker&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;ms-dotnettools.csharp&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;ms-vscode.azurecli&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;ms-azuretools.vscode-bicep&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// Use &#x27;forwardPorts&#x27; to make a list of ports inside the container available locally.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// &quot;forwardPorts&quot;: [],</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// Ensure Dapr is running on opening the container</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;postCreateCommand&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;dapr uninstall --all &amp;&amp; dapr init&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// Comment out connect as root instead. More info: https://aka.ms/vscode-remote/containers/non-root.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;remoteUser&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;vscode&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;features&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;azure-cli&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;latest&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The above will:</p><ul><li>install Node 16 / dotnet 6 and the latest Azure CLI</li><li>install a number of VS Code extensions related to dapr / Docker / Bicep / Azure / C#</li><li>install dapr when the container starts</li></ul><p>We&#x27;re ready! Reopen your repo in a container (it will take a while first time out) and you&#x27;ll be ready to go.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="create-a-dotnet-service">Create a dotnet service<a class="hash-link" href="#create-a-dotnet-service" title="Direct link to heading">â€‹</a></h2><p>Now we&#x27;re going to create a dotnet service. The aim of this post is not to build a specific application, but rather to demonstrate how simple service to service communication is with dapr. So we&#x27;ll use the web api template that ships with dotnet 6. That arrives with a fake weather API included, so we&#x27;ll name our service accordingly:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet new webapi -o WeatherService</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Inside the created <code>Program.cs</code>, find the following line and delete it:</p><div class="codeBlockContainer_I0IT language-cs theme-code-block"><div class="codeBlockContent_wNvx cs"><pre tabindex="0" class="prism-code language-cs codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">app.UseHttpsRedirection();</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>HTTPS is important, however Azure Container Apps are going to tackle that for us.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="create-a-nodejs-service-with-koa">Create a Node.js service (with Koa)<a class="hash-link" href="#create-a-nodejs-service-with-koa" title="Direct link to heading">â€‹</a></h2><p>Creating our dotnet service was very simple. We&#x27;re now going to create a web app with Node.js and Koa that calls our dotnet service. This will be a little more complicated - but still surprisingly simple thanks to the great API choices of dapr.</p><p>Let&#x27;s make that service:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token function" style="color:rgb(130, 170, 255)">mkdir</span><span class="token plain"> WebService</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">cd</span><span class="token plain"> WebService</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">npm</span><span class="token plain"> init -y</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">npm</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> koa axios --save</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">npm</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">install</span><span class="token plain"> @types/koa @types/node @types/axios typescript --save-dev</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We&#x27;re installing the following:</p><ul><li><a href="https://koajs.com/" target="_blank" rel="noopener noreferrer">koa</a> - the web framework we&#x27;re going to use</li><li><a href="https://axios-http.com/" target="_blank" rel="noopener noreferrer">axios</a> - to make calls to our dotnet service via HTTP / dapr</li><li><a href="https://www.typescriptlang.org/" target="_blank" rel="noopener noreferrer">TypeScript</a> and associated type definitions, so we can take advantage of static typing. Admittedly since we&#x27;re building a minimal example this is not super beneficial; but TS makes me happy and I&#x27;d certainly want static typing in place if going beyond a simple example. Start as you mean to go on.</li></ul><p>We&#x27;ll create a <code>tsconfig.json</code>:</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;compilerOptions&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;esModuleInterop&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;module&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;commonjs&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;target&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;es2017&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;noImplicitAny&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;outDir&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;./dist&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;strict&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;sourceMap&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We&#x27;ll update the <code>scripts</code> section of our <code>package.json</code> like so:</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;scripts&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;build&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;tsc&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;start&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;node dist/index.js&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>So we can build and start our web app. Now let&#x27;s write it!</p><p>We&#x27;re going to create an <code>index.ts</code> file:</p><div class="codeBlockContainer_I0IT language-ts theme-code-block"><div class="codeBlockContent_wNvx ts"><pre tabindex="0" class="prism-code language-ts codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">Koa</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;koa&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> </span><span class="token imports">axios</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;axios&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// How we connect to the dotnet service with dapr</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">const</span><span class="token plain"> daprSidecarBaseUrl </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(173, 219, 103)">`</span><span class="token template-string string" style="color:rgb(173, 219, 103)">http://localhost:</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">${</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token template-string interpolation">  process</span><span class="token template-string interpolation punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token template-string interpolation">env</span><span class="token template-string interpolation punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token template-string interpolation constant" style="color:rgb(130, 170, 255)">DAPR_HTTP_PORT</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:rgb(127, 219, 202)">||</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation number" style="color:rgb(247, 140, 108)">3501</span><span class="token template-string interpolation"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token template-string interpolation"></span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token template-string template-punctuation string" style="color:rgb(173, 219, 103)">`</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// app id header for service discovery</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">const</span><span class="token plain"> weatherServiceAppIdHeaders </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;dapr-app-id&#x27;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> process</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token constant" style="color:rgb(130, 170, 255)">WEATHER_SERVICE_NAME</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">||</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;dotnet-app&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">const</span><span class="token plain"> app </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 139)">Koa</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">use</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="color:rgb(127, 219, 202)">async</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(127, 219, 202)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">const</span><span class="token plain"> data </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">await</span><span class="token plain"> axios</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token keyword" style="color:rgb(127, 219, 202)">get</span><span class="token operator" style="color:rgb(127, 219, 202)">&lt;</span><span class="token maybe-class-name">WeatherForecast</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token template-string template-punctuation string" style="color:rgb(173, 219, 103)">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">${</span><span class="token template-string interpolation">daprSidecarBaseUrl</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token template-string string" style="color:rgb(173, 219, 103)">/weatherForecast</span><span class="token template-string template-punctuation string" style="color:rgb(173, 219, 103)">`</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        headers</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> weatherServiceAppIdHeaders</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ctx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">body</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(173, 219, 103)">`</span><span class="token template-string string" style="color:rgb(173, 219, 103)">And the weather today will be </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">${</span><span class="token template-string interpolation">data</span><span class="token template-string interpolation punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token template-string interpolation">data</span><span class="token template-string interpolation punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token template-string interpolation number" style="color:rgb(247, 140, 108)">0</span><span class="token template-string interpolation punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token template-string interpolation punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token template-string interpolation">summary</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token template-string template-punctuation string" style="color:rgb(173, 219, 103)">`</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">exc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token console class-name" style="color:rgb(255, 203, 139)">console</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Problem calling weather service&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> exc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ctx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">body</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Something went wrong!&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">const</span><span class="token plain"> portNumber </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">listen</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">portNumber</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token console class-name" style="color:rgb(255, 203, 139)">console</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">log</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token template-string template-punctuation string" style="color:rgb(173, 219, 103)">`</span><span class="token template-string string" style="color:rgb(173, 219, 103)">listening on port </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">${</span><span class="token template-string interpolation">portNumber</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token template-string template-punctuation string" style="color:rgb(173, 219, 103)">`</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">interface</span><span class="token plain"> </span><span class="token class-name maybe-class-name" style="color:rgb(255, 203, 139)">WeatherForecast</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  date</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  temperatureC</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  temperatureF</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">number</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  summary</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The above code is fairly simple but is achieving quite a lot. It:</p><ul><li>uses various environment variables to construct the URLs / headers which allow connecting to the dapr sidecar running alongside the app, and consequently to the weather service through the dapr sidecar running alongside the weather service. We&#x27;re going to set up the environment variables which this code relies upon later.</li><li>spins up a web server with koa on port 3000</li><li>that web server, when sent an HTTP request, will call the <code>weatherForecast</code> endpoint of the dotnet app. It will grab what comes back, take the first entry in there and surface that up as the weather forecast.</li><li>We&#x27;re also defining a <code>WeatherForecast</code> interface to represent the type of the data that comes back from the dotnet service</li></ul><p>It&#x27;s worth dwelling for a moment on the simplicity that dapr is affording us here. We&#x27;re able to make HTTP requests to our dotnet service just like they were any other service running locally. What&#x27;s actually happening is illustrated by the diagram below:</p><p><img loading="lazy" alt="a diagram showing traffic going from the web service to the weather service and back again via dapr" src="/assets/images/dapr-sidecar.drawio-14d1fc55e5031b5be918168a434e12ac.svg" width="672" height="403"></p><p>We&#x27;re making HTTP requests from the web service, which look like they&#x27;re going directly to the weather service. But in actual fact, they&#x27;re being routed through dapr sidecars until they reach their destination. Why is this fantastic? Well there&#x27;s two things we aren&#x27;t having to think about here:</p><ul><li>certificates</li><li>inter-service authentication</li></ul><p>Both of these can be complex and burn a large amount of engineering time. Because we&#x27;re using dapr it&#x27;s not a problem we have to solve. Isn&#x27;t that great?</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="debugging-dapr-in-vs-code">Debugging dapr in VS Code<a class="hash-link" href="#debugging-dapr-in-vs-code" title="Direct link to heading">â€‹</a></h2><p>We want to be able to debug this code. We can achieve that in VS Code by setting a <a href="https://code.visualstudio.com/docs/editor/debugging#_launchjson-attributes" target="_blank" rel="noopener noreferrer"><code>launch.json</code></a> and a <a href="https://code.visualstudio.com/docs/editor/tasks" target="_blank" rel="noopener noreferrer"><code>tasks.json</code></a> file.</p><p>First of all we&#x27;ll create a <code>launch.json</code> file in the <code>.vscode</code> folder of our repo:</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// Use IntelliSense to learn about possible attributes.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// Hover to view descriptions of existing attributes.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;version&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;0.2.0&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;compounds&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;name&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;All Container Apps&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;configurations&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;WeatherService&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;WebService&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;presentation&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;hidden&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;group&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Containers&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;order&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;configurations&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;name&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;WeatherService&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;coreclr&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;request&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;launch&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;preLaunchTask&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;daprd-debug-dotnet&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;postDebugTask&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;daprd-down-dotnet&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;program&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;${workspaceFolder}/WeatherService/bin/Debug/net6.0/WeatherService.dll&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;args&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;cwd&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;${workspaceFolder}&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;stopAtEntry&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">false</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;env&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;DOTNET_ENVIRONMENT&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Development&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;DOTNET_URLS&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;http://localhost:5000&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;DAPR_HTTP_PORT&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;3500&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;DAPR_GRPC_PORT&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;50000&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;DAPR_METRICS_PORT&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;9090&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;name&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;WebService&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;node&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;request&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;launch&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;preLaunchTask&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;daprd-debug-node&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;postDebugTask&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;daprd-down-node&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;program&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;${workspaceFolder}/WebService/index.ts&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;cwd&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;${workspaceFolder}&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;env&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;NODE_ENV&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;development&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;PORT&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;3000&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;DAPR_HTTP_PORT&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;3501&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;DAPR_GRPC_PORT&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;50001&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;DAPR_METRICS_PORT&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;9091&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;WEATHER_SERVICE_NAME&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;dotnet-app&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;protocol&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;inspector&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;outFiles&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;${workspaceFolder}/WebService/dist/**/*.js&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;serverReadyAction&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;action&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;openExternally&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The things to note about this are:</p><ul><li>we create a Node.js (&quot;WebService&quot;) and a dotnet (&quot;WeatherService&quot;) configuration. These are referenced by the <code>All Container Apps</code> compound. Kicking off that will start both the Node.js and the dotnet apps.</li><li>The Node.js app runs a <code>daprd-debug-node</code> task prior to launch and a <code>daprd-down-node</code> task when debugging completes. Comparable tasks are run by the dotnet container - we&#x27;ll look at these in a moment.</li><li>Various environment variables are configured, most of which control the behaviour of dapr. When we&#x27;re debugging locally we&#x27;ll be using some non-typical ports to accomodate multiple dapr sidecars being in play at the same time. Note also the <code>&quot;WEATHER_SERVICE_NAME&quot;: &quot;dotnet-app&quot;</code> - it&#x27;s this that allows the WebService to communicate with the WeatherService - <code>dotnet-app</code> is the <code>appId</code> used to identify a service with dapr. We&#x27;ll see that as we configure our <code>tasks.json</code>.</li></ul><p>Here&#x27;s the <code>tasks.json</code> we must make:</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// See https://go.microsoft.com/fwlink/?LinkId=733558</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// for the documentation about the tasks.json format</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;version&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;2.0.0&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;tasks&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;label&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;dotnet-build&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;command&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;dotnet&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;process&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;args&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;build&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;${workspaceFolder}/WeatherService/WeatherService.csproj&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;/property:GenerateFullPaths=true&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;/consoleloggerparameters:NoSummary&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;problemMatcher&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;$msCompile&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;label&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;daprd-debug-dotnet&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;appId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;dotnet-app&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;appPort&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">5000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;httpPort&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3500</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;grpcPort&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">50000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;metricsPort&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">9090</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;daprd&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;dependsOn&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;dotnet-build&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;label&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;daprd-down-dotnet&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;appId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;dotnet-app&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;daprd-down&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;label&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;npm-install&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;shell&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;command&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;npm install&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;options&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;cwd&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;${workspaceFolder}/WebService&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;label&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;webservice-build&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;typescript&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;tsconfig&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;WebService/tsconfig.json&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;problemMatcher&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;$tsc&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;group&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;kind&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;build&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;isDefault&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;dependsOn&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;npm-install&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;label&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;daprd-debug-node&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;appId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;node-app&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;appPort&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;httpPort&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3501</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;grpcPort&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">50001</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;metricsPort&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">9091</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;daprd&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;dependsOn&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;webservice-build&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;label&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;daprd-down-node&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;appId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;node-app&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;daprd-down&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>There&#x27;s two sets of tasks here; one for the WeatherService and one for the WebService. You&#x27;ll see some commonalities here. For each service there&#x27;s a <code>daprd</code> task that depends upon the relevant service being built and passes the various ports for the dapr sidecar to run on that runs just before debugging kicks off. To go with that, there&#x27;s a <code>daprd-down</code> task for each service that runs when debugging finishes and shuts down dapr.</p><p>We&#x27;re now ready to debug our app. Let&#x27;s hit F5.</p><p><img loading="lazy" alt="screenshot of debugging the index.ts file in VS Code" src="/assets/images/debugging-660bb23b8958f3362aac922d0a188a9a.png" width="2680" height="1080"></p><p>And if we look at our browser:</p><p><img loading="lazy" alt="screenshot of browsing Firefox at http://localhost:3000 and seeing &amp;quot;And the weather today will be Freezing&amp;quot; in the output" src="data:image/png;base64,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" width="764" height="160"></p><p>It works! We&#x27;re running a Node.js WebService which, when called, is communicating with our dotnet WeatherService and surfacing up the results. Brilliant!</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="containerising-our-services-with-docker">Containerising our services with Docker<a class="hash-link" href="#containerising-our-services-with-docker" title="Direct link to heading">â€‹</a></h2><p>Before we can deploy each of our services, they need to be containerised.</p><p>First let&#x27;s add a <code>Dockerfile</code> to the <code>WeatherService</code> folder:</p><div class="codeBlockContainer_I0IT language-docker theme-code-block"><div class="codeBlockContent_wNvx docker"><pre tabindex="0" class="prism-code language-docker codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">FROM mcr.microsoft.com/dotnet/sdk:6.0 as build</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">WORKDIR /app</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">COPY . .</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">RUN dotnet restore</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">RUN dotnet publish -o /app/publish</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">FROM mcr.microsoft.com/dotnet/aspnet:6.0 as runtime</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">WORKDIR /app</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">COPY --from=build /app/publish /app</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ENV DOTNET_ENVIRONMENT=Production</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ENV ASPNETCORE_URLS=&#x27;http://+:5000&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">EXPOSE 5000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ENTRYPOINT [ &quot;dotnet&quot;, &quot;/app/WeatherService.dll&quot; ]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Then we&#x27;ll add a <code>Dockerfile</code> to the <code>WebService</code> folder:</p><div class="codeBlockContainer_I0IT language-docker theme-code-block"><div class="codeBlockContent_wNvx docker"><pre tabindex="0" class="prism-code language-docker codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">FROM node:16 AS build</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">WORKDIR /app</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">COPY package.json ./</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">COPY package-lock.json ./</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">RUN npm install</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">COPY . .</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">RUN npm run build</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">FROM node:16 AS runtime</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">WORKDIR /app</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">COPY --from=build /app/dist /app</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">COPY --from=build /app/package.json /app</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">COPY --from=build /app/package-lock.json /app</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">RUN npm install</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ENV NODE_ENV production</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">EXPOSE 3000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ENTRYPOINT [ &quot;node&quot;, &quot;/app/index.js&quot; ]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Likely these <code>Dockerfile</code>s could be optimised further; but we&#x27;re not focussed on that just now. What we have now are two simple <code>Dockerfile</code>s that will give us images we can run. Given that one depends on the other it makes sense to bring them together with a <code>docker-compose.yml</code> file which we&#x27;ll place in the root of the repo:</p><div class="codeBlockContainer_I0IT language-yml theme-code-block"><div class="codeBlockContent_wNvx yml"><pre tabindex="0" class="prism-code language-yml codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;3.4&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">weatherservice</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">REGISTRY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">weatherservice</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">TAG</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">latest</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">context</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ./WeatherService</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">dockerfile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Dockerfile</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;50000:50000&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Dapr instances communicate over gRPC so we need to expose the gRPC port</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">DOTNET_ENVIRONMENT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Development&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">ASPNETCORE_URLS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;http://+:5000&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">DAPR_HTTP_PORT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3500</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">DAPR_GRPC_PORT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">50000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">DAPR_METRICS_PORT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">9090</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">weatherservice-dapr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;daprio/daprd:latest&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;./daprd&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;-app-id&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;dotnet-app&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;-app-port&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;5000&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;-dapr-http-port&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;3500&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;-placement-host-address&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;placement:50006&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">network_mode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;service:weatherservice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">depends_on</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> weatherservice</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">webservice</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">REGISTRY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">webservice</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">TAG</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">latest</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;3000:3000&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># The web front end port</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;50001:50001&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Dapr instances communicate over gRPC so we need to expose the gRPC port</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">context</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ./WebService</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">dockerfile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Dockerfile</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">NODE_ENV</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;development&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">PORT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;3000&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">DAPR_HTTP_PORT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3501</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">DAPR_GRPC_PORT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">50001</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">DAPR_METRICS_PORT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">9091</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">WEATHER_SERVICE_NAME</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;dotnet-app&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">webservice-dapr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;daprio/daprd:latest&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;./daprd&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;-app-id&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;node-app&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;-app-port&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;3000&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;-dapr-http-port&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;3501&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;-placement-host-address&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;placement:50006&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Dapr&#x27;s placement service can be reach via the docker DNS entry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">network_mode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;service:webservice&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">depends_on</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> webservice</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">dapr-placement</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;daprio/dapr:latest&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;./placement&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;-port&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;50006&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;50006:50006&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>With this in place we can run <code>docker-compose up</code> and bring up our application locally.</p><p>And now we have docker images built, we can look at deploying them.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="deploying-to-azure">Deploying to Azure<a class="hash-link" href="#deploying-to-azure" title="Direct link to heading">â€‹</a></h2><p>At this point we have pretty much everything we need in terms of application code and the ability to build and debug it. Now we&#x27;d like to deploy it to Azure.</p><p>Let&#x27;s begin with the Bicep required to deploy our Azure Container Apps.</p><p>In our repository we&#x27;ll create an <code>infra</code> directory, into which we&#x27;ll place a <code>main.bicep</code> file which will contain our Bicep template:</p><div class="codeBlockContainer_I0IT language-bicep theme-code-block"><div class="codeBlockContent_wNvx bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">param branchName string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param webServiceImage string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param webServicePort int</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param webServiceIsExternalIngress bool</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param weatherServiceImage string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param weatherServicePort int</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param weatherServiceIsExternalIngress bool</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param containerRegistry string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param containerRegistryUsername string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@secure()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param containerRegistryPassword string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param tags object</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var location = resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var minReplicas = 0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var maxReplicas = 1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var branch = toLower(last(split(branchName, &#x27;/&#x27;)))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var environmentName = &#x27;${branch}-env&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var workspaceName = &#x27;${branch}-log-analytics&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var appInsightsName = &#x27;${branch}-app-insights&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var webServiceContainerAppName = &#x27;${branch}-web&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var weatherServiceContainerAppName = &#x27;${branch}-weather&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var containerRegistryPasswordRef = &#x27;container-registry-password&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource workspace &#x27;Microsoft.OperationalInsights/workspaces@2020-08-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: workspaceName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: tags</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      name: &#x27;PerGB2018&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    retentionInDays: 30</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    workspaceCapping: {}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource appInsights &#x27;Microsoft.Insights/components@2020-02-02-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: appInsightsName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: tags</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;web&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Application_Type: &#x27;web&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Flow_Type: &#x27;Bluefield&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource environment &#x27;Microsoft.Web/kubeEnvironments@2021-02-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: environmentName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;containerenvironment&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: tags</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    type: &#x27;managed&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    internalLoadBalancerEnabled: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    appLogsConfiguration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      destination: &#x27;log-analytics&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      logAnalyticsConfiguration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        customerId: workspace.properties.customerId</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        sharedKey: listKeys(workspace.id, workspace.apiVersion).primarySharedKey</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    containerAppsConfiguration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      daprAIInstrumentationKey: appInsights.properties.InstrumentationKey</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource weatherServiceContainerApp &#x27;Microsoft.Web/containerapps@2021-03-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: weatherServiceContainerAppName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;containerapps&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: tags</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    kubeEnvironmentId: environment.id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    configuration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      secrets: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          name: containerRegistryPasswordRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          value: containerRegistryPassword</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      registries: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          server: containerRegistry</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          username: containerRegistryUsername</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          passwordSecretRef: containerRegistryPasswordRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ingress: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        external: weatherServiceIsExternalIngress</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        targetPort: weatherServicePort</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    template: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      containers: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          image: weatherServiceImage</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          name: weatherServiceContainerAppName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          transport: &#x27;auto&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      scale: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        minReplicas: minReplicas</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        maxReplicas: maxReplicas</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      dapr: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        enabled: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        appPort: weatherServicePort</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        appId: weatherServiceContainerAppName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource webServiceContainerApp &#x27;Microsoft.Web/containerapps@2021-03-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: webServiceContainerAppName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;containerapps&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: tags</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    kubeEnvironmentId: environment.id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    configuration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      secrets: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          name: containerRegistryPasswordRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          value: containerRegistryPassword</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      registries: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          server: containerRegistry</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          username: containerRegistryUsername</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          passwordSecretRef: containerRegistryPasswordRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ingress: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        external: webServiceIsExternalIngress</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        targetPort: webServicePort</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    template: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      containers: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          image: webServiceImage</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          name: webServiceContainerAppName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          transport: &#x27;auto&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          env: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              name: &#x27;WEATHER_SERVICE_NAME&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              value: weatherServiceContainerAppName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      scale: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        minReplicas: minReplicas</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        maxReplicas: maxReplicas</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      dapr: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        enabled: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        appPort: webServicePort</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        appId: webServiceContainerAppName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">output webServiceUrl string = webServiceContainerApp.properties.latestRevisionFqdn</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This will deploy two container apps - one for our <code>WebService</code> and one for our <code>WeatherService</code>. Alongside that we&#x27;ve resources for logging and environments.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="setting-up-a-resource-group">Setting up a resource group<a class="hash-link" href="#setting-up-a-resource-group" title="Direct link to heading">â€‹</a></h2><p>With our Bicep in place, we&#x27;re going to need a resource group to send it to. Right now, Azure Container Apps aren&#x27;t available everywhere. So we&#x27;re going to create ourselves a resource group in North Europe which does support ACAs:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">az group create -g rg-aca -l northeurope</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="secrets-for-github-actions">Secrets for GitHub Actions<a class="hash-link" href="#secrets-for-github-actions" title="Direct link to heading">â€‹</a></h2><p>We&#x27;re aiming to set up a GitHub Action to handle our deployment. This will depend upon a number of secrets:</p><p><img loading="lazy" alt="Screenshot of the secrets in the GitHub website that we need to create" src="/assets/images/screenshot-github-secrets-29ef6fe4f7b252562e7a9130dcb05f7c.png" width="1544" height="250"></p><p>We&#x27;ll need to create each of these secrets.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="azure_credentials---github-logging-into-azure"><code>AZURE_CREDENTIALS</code> - GitHub logging into Azure<a class="hash-link" href="#azure_credentials---github-logging-into-azure" title="Direct link to heading">â€‹</a></h3><p>So GitHub Actions can interact with Azure on our behalf, we need to provide it with some credentials. We&#x27;ll use the Azure CLI to create these:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">az ad sp create-for-rbac --name </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;myApp&quot;</span><span class="token plain"> --role contributor </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    --scopes /subscriptions/</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">subscription-id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">/resourceGroups/</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">resource-group</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    --sdk-auth</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Remember to replace the <code>{subscription-id}</code> with your subscription id and <code>{resource-group}</code> with the name of your resource group (<code>rg-aca</code> if you&#x27;re following along). This command will pump out a lump of JSON that looks something like this:</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;clientId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-client-id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;clientSecret&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-client-secret&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;subscriptionId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-subscription-id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;tenantId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-tenant-id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;activeDirectoryEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://login.microsoftonline.com&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;resourceManagerEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://management.azure.com/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;activeDirectoryGraphResourceId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://graph.windows.net/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;sqlManagementEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://management.core.windows.net:8443/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;galleryEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://gallery.azure.com/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;managementEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://management.core.windows.net/&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Take this and save it as the <code>AZURE_CREDENTIALS</code> secret in Azure.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="packages_token---azure-accessing-the-github-container-registry"><code>PACKAGES_TOKEN</code> - Azure accessing the GitHub container registry<a class="hash-link" href="#packages_token---azure-accessing-the-github-container-registry" title="Direct link to heading">â€‹</a></h3><p>We also need a secret for accessing packages from Azure. We&#x27;re going to be publishing packages to the GitHub container registry. Azure is going to need to be able to access this when we&#x27;re deploying. ACA deployment works by telling Azure where to look for an image and providing any necessary credentials to do the acquisition. To facilitate this we&#x27;ll set up a <code>PACKAGES_TOKEN</code> secret. This is a GitHub personal access token with the <code>read:packages</code> scope. <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token" target="_blank" rel="noopener noreferrer">Follow the instructions here to create the token.</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="deploying-with-github-actions">Deploying with GitHub Actions<a class="hash-link" href="#deploying-with-github-actions" title="Direct link to heading">â€‹</a></h2><p>With our secrets configured, we&#x27;re now well placed to write our GitHub Action. We&#x27;ll create a <code>.github/workflows/build-and-deploy.yaml</code> file in our repository and populate it thusly:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># yaml-language-server: $schema=./build.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Build and Deploy</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">on</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Trigger the workflow on push or pull request,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># but only for the main branch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">push</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">pull_request</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Publish semver tags as releases.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">tags</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;v*.*.*&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">workflow_dispatch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">RESOURCE_GROUP</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> rg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">aca</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">REGISTRY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ghcr.io</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">IMAGE_NAME</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> github.repository </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">matrix</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token key atrule">&#x27;imageName&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;node-service&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token key atrule">&#x27;directory&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;./WebService&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token key atrule">&#x27;imageName&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;dotnet-service&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token key atrule">&#x27;directory&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;./WeatherService&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">permissions</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">contents</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> read</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">packages</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> write</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">outputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">image-node</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> steps.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">tag.outputs.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">image-dotnet</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> steps.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">tag.outputs.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">dotnet</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Checkout repository</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> actions/checkout@v2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Login against a Docker registry except on PR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># https://github.com/docker/login-action</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Log into registry $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> github.event_name </span><span class="token tag" style="color:rgb(127, 219, 202)">!=</span><span class="token plain"> &#x27;pull_request&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> docker/login</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">action@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">registry</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">username</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> github.actor </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">password</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> secrets.GITHUB_TOKEN </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Extract metadata (tags, labels) for Docker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># https://github.com/docker/metadata-action</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Extract Docker metadata</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> meta</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> docker/metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">action@v3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">images</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">/$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.IMAGE_NAME </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">/$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> matrix.services.imageName </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">tags</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            type=semver,pattern={{version}}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            type=semver,pattern={{major}}.{{minor}}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            type=semver,pattern={{major}}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            type=ref,event=branch</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            type=sha</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Build and push Docker image with Buildx (don&#x27;t push on PR)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># https://github.com/docker/build-push-action</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Build and push Docker image</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> docker/build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">push</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">action@v2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">context</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> matrix.services.directory </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">push</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> github.event_name </span><span class="token tag" style="color:rgb(127, 219, 202)">!=</span><span class="token plain"> &#x27;pull_request&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">tags</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> steps.meta.outputs.tags </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> steps.meta.outputs.labels </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Output image tag</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">tag</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> echo &quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">output name=image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> matrix.services.imageName </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">/$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.IMAGE_NAME </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">/$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> matrix.services.imageName </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">sha</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">$(git rev</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">parse </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">short HEAD)&quot; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> tr &#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">upper</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">&#x27; &#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">lower</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">deploy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">needs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Checkout repository</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> actions/checkout@v2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Azure Login</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azure/login@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">creds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> secrets.AZURE_CREDENTIALS </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azure/CLI@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> github.event_name </span><span class="token tag" style="color:rgb(127, 219, 202)">!=</span><span class="token plain"> &#x27;pull_request&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            REF_SHA=&#x27;${{ github.ref }}.${{ github.sha }}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            DEPLOYMENT_NAME=&quot;${REF_SHA////-}&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            echo &quot;DEPLOYMENT_NAME=$DEPLOYMENT_NAME&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            TAGS=&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">&quot;owner&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;johnnyreilly&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> &quot;email&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;johnny_reilly@hotmail.com&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            az deployment group create \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">resource</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">group $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.RESOURCE_GROUP </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">name &quot;$DEPLOYMENT_NAME&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">template</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">file ./infra/main.bicep \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">parameters \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                  branchName=&#x27;$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> github.event.number == 0 </span><span class="token important">&amp;&amp;</span><span class="token plain"> &#x27;main&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain">  format(&#x27;pr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> github.event.number) </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">&#x27; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                  webServiceImage=&#x27;$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> needs.build.outputs.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">node </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">&#x27; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                  webServicePort=3000 \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                  webServiceIsExternalIngress=true \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                  weatherServiceImage=&#x27;$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> needs.build.outputs.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">dotnet </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">&#x27; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                  weatherServicePort=5000 \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                  weatherServiceIsExternalIngress=false \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                  containerRegistry=$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                  containerRegistryUsername=$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> github.actor </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                  containerRegistryPassword=$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> secrets.PACKAGES_TOKEN </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                  tags=&quot;$TAGS&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>There&#x27;s a lot in this workflow. Let&#x27;s dig into the <code>build</code> and <code>deploy</code> jobs to see what&#x27;s happening.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="build---building-our-image"><code>build</code> - building our image<a class="hash-link" href="#build---building-our-image" title="Direct link to heading">â€‹</a></h3><p>The <code>build</code> job is all about building our container images and pushing then to the GitHub registry. It&#x27;s heavily inspired by <a href="https://twitter.com/jeffhollan" target="_blank" rel="noopener noreferrer">Jeff Hollan</a>&#x27;s <a href="https://github.com/Azure-Samples/container-apps-store-api-microservice" target="_blank" rel="noopener noreferrer">Azure sample app GHA</a>. When we look at the <code>strategy</code> we can see a <code>matrix</code> of <code>services</code> consisting of two services; our node app and our dotnet app:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">matrix</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token key atrule">&#x27;imageName&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;node-service&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token key atrule">&#x27;directory&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;./WebService&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token key atrule">&#x27;imageName&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;dotnet-service&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token key atrule">&#x27;directory&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;./WeatherService&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This is a matrix because a typical use case of an Azure Container Apps will be multi-container - just as this is. The <code>outputs</code> pumps out the details of our <code>image-node</code> and <code>image-dotnet</code> images to be used later:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">outputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">image-node</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> steps.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">tag.outputs.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">image-dotnet</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> steps.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">tag.outputs.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">dotnet</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>With that understanding in place, let&#x27;s examine what each of the steps in the <code>build</code> job does</p><ul><li><code>Log into registry</code> - logs into the GitHub container registry</li><li><code>Extract Docker metadata</code> - acquire tags which will be used for versioning</li><li><code>Build and push Docker image</code> - build the docker image and if this is not a PR: tag, label and push it to the registry</li><li><code>Output image tag</code> - write out the image tag for usage in deployment</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="deploy---shipping-our-image-to-azure"><code>deploy</code> - shipping our image to Azure<a class="hash-link" href="#deploy---shipping-our-image-to-azure" title="Direct link to heading">â€‹</a></h3><p>The <code>deploy</code> job runs the <a href="https://docs.microsoft.com/en-us/cli/azure/deployment/group?view=azure-cli-latest#az_deployment_group_create" target="_blank" rel="noopener noreferrer"><code>az deployment group create</code></a> command which performs a deployment of our <code>main.bicep</code> file.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azure/CLI@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> github.event_name </span><span class="token tag" style="color:rgb(127, 219, 202)">!=</span><span class="token plain"> &#x27;pull_request&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">      REF_SHA=&#x27;${{ github.ref }}.${{ github.sha }}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">      DEPLOYMENT_NAME=&quot;${REF_SHA////-}&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">      echo &quot;DEPLOYMENT_NAME=$DEPLOYMENT_NAME&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      TAGS=&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">&quot;owner&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;johnnyreilly&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> &quot;email&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;johnny_reilly@hotmail.com&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      az deployment group create \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">resource</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">group $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.RESOURCE_GROUP </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">name &quot;$DEPLOYMENT_NAME&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">template</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">file ./infra/main.bicep \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">parameters \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            branchName=&#x27;$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> github.event.number == 0 </span><span class="token important">&amp;&amp;</span><span class="token plain"> &#x27;main&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain">  format(&#x27;pr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> github.event.number) </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">&#x27; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            webServiceImage=&#x27;$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> needs.build.outputs.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">node </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">&#x27; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            webServicePort=3000 \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            webServiceIsExternalIngress=true \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            weatherServiceImage=&#x27;$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> needs.build.outputs.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">dotnet </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">&#x27; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            weatherServicePort=5000 \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            weatherServiceIsExternalIngress=false \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            containerRegistry=$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            containerRegistryUsername=$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> github.actor </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            containerRegistryPassword=$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> secrets.PACKAGES_TOKEN </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            tags=&quot;$TAGS&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In either case we pass the same set of parameters:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token assign-left variable" style="color:rgb(214, 222, 235)">branchName</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;${{ github.event.number == 0 &amp;&amp; &#x27;</span><span class="token plain">main</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27; ||  format(&#x27;</span><span class="token plain">pr-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;, github.event.number) }}&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">webServiceImage</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;</span><span class="token string variable" style="color:rgb(214, 222, 235)">${{ needs.build.outputs.image-node }</span><span class="token string" style="color:rgb(173, 219, 103)">}&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">webServicePort</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">3000</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">webServiceIsExternalIngress</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">true </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">weatherServiceImage</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;</span><span class="token string variable" style="color:rgb(214, 222, 235)">${{ needs.build.outputs.image-dotnet }</span><span class="token string" style="color:rgb(173, 219, 103)">}&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">weatherServicePort</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">5000</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">weatherServiceIsExternalIngress</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">true </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">containerRegistry</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token variable" style="color:rgb(214, 222, 235)">${{ env.REGISTRY }</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">containerRegistryUsername</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token variable" style="color:rgb(214, 222, 235)">${{ github.actor }</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">containerRegistryPassword</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token variable" style="color:rgb(214, 222, 235)">${{ secrets.PACKAGES_TOKEN }</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">tags</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;</span><span class="token string variable" style="color:rgb(214, 222, 235)">$tags</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>These are either:</p><ul><li>secrets we set up earlier</li><li><a href="https://docs.github.com/en/actions/learn-github-actions/contexts" target="_blank" rel="noopener noreferrer">special github variables</a></li><li>environment variables declared at the start of the script or</li><li>outputs from the build step - this is where we acquire our node and dotnet images</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="running-it">Running it<a class="hash-link" href="#running-it" title="Direct link to heading">â€‹</a></h2><p>When the GitHub Action has been run you&#x27;ll find that Azure Container Apps are now showing up inside the Azure Portal in your resource group, alongside the other resources:</p><p><img loading="lazy" alt="screenshot of the Azure Container App&amp;#39;s resource group in the Azure Portal" src="/assets/images/screenshot-azure-portal-resource-group-b64514fc0f1f74a4c50a2fa94f13d5c2.png" width="2635" height="1142"></p><p>If we take a look at our web ACA we&#x27;ll see</p><p><img loading="lazy" alt="screenshot of the web Azure Container App&amp;#39;s in the Azure Portal" src="/assets/images/screenshot-azure-portal-container-app-9b737cce4d0bdd153a640ce08538cb4f.png" width="1064" height="612"></p><p>And when we take a closer look at the container app, we find a URL we can navigate to:</p><p><img loading="lazy" alt="screenshot of the Azure Container App in the Azure Portal revealing it&amp;#39;s URL" src="/assets/images/screenshot-working-app-2e37ea9245120191848855f9ca826399.png" width="900" height="332"></p><p>Congratulations! You&#x27;ve built and deployed a simple web app to Azure Container Apps with Bicep and GitHub Actions and secrets.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-subscription--cannot-have-more-than-2-environments"><code>The subscription &#x27;***&#x27; cannot have more than 2 environments.</code><a class="hash-link" href="#the-subscription--cannot-have-more-than-2-environments" title="Direct link to heading">â€‹</a></h2><p>Before signing off, it&#x27;s probably worth sharing this gotcha. If you&#x27;ve been playing with Azure Container Apps you may have already deployed an &quot;environment&quot; (<code>Microsoft.Web/kubeEnvironments</code>). It&#x27;s fairly common to have a limit of one environment per subscription, which is what this message is saying. So either delete other environments, share the one you have or arrange to raise the limit on your subscription.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/azure-container-apps">Azure Container Apps</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/bicep">Bicep</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/git-hub-actions">GitHub Actions</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/git-hub-container-registry">GitHub container registry</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/devcontainer">devcontainer</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/debug">debug</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Azure Container Apps: dapr, devcontainer, debug and deploy" href="/2022/01/22/azure-container-apps-dapr-bicep-github-actions-debug-devcontainer"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2021/12/27/azure-container-apps-build-and-deploy-with-bicep-and-github-actions">Azure Container Apps: build and deploy with Bicep and GitHub Actions</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-12-27T00:00:00.000Z" itemprop="datePublished">December 27, 2021</time> Â· <!-- -->14 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/assets/images/title-image-3da5757ae1c7fd02de2618a79f791be9.png"><div class="markdown" itemprop="articleBody"><p>This post shows how to build and deploy a simple web application to Azure Container Apps using Bicep and GitHub Actions. This includes the configuration and deployment of secrets.</p><p>This post follows on from the <a href="/2021/12/19/azure-container-apps-bicep-and-github-actions">previous post</a> which deployed infrastructure and a &quot;hello world&quot; container, this time introducing the building of an image and storing it in the <a href="https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry" target="_blank" rel="noopener noreferrer">GitHub container registry</a> so it can be deployed.</p><p>If you&#x27;d like to learn more about using dapr with Azure Container Apps then you might want to read <a href="/2022/01/22/azure-container-apps-dapr-bicep-github-actions-debug-devcontainer">this post</a>.</p><p><img loading="lazy" alt="title image reading &amp;quot;Azure Container Apps: build and deploy with Bicep and GitHub Actions&amp;quot; with the Bicep, Azure Container Apps and GitHub Actions logos" src="/assets/images/title-image-3da5757ae1c7fd02de2618a79f791be9.png" width="1600" height="900"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-containerised-convent">The containerised convent<a class="hash-link" href="#the-containerised-convent" title="Direct link to heading">â€‹</a></h2><p>I learn the most about a technology when I&#x27;m using it to build something. It so happens that I have an aunt that&#x27;s a nun, and long ago she persuaded me to build her convent a website. I&#x27;m a good nephew and I complied. Since that time I&#x27;ve been merrily overengineering it for fun and non-profit.</p><p>My aunts website is a pretty vanilla node app. Significantly it is already containerised and runs on <a href="https://azure.microsoft.com/en-gb/services/app-service/containers/" target="_blank" rel="noopener noreferrer">Azure App Service Web App for Containers</a>. Given it lives in the context of a container, this makes it a great candidate for porting to Azure Container Apps.</p><p>So that&#x27;s what we&#x27;ll do in this post. But where I&#x27;m building and deploying my aunt&#x27;s container, you could equally be substituting your own; with some minimal changes.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="bicep">Bicep<a class="hash-link" href="#bicep" title="Direct link to heading">â€‹</a></h2><p>Let&#x27;s begin with the Bicep required to deploy our Azure Container App.</p><p>In our repository we&#x27;ll create an <code>infra</code> directory, into which we&#x27;ll place a <code>main.bicep</code> file which will contain our Bicep template:</p><div class="codeBlockContainer_I0IT language-bicep theme-code-block"><div class="codeBlockContent_wNvx bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">param nodeImage string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param nodePort int</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param nodeIsExternalIngress bool</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param containerRegistry string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param containerRegistryUsername string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@secure()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param containerRegistryPassword string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param tags object</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@secure()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param APPSETTINGS_API_KEY string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param APPSETTINGS_DOMAIN string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param APPSETTINGS_FROM_EMAIL string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param APPSETTINGS_RECIPIENT_EMAIL string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var location = resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var environmentName = &#x27;env-${uniqueString(resourceGroup().id)}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var minReplicas = 0</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var nodeServiceAppName = &#x27;node-app&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var workspaceName = &#x27;${nodeServiceAppName}-log-analytics&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var appInsightsName = &#x27;${nodeServiceAppName}-app-insights&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var containerRegistryPasswordRef = &#x27;container-registry-password&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var mailgunApiKeyRef = &#x27;mailgun-api-key&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource workspace &#x27;Microsoft.OperationalInsights/workspaces@2020-08-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: workspaceName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: tags</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      name: &#x27;PerGB2018&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    retentionInDays: 30</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    workspaceCapping: {}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource appInsights &#x27;Microsoft.Insights/components@2020-02-02-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: appInsightsName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: tags</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;web&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Application_Type: &#x27;web&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    Flow_Type: &#x27;Bluefield&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource environment &#x27;Microsoft.Web/kubeEnvironments@2021-03-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: environmentName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: tags</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    type: &#x27;managed&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    internalLoadBalancerEnabled: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    appLogsConfiguration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      destination: &#x27;log-analytics&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      logAnalyticsConfiguration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        customerId: workspace.properties.customerId</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        sharedKey: listKeys(workspace.id, workspace.apiVersion).primarySharedKey</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    containerAppsConfiguration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      daprAIInstrumentationKey: appInsights.properties.InstrumentationKey</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource containerApp &#x27;Microsoft.Web/containerapps@2021-03-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: nodeServiceAppName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;containerapps&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  tags: tags</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    kubeEnvironmentId: environment.id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    configuration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      secrets: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          name: containerRegistryPasswordRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          value: containerRegistryPassword</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          name: mailgunApiKeyRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          value: APPSETTINGS_API_KEY</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      registries: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          server: containerRegistry</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          username: containerRegistryUsername</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          passwordSecretRef: containerRegistryPasswordRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ingress: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        &#x27;external&#x27;: nodeIsExternalIngress</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        &#x27;targetPort&#x27;: nodePort</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    template: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      containers: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          image: nodeImage</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          name: nodeServiceAppName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          transport: &#x27;auto&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          env: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              name: &#x27;APPSETTINGS_API_KEY&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              secretref: mailgunApiKeyRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              name: &#x27;APPSETTINGS_DOMAIN&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              value: APPSETTINGS_DOMAIN</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              name: &#x27;APPSETTINGS_FROM_EMAIL&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              value: APPSETTINGS_FROM_EMAIL</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              name: &#x27;APPSETTINGS_RECIPIENT_EMAIL&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              value: APPSETTINGS_RECIPIENT_EMAIL</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      scale: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        minReplicas: minReplicas</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Let&#x27;s talk through this template. The environment, workspace and app insights resources are fairly self explanatory. The <code>containerApp</code> resource is where the action is. We&#x27;ll drill into that resource and the parameters used to configure it.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="the-node-container-app">The node container app<a class="hash-link" href="#the-node-container-app" title="Direct link to heading">â€‹</a></h3><p>We&#x27;re going to create a single container app for our node web application. This is configured with these parameters:</p><div class="codeBlockContainer_I0IT language-bicep theme-code-block"><div class="codeBlockContent_wNvx bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">param nodeImage string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param nodePort int</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param nodeIsExternalIngress bool</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The above parameters relate to the node application that represents the website. The <code>nodeImage</code> is the container image which should be deployed to a container app. The <code>nodePort</code> is the port from the app which should be exposed (<code>3000</code> in our case). <code>nodeIsExternalIngress</code> is <a href="https://docs.microsoft.com/en-us/azure/container-apps/ingress?tabs=bash#configuration" target="_blank" rel="noopener noreferrer">whether the container should be accessible on the internet</a>. (Always <code>true</code> incidentally.)</p><p>When these parameters are applied to the <code>containerApp</code> resource, it looks like this:</p><div class="codeBlockContainer_I0IT language-bicep theme-code-block"><div class="codeBlockContent_wNvx bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">var nodeServiceAppName = &#x27;node-app&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource containerApp &#x27;Microsoft.Web/containerapps@2021-03-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ingress: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        &#x27;external&#x27;: nodeIsExternalIngress</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        &#x27;targetPort&#x27;: nodePort</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    template: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      containers: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          image: nodeImage</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          name: nodeServiceAppName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="accessing-the-github-container-registry">Accessing the GitHub Container Registry<a class="hash-link" href="#accessing-the-github-container-registry" title="Direct link to heading">â€‹</a></h3><p>Given that we&#x27;ve told Bicep to deploy an <code>image</code>, we&#x27;re going to need to tell it what registry it can use to acquire that image. Our template takes these parameters:</p><div class="codeBlockContainer_I0IT language-bicep theme-code-block"><div class="codeBlockContent_wNvx bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">param containerRegistry string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param containerRegistryUsername string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@secure()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param containerRegistryPassword string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param tags object</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>With the exception of the <code>tags</code> object which is metadata to apply to resources, these parameters are related to the container registry where our images will be stored. GitHub&#x27;s in our case. Remember, what we deploy to Azure Container Apps are container images. To get something running in an ACA, it first has to reside in a container registry. There&#x27;s a multitude of container registries out there and we&#x27;re using the one directly available in GitHub. As an alternative, we could use an <a href="https://azure.microsoft.com/en-us/services/container-registry/" target="_blank" rel="noopener noreferrer">Azure Container Registry</a>, or <a href="https://hub.docker.com/" target="_blank" rel="noopener noreferrer">Docker Hub</a> - or something else entirely.</p><p>Do note the <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/bicep/parameters#secure-parameters" target="_blank" rel="noopener noreferrer"><code>@secure()</code></a> decorator. This marks the <code>containerRegistryPassword</code> parameter as secure. The value for a secure parameter isn&#x27;t saved to the deployment history and isn&#x27;t logged. Typically you&#x27;ll want to mark secrets with the <code>@secure()</code> decorator for this very reason.</p><p>We use the parameters to configure the <code>registries</code> property of our container app. This tells the ACA where it can go to collect the image it needs. You can also see our first usage of secrets here. We declare the <code>containerRegistryPassword</code> as a secret which is stored against the ref <code>&#x27;container-registry-password&#x27;</code>; captured as the variable <code>containerRegistryPasswordRef</code>. That variable is then referenced in the <code>passwordSecretRef</code> property - thus telling ACA where it can find the password.</p><div class="codeBlockContainer_I0IT language-bicep theme-code-block"><div class="codeBlockContent_wNvx bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">var containerRegistryPasswordRef = &#x27;container-registry-password&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource containerApp &#x27;Microsoft.Web/containerapps@2021-03-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    configuration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      secrets: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          name: containerRegistryPasswordRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          value: containerRegistryPassword</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      registries: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          server: containerRegistry</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          username: containerRegistryUsername</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          passwordSecretRef: containerRegistryPasswordRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="secrets--configuration">Secrets / Configuration<a class="hash-link" href="#secrets--configuration" title="Direct link to heading">â€‹</a></h3><p>The final collection of parameters are unrelated to the infrastructure of deployment, rather they are the things required to configure our running application:</p><div class="codeBlockContainer_I0IT language-bicep theme-code-block"><div class="codeBlockContent_wNvx bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">@secure()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param APPSETTINGS_API_KEY string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param APPSETTINGS_DOMAIN string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param APPSETTINGS_FROM_EMAIL string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param APPSETTINGS_RECIPIENT_EMAIL string</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Again we&#x27;ve got a secret marked with <code>@secure()</code> in the form of our <code>APPSETTINGS_API_KEY</code>. Just as we did with <code>containerRegistryPassword</code>, we declare <code>APPSETTINGS_API_KEY</code> to be a secret, which is stored against the ref <code>&#x27;mailgun-api-key&#x27;</code>; captured as the variable <code>mailgunApiKeyRef</code>.</p><p>All of our configuration is exposed to the running application through environment variables. By and large this is achieved through the mechanism of key / value pairs (well technically <code>name</code> / <code>value</code>) with a slight variation for secrets. Similar to the <code>passwordSecretRef</code> mechanism we used for the registry password, we use a <code>secretref</code> in place of <code>value</code> when passing a secret, and the value will be the ref that was set up in the <code>secrets</code> section; <code>mailgunApiKeyRef</code> in this case.</p><div class="codeBlockContainer_I0IT language-bicep theme-code-block"><div class="codeBlockContent_wNvx bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">var mailgunApiKeyRef = &#x27;mailgun-api-key&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource containerApp &#x27;Microsoft.Web/containerapps@2021-03-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    configuration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      secrets: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          name: mailgunApiKeyRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          value: APPSETTINGS_API_KEY</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    template: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      containers: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          env: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              name: &#x27;APPSETTINGS_API_KEY&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              secretref: mailgunApiKeyRef</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              name: &#x27;APPSETTINGS_DOMAIN&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              value: APPSETTINGS_DOMAIN</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              name: &#x27;APPSETTINGS_FROM_EMAIL&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              value: APPSETTINGS_FROM_EMAIL</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              name: &#x27;APPSETTINGS_RECIPIENT_EMAIL&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              value: APPSETTINGS_RECIPIENT_EMAIL</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="setting-up-a-resource-group">Setting up a resource group<a class="hash-link" href="#setting-up-a-resource-group" title="Direct link to heading">â€‹</a></h2><p>With our Bicep in place, we&#x27;re going to need a resource group to send it to. Right now, Azure Container Apps aren&#x27;t available everywhere. So we&#x27;re going to create ourselves a resource group in North Europe which does support ACAs:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">az group create -g rg-aca -l northeurope</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="secrets-for-github-actions">Secrets for GitHub Actions<a class="hash-link" href="#secrets-for-github-actions" title="Direct link to heading">â€‹</a></h2><p>We&#x27;re aiming to set up a GitHub Action to handle our deployment. This will depend upon a number of secrets:</p><p><img loading="lazy" alt="Screenshot of the secrets in the GitHub website that we need to create" src="/assets/images/screenshot-github-secrets-99b5553140a144c164a434c95dd7e4e1.png" width="1544" height="842"></p><p>We&#x27;ll need to create each of these secrets.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="azure_credentials---github-logging-into-azure"><code>AZURE_CREDENTIALS</code> - GitHub logging into Azure<a class="hash-link" href="#azure_credentials---github-logging-into-azure" title="Direct link to heading">â€‹</a></h3><p>So GitHub Actions can interact with Azure on our behalf, we need to provide it with some credentials. We&#x27;ll use the Azure CLI to create these:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">az ad sp create-for-rbac --name </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;myApp&quot;</span><span class="token plain"> --role contributor </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    --scopes /subscriptions/</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">subscription-id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">/resourceGroups/</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">resource-group</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    --sdk-auth</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Remember to replace the <code>{subscription-id}</code> with your subscription id and <code>{resource-group}</code> with the name of your resource group (<code>rg-aca</code> if you&#x27;re following along). This command will pump out a lump of JSON that looks something like this:</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;clientId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-client-id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;clientSecret&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-client-secret&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;subscriptionId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-subscription-id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;tenantId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-tenant-id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;activeDirectoryEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://login.microsoftonline.com&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;resourceManagerEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://management.azure.com/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;activeDirectoryGraphResourceId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://graph.windows.net/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;sqlManagementEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://management.core.windows.net:8443/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;galleryEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://gallery.azure.com/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;managementEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://management.core.windows.net/&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Take this and save it as the <code>AZURE_CREDENTIALS</code> secret in Azure.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="packages_token---azure-accessing-the-github-container-registry"><code>PACKAGES_TOKEN</code> - Azure accessing the GitHub container registry<a class="hash-link" href="#packages_token---azure-accessing-the-github-container-registry" title="Direct link to heading">â€‹</a></h3><p>We also need a secret for accessing packages from Azure. We&#x27;re going to be publishing packages to the GitHub container registry. Azure is going to need to be able to access this when we&#x27;re deploying. ACA deployment works by telling Azure where to look for an image and providing any necessary credentials to do the acquisition. To facilitate this we&#x27;ll set up a <code>PACKAGES_TOKEN</code> secret. This is a GitHub personal access token with the <code>read:packages</code> scope. <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token" target="_blank" rel="noopener noreferrer">Follow the instructions here to create the token.</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="secrets-for-the-app">Secrets for the app<a class="hash-link" href="#secrets-for-the-app" title="Direct link to heading">â€‹</a></h3><p>Alongside these infrastructure / deployment related secrets, we&#x27;ll need ones to configure the app at runtime:</p><ul><li><code>APPSETTINGS_API_KEY</code> - an API key for Mailgun which will be used to send emails</li><li><code>APPSETTINGS_DOMAIN</code> - the domain for the email eg <code>mg.poorclaresarundel.org</code></li><li><code>APPSETTINGS_FROM_EMAIL</code> - who automated emails should come from eg <code>noreply@mg.poorclaresarundel.org</code></li><li><code>APPSETTINGS_RECIPIENT_EMAIL</code> - the email address emails should be sent to</li></ul><p>Strictly speaking, only the API key is a secret. But to simplify this post we&#x27;ll configure all of these as secrets in GitHub.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="deploying-with-github-actions">Deploying with GitHub Actions<a class="hash-link" href="#deploying-with-github-actions" title="Direct link to heading">â€‹</a></h2><p>With our secrets configured, we&#x27;re now well placed to write our GitHub Action. We&#x27;ll create a <code>.github/workflows/deploy.yaml</code> file in our repository and populate it thusly:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># yaml-language-server: $schema=./build.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Build and Deploy</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">on</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Trigger the workflow on push or pull request,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># but only for the main branch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">push</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">pull_request</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Publish semver tags as releases.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">tags</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;v*.*.*&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">workflow_dispatch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">RESOURCE_GROUP</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> rg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">aca</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">REGISTRY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ghcr.io</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">IMAGE_NAME</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> github.repository </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">matrix</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token key atrule">&#x27;imageName&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;node-service&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token key atrule">&#x27;directory&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;./node-service&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">permissions</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">contents</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> read</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">packages</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> write</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">outputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">containerImage-node</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> steps.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">tag.outputs.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Checkout repository</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> actions/checkout@v2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Login against a Docker registry except on PR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># https://github.com/docker/login-action</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Log into registry $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> github.event_name </span><span class="token tag" style="color:rgb(127, 219, 202)">!=</span><span class="token plain"> &#x27;pull_request&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> docker/login</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">action@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">registry</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">username</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> github.actor </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">password</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> secrets.GITHUB_TOKEN </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Extract metadata (tags, labels) for Docker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># https://github.com/docker/metadata-action</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Extract Docker metadata</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> meta</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> docker/metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">action@v3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">images</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">/$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.IMAGE_NAME </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">/$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> matrix.services.imageName </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">tags</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            type=semver,pattern={{version}}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            type=semver,pattern={{major}}.{{minor}}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            type=semver,pattern={{major}}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            type=ref,event=branch</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            type=sha</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># Build and push Docker image with Buildx (don&#x27;t push on PR)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># https://github.com/docker/build-push-action</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Build and push Docker image</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> docker/build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">push</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">action@v2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">context</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> matrix.services.directory </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">push</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> github.event_name </span><span class="token tag" style="color:rgb(127, 219, 202)">!=</span><span class="token plain"> &#x27;pull_request&#x27; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">tags</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> steps.meta.outputs.tags </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> steps.meta.outputs.labels </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Output image tag</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">tag</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> echo &quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">output name=image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> matrix.services.imageName </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.REGISTRY </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">/$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> env.IMAGE_NAME </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">/$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> matrix.services.imageName </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">sha</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">$(git rev</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">parse </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">short HEAD)&quot; </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> tr &#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">upper</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">&#x27; &#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">lower</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">deploy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">needs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">build</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Checkout repository</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> actions/checkout@v2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Azure Login</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azure/login@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">creds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> secrets.AZURE_CREDENTIALS </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azure/CLI@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> github.event_name </span><span class="token tag" style="color:rgb(127, 219, 202)">!=</span><span class="token plain"> &#x27;pull_request&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            tags=&#x27;{&quot;owner&quot;:&quot;johnnyreilly&quot;, &quot;email&quot;:&quot;johnny_reilly@hotmail.com&quot;}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            az deployment group create \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">              --resource-group ${{ env.RESOURCE_GROUP }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">              --template-file ./infra/main.bicep \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">              --parameters \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  nodeImage=&#x27;${{ needs.build.outputs.containerImage-node }}&#x27; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  nodePort=3000 \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  nodeIsExternalIngress=true \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  containerRegistry=${{ env.REGISTRY }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  containerRegistryUsername=${{ github.actor }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  containerRegistryPassword=${{ secrets.PACKAGES_TOKEN }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  tags=&quot;$tags&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  APPSETTINGS_API_KEY=&quot;${{ secrets.APPSETTINGS_API_KEY }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  APPSETTINGS_DOMAIN=&quot;${{ secrets.APPSETTINGS_DOMAIN }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  APPSETTINGS_FROM_EMAIL=&quot;${{ secrets.APPSETTINGS_FROM_EMAIL }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  APPSETTINGS_RECIPIENT_EMAIL=&quot;${{ secrets.APPSETTINGS_RECIPIENT_EMAIL }}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> What</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">if bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azure/CLI@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> github.event_name == &#x27;pull_request&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            tags=&#x27;{&quot;owner&quot;:&quot;johnnyreilly&quot;, &quot;email&quot;:&quot;johnny_reilly@hotmail.com&quot;}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            az deployment group what-if \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">              --resource-group ${{ env.RESOURCE_GROUP }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">              --template-file ./infra/main.bicep \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">              --parameters \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  nodeImage=&#x27;${{ needs.build.outputs.containerImage-node }}&#x27; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  nodePort=3000 \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  nodeIsExternalIngress=true \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  containerRegistry=${{ env.REGISTRY }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  containerRegistryUsername=${{ github.actor }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  containerRegistryPassword=${{ secrets.PACKAGES_TOKEN }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  tags=&quot;$tags&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  APPSETTINGS_API_KEY=&quot;${{ secrets.APPSETTINGS_API_KEY }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  APPSETTINGS_DOMAIN=&quot;${{ secrets.APPSETTINGS_DOMAIN }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  APPSETTINGS_FROM_EMAIL=&quot;${{ secrets.APPSETTINGS_FROM_EMAIL }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                  APPSETTINGS_RECIPIENT_EMAIL=&quot;${{ secrets.APPSETTINGS_RECIPIENT_EMAIL }}&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>There&#x27;s a lot in this workflow. Let&#x27;s dig into the <code>build</code> and <code>deploy</code> jobs to see what&#x27;s happening.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="build---building-our-image"><code>build</code> - building our image<a class="hash-link" href="#build---building-our-image" title="Direct link to heading">â€‹</a></h3><p>The <code>build</code> job is all about building our container images and pushing then to the GitHub registry. It&#x27;s heavily inspired by <a href="https://twitter.com/jeffhollan" target="_blank" rel="noopener noreferrer">Jeff Hollan</a>&#x27;s <a href="https://github.com/Azure-Samples/container-apps-store-api-microservice" target="_blank" rel="noopener noreferrer">Azure sample app GHA</a>. When we look at the <code>strategy</code> we can see a <code>matrix</code> of <code>services</code> consisting of a single service; our node app:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">strategy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">matrix</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> </span><span class="token key atrule">&#x27;imageName&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;node-service&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token key atrule">&#x27;directory&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;./node-service&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This is a matrix because a typical use case of an Azure Container App will be multi-container, so we&#x27;re starting generic from the beginning. The <code>outputs</code> pumps out the details of our <code>containerImage-node</code> image to be used later:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">outputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">containerImage-node</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> steps.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">tag.outputs.image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>With that understanding in place, let&#x27;s examine what each of the steps in the <code>build</code> job does</p><ul><li><code>Log into registry</code> - logs into the GitHub container registry</li><li><code>Extract Docker metadata</code> - acquire tags which will be used for versioning</li><li><code>Build and push Docker image</code> - build the docker image and if this is not a PR: tag, label and push it to the registry</li><li><code>Output image tag</code> - write out the image tag for usage in deployment</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="deploy---shipping-our-image-to-azure"><code>deploy</code> - shipping our image to Azure<a class="hash-link" href="#deploy---shipping-our-image-to-azure" title="Direct link to heading">â€‹</a></h3><p>The <code>deploy</code> job does two possible things with our Bicep template; <code>main.bicep</code>.</p><p>In the case of a pull request, it runs the <a href="https://docs.microsoft.com/en-us/cli/azure/deployment/group?view=azure-cli-latest#az_deployment_group_what_if" target="_blank" rel="noopener noreferrer"><code>az deployment group what-if</code></a> - this allows us to see what the effect would be of applying a PR to our infrastructure.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> What</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">if bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azure/CLI@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> github.event_name == &#x27;pull_request&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">      tags=&#x27;{&quot;owner&quot;:&quot;johnnyreilly&quot;, &quot;email&quot;:&quot;johnny_reilly@hotmail.com&quot;}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">      az deployment group what-if \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        --resource-group ${{ env.RESOURCE_GROUP }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        --template-file ./infra/main.bicep \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        --parameters \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            nodeImage=&#x27;${{ needs.build.outputs.containerImage-node }}&#x27; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            nodePort=3000 \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            nodeIsExternalIngress=true \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            containerRegistry=${{ env.REGISTRY }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            containerRegistryUsername=${{ github.actor }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            containerRegistryPassword=${{ secrets.PACKAGES_TOKEN }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            tags=&quot;$tags&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            APPSETTINGS_API_KEY=&quot;${{ secrets.APPSETTINGS_API_KEY }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            APPSETTINGS_DOMAIN=&quot;${{ secrets.APPSETTINGS_DOMAIN }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            APPSETTINGS_FROM_EMAIL=&quot;${{ secrets.APPSETTINGS_FROM_EMAIL }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            APPSETTINGS_RECIPIENT_EMAIL=&quot;${{ secrets.APPSETTINGS_RECIPIENT_EMAIL }}&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>When it&#x27;s not a pull request, it runs the <a href="https://docs.microsoft.com/en-us/cli/azure/deployment/group?view=azure-cli-latest#az_deployment_group_create" target="_blank" rel="noopener noreferrer"><code>az deployment group create</code></a> command which performs a deployment of our <code>main.bicep</code> file.</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azure/CLI@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> github.event_name </span><span class="token tag" style="color:rgb(127, 219, 202)">!=</span><span class="token plain"> &#x27;pull_request&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">      tags=&#x27;{&quot;owner&quot;:&quot;johnnyreilly&quot;, &quot;email&quot;:&quot;johnny_reilly@hotmail.com&quot;}&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">      az deployment group create \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        --resource-group ${{ env.RESOURCE_GROUP }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        --template-file ./infra/main.bicep \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        --parameters \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            nodeImage=&#x27;${{ needs.build.outputs.containerImage-node }}&#x27; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            nodePort=3000 \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            nodeIsExternalIngress=true \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            containerRegistry=${{ env.REGISTRY }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            containerRegistryUsername=${{ github.actor }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            containerRegistryPassword=${{ secrets.PACKAGES_TOKEN }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            tags=&quot;$tags&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            APPSETTINGS_API_KEY=&quot;${{ secrets.APPSETTINGS_API_KEY }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            APPSETTINGS_DOMAIN=&quot;${{ secrets.APPSETTINGS_DOMAIN }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            APPSETTINGS_FROM_EMAIL=&quot;${{ secrets.APPSETTINGS_FROM_EMAIL }}&quot; \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            APPSETTINGS_RECIPIENT_EMAIL=&quot;${{ secrets.APPSETTINGS_RECIPIENT_EMAIL }}&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In either case we pass the same set of parameters:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token assign-left variable" style="color:rgb(214, 222, 235)">nodeImage</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;</span><span class="token string variable" style="color:rgb(214, 222, 235)">${{ needs.build.outputs.containerImage-node }</span><span class="token string" style="color:rgb(173, 219, 103)">}&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">nodePort</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">3000</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">nodeIsExternalIngress</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">true </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">containerRegistry</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token variable" style="color:rgb(214, 222, 235)">${{ env.REGISTRY }</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">containerRegistryUsername</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token variable" style="color:rgb(214, 222, 235)">${{ github.actor }</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">containerRegistryPassword</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token variable" style="color:rgb(214, 222, 235)">${{ secrets.PACKAGES_TOKEN }</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">tags</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;</span><span class="token string variable" style="color:rgb(214, 222, 235)">$tags</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">APPSETTINGS_API_KEY</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;</span><span class="token string variable" style="color:rgb(214, 222, 235)">${{ secrets.APPSETTINGS_API_KEY }</span><span class="token string" style="color:rgb(173, 219, 103)">}&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">APPSETTINGS_DOMAIN</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;</span><span class="token string variable" style="color:rgb(214, 222, 235)">${{ secrets.APPSETTINGS_DOMAIN }</span><span class="token string" style="color:rgb(173, 219, 103)">}&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">APPSETTINGS_FROM_EMAIL</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;</span><span class="token string variable" style="color:rgb(214, 222, 235)">${{ secrets.APPSETTINGS_FROM_EMAIL }</span><span class="token string" style="color:rgb(173, 219, 103)">}&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">APPSETTINGS_RECIPIENT_EMAIL</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;</span><span class="token string variable" style="color:rgb(214, 222, 235)">${{ secrets.APPSETTINGS_RECIPIENT_EMAIL }</span><span class="token string" style="color:rgb(173, 219, 103)">}&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>These are either:</p><ul><li>secrets we set up earlier</li><li>environment variables declared at the start of the script or</li><li>outputs from the build step - this is where we acquire our node image</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="running-it">Running it<a class="hash-link" href="#running-it" title="Direct link to heading">â€‹</a></h2><p>When the GitHub Action has been run you&#x27;ll find that Azure Container App is now showing up inside the Azure Portal in your resource group, alongside the other resources:</p><p><img loading="lazy" alt="screenshot of the Azure Container App&amp;#39;s resource group in the Azure Portal" src="/assets/images/screenshot-azure-portal-container-app-ee70db004700ddaac1de8e411a9b87da.png" width="2507" height="420"></p><p>And when we take a closer look at the container app, we find a URL we can navigate to:</p><p><img loading="lazy" alt="screenshot of the Azure Container App in the Azure Portal revealing it&amp;#39;s URL" src="/assets/images/screenshot-azure-portal-container-app-url-ed4d07a3928693eb95afb4707dd78ce5.png" width="1404" height="388"></p><p>Congratulations! You&#x27;ve built and deployed a simple web app to Azure Container Apps with Bicep and GitHub Actions and secrets.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/azure-container-apps">Azure Container Apps</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/bicep">Bicep</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/git-hub-actions">GitHub Actions</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/git-hub-container-registry">GitHub container registry</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Azure Container Apps: build and deploy with Bicep and GitHub Actions" href="/2021/12/27/azure-container-apps-build-and-deploy-with-bicep-and-github-actions"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/2021/12/19/azure-container-apps-bicep-and-github-actions">Azure Container Apps, Bicep and GitHub Actions</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-12-19T00:00:00.000Z" itemprop="datePublished">December 19, 2021</time> Â· <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/assets/images/title-image-151d61532e1cffb9c37053af7da126fc.png"><div class="markdown" itemprop="articleBody"><p>Azure Container Apps are an exciting way to deploy containers to Azure. This post shows how to deploy the infrastructure for an Azure Container App to Azure using Bicep and GitHub Actions. The <a href="https://docs.microsoft.com/en-us/azure/container-apps/" target="_blank" rel="noopener noreferrer">Azure Container App documentation</a> features quickstarts for deploying your first container app using both the Azure Portal and the Azure CLI. These are great, but there&#x27;s a gap if you prefer to deploy using Bicep and you&#x27;d like to get your CI/CD setup right from the beginning. This post aims to fill that gap.</p><p>If you&#x27;re interested in building your own containers as well, it&#x27;s worth looking at <a href="/2021/12/27/azure-container-apps-build-and-deploy-with-bicep-and-github-actions">this follow up post</a>.</p><p><img loading="lazy" alt="title image reading &amp;quot;Azure Container Apps, Bicep and GitHub Actions&amp;quot; with the Bicep, Azure Container Apps and GitHub Actions logos" src="/assets/images/title-image-151d61532e1cffb9c37053af7da126fc.png" width="1600" height="900"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="bicep">Bicep<a class="hash-link" href="#bicep" title="Direct link to heading">â€‹</a></h2><p>Let&#x27;s begin with the Bicep required to deploy an Azure Container App.</p><p>In our new repository we&#x27;ll create an <code>infra</code> directory, into which we&#x27;ll place a <code>main.bicep</code> file which will contain our Bicep template.</p><p>I&#x27;ve pared this down to the simplest Bicep template that I can; it only requires a name parameter:</p><div class="codeBlockContainer_I0IT language-bicep theme-code-block"><div class="codeBlockContent_wNvx bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">param name string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param secrets array = []</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var location = resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var environmentName = &#x27;Production&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var workspaceName = &#x27;${name}-log-analytics&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource workspace &#x27;Microsoft.OperationalInsights/workspaces@2020-08-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: workspaceName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      name: &#x27;PerGB2018&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    retentionInDays: 30</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    workspaceCapping: {}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource environment &#x27;Microsoft.Web/kubeEnvironments@2021-03-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: environmentName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    type: &#x27;managed&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    internalLoadBalancerEnabled: false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    appLogsConfiguration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      destination: &#x27;log-analytics&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      logAnalyticsConfiguration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        customerId: workspace.properties.customerId</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        sharedKey: listKeys(workspace.id, workspace.apiVersion).primarySharedKey</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource containerApp &#x27;Microsoft.Web/containerapps@2021-03-01&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: name</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  kind: &#x27;containerapps&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    kubeEnvironmentId: environment.id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    configuration: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      secrets: secrets</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      registries: []</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ingress: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        &#x27;external&#x27;:true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        &#x27;targetPort&#x27;:80</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    template: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      containers: [</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          &#x27;name&#x27;:&#x27;simple-hello-world-container&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          &#x27;image&#x27;:&#x27;mcr.microsoft.com/azuredocs/containerapps-helloworld:latest&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          &#x27;command&#x27;:[]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          &#x27;resources&#x27;:{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            &#x27;cpu&#x27;:&#x27;.25&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            &#x27;memory&#x27;:&#x27;.5Gi&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Some things to note from the template:</p><ul><li>We&#x27;re deploying three resources; a container app, a kube environment and an operational insights.</li><li>Just like the official quickstarts we&#x27;re going to use the <code>containerapps-helloworld</code> image.</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="setting-up-a-resource-group">Setting up a resource group<a class="hash-link" href="#setting-up-a-resource-group" title="Direct link to heading">â€‹</a></h2><p>In order that you can deploy your Bicep, we&#x27;re going to need a resource group to send it to. Right now, Azure Container Apps aren&#x27;t available everywhere. So we&#x27;re going to create ourselves a resource group in North Europe which does support ACAs:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">az group create -g rg-aca -l northeurope</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="deploying-with-the-azure-cli">Deploying with the Azure CLI<a class="hash-link" href="#deploying-with-the-azure-cli" title="Direct link to heading">â€‹</a></h2><p>With this resource group in place, we could simply deploy using the Azure CLI like so:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">az deployment group create </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --resource-group rg-aca </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --template-file ./infra/main.bicep </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  --parameters </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token assign-left variable" style="color:rgb(214, 222, 235)">name</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;container-app&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="deploying-with-github-actions">Deploying with GitHub Actions<a class="hash-link" href="#deploying-with-github-actions" title="Direct link to heading">â€‹</a></h2><p>However, we&#x27;re aiming to set up a GitHub Action to do this for us. We&#x27;ll create a <code>.github/workflows/deploy.yaml</code> file in our repository:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">on</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">push</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">main</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">workflow_dispatch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">RESOURCE_GROUP</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> rg</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">aca</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">deploy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Checkout repository</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> actions/checkout@v2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Azure Login</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azure/login@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">creds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> secrets.AZURE_CREDENTIALS </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azure/CLI@v1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">            az deployment group create \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">              --resource-group ${{ env.RESOURCE_GROUP }} \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">              --template-file ./infra/main.bicep \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">              --parameters \</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                name=&#x27;container-app&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The above GitHub action is very simple. It:</p><ol><li>Logs into Azure using some <code>AZURE_CREDENTIALS</code> we&#x27;ll set up in a moment.</li><li>Invokes the Azure CLI to deploy our Bicep template.</li></ol><p>Let&#x27;s create that <code>AZURE_CREDENTIALS</code> secret in GitHub:</p><p><img loading="lazy" alt="Screenshot of `AZURE_CREDENTIALS` secret in the GitHub website that we need to create" src="data:image/png;base64,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" width="1540" height="235"></p><p>We&#x27;ll use the Azure CLI once more:</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">az ad sp create-for-rbac --name </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;myApp&quot;</span><span class="token plain"> --role contributor </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    --scopes /subscriptions/</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">subscription-id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">/resourceGroups/</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">resource-group</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    --sdk-auth</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Remember to replace the <code>{subscription-id}</code> with your subscription id and <code>{resource-group}</code> with the name of your resource group (<code>rg-aca</code> if you&#x27;re following along). This command will pump out a lump of JSON that looks something like this:</p><div class="codeBlockContainer_I0IT language-json theme-code-block"><div class="codeBlockContent_wNvx json"><pre tabindex="0" class="prism-code language-json codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;clientId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-client-id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;clientSecret&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-client-secret&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;subscriptionId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-subscription-id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;tenantId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;a-tenant-id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;activeDirectoryEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://login.microsoftonline.com&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;resourceManagerEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://management.azure.com/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;activeDirectoryGraphResourceId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://graph.windows.net/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;sqlManagementEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://management.core.windows.net:8443/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;galleryEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://gallery.azure.com/&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;managementEndpointUrl&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;https://management.core.windows.net/&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Take this and save it as the <code>AZURE_CREDENTIALS</code> secret in Azure.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="running-it">Running it<a class="hash-link" href="#running-it" title="Direct link to heading">â€‹</a></h2><p>When the GitHub Action has been run you&#x27;ll find that Azure Container App is now showing up inside the Azure Portal:</p><p><img loading="lazy" alt="screenshot of the Azure Container App in the Azure Portal" src="/assets/images/screenshot-azure-portal-container-app-ced5e322f67db533948a5bedea469a03.png" width="1400" height="541"></p><p>You&#x27;ll see a URL is displayed, when you go that URL you&#x27;ll find the hello world image is running!</p><p><img loading="lazy" alt="screenshot of the running Azure Container App" src="/assets/images/screenshot-of-running-container-app-9c2faf56fe8f79d635d7365293bc823a.png" width="2227" height="953"></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/azure-container-apps">Azure Container Apps</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/bicep">Bicep</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/git-hub-actions">GitHub Actions</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Azure Container Apps, Bicep and GitHub Actions" href="/2021/12/19/azure-container-apps-bicep-and-github-actions"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" rel="noopener" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" loading="lazy" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c49ac07e.js"></script>
<script src="/assets/js/main.67d6d314.js"></script>
</body>
</html>