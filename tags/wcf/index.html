<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">3 posts tagged with &quot;WCF&quot; | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="3 posts tagged with &quot;WCF&quot; | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/tags/wcf"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-react-helmet="true" name="robots" content="max-image-preview:large"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/tags/wcf"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/wcf" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/wcf" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ff16c2af.css">
<link rel="preload" href="/assets/js/runtime~main.63119928.js" as="script">
<link rel="preload" href="/assets/js/main.c1af33ba.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog-archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://polywork.johnnyreilly.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Polywork<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/31/nswag-generated-c-sharp-client-property-name-clash">NSwag generated C# client: Open API property name clashes and decimal types rather than double</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/18/docusaurus-meta-tags-and-google-discover">Docusaurus, meta tags and Google Discover</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/15/structured-data-seo-and-react">Structured data, SEO and React</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/09/12/permissioning-azure-pipelines-bicep-role-assignments">Permissioning Azure Pipelines with Bicep and Azure RBAC Role Assignments</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/09/10/google-apis-authentication-with-typescript">Google APIs: authentication with TypeScript</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>3 posts tagged with &quot;WCF&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2013/01/03/html-to-pdf-using-wcf-service">HTML to PDF using a WCF Service</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2013-01-03T00:00:00.000Z" itemprop="datePublished">January 3, 2013</time> Â· <!-- -->4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_31ik" id="tl-dr---talk-is-cheap-show-me-the-code">TL; DR - &quot;Talk is cheap. Show me the code.&quot;<a aria-hidden="true" class="hash-link" href="#tl-dr---talk-is-cheap-show-me-the-code" title="Direct link to heading">â€‹</a></h2><p>Some time ago I wrote a <a href="http://icanmakethiswork.blogspot.com/2012/04/making-pdfs-from-html-in-c-using.html" target="_blank" rel="noopener noreferrer">post which demonstrated how you could make PDFs from HTML</a> using C# and <a href="http://code.google.com/p/wkhtmltopdf/" target="_blank" rel="noopener noreferrer">wkhtmltopdf</a>. To my lasting surprise this has been the most popular post I&#x27;ve written. I recently put together an ASP.NET WCF service which exposed this functionality which I thought might be worth sharing. The code can be found on GitHub <a href="https://github.com/johnnyreilly/PdfMakerWcfService" target="_blank" rel="noopener noreferrer">here</a>.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="a-little-more-detail">A little more detail<a aria-hidden="true" class="hash-link" href="#a-little-more-detail" title="Direct link to heading">â€‹</a></h2><p>I should say up front that I&#x27;m still a little ambivalent about how sensible an idea this is. Behind the scenes this WCF service is remotely firing up wkhtmltopdf using <code>System.Diagnostics.Process</code>. I feel a little wary about recommending this as a solution for a variety of not particularly defined reasons. However, I have to say I&#x27;ve found this pretty stable and reliable. Bottom line it seems to work and work consistently. But I though I should include a caveat emptor; there is probably a better approach than this available. Anyway...</p><p>There isn&#x27;t actually a great deal to say about this WCF service. It should (hopefully) just do what it says on the tin. Putting it together didn&#x27;t involve a great deal of work; essentially it takes the code from the initial blog post and just wraps it in a WCF service called <code>PdfMaker</code>. The service exposes 2 methods:</p><ol><li><code>GetPdf</code> <!-- -->-<!-- --> given a supplied URL this method creates a PDF and then returns it as a Stream to the client</li><li><code>GetPdfUrl</code> <!-- -->-<!-- --> given a supplied URL this method creates a PDF and then returns the location of it to the client</li></ol><p>Both of these methods also set a Location header in the response indicating the location of the created PDF.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="that-which-binds-us">That which binds us<a aria-hidden="true" class="hash-link" href="#that-which-binds-us" title="Direct link to heading">â€‹</a></h2><p>The service uses <code>webHttpBinding</code>. This is commonly employed when people want to expose a RESTful WCF service. The reason I&#x27;ve used this binding is I wanted a simple &quot;in&quot; when calling the service. I wanted to be able to call the service via AJAX as well as directly by browsing to the service and supplying a URL-encoded URL like this:</p><p><code>http://localhost:59002/PdfMaker.svc/GetPdf?url=http%3A%2F%2Fnews.ycombinator.com/</code>You may wonder why I&#x27;m using <a href="http://news.ycombinator.com" target="_blank" rel="noopener noreferrer">http://news.ycombinator.com</a> for the example above. I chose this as Hacker News is a very simple site; very few resources and a small page size. This means the service has less work to do when creating the PDF; it&#x27;s a quick demo.</p><p>I should say that this service is arguably <!-- -->*<!-- -->*<!-- -->not<!-- -->*<!-- -->*<!-- --> completely RESTful as each GET operation behind the scenes attempts to create a new PDF (arguably a side-effect). These should probably be POST operations as they create a new resource each time they&#x27;re hit. However, if they were I wouldn&#x27;t be able to just enter a URL into a browser for testing and that&#x27;s really useful. So tough, I shake my fist at the devotees of pure REST on this occasion. (If I should be attacked in the street shortly after this blog is posted then the police should be advised this is good line of inquiry...)</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="good-behaviour">Good behaviour<a aria-hidden="true" class="hash-link" href="#good-behaviour" title="Direct link to heading">â€‹</a></h2><p>It&#x27;s worth noting that <code>automaticFormatSelectionEnabled</code> set to true on the behaviour so that content negotiation is enabled. Obviously for the <code>GetPdf</code> action this is rather meaningless as it&#x27;s a stream that&#x27;s passed back. However, for the <code>GetPdfUrl</code> action the returned string can either be JSON or XML. The Fiddler screenshots below demonstrate this in action:</p><p><img src="https://4.bp.blogspot.com/-CX7w0jI0jTE/UOVaDP5Ae-I/AAAAAAAAAXk/H7zhyYYjPGA/s400/GetPdfUrl%2B-%2BJSON.png"></p><p><img src="https://4.bp.blogspot.com/-78GBDqI596I/UOVaTchTbBI/AAAAAAAAAXw/rz2Dg4g8BRs/s400/GetPdfUrl%2B-%2BXML.png"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="test-harness">Test Harness<a aria-hidden="true" class="hash-link" href="#test-harness" title="Direct link to heading">â€‹</a></h2><p>As a final touch I added in a test harness in the form of <code>Demo.aspx</code>. If you browse to it you&#x27;ll see a screen a little like this:</p><p><img src="https://2.bp.blogspot.com/-zoyt7ufl9FQ/UOVmD0VPh0I/AAAAAAAAAYE/DnmZmbx-Mxc/s400/PdfMakerDemo.png"></p><p>It&#x27;s fairly self-explanatory as you can see. And here&#x27;s an example of the output generated when pointing at Hacker News:</p><iframe src="https://docs.google.com/file/d/0B87K8-qxOZGFMGNCUWRneUFsVFU/preview" width="500" height="500"></iframe><p>And that&#x27;s it. If there was a need this service could be easily extended to leverage the <a href="http://madalgo.au.dk/~jakobt/wkhtmltoxdoc/wkhtmltopdf-0.9.9-doc.html" target="_blank" rel="noopener noreferrer">various options</a> that wkhtmltopdf makes available. Hope people find it useful.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/wkhtmltopdf">wkhtmltopdf</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/html">html</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/wcf">WCF</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/pdf">pdf</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about HTML to PDF using a WCF Service" href="/2013/01/03/html-to-pdf-using-wcf-service"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2012/03/22/wcf-moving-from-config-to-code-simple">WCF - moving from Config to Code, a simple WCF service harness (plus implementing your own Authorization)</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2012-03-22T00:00:00.000Z" itemprop="datePublished">March 22, 2012</time> Â· <!-- -->11 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Last time I wrote about WCF I was getting up and running with <a href="http://icanmakethiswork.blogspot.com/2012/02/wcf-transport-windows-authentication.html" target="_blank" rel="noopener noreferrer">WCF Transport Windows authentication using NetTcpBinding in an Intranet environment</a>. I ended up with a WCF service hosted in a Windows Service which did pretty much what the previous post name implies.</p><p>Since writing that I&#x27;ve taken things on a bit further and I thought it worth recording my approach whilst it&#x27;s still fresh in my mind. There&#x27;s 3 things I want to go over:</p><ol><li>I&#x27;ve moved away from the standard config driven WCF approach to a more &quot;code-first&quot; style</li><li>I&#x27;ve established a basic Windows Service hosted WCF service / client harness which is useful if you&#x27;re trying to get up and running with a WCF service quickly</li><li>I&#x27;ve locked down the WCF authorization to a single Windows account through the use of my own <a href="http://msdn.microsoft.com/en-us/library/ms731774.aspx" target="_blank" rel="noopener noreferrer">ServiceAuthorizationManager</a></li></ol><h2 class="anchor anchorWithStickyNavbar_31ik" id="moving-from-config-to-code">Moving from Config to Code<a aria-hidden="true" class="hash-link" href="#moving-from-config-to-code" title="Direct link to heading">â€‹</a></h2><p>So, originally I was doing what all the cool kids are doing and driving the configuration of my WCF service and all its clients through config files. And why not? I&#x27;m in good company.</p><p>Here&#x27;s why not: it gets <!-- -->*<strong>very</strong>*<!-- --> verbose <!-- -->*<strong>very</strong>*<!-- --> quickly....</p><p>Okay - that&#x27;s not the end of the world. My problem was that I had <!-- -->~<!-- -->10 Windows Services and 3 Web applications that needed to call into my WCF Service. I didn&#x27;t want to have to separately tweak 15 or so configs each time I wanted to make one standard change to WCF configuration settings. I wanted everything in one place.</p><p>Now there&#x27;s newer (and probably hipper) ways of achieving this. <a href="http://stackoverflow.com/a/2814286" target="_blank" rel="noopener noreferrer">Here&#x27;s one possibility I happened upon on StackOverflow that looks perfectly fine.</a></p><p>Well I didn&#x27;t use a hip new approach - no I went Old School with my old friend the <a href="http://msdn.microsoft.com/en-us/library/ms228154.aspx" target="_blank" rel="noopener noreferrer">appSettings file attribute</a>. Remember that? It&#x27;s just a simple way to have all your common appSettings configuration settings in a single file which can be linked to from as many other apps as you like. It&#x27;s wonderful and I&#x27;ve been using it for a long time now. Unfortunately it&#x27;s pretty basic in that it&#x27;s only the appSettings section that can be shared out; no <code>&amp;lt;system.serviceModel&amp;gt;</code> or similar.</p><p>But that wasn&#x27;t really a problem from my perspective. I realised that there were actually very few things that needed to be configurable for my WCF service. Really I wanted a basic WCF harness that could be initialised in code which implicitly set all the basic configuration with settings that worked (ie it was set up with defaults like maximum message size which were sufficiently sized). On top of that I would allow myself to configure just those things that I needed to through the use of my own custom WCF config settings in the shared appSettings.config file.</p><p>Once done I massively reduced the size of my configs from frankly gazillions of entries to just these appSettings.config entries which were shared across each of my WCF service clients and by my Windows Service harness:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly xml"><pre tabindex="0" class="prism-code language-xml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">appSettings</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">add</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">key</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">WcfBaseAddressForClient</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">net.tcp://localhost:9700/</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">add</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">key</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">WcfWindowsSecurityApplied</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">true</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">add</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">key</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">WcfCredentialsUserName</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">myUserName</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">add</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">key</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">WcfCredentialsPassword</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">myPassword</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">add</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">key</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">WcfCredentialsDomain</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">myDomain</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(127, 219, 202)">appSettings</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>And these config settings used only by my Windows Service harness:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly xml"><pre tabindex="0" class="prism-code language-xml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">appSettings</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">file</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">../Shared/AppSettings.config</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">add</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">key</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">WcfBaseAddressForService</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">net.tcp://localhost:9700/</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(127, 219, 202)">appSettings</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="show-me-your-harness">Show me your harness<a aria-hidden="true" class="hash-link" href="#show-me-your-harness" title="Direct link to heading">â€‹</a></h2><p>I ended up with a quite a nice basic &quot;vanilla&quot; framework that allowed me to quickly set up Windows Service hosted WCF services. The framework also provided me with a simple way to consume these WCF services with a minimum of code an configuration. No muss. No fuss. :-) So pleased with it was I that I thought I&#x27;d go through it here much in the manner of a chef baking a cake...</p><p>To start with I created myself a Windows Service in Visual Studio which I grandly called &quot;WcfWindowsService&quot;. The main service class looked like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">public class WcfWindowsService: ServiceBase</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static string WindowsServiceName = &quot;WCF Windows Service&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static string WindowsServiceDescription = &quot;Windows service that hosts a WCF service.&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    private static readonly log4net.ILog _logger = log4net.LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public List&lt;ServiceHost&gt; _serviceHosts = null;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public WcfWindowsService()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ServiceName = WindowsServiceName;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static void Main()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      ServiceBase.Run(new WcfWindowsService());</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// The Windows Service is starting</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// &lt;param name=&quot;args&quot;&gt;&lt;/param&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    protected override void OnStart(string[] args)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      try</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        CloseAndClearServiceHosts();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        //Make log4net startup</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        XmlConfigurator.Configure();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        _logger.Warn(&quot;WCF Windows Service starting...&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        _logger.Info(&quot;Global.WcfWindowsSecurityApplied = &quot; + Global.WcfWindowsSecurityApplied.ToString().ToLower());</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        if (Global.WcfWindowsSecurityApplied)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          _logger.Info(&quot;Global.WcfOnlyAuthorizedForWcfCredentials = &quot; + Global.WcfOnlyAuthorizedForWcfCredentials.ToString().ToLower());</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          if (Global.WcfOnlyAuthorizedForWcfCredentials)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _logger.Info(&quot;Global.WcfCredentialsDomain = &quot; + Global.WcfCredentialsDomain);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _logger.Info(&quot;Global.WcfCredentialsUserName = &quot; + Global.WcfCredentialsUserName);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        //Create binding</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        var wcfBinding = WcfHelper.CreateBinding(Global.WcfWindowsSecurityApplied);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // Create a servicehost and endpoints for each service and open each</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        _serviceHosts = new List&lt;ServiceHost&gt;();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        _serviceHosts.Add(WcfServiceFactory&lt;IHello&gt;.CreateAndOpenServiceHost(typeof(HelloService), wcfBinding));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        _serviceHosts.Add(WcfServiceFactory&lt;IGoodbye&gt;.CreateAndOpenServiceHost(typeof(GoodbyeService), wcfBinding));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        _logger.Warn(&quot;WCF Windows Service started.&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      catch (Exception exc)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        _logger.Error(&quot;Problem starting up&quot;, exc);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        throw exc;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// The Windows Service is stopping</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    protected override void OnStop()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      CloseAndClearServiceHosts();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      _logger.Warn(&quot;WCF Windows Service stopped&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// Close and clear service hosts in list and clear it down</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    private void CloseAndClearServiceHosts()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      if (_serviceHosts != null)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        foreach (var serviceHost in _serviceHosts)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          CloseAndClearServiceHost(serviceHost);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        _serviceHosts.Clear();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// Close and clear the passed service host</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// &lt;param name=&quot;serviceHost&quot;&gt;&lt;/param&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    private void CloseAndClearServiceHost(ServiceHost serviceHost)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      if (serviceHost != null)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        _logger.Info(string.Join(&quot;, &quot;, serviceHost.BaseAddresses) + &quot; is closing...&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        serviceHost.Close();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        _logger.Info(string.Join(&quot;, &quot;, serviceHost.BaseAddresses) + &quot; is closed&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>As you&#x27;ve no doubt noticed this makes use of <a href="http://logging.apache.org/log4net/" target="_blank" rel="noopener noreferrer">Log4Net</a> for logging purposes (I&#x27;ll assume you&#x27;re aware of it). My Windows Service implements such fantastic WCF services as HelloService and GoodbyeService. Each revolutionary in their own little way. To give you a taste of the joie de vivre that these services exemplify take a look at this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">// Implement the IHello service contract in a service class.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public class HelloService : WcfServiceAuthorizationManager, IHello</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // Implement the IHello methods.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public string GreetMe(string thePersonToGreet)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      return &quot;well hello there &quot; + thePersonToGreet;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Exciting! WcfWindowsService also references another class called &quot;Global&quot; which is a helper class - to be honest not much more than a wrapper for my config settings. It looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">static public class Global</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    #region Properties</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // eg &quot;net.tcp://localhost:9700/&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static string WcfBaseAddressForService { get { return ConfigurationManager.AppSettings[&quot;WcfBaseAddressForService&quot;]; } }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // eg true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static bool WcfWindowsSecurityApplied { get { return bool.Parse(ConfigurationManager.AppSettings[&quot;WcfWindowsSecurityApplied&quot;]); } }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // eg true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static bool WcfOnlyAuthorizedForWcfCredentials { get { return bool.Parse(ConfigurationManager.AppSettings[&quot;WcfOnlyAuthorizedForWcfCredentials&quot;]); } }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // eg &quot;myDomain&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static string WcfCredentialsDomain { get { return ConfigurationManager.AppSettings[&quot;WcfCredentialsDomain&quot;]; } }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // eg &quot;myUserName&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static string WcfCredentialsUserName { get { return ConfigurationManager.AppSettings[&quot;WcfCredentialsUserName&quot;]; } }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // eg &quot;myPassword&quot; - this should *never* be stored unencrypted and is only ever used by clients that are not already running with the approved Windows credentials</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static string WcfCredentialsPassword { get { return ConfigurationManager.AppSettings[&quot;WcfCredentialsPassword&quot;]; } }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    #endregion</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>WcfWindowsService creates and hosts a HelloService and a GoodbyeService when it starts up. It does this using my handy WcfServiceFactory:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">public class WcfServiceFactory&lt;TInterface&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    private static readonly log4net.ILog _logger = log4net.LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static ServiceHost CreateAndOpenServiceHost(Type serviceType, NetTcpBinding wcfBinding)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      var serviceHost = new ServiceHost(serviceType, new Uri(Global.WcfBaseAddressForService + ServiceHelper&lt;TInterface&gt;.GetServiceName()));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      serviceHost.AddServiceEndpoint(typeof(TInterface), wcfBinding, &quot;&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      serviceHost.Authorization.ServiceAuthorizationManager = new WcfServiceAuthorizationManager(); // This allows us to control authorisation within WcfServiceAuthorizationManager</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      serviceHost.Open();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      _logger.Info(string.Join(&quot;, &quot;, serviceHost.BaseAddresses) + &quot; is now listening.&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      return serviceHost;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To do this it also uses my equally handy WcfHelper class:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">static public class WcfHelper</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// Create a NetTcpBinding</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// &lt;param name=&quot;useWindowsSecurity&quot;&gt;&lt;/param&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    /// &lt;returns&gt;&lt;/returns&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static NetTcpBinding CreateBinding(bool useWindowsSecurity)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      var wcfBinding = new NetTcpBinding();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      if (useWindowsSecurity)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        wcfBinding.Security.Mode = SecurityMode.Transport;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        wcfBinding.Security.Transport.ClientCredentialType = TcpClientCredentialType.Windows;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      else</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        wcfBinding.Security.Mode = SecurityMode.None;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      wcfBinding.MaxBufferSize = int.MaxValue;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      wcfBinding.MaxReceivedMessageSize = int.MaxValue;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      wcfBinding.ReaderQuotas.MaxArrayLength = int.MaxValue;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      wcfBinding.ReaderQuotas.MaxDepth = int.MaxValue;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      wcfBinding.ReaderQuotas.MaxStringContentLength = int.MaxValue;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      wcfBinding.ReaderQuotas.MaxBytesPerRead = int.MaxValue;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      return wcfBinding;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  /// Create a WCF Client for use anywhere (be it Windows Service or ASP.Net web application)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  /// nb Credential fields are optional and only likely to be needed by web applications</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  /// &lt;typeparam name=&quot;TInterface&quot;&gt;&lt;/typeparam&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public class WcfClientFactory&lt;TInterface&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static TInterface CreateChannel(bool useWindowsSecurity, string wcfBaseAddress, string wcfCredentialsUserName = null, string wcfCredentialsPassword = null, string wcfCredentialsDomain = null)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      //Create NetTcpBinding using universally</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      var wcfBinding = WcfHelper.CreateBinding(useWindowsSecurity);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      //Get Service name from examining the ServiceNameAttribute decorating the interface</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      var serviceName = ServiceHelper&lt;TInterface&gt;.GetServiceName();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      //Create the factory for creating your channel</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      var factory = new ChannelFactory&lt;TInterface&gt;(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        wcfBinding,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        new EndpointAddress(wcfBaseAddress + serviceName)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      //if credentials have been supplied then use them</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      if (!string.IsNullOrEmpty(wcfCredentialsUserName))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        factory.Credentials.Windows.ClientCredential = new System.Net.NetworkCredential(wcfCredentialsUserName, wcfCredentialsPassword, wcfCredentialsDomain);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      //Create the channel</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      var channel = factory.CreateChannel();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      return channel;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now the above WcfHelper class and it&#x27;s comrade-in-arms the WcfClientFactory don&#x27;t live in the WcfWindowsService project with the other classes. No. They live in a separate project called the WcfWindowsServiceContracts project with their old mucker the ServiceHelper:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">public class ServiceHelper&lt;T&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static string GetServiceName()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      var customAttributes = typeof(T).GetCustomAttributes(false);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      if (customAttributes.Length &gt; 0)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        foreach (var customAttribute in customAttributes)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          if (customAttribute is ServiceNameAttribute)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return ((ServiceNameAttribute)customAttribute).ServiceName;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      throw new ArgumentException(&quot;Interface is missing ServiceNameAttribute&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  [AttributeUsage(AttributeTargets.Interface, AllowMultiple = false)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public class ServiceNameAttribute : System.Attribute</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public ServiceNameAttribute(string serviceName)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      this.ServiceName = serviceName;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public string ServiceName { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now can you guess what the WcfWindowsServiceContracts project might contain? Yes; contracts for your services (oh the excitement)! What might one of these contracts look like I hear you ask... Well, like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">[ServiceContract()]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  [ServiceName(&quot;HelloService&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  public interface IHello</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    [OperationContract]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    string GreetMe(string thePersonToGreet);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The WcfWindowsServiceContracts project is included in <!-- -->*<strong>any</strong>*<!-- --> WCF client solution that wants to call your WCF services. It is also included in the WCF service solution. It facilitates the calling of services. What you&#x27;re no doubt wondering is how this might be achieved. Well here&#x27;s how, it uses our old friend the <code>WcfClientFactory</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">var helloClient = WcfClientFactory&lt;IHello&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    .CreateChannel(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      useWindowsSecurity:     Global.WcfWindowsSecurityApplied,  // eg true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      wcfBaseAddress:         Global.WcfBaseAddressForClient,    // eg &quot;net.tcp://localhost:9700/&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      wcfCredentialsUserName: Global.WcfCredentialsUserName,     // eg &quot;myUserName&quot; - Optional parameter - only passed by web applications that need to impersonate the valid user</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      wcfCredentialsPassword: Global.WcfCredentialsPassword,     // eg &quot;myPassword&quot; - Optional parameter - only passed by web applications that need to impersonate the valid user</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      wcfCredentialsDomain:   Global.WcfCredentialsDomain        // eg &quot;myDomain&quot; - Optional parameter - only passed by web applications that need to impersonate the valid user</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  var greeting = helloClient.GreetMe(&quot;John&quot;); //&quot;well hello there John&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>See? Simple as simple. The eagle eyed amongst you will have noticed that client example above is using &quot;<code>Global</code>&quot; which is essentially a copy of the <code>Global</code> class mentioned above that is part of the WcfWindowsService project.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="locking-down-authorization-to-a-single-windows-account">Locking down Authorization to a single Windows account<a aria-hidden="true" class="hash-link" href="#locking-down-authorization-to-a-single-windows-account" title="Direct link to heading">â€‹</a></h2><p>I can tell you think i&#x27;ve forgotten something. &quot;Tell me about this locking down to the single Windows account / what is this mysterious <code>WcfServiceAuthorizationManager</code> class that all your WCF services inherit from? Don&#x27;t you fob me off now.... etc&quot;</p><p>Well ensuring that only a single Windows account is authorised (yes dammit the original English spelling) to access our WCF services is achieved by implementing our own <code>ServiceAuthorizationManager</code> class. This implementation is used for authorisation by your <code>ServiceHost</code> and the logic sits in the overridden <code>CheckAccessCore</code> method. All of our WCF service classes will inherit from our <code>ServiceAuthorizationManager</code> class and so trigger the <code>CheckAccessCore</code> authorisation each time they are called.</p><p>As you can see from the code below, depending on our configuration, we lock down access to all our WCF services to a specific Windows account. This is far from the only approach that you might want to take to authorisation; it&#x27;s simply the one that we&#x27;ve been using. However the power of being able to implement your own authorisation in the <code>CheckAccessCore</code> method allows you the flexibility to do pretty much anything you want:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">public class WcfServiceAuthorizationManager : ServiceAuthorizationManager</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    protected static readonly log4net.ILog _logger = log4net.LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    protected override bool CheckAccessCore(OperationContext operationContext)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      if (Global.WcfWindowsSecurityApplied)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        if ((operationContext.ServiceSecurityContext.IsAnonymous) ||</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          (operationContext.ServiceSecurityContext.PrimaryIdentity == null))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          _logger.Error(&quot;WcfWindowsSecurityApplied = true but no credentials have been supplied&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          return false;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        if (Global.WcfOnlyAuthorizedForWcfCredentials)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          if (operationContext.ServiceSecurityContext.PrimaryIdentity.Name.ToLower() == Global.WcfCredentialsDomain.ToLower() + &quot;\\&quot; + Global.WcfCredentialsUserName.ToLower())</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _logger.Debug(&quot;WcfOnlyAuthorizedForWcfCredentials = true and the valid user (&quot; + operationContext.ServiceSecurityContext.PrimaryIdentity.Name + &quot;) has been supplied and access allowed&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return true;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          else</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _logger.Error(&quot;WcfOnlyAuthorizedForWcfCredentials = true and an invalid user (&quot; + operationContext.ServiceSecurityContext.PrimaryIdentity.Name + &quot;) has been supplied and access denied&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return false;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        else</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          _logger.Debug(&quot;WcfOnlyAuthorizedForWcfCredentials = false, credentials were supplied (&quot; + operationContext.ServiceSecurityContext.PrimaryIdentity.Name + &quot;) so access allowed&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          return true;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      else</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        _logger.Info(&quot;WcfWindowsSecurityApplied = false so we are allowing unfettered access&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Phewwww... I know this has ended up as a bit of a brain dump but hopefully people will find it useful. At some point I&#x27;ll try to put up the above solution on GitHub so people can grab it easily for themselves.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/service-authorization-manager">ServiceAuthorizationManager</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/windows-account">Windows Account</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/windows-service">Windows Service</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/configuration">configuration</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/wcf">WCF</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/authorisation">authorisation</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/net-tcp-binding">NetTcpBinding</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about WCF - moving from Config to Code, a simple WCF service harness (plus implementing your own Authorization)" href="/2012/03/22/wcf-moving-from-config-to-code-simple"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2012/02/15/wcf-transport-windows-authentication">WCF Transport Windows authentication using NetTcpBinding in an Intranet environment</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2012-02-15T00:00:00.000Z" itemprop="datePublished">February 15, 2012</time> Â· <!-- -->5 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_31ik" id="update">Update<a aria-hidden="true" class="hash-link" href="#update" title="Direct link to heading">â€‹</a></h2><p>Since I wrote this initial post I&#x27;ve taken thinks on a bit further. Take a look at this post to see what I mean: <a href="http://icanmakethiswork.blogspot.com/2012/03/wcf-moving-from-config-to-code-simple.html" target="_blank" rel="noopener noreferrer">http://icanmakethiswork.blogspot.com/2012/03/wcf-moving-from-config-to-code-simple.html</a> I know I said I&#x27;d write about JSON this time. I will get to that but not this time. This time WCF authentication quirks. I&#x27;ve been working on a project that uses .NET Remoting to have a single central point to which web applications and Windows services can call into. This is used in an intranet environment and all the websites and Windows services were hosted on the same single server along with our .NET Remoting Windows service. (They could quite easily have been on different servers but there was no need in this case.) It was decided to &quot;embrace the new&quot; by migrating this .NET Remoting project over to WCF. The plan wasn&#x27;t to do anything revolutionary, just to move from one approach to the other as easily as possible. I found the following useful article on MSDN: <a href="http://msdn.microsoft.com/en-us/library/aa730857%28v=vs.80%29.aspx" target="_blank" rel="noopener noreferrer">http://msdn.microsoft.com/en-us/library/aa730857%28v=vs.80%29.aspx</a> This particular article was helpful and following the steps enclosed I was quickly up and running with a basic WCF service hosted in a Windows service. It was at this point I started thinking about security. The existing .NET Remoting approach had no security in place. This wasn&#x27;t ideal but also probably wasn&#x27;t the worry you might think. It was hosted in an intranet environment and hence not so exposed to the rigours of the Wild Wild Web. However, since I was looking at WCF I thought it would be a good opportunity to get some basic security in place. This generally pleases auditors. I opted to use <a href="http://msdn.microsoft.com/en-us/library/ms733089.aspx" target="_blank" rel="noopener noreferrer">Windows Transport authentication</a> as this seemed pretty appropriate for an intranet environment. The idea being that we&#x27;d authenticate with Windows for an account in our domain. After headbutting Windows for some time I managed to get a successful client call going from the website running on my development machine to the (separate) development server that was hosting our WCF Window service using Transport Windows authentication. However, when deploying the website to the development server I discovered we would experience the following error when the website attempted to call the WCF service (on the same server).</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">Event Type: Failure Audit</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Event Source: Security</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Event Category: Logon/Logoff</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Event ID: 537</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Date: 15/02/2012</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Time: 16:32:04</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">User: NT AUTHORITY\SYSTEM</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Computer: MINE999</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Description:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Logon Failure:</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Reason: An error occurred during logon</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Logon Type: 3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Logon Process: ^</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Authentication Package: NTLM</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Status code: 0xC000006D</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Not terribly helpful. At the end of the day it seemed we were suffering from a security &quot;feature&quot; introduced by Microsoft to prevent services calling services on the same box with a fully qualified name. An explanation of this can be found here: <a href="http://developers.de/blogs/damir_dobric/archive/2009/08/28/authentication-problems-by-using-of-ntlm.aspx" target="_blank" rel="noopener noreferrer">http://developers.de/blogs/damir_dobric/archive/2009/08/28/authentication-problems-by-using-of-ntlm.aspx</a> Using method 1 in the enclosed link I initially worked round this by amending the registry and rebooting the server: <a href="http://support.microsoft.com/kb/887993" target="_blank" rel="noopener noreferrer">http://support.microsoft.com/kb/887993</a> This was not a fantastic solution. Fortunately I subsequently found a better one but since the resources on the web are <!-- -->*<strong>ATROCIOUS</strong>*<!-- --> on this point I thought I should take the time to note down the full explanation since otherwise it&#x27;ll be lost in the mists of time. Here we go: The equivalent security to the previous .NET Remoting solution in WCF was to use this config setting on client and service:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly xml"><pre tabindex="0" class="prism-code language-xml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">security</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">mode</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">None</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>As I&#x27;ve said, this is an intranet environment and so having this &quot;none&quot; security setting in place is made less worrying by the fact that the network itself is secured. But obviously this is not ideal and unlikely to be audit compliant. To use Windows security you need this netTcpBinding config setting on client and service:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly xml"><pre tabindex="0" class="prism-code language-xml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">security</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">mode</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">Transport</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">transport</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">clientCredentialType</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">Windows</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(127, 219, 202)">security</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To call the service with this setting in place you will need to be an authenticated Windows user. (Or at the very least impersonating one - but you knew that.) <strong>NOW FOR THE MOST IMPORTANT BIT.....</strong> The endpoint addresses <!-- -->*<strong>must</strong>*<!-- --> be &quot;localhost&quot; for <em>both</em> client and service when both are deployed to the same server. If this is not the case then you will suffer from the aforementioned security &quot;feature&quot; which will provide you with unhelpful &quot;the server has rejected the client credentials&quot; messages and <!-- -->*<strong>nothing</strong>*<!-- --> else. <strong>OK FINISHED - MOVE ALONG NOW... NOTHING MORE TO SEE HERE</strong> With WCF Windows Transport authentication in place you can interrogate the calling user id within the service methods by simply evaluating ServiceSecurityContext.Current.PrimaryIdentity.Name (which will be something like &quot;myDomain\myUserName&quot;). So we you wanted to, we could have a simple step which evaluated if the calling user is on the &quot;approved&quot; / &quot;authorised&quot; list. I&#x27;m sure this could be made more sophisticated by using groups etc I guess - though I haven&#x27;t investigated it further as yet. In fact, I suspect Microsoft may have something even more sophisticated still available for use which I&#x27;m unaware of - if anyone knows a simple explanation of this then please do let me know! In closing, I do think Microsoft could work on providing more helpful error messages than &quot;the server has rejected the client credentials&quot;. Going by what I read as I researched this error many people seem to have struggled much as I did before eventually bailing out and ended up chancing it by turning security off in their applications. Clearly it is not desirable to have people so confused by errors that they give up and settle for a less secure solution.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/client-credential-type">clientCredentialType</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/security">Security</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/windows">Windows</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/wcf">WCF</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/authentication">Authentication</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/the-server-has-rejected-the-client-credentials">the server has rejected the client credentials</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/net-tcp-binding">NetTcpBinding</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about WCF Transport Windows authentication using NetTcpBinding in an Intranet environment" href="/2012/02/15/wcf-transport-windows-authentication"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.63119928.js"></script>
<script src="/assets/js/main.c1af33ba.js"></script>
</body>
</html>