<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">One post tagged with &quot;http requests&quot; | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="One post tagged with &quot;http requests&quot; | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/tags/http-requests"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-react-helmet="true" name="robots" content="max-image-preview:large"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/tags/http-requests"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/http-requests" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/http-requests" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ff16c2af.css">
<link rel="preload" href="/assets/js/runtime~main.16c33af7.js" as="script">
<link rel="preload" href="/assets/js/main.be0a0479.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog-archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://polywork.johnnyreilly.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Polywork<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/12/12/open-graph-sharing-previews-guide">Open Graph: a guide to sharable social media previews</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/12/05/azure-static-web-app-deploy-previews-with-azure-devops">Azure Static Web App Deploy Previews with Azure DevOps</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/22/typescript-vs-jsdoc-javascript">TypeScript vs JSDoc JavaScript</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/18/azure-standard-tests-with-bicep">Azure standard availability tests with Bicep</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/31/nswag-generated-c-sharp-client-property-name-clash">NSwag generated C# client: Open API property name clashes and decimal types rather than double</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>One post tagged with &quot;http requests&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2019/02/22/aspnet-core-allowlist-proxying-http-requests">ASP.NET Core: Proxying HTTP Requests with an AllowList</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2019-02-22T00:00:00.000Z" itemprop="datePublished">February 22, 2019</time> Â· <!-- -->7 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/blog/2019-02-22-aspnet-core-allowlist-proxying-http-requests/hang-on-lads-ive-got-a-great-idea.jpg"><div class="markdown" itemprop="articleBody"><p>This post demonstrates a mechanism for proxying HTTP requests in ASP.NET Core. It doesn&#x27;t proxy all requests; it only proxies requests that match entries on an &quot;allowlist&quot; - so we only proxy the traffic that we&#x27;ve actively decided is acceptable as determined by taking the form of an expected URL and HTTP verb (GET / POST etc).</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="why-do-we-need-to-proxy">Why do we need to proxy?<a aria-hidden="true" class="hash-link" href="#why-do-we-need-to-proxy" title="Direct link to heading">â€‹</a></h2><p>Once upon a time there lived a young team who were building a product. They were ready to go live with their beta and so they set off on a journey to a mystical land they had heard tales of. This magical kingdom was called &quot;Production&quot;. However, Production was a land with walls and but one gate. That gate was jealously guarded by a defender named &quot;InfoSec&quot;. InfoSec was there to make sure that only the the right people, noble of thought and pure of deed were allowed into the promised land. InfoSec would ask questions like &quot;are you serving over HTTPS&quot; and &quot;what are you doing about cross site scripting&quot;?</p><p>The team felt they had good answers to InfoSec&#x27;s questions. However, just as they were about to step through the gate, InfoSec held up their hand and said &quot;your application wants to access a database... database access needs to take place on our own internal network. Not over the publicly accessible internet.&quot;</p><p>The team, with one foot in the air, paused. They swallowed and said &quot;can you give us five minutes?&quot;</p><p><img alt="image taken from the end of the classic movie &amp;quot;The Italian Job&amp;quot; of the bus hanging half off a mountainside" src="/assets/images/hang-on-lads-ive-got-a-great-idea-d87277f50bf9435db73abbf57226631a.jpg"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="the-proxy-regroup">The Proxy Regroup<a aria-hidden="true" class="hash-link" href="#the-proxy-regroup" title="Direct link to heading">â€‹</a></h2><p>And so it came to pass that the teams product (which took the form of ASP.Net Core web application) had to be changed. Where once there had been a single application, there would now be two; one that lived on the internet (the <em>web</em> app) and one that lived on the companies private network (the <em>API</em> app). The API app would do all the database access. In fact the product team opted to move all significant operations into the API as well. This left the web app with two purposes:</p><ol><li>the straightforward serving of HTML, CSS, JS and images</li><li>the proxying of API calls through to the API app</li></ol><h2 class="anchor anchorWithStickyNavbar_31ik" id="proxy-part-1">Proxy Part 1<a aria-hidden="true" class="hash-link" href="#proxy-part-1" title="Direct link to heading">â€‹</a></h2><p>In the early days of this proxying the team reached for <a href="https://github.com/twitchax/AspNetCore.Proxy" target="_blank" rel="noopener noreferrer"><code>AspNetCore.Proxy</code></a>. It&#x27;s a great open source project that allows you to proxy HTTP requests. It gives you complete control over the construction of proxy requests, so that you can have a request come into your API and end up proxying it to a URL with a completely different path on the proxy server.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="proxy-part-2">Proxy Part 2<a aria-hidden="true" class="hash-link" href="#proxy-part-2" title="Direct link to heading">â€‹</a></h2><p>The approach offered by <code>AspNetCore.Proxy</code> is fantastically powerful in terms of control. However, we didn&#x27;t actually need that level of configurability. In fact, it resulted in us writing a great deal of boilerplate code. You see in our case we&#x27;d opted to proxy path for path, changing only the server name on each proxied request. So if a GET request came in going to <a href="https://web.app.com/api/version" target="_blank" rel="noopener noreferrer">https://web.app.com/api/version</a> then we would want to proxy it to a GET request to <a href="https://api.app.com/api/version" target="_blank" rel="noopener noreferrer">https://api.app.com/api/version</a>. You see? All we did was swap <a href="https://web.app.com" target="_blank" rel="noopener noreferrer">https://web.app.com</a> for <a href="https://api.app.com." target="_blank" rel="noopener noreferrer">https://api.app.com.</a> Nothing more. We did that as a rule. We knew we <em>always</em> wanted to do just this.</p><p>So we ended up spinning up our own solution which allowed just the specification of paths we wanted to proxy with their corresponding HTTP verbs. Let&#x27;s talk through it. Usage of our approach ended up as a middleware within our web app&#x27;s <code>Startup.cs</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">public void Configure(IApplicationBuilder app) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    app.UseProxyAllowList(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // where ServerToProxyToBaseUrl is the server you want requests to be proxied to</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // eg &quot;https://the-server-we-proxy-to&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        proxyAddressTweaker: (requestPath) =&gt; $&quot;{ServerToProxyToBaseUrl}{requestPath}&quot;,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        allowListProxyRoutes: new [] {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // An anonymous request</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            AllowListProxy.AnonymousRoute(&quot;api/version&quot;, HttpMethod.Get),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // An authenticated request; to send this we must know who the user is</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            AllowListProxy.Route(&quot;api/account/{accountId:int}/all-the-secret-info&quot;, HttpMethod.Get, HttpMethod.Post),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    app.UseMvc();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If you look at the code above you can see that we are proxing requests to a single server: <code>ServerToProxyToBaseUrl</code>. We&#x27;re also only proxying requests which match an entry on our allowlist (as represented by <code>allowListProxyRoutes</code>). So in this case we&#x27;re proxying two different requests:</p><ol><li><code>GET</code> requests to <code>api/version</code> are proxied through as <em>anonymous</em><code>GET</code> requests.</li><li><code>GET</code> and <code>POST</code> requests to <code>api/account/{accountId:int}/all-the-secret-info</code> are proxied through as <code>GET</code> and <code>POST</code> requests. These requests require that a user be authenticated first.</li></ol><p>The <code>AllowListProxy</code> proxy class we&#x27;ve been using looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Collections.Generic;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Net.Http;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace My.Web.Proxy {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class AllowListProxy {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public string Path { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IEnumerable&lt;HttpMethod&gt; Methods { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public bool IsAnonymous { get; set; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private AllowListProxy(string path, bool isAnonymous, params HttpMethod[] methods) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (methods == null || methods.Length == 0)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                throw new ArgumentException($&quot;You need at least a single HttpMethod to be specified for {path}&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Path = path;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            IsAnonymous = isAnonymous;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Methods = methods;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static AllowListProxy Route(string path, params HttpMethod[] methods) =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            new AllowListProxy(path, isAnonymous: false, methods: methods);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static AllowListProxy AnonymousRoute(string path, params HttpMethod[] methods) =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            new AllowListProxy(path, isAnonymous: true, methods: methods);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The middleware for proxying (our <code>UseProxyAllowList</code>) looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Collections.Generic;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.ComponentModel;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Linq;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Net.Http;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Reflection;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Threading.Tasks;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.AspNetCore.Authentication;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.AspNetCore.Builder;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.AspNetCore.Http;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.AspNetCore.Routing;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.DependencyModel;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.DependencyInjection;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Serilog;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace My.Web.Proxy {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static class ProxyRouteExtensions {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// Middleware which proxies the supplied allowlist routes</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static void UseProxyAllowList(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            this IApplicationBuilder app,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Func&lt;string, string&gt; proxyAddressTweaker,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Action&lt;HttpContext, HttpRequestMessage&gt; preSendProxyRequestAction,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            IEnumerable&lt;AllowListProxy&gt; allowListProxyRoutes</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        ) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            app.UseRouter(builder =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                foreach (var allowListProxy in allowListProxyRoutes) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    foreach (var method in allowListProxy.Methods) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        builder.MapMiddlewareVerb(method.ToString(), allowListProxy.Path, proxyApp =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                            proxyApp.UseProxy_Challenge(allowListProxy.IsAnonymous);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                            proxyApp.UseProxy_Run(proxyAddressTweaker, preSendProxyRequestAction);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private static void UseProxy_Challenge(this IApplicationBuilder app, bool allowAnonymous) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            app.Use((context, next) =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var routePath = context.Request.Path.Value;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var weAreAuthenticatedOrWeDontNeedToBe =</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    context.User.Identity.IsAuthenticated || allowAnonymous;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (weAreAuthenticatedOrWeDontNeedToBe)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    return next();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return context.ChallengeAsync();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private static void UseProxy_Run(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            this IApplicationBuilder app,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Func&lt;string, string&gt; proxyAddressTweaker,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Action&lt;HttpContext, HttpRequestMessage&gt; preSendProxyRequestAction</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            app.Run(async context =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var proxyAddress = &quot;&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    proxyAddress = proxyAddressTweaker(context.Request.Path.Value);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    var proxyRequest = context.Request.CreateProxyHttpRequest(proxyAddress);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    if (preSendProxyRequestAction != null)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        preSendProxyRequestAction(context, proxyRequest);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    var httpClients = context.RequestServices.GetService&lt;IHttpClients&gt;(); // IHttpClients is just a wrapper for HttpClient - insert your own here</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    var proxyResponse = await httpClients.SendRequestAsync(proxyRequest,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                            HttpCompletionOption.ResponseHeadersRead, context.RequestAborted)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        .ConfigureAwait(false);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    await context.CopyProxyHttpResponse(proxyResponse).ConfigureAwait(false);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                catch (OperationCanceledException ex) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    if (ex.CancellationToken.IsCancellationRequested)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        return;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    if (!context.Response.HasStarted)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        context.Response.StatusCode = 408;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        await context.Response</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                            .WriteAsync(&quot;Request timed out.&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                catch (Exception e) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    if (!context.Response.HasStarted)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        context.Response.StatusCode = 500;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        await context.Response</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                            .WriteAsync(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                                $&quot;Request could not be proxied.\n\n{e.Message}\n\n{e.StackTrace}.&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static void AddOrReplaceHeader(this HttpRequestMessage request, string headerName, string headerValue) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // It&#x27;s possible for there to be multiple headers with the same name; we only want a single header to remain.  Our one.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            while (request.Headers.TryGetValues(headerName, out var existingAuthorizationHeader)) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                request.Headers.Remove(headerName);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            request.Headers.TryAddWithoutValidation(headerName, headerValue);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static HttpRequestMessage CreateProxyHttpRequest(this HttpRequest request, string uriString) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var uri = new Uri(uriString + request.QueryString);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var requestMessage = new HttpRequestMessage();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var requestMethod = request.Method;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (!HttpMethods.IsGet(requestMethod) &amp;&amp;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                !HttpMethods.IsHead(requestMethod) &amp;&amp;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                !HttpMethods.IsDelete(requestMethod) &amp;&amp;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                !HttpMethods.IsTrace(requestMethod)) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var streamContent = new StreamContent(request.Body);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                requestMessage.Content = streamContent;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // Copy the request headers.</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (requestMessage.Content != null)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                foreach (var header in request.Headers)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    if (!requestMessage.Headers.TryAddWithoutValidation(header.Key, header.Value.ToArray()))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        requestMessage.Content?.Headers.TryAddWithoutValidation(header.Key, header.Value.ToArray());</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            requestMessage.Headers.Host = uri.Authority;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            requestMessage.RequestUri = uri;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            requestMessage.Method = new HttpMethod(request.Method);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return requestMessage;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static async Task CopyProxyHttpResponse(this HttpContext context, HttpResponseMessage responseMessage) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var response = context.Response;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            response.StatusCode = (int) responseMessage.StatusCode;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            foreach (var header in responseMessage.Headers) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                response.Headers[header.Key] = header.Value.ToArray();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (responseMessage.Content != null) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                foreach (var header in responseMessage.Content.Headers) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    response.Headers[header.Key] = header.Value.ToArray();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            response.Headers.Remove(&quot;transfer-encoding&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            using(var responseStream = await responseMessage.Content.ReadAsStreamAsync().ConfigureAwait(false)) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                await responseStream.CopyToAsync(response.Body, 81920, context.RequestAborted).ConfigureAwait(false);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This works out to be a flexible and simple approach to allowlist proxying.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/asp-net-core">asp net core</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/proxy">proxy</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/http-requests">http requests</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/allowlist">allowlist</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about ASP.NET Core: Proxying HTTP Requests with an AllowList" href="/2019/02/22/aspnet-core-allowlist-proxying-http-requests"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.16c33af7.js"></script>
<script src="/assets/js/main.be0a0479.js"></script>
</body>
</html>