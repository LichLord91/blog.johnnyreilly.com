<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">3 posts tagged with &quot;Easy Auth&quot; | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="3 posts tagged with &quot;Easy Auth&quot; | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/tags/easy-auth"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-react-helmet="true" name="robots" content="max-image-preview:large"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/tags/easy-auth"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/easy-auth" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/tags/easy-auth" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ff16c2af.css">
<link rel="preload" href="/assets/js/runtime~main.2cfd3172.js" as="script">
<link rel="preload" href="/assets/js/main.14ca547e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog-archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://polywork.johnnyreilly.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Polywork<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/12/05/azure-static-web-app-deploy-previews-with-azure-devops">Azure Static Web App Deploy Previews with Azure DevOps</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/22/typescript-vs-jsdoc-javascript">TypeScript vs JSDoc JavaScript</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/18/azure-standard-tests-with-bicep">Azure standard availability tests with Bicep</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/31/nswag-generated-c-sharp-client-property-name-clash">NSwag generated C# client: Open API property name clashes and decimal types rather than double</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/18/docusaurus-meta-tags-and-google-discover">Docusaurus, meta tags and Google Discover</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>3 posts tagged with &quot;Easy Auth&quot;</h1><a href="/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2021/02/27/goodbye-client-affinity-hello-data-protection-with-azure">Goodbye Client Affinity, Hello Data Protection with Azure</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-02-27T00:00:00.000Z" itemprop="datePublished">February 27, 2021</time> Â· <!-- -->4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/blog/2021-02-27-goodbye-client-affinity-hello-data-protection-with-azure/traffic-to-app-service.png"><div class="markdown" itemprop="articleBody"><p>I&#x27;ve written lately about <a href="/2021/02/11/azure-app-service-health-checks-and-zero-downtime-deployments">zero downtime releases with Azure App Service</a>. Zero downtime releases are only successful if your authentication mechanism survives a new deployment. We looked in my last post at <a href="/2021/02/16/easy-auth-tokens-survive-releases-on-linux-azure-app-service">how to achieve this with Azure&#x27;s in-built authentication mechanism; Easy Auth</a>.</p><p>We&#x27;re now going to look at how the same goal can be achieved if your ASP.NET application is authenticating another way. We achieve this through use of the <a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/overview" target="_blank" rel="noopener noreferrer">ASP.NET Data Protection</a> system. Andrew Lock has written <a href="https://andrewlock.net/an-introduction-to-the-data-protection-system-in-asp-net-core/" target="_blank" rel="noopener noreferrer">an excellent walkthrough on the topic</a> and I encourage you to read it.</p><p>We&#x27;re interested in the ASP.NET data-protection system because it encrypts and decrypts sensitive data including the authentication cookie. It&#x27;s wonderful that the data protection does this, but at the same time it presents a problem. We would like to route traffic to <em>multiple</em> instances of our applicationâ€¦ So traffic could go to instance 1, instance 2 of our app etc.</p><p><img alt="traffic to app service" src="/assets/images/traffic-to-app-service-0fb4d2ef97f99c82fd5fba1240824fb9.png"></p><p>How can we ensure the different instances of our app can read the authentication cookies regardless of the instance that produced them? How can we ensure that instance 1 can read cookies produced by instance 2 and vice versa? And for that matter, we&#x27;d like all instances to be able to read cookies whether they were produced by an instance in a production or staging slot.</p><p>We&#x27;re aiming to avoid the use of &quot;sticky sessions&quot; and ARRAffinity cookies. These ensure that traffic is continually routed to the same instance. Routing to the same instance explicitly prevents us from stopping routing traffic to an old instance and starting routing to a new one.</p><p>With the data protection activated and multiple instances of your app service you immediately face the issue that different instances of the app will be unable to read cookies they did not create. This is the default behaviour of data protection. <a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/web-farm?view=aspnetcore-5.0#data-protection" target="_blank" rel="noopener noreferrer">To quote the docs:</a></p><blockquote><p>Data Protection relies upon a set of cryptographic keys stored in a key ring. When the Data Protection system is initialized, it applies default settings that store the key ring locally. Under the default configuration, a unique key ring is stored on each node of the web farm. Consequently, each web farm node can&#x27;t decrypt data that&#x27;s encrypted by an app on any other node.</p></blockquote><p>The problem here is the data protection keys (the key ring) is being stored locally on each instance. What are the implications of this? Well, For example, instance 2 doesn&#x27;t have access to the keys instance 1 is using and so can&#x27;t decrypt instance 1 cookies.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="sharing-is-caring">Sharing is caring<a aria-hidden="true" class="hash-link" href="#sharing-is-caring" title="Direct link to heading">â€‹</a></h2><p>What we need to do is move away from storing keys locally, and to storing it in a <em>shared</em> place instead. We&#x27;re going to store data protection keys in Azure Blob Storage and protect the keys with Azure Key Vault:</p><p><img alt="persist keys to azure blob" src="/assets/images/data-protection-zero-downtime-d267eb88eafd479df49a359021e7f628.png"></p><p>All instances of the application can access the key ring and consequently sharing cookies is enabled. <a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/configuration/overview?view=aspnetcore-5.0#protectkeyswithazurekeyvault" target="_blank" rel="noopener noreferrer">As the documentation attests</a>, enabling this is fairly simple. It amounts to adding the following packages to your ASP.NET app:</p><ul><li><a href="https://www.nuget.org/packages/Azure.Extensions.AspNetCore.DataProtection.Blobs" target="_blank" rel="noopener noreferrer"><code>Azure.Extensions.AspNetCore.DataProtection.Blobs</code></a></li><li><a href="https://www.nuget.org/packages/Azure.Extensions.AspNetCore.DataProtection.Keys" target="_blank" rel="noopener noreferrer"><code>Azure.Extensions.AspNetCore.DataProtection.Keys</code></a></li></ul><p>And adding the following to the <code>ConfigureServices</code> in your ASP.NET app:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">services.AddDataProtection().SetApplicationName(&quot;OurWebApp&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // azure credentials require storage blob contributor role permissions</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // eg https://my-storage-account.blob.core.windows.net/keys/key</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        .PersistKeysToAzureBlobStorage(new Uri($&quot;https://{Configuration[&quot;StorageAccountName&quot;]}.blob.core.windows.net/keys/key&quot;), new DefaultAzureCredential())</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // azure credentials require key vault crypto role permissions</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // eg https://my-key-vault.vault.azure.net/keys/dataprotection</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        .ProtectKeysWithAzureKeyVault(new Uri($&quot;https://{Configuration[&quot;KeyVaultName&quot;]}.vault.azure.net/keys/dataprotection&quot;), new DefaultAzureCredential());</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In the above example you can see we&#x27;re passing the name of our Storage account and Key Vault via configuration.</p><p>There&#x27;s one more crucial piece of the puzzle here; and it&#x27;s role assignments, better known as permissions. Your App Service needs to be able to read and write to Azure Key Vault and the Azure Blob Storage. The permissions of <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#storage-blob-data-contributor" target="_blank" rel="noopener noreferrer">Storage Blob Data Contributor</a> and <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#key-vault-crypto-officer-preview" target="_blank" rel="noopener noreferrer">Key Vault Crypto Officer</a> are sufficient to enable this. (If you&#x27;d like to see what configuring that looks like via ARM templates then <a href="/2021/02/08/arm-templates-security-role-assignments">check out this post</a>.)</p><p>With this in place we&#x27;re able to route traffic to any instance of our application, secure in the knowledge that it will be able to read the cookies. Furthermore, we&#x27;ve enabled zero downtime releases as a direct consequence.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure">Azure</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/data-protection">Data Protection</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/easy-auth">Easy Auth</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/asp-net">ASP.NET</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/client-affinity">Client Affinity</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Goodbye Client Affinity, Hello Data Protection with Azure" href="/2021/02/27/goodbye-client-affinity-hello-data-protection-with-azure"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2021/02/16/easy-auth-tokens-survive-releases-on-linux-azure-app-service">Making Easy Auth tokens survive releases on Linux Azure App Service</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-02-16T00:00:00.000Z" itemprop="datePublished">February 16, 2021</time> Â· <!-- -->4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/blog/2021-02-16-easy-auth-tokens-survive-releases-on-linux-azure-app-service/easy-auth-zero-downtime-deployment.png"><div class="markdown" itemprop="articleBody"><p>I <a href="/2021/02/11/azure-app-service-health-checks-and-zero-downtime-deployments">wrote recently about zero downtime deployments on Azure App Service</a>. Many applications require authentication, and ours is no exception. In our case we&#x27;re using Azure Active Directory facilitated by <a href="https://docs.microsoft.com/en-us/azure/app-service/overview-authentication-authorization" target="_blank" rel="noopener noreferrer">&quot;Easy Auth&quot;</a> which provides authentication to our App Service.</p><p>Our app uses a Linux App Service. It&#x27;s worth knowing that Linux App Services run as a Docker container. As a consequence, Easy Auth works in a slightly different way; effectively as a middleware. <a href="https://docs.microsoft.com/en-us/azure/app-service/overview-authentication-authorization#on-containers" target="_blank" rel="noopener noreferrer">To quote the docs on Easy Auth</a>:</p><blockquote><p>This module handles several things for your app:</p><ul><li>Authenticates users with the specified provider</li><li>Validates, stores, and refreshes tokens</li><li>Manages the authenticated session</li><li>Injects identity information into request headers The module runs separately from your application code and is configured using app settings. No SDKs, specific languages, or changes to your application code are required.</li></ul><p>The authentication and authorization module runs in a separate container, isolated from your application code. Using what&#x27;s known as the <a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/ambassador" target="_blank" rel="noopener noreferrer">Ambassador</a> pattern, it interacts with the incoming traffic to perform similar functionality as on Windows.</p></blockquote><p>However, <a href="https://social.msdn.microsoft.com/Forums/en-US/dde551b2-c86d-474b-b0a6-cc66163785a1/restarting-azure-app-service-on-linux-with-azure-active-directory-authentication-resets-authme#b59951ab-623a-4442-a221-80c157387bbe" target="_blank" rel="noopener noreferrer">Microsoft have acknowledged there is a potential bug in Easy Auth support at present</a>. When the app service is restarted, the stored tokens are removed, and <strong>authentication begins to fail</strong>. As you might well imagine, authentication similarly starts to fail when a new app service is introduced - as is the case during deployment.</p><p>This is really significant. You may well have &quot;zero downtime deployment&quot;, but it doesn&#x27;t amount to a hill of beans if the moment you&#x27;ve deployed your users find they&#x27;re effectively logged out. <a href="https://social.msdn.microsoft.com/Forums/en-US/dde551b2-c86d-474b-b0a6-cc66163785a1/restarting-azure-app-service-on-linux-with-azure-active-directory-authentication-resets-authme#b59951ab-623a-4442-a221-80c157387bbe" target="_blank" rel="noopener noreferrer">The advice from Microsoft</a> is to use <a href="https://docs.microsoft.com/en-gb/archive/blogs/jpsanders/azure-app-service-authentication-using-a-blob-storage-for-token-cache" target="_blank" rel="noopener noreferrer">Blob Storage for Token Cache</a>:</p><p><a href="https://twitter.com/cgillum" target="_blank" rel="noopener noreferrer">Chris Gillum</a> said in a <a href="https://cgillum.tech/2016/03/07/app-service-token-store/" target="_blank" rel="noopener noreferrer">blog on the topic</a>:</p><blockquote><p>you can provision an Azure Blob Storage container and configure your web app with a SaS URL (with read/write/list access) pointing to that blob container. This SaS URL can then be saved to the <code>WEBSITE_AUTH_TOKEN_CONTAINER_SASURL</code> app setting. When this app setting is present, all tokens will be stored in and fetched from the specified blob container.</p></blockquote><p>To turn that into something visual, what&#x27;s suggested is this:</p><p><img alt="diagram of Easy Auth with blog storage" src="/assets/images/easy-auth-zero-downtime-deployment-504b87e27d28a69b4c10d7c085fd9fbc.png"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="sas-sy-arm-templates">SaS-sy ARM Templates<a aria-hidden="true" class="hash-link" href="#sas-sy-arm-templates" title="Direct link to heading">â€‹</a></h2><p>I have the good fortune to work with some very talented people. One of them, <a href="https://github.com/jmccor99" target="_blank" rel="noopener noreferrer">John McCormick</a> turned his hand to putting this proposed solution into <code>azure-pipelines.yml</code> and ARM template-land. First of all, let&#x27;s look at our <code>azure-pipelines.yml</code>. We add the following, prior to our deployment job:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yml"><pre tabindex="0" class="prism-code language-yml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> SASGen</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Generate SAS Token</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzurePowerShell@4</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ObtainSasTokenTask</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(serviceConnection)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">ScriptType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> inlineScript</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">Inline</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                $startTime = Get-Date</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                $expiryTime = $startTime.AddDays(90)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                $storageAcc = Get-AzStorageAccount -ResourceGroupName $(azureResourceGroup) -Name $(storageAccountName)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                $ctx = $storageAcc.Context</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                $sas = New-AzStorageContainerSASToken -Context $ctx -Name &quot;tokens&quot; -Permission &quot;rwl&quot; -Protocol HttpsOnly -StartTime $startTime -ExpiryTime $expiryTime -FullUri</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">                Write-Host &quot;##vso[task.setvariable variable=sasToken;issecret=true;isOutput=true]$sas&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">azurePowerShellVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;LatestVersion&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DeployAppARMTemplates</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">variables</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token key atrule">sasToken</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain">dependencies.SASGen.outputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;ObtainSasTokenTask.sasToken&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy App ARM Templates</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">dependsOn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> SASGen</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureResourceManagerTemplateDeployment@3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">service ARM Template</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">deploymentScope</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">azureResourceManagerConnection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(serviceConnection)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">subscriptionId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(subscriptionId)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Create Or Update Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(azureResourceGroup)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(location)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">templateLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Linked artifact</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">csmFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;infra/app-service/azuredeploy.json&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">csmParametersFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;infra/azuredeploy.parameters.json&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">overrideParameters</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">sasUrl $(sasToken)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              </span><span class="token key atrule">deploymentMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Incremental</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>There&#x27;s two notable things happening above:</p><ol><li>In the <code>SASGen</code> job, a PowerShell script runs that <a href="https://docs.microsoft.com/en-us/powershell/module/az.storage/new-azstoragecontainersastoken?view=azps-5.5.0" target="_blank" rel="noopener noreferrer">generates a SaS token URL</a> with read, write and list permissions that will last for 90 days. (Incidentally, there is a way to do this via <a href="https://stackoverflow.com/a/56127006/761388" target="_blank" rel="noopener noreferrer">ARM templates, and without PowerShell</a> <!-- -->-<!-- --> but alas it didn&#x27;t seem to work when we experimented with it.)</li><li>The generated (secret) token URL (<code>sasUrl</code>) is passed as a parameter to our App Service ARM template. The ARM template sets an appsetting for the app service:</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;apiVersion&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;2020-09-01&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;name&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;appsettings&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;config&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;properties&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;WEBSITE_AUTH_TOKEN_CONTAINER_SASURL&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;[parameters(&#x27;sasUrl&#x27;)]&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If you google <code>WEBSITE_AUTH_TOKEN_CONTAINER_SASURL</code> you will not find a geat deal. Documentation is short. What you will find is <a href="http://jsandersblog.azurewebsites.net/2017/08/10/azure-app-service-authentication-using-a-blob-storage-for-token-cache/" target="_blank" rel="noopener noreferrer">Jeff Sanders excellent blog on the topic</a>. It is, in terms of content, it has some commonality with this post; except in Jeff&#x27;s example he&#x27;s manually implementing the workaround in the Azure Portal.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="whats-actually-happening">What&#x27;s actually happening?<a aria-hidden="true" class="hash-link" href="#whats-actually-happening" title="Direct link to heading">â€‹</a></h2><p>With this in place, every time someone logs into your app a JSON token is written to the storage like so:</p><p><img alt="token in storage account" src="/assets/images/token-9f104a2188a359fa7cedaf8371d2963d.png"></p><p>If you take the trouble to look inside you&#x27;ll find something like this tucked away:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;encrypted&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;tokens&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;aad&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;herewith_a_very_very_long_encrypted_token&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;version&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>With this in place, you can safely restart your app service and / or deploy a new one, safe in the knowledge that the tokens will live on in the storage account, and that consequently you will not be unauthenticating users.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure">Azure</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/easy-auth">Easy Auth</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/tokens">tokens</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/sas">SAS</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/blob-storage">Blob Storage</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Making Easy Auth tokens survive releases on Linux Azure App Service" href="/2021/02/16/easy-auth-tokens-survive-releases-on-linux-azure-app-service"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2021/01/17/azure-easy-auth-and-roles-with-net-and-microsoft-identity-web">Azure Easy Auth and Roles with .NET and Microsoft.Identity.Web</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-01-17T00:00:00.000Z" itemprop="datePublished">January 17, 2021</time> Â· <!-- -->3 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="/2021/01/14/azure-easy-auth-and-roles-with-dotnet-and-core">I wrote recently about how to get Azure Easy Auth to work with roles</a>. This involved borrowing the approach used by <a href="https://github.com/MaximRouiller/MaximeRouiller.Azure.AppService.EasyAuth" target="_blank" rel="noopener noreferrer">MaximeRouiller.Azure.AppService.EasyAuth</a>.</p><p>As a consequence of writing that post I came to learn that official support for Azure Easy Auth had landed in October 2020 in v1.2 of <a href="https://github.com/AzureAD/microsoft-identity-web/wiki/1.2.0#integration-with-azure-app-services-authentication-of-web-apps-running-with-microsoftidentityweb" target="_blank" rel="noopener noreferrer">Microsoft.Identity.Web</a>. This was great news; I was delighted.</p><p>However, it turns out that the same authorization issue that <code>MaximeRouiller.Azure.AppService.EasyAuth</code> suffers from, is visited upon <code>Microsoft.Identity.Web</code> as well.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="getting-set-up">Getting set up<a aria-hidden="true" class="hash-link" href="#getting-set-up" title="Direct link to heading">â€‹</a></h2><p>We&#x27;re using a .NET 5 project, running in an Azure App Service (Linux). In our <code>.csproj</code> we have:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly xml"><pre tabindex="0" class="prism-code language-xml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">PackageReference</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">Microsoft.Identity.Web</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">1.4.1</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In our <code>Startup.cs</code> we&#x27;re using:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">public void ConfigureServices(IServiceCollection services) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    //...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    services.AddMicrosoftIdentityWebAppAuthentication(Configuration);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    //...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">public void Configure(IApplicationBuilder app, IWebHostEnvironment env) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    //...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    app.UseAuthentication();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    app.UseAuthorization();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    //...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="you-gotta-roles-with-it">You gotta <code>roles</code> with it<a aria-hidden="true" class="hash-link" href="#you-gotta-roles-with-it" title="Direct link to heading">â€‹</a></h2><p>Whilst the authentication works, authorization does not. So whilst my app knows who I am - the authorization is not working with relation to <strong>roles</strong>.</p><p>When directly using <code>Microsoft.Identity.Web</code> when running locally, we see these claims:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Administrator&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Reader&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>However, we get different behaviour with EasyAuth; it provides roles related claims with a <strong>different type</strong>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;roles&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Administrator&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;type&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;roles&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;Reader&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This means that roles related authorization <em>does not work</em> with Easy Auth:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">[Authorize(Roles = &quot;Reader&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">[HttpGet(&quot;api/reader&quot;)]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">public string GetWithReader() =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    &quot;this is a secure endpoint that users with the Reader role can access&quot;;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This is because .NET is looking for claims with a <code>type</code> of <code>&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</code> and not finding them with Easy Auth.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="claims-transformation-ftw">Claims transformation FTW<a aria-hidden="true" class="hash-link" href="#claims-transformation-ftw" title="Direct link to heading">â€‹</a></h2><p>There is a way to work around this issue .NET using <code>IClaimsTransformation</code>. This is a poorly documented feature, but fortunately <a href="https://gunnarpeipman.com/aspnet-core-adding-claims-to-existing-identity/" target="_blank" rel="noopener noreferrer">Gunnar Peipman&#x27;s blog does a grand job of explaining it</a>.</p><p>Inside our <code>Startup.cs</code> I&#x27;ve registered a claims transformer:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">services.AddScoped&lt;IClaimsTransformation, AddRolesClaimsTransformation&gt;();</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>And that claims transformer looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">public class AddRolesClaimsTransformation : IClaimsTransformation {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    private readonly ILogger&lt;AddRolesClaimsTransformation&gt; _logger;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public AddRolesClaimsTransformation(ILogger&lt;AddRolesClaimsTransformation&gt; logger) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        _logger = logger;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public Task&lt;ClaimsPrincipal&gt; TransformAsync(ClaimsPrincipal principal) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        var mappedRolesClaims = principal.Claims</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            .Where(claim =&gt; claim.Type == &quot;roles&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            .Select(claim =&gt; new Claim(ClaimTypes.Role, claim.Value))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            .ToList();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // Clone current identity</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        var clone = principal.Clone();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        if (clone.Identity is not ClaimsIdentity newIdentity) return Task.FromResult(principal);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // Add role claims to cloned identity</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        foreach (var mappedRoleClaim in mappedRolesClaims)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            newIdentity.AddClaim(mappedRoleClaim);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        if (mappedRolesClaims.Count &gt; 0)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _logger.LogInformation(&quot;Added roles claims {mappedRolesClaims}&quot;, mappedRolesClaims);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        else</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _logger.LogInformation(&quot;No roles claims added&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        return Task.FromResult(clone);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The class above creates a new principal with <code>&quot;roles&quot;</code> claims mapped across to <code>&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims/role&quot;</code>. This is enough to get .NET treating roles the way you&#x27;d hope.</p><p><a href="https://github.com/AzureAD/microsoft-identity-web/issues/881" target="_blank" rel="noopener noreferrer">I&#x27;ve raised an issue against the <code>Microsoft.Identity.Web</code> repo</a> about this. Perhaps one day this workaround will no longer be necessary.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure">Azure</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/easy-auth">Easy Auth</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/roles">Roles</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/asp-net">ASP.NET</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/microsoft-identity-web">Microsoft.Identity.Web</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Azure Easy Auth and Roles with .NET and Microsoft.Identity.Web" href="/2021/01/17/azure-easy-auth-and-roles-with-net-and-microsoft-identity-web"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.2cfd3172.js"></script>
<script src="/assets/js/main.14ca547e.js"></script>
</body>
</html>