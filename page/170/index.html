<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#3578e5">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">I CAN MAKE THIS WORK | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="I CAN MAKE THIS WORK | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-react-helmet="true" name="description" content="The blog of johnnyreilly"><meta data-react-helmet="true" property="og:description" content="The blog of johnnyreilly"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/page/170"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_posts_list"><meta data-react-helmet="true" name="robots" content="max-image-preview:large"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/page/170"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/page/170" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/page/170" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.58376e75.css">
<link rel="preload" href="/assets/js/runtime~main.699d7d58.js" as="script">
<link rel="preload" href="/assets/js/main.f167c9f1.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://polywork.johnnyreilly.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Polywork<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/12/19/azure-container-apps-bicep-and-github-actions">Azure Container Apps, Bicep and GitHub Actions</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/12/12/open-graph-sharing-previews-guide">Open Graph: a guide to sharable social media previews</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/12/05/azure-static-web-app-deploy-previews-with-azure-devops">Azure Static Web App Deploy Previews with Azure DevOps</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/22/typescript-vs-jsdoc-javascript">TypeScript vs JSDoc JavaScript</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/18/azure-standard-tests-with-bicep">Azure standard availability tests with Bicep</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2014/11/26/Coded-UI-IE-11-and-the-runas-problem">Pretending to be someone you&#x27;re not and the dark pit of despair</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2014-11-26T00:00:00.000Z" itemprop="datePublished">November 26, 2014</time> Â· <!-- -->11 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_31ik" id="coded-ui-ie-11-and-the-runas-problem"><sub>(Coded UI, IE 11 and the &quot;runas&quot; problem)</sub><a aria-hidden="true" class="hash-link" href="#coded-ui-ie-11-and-the-runas-problem" title="Direct link to heading">â€‹</a></h2><p>&quot;I&#x27;m not angry, I&#x27;m just disappointed.&quot;</p><p>That&#x27;s kind of how I feel about Coded UI tests. It may well be that you&#x27;ve never heard of them - in my experience very few people seem to be aware of them. What are they? Well, I&#x27;ve never used <a href="http://www.seleniumhq.org/" target="_blank" rel="noopener noreferrer">Selenium</a> but as best I understand Coded UI is Microsoft&#x27;s own version of that. Namely it&#x27;s a way to automate testing, in my case browser-based testing. You can write a suite of tests that will spin up your application and test it out, going from screen to screen, URL to URL and asserting all is as you would expect.</p><p>The project that I&#x27;m currently working on has a pretty comprehensive set of tests covering the use of the application. Each night as the clock strikes midnight a lonely computer in the West End of London whirrs into life and runs the full suite. It takes about 8 hours and at the end a report slips into your inbox letting you know of any failures.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="sounds-brilliant-right-how-could-someone-not-love-this">Sounds brilliant right? How could someone not love this?<a aria-hidden="true" class="hash-link" href="#sounds-brilliant-right-how-could-someone-not-love-this" title="Direct link to heading">â€‹</a></h2><p>Well a number of reasons. First of all, <em>it takes 8 hours</em>!!!! That&#x27;s a long time; I&#x27;d rather learn what I broke today rather than tomorrow.</p><p>Also, and this is probably more significant, Coded UI tests are pretty flaky. Let me qualify that. For a test to be particularly useful it has to be quick, repeatable and reliable. As I&#x27;ve said, Coded UI tests are not quick.</p><p>By their very nature integration tests (of which Coded UI tests are a type) can never be entirely reliably repeatable. They test your app in it&#x27;s entirety. So, for example, if a 3rd party service goes down for 5 minutes then you will get failed tests. You&#x27;ll burn time investigating these false positives.</p><p>Further to that, Coded UI tests are repeatable, except when they&#x27;re not. I&#x27;ve seen colleagues reduced to near tears by incredible sensitivity of Coded UI tests. Out of the box Coded UI tests appear to ship with the <a href="http://blog.codinghorror.com/the-works-on-my-machine-certification-program/" target="_blank" rel="noopener noreferrer">&quot;Works on my machine&quot;</a> guarantee. It requires far more effort that you&#x27;d expect to come up with tests that can be reliably expected to pass. They will fail for surprising reasons. For instance, did you know that using the 2.x branch of jQuery won&#x27;t work with Coded UI? <a href="https://connect.microsoft.com/VisualStudio/Feedback/Details/794841" target="_blank" rel="noopener noreferrer">Neither did I.</a> I&#x27;ve lost track of the time that has been wasted running the same test in multiple different environments trying to identify what exactly is upsetting Coded UI about the environment this time.</p><p>It is sad but true that with Coded UI tests you can spend an <em>enormous</em> amount of time maintaining the test pack on a day to day basis. As infrastructure and project dependencies are upgraded you will sadly discover Coded UI has once again gone into the foetal position and has to tempted back to normal functioning by whispering sweet nothings in it&#x27;s ear. (<em>&quot;It&#x27;s not true that they&#x27;ve ended support for Windows XP&quot; / &quot;IE 6 will live forever&quot;</em> and so on)</p><p>Coded UI also appears to be badly supported by Microsoft. Documentation is pretty sparse and, as we&#x27;ll come back to in a minute, Coded UI is sometimes broken or damaged by other products shipped by Microsoft. This makes it hard to have faith in Coded UI. Indeed, if you&#x27;re thinking of automating your QA testing my advice would be &quot;look into Selenium&quot;. Not because I&#x27;ve used it (I haven&#x27;t) but those I&#x27;ve met who have used Selenium and Coded UI say Selenium wins hands down.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="and-yet-and-yet">And yet, and yet...<a aria-hidden="true" class="hash-link" href="#and-yet-and-yet" title="Direct link to heading">â€‹</a></h2><p>All of the above said, if you have a Coded UI test suite it can still pay dividends. Significant dividends. As I mentioned, my current project has a significant coverage of Coded UI tests. We&#x27;ve crawled over a lot of broken glass to put these together. But now they&#x27;re there it is undeniably useful.</p><p>Every now and then we&#x27;ll do a significant refactor of part of the application. For instance, we&#x27;ve entirely changed our persistence strategy in the app but been able to check the code in with a high degree of confidence gleaned from running our test suite using the refactored codebase.</p><p>Let me be clear: Coded UI tests can be useful.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="the-runas-problem">The &quot;runas&quot; Problem<a aria-hidden="true" class="hash-link" href="#the-runas-problem" title="Direct link to heading">â€‹</a></h2><p>Long preamble over, this post is about how to work around the latest issue Coded UI has thrown in our direction. I call it the &quot;runas&quot; problem. Our application is a Knockout / ASP.Net MVC web app built to be used in an intranet environment. By that I mean that identity is handled by Active Directory / <a href="http://en.wikipedia.org/wiki/Integrated_Windows_Authentication" target="_blank" rel="noopener noreferrer">Windows Authentication</a>. When someone logs into our app we know who they are without them having to directly supply us with a username and password. No, by logging into their computer they have announced just who they are and Internet Explorer (for it is he) will pass along the credentials. (The app can be used with pretty much any browser but we&#x27;re only mandated to support IE 9+.)</p><p>In order that we can test the app we have a number of test accounts set up in Active Directory. These test accounts have been assigned various roles (viewer / editor / administrator etc). Our tests are designed to run using these accounts in order that all scenarios can be adequately tested.</p><p>To achieve this lofty goal the following code (or something very like it) is executed as the first step in any Coded UI test:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">string browserLocation = &quot;C:\\Program Files\\Internet Explorer\\iexplore.exe&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">string url = &quot;http://localhost:12345/&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">string username = &quot;test.editor&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">string domain = &quot;theDomain&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var password = new SecureString();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">foreach (char c in &quot;test.editor.password&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    password.AppendChar(c);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ApplicationUnderTest.Launch(browserLocation, null, url, username, password, domain);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>What this does is fire up Internet Explorer as the supplied user of theDomain\test.editor, and navigate to the home page. With that as our starting place we could dependably then run a test as this test user. This was a solution not without quirks (on occasion Coded UI tests would &quot;stutter&quot; - repeating each keypress 3 times with calamitous effects). But generally, this worked.</p><p>Until that is either Visual Studio 2013 Update 3 or Internet Explorer 11 was installed. One of these (and it appears to be hotly contested) broke the ability to run the above code successfully. After these were installed running the above code resulted in the following error message:</p><blockquote><p>&quot;The application cannot be started. This could be due to one of the following reasons:</p><ol><li>Another instance of the application is already running and only one instance can be running at a time.</li><li>The application started another process and has now stopped. You may need to launch the process directly.</li><li>You do not have sufficient privileges for this application.&quot; File: C:\Program Files\Internet Explorer\iexplore.exe.&quot;</li></ol></blockquote><p>Lamentably, this was pretty much unresolvable and <a href="https://connect.microsoft.com/VisualStudio/feedbackdetail/view/949049/coded-ui-cannot-run-as-a-different-user-with-visual-studio-2013-update-3" target="_blank" rel="noopener noreferrer">logging it with Microsoft yielded nothing helpful</a>. This is what I mean about Coded UI being badly supported by Microsoft. Despite my best efforts to report this issue both to Connect and <a href="http://social.msdn.microsoft.com/Forums/vstudio/en-US/f48665e4-569a-4b67-9bdb-5522b2adffb2/cannot-run-coded-ui-tests-as-different-user-on-windows-81?forum=vsmantest#28c9decb-b579-4848-a7a9-f41c57584d59" target="_blank" rel="noopener noreferrer">elsewhere</a> and in the end nothing useful happened.</p><p>So what to do? I still have Coded UI tests, I still need to be able to run them. And crucially I need to be able to run them impersonating a different user. What to do indeed....</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="the-hack">The <strike>hack</strike><a aria-hidden="true" class="hash-link" href="#the-hack" title="Direct link to heading">â€‹</a></h2><p>workaround</p><p>After IE 11 / Visual Studio Update 3 / whatev&#x27;s was installed I was left with a setup that allowed me to run Coded UI tests, <u>but only</u></p><p>as the current user. On that basis I started looking into a little MVC jiggery pokery. All my controllers inherit from a single base controller. Inside there I placed the following extra override:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">public abstract class BaseController : System.Web.Mvc.Controller</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  //...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  protected override void OnAuthorization(AuthorizationContext filterContext)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#if DEBUG</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    if (filterContext.HttpContext.IsDebuggingEnabled)// Is compilation debug=&quot;true&quot; set in the web.config?</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      var userToImpersonate = Session[&quot;UserToImpersonate&quot;] as string;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      if (!string.IsNullOrEmpty(userToImpersonate))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // userToImpersonate example: &quot;test.editor@theDomain.com&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        filterContext.HttpContext.User = new RolePrincipal(new WindowsIdentity(userToImpersonate));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      base.OnAuthorization(filterContext);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  //...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Each request will trigger this method as one of the first steps in the MVC pipeline. What it does is checks the <code>Session</code> for a user to impersonate. (Yes I&#x27;m as wary of Session as the next chap - but in this case it&#x27;s the right tool for the job.) If a user has been specified then it replaces the current user with the <code>Session</code> user. From this point forwards the app is effectively running as that user. That&#x27;s great!</p><p>In order that Coded UI can make use of this mechanism we need to introduce a &quot;hook&quot;. This is going to look a bit hacky - bear with me. Inside <code>Global.asax.cs</code> we&#x27;re going to add a <code>Session_Start</code> method:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">protected void Session_Start(object sender, EventArgs eventArgs)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#if DEBUG</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // If a user to impersonate has been supplied then add this user to the session</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // Impersonation will happen in the OnAuthorization method of our base MVC controller</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // Note, this is only allowed in debug mode - not in release mode</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    // This exists purely to support coded ui tests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    if (Context.IsDebuggingEnabled)  // Is compilation debug=&quot;true&quot; set in the web.config?</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        var userToImpersonate = Request.QueryString[&quot;UserToImpersonate&quot;] as string;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        if (!string.IsNullOrEmpty(userToImpersonate))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Session.Add(&quot;UserToImpersonate&quot;, userToImpersonate);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>For the first Request in a Session this checks the <code>QueryString</code> for a parameter called <code>UserToImpersonate</code>. If it&#x27;s found then it&#x27;s placed into <code>Session</code>. With this hook exposed we can now amend the first step that all our Coded UI tests follow:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">// Various lines commented out as doesn&#x27;t work with IE 11 - left as an example of how it could be done in the past</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">//string browserLocation = &quot;C:\\Program Files\\Internet Explorer\\iexplore.exe&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">string url = &quot;http://localhost:12345/&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">string username = &quot;test.editor&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">string domain = &quot;theDomain.com&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">//var password = new SecureString();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">//foreach (char c in &quot;test.editor.password&quot;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">//{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">//    password.AppendChar(c);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">//}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">//ApplicationUnderTest.Launch(browserLocation, null, url, username, password, domain);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Suffixing url with UrlToImpersonate which will be picked up in Session_Start and used to impersonate</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// in OnAuthorization in BaseController.  Also no longer using ApplicationUnderTest.Launch; switched to</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// BrowserWindow.Launch</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// No longer used parameters: browserLocation, password</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var userToImpersonate = username + &quot;@&quot; + domain; // eg &quot;test.editor@theDomain.com&quot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var urlWithUser = url + &quot;?UserToImpersonate=&quot; + HttpUtility.UrlEncode(userToImpersonate);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var browser = BrowserWindow.Launch(urlWithUser, &quot;-nomerge&quot;); // &quot;-nomerge&quot; flag forces a new session</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>As you can see we actually need less when we&#x27;re using this approach. We no longer need to directly specify the password or the browser location. And the user to impersonate is now passed in as the part of the initial URL used to launch the test.</p><p>Pay careful attention to the &quot;-nomerge&quot; flag that is passed in. This ensures that when another browser instance is opened a new session will be started. This is essential for &quot;multi-user&quot; tests that run tests for <em>different</em> users as part of the same test. It ensures that &quot;test.editor&quot; and &quot;test.different.editor&quot; can co-exist happily.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="what-do-i-think-of-the-workaround">What do I think of the workaround?<a aria-hidden="true" class="hash-link" href="#what-do-i-think-of-the-workaround" title="Direct link to heading">â€‹</a></h2><p>This approach works reliably and dependably. More so than the original approach which on occasion wouldn&#x27;t work or would &quot;stutter&quot; keypresses. That&#x27;s the good news.</p><p>The not so good news is that this approach is, in my view, a bit of hack. I want you to know that this isn&#x27;t my ideal.</p><p>I <em>really</em> don&#x27;t like having to change the actual system code to facilitate the impersonation requirement. Naturally we only ship the release and not the debug builds to Production so the &quot;back door&quot; that this approach provides will not exist in our Production builds. It will only be accessible in our development environments and on our Coded UI test server. But it feels oh so wrong that there is an effective potential back door in the system now. Well, only if the stars were to align in a really terrible (and admittedly rather unlikely) way. But still, you take my point. Caveat emptor and all that. This is something of a cutdown example to illustrate the point. If anyone else intends to use this then I&#x27;d suggest doing more to safeguard your approach. Implementing impersonation allowlists so &quot;any&quot; user cannot be impersonated would be a sensible precaution to start with.</p><p>Perhaps this is just one more reason that I&#x27;m not that enamoured of Coded UI. Once again it is useful but I&#x27;ve had to compromise more than I&#x27;d like to keep it&#x27;s use. If anyone out there has a better solution I would <em>love</em> to hear from you.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/ie-11">IE 11</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/runas">runas</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/coded-ui">Coded UI</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/nomerge">nomerge</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/internet-exporer">Internet Exporer</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/page/169"><div class="pagination-nav__label">Â«<!-- --> <!-- -->Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/page/171"><div class="pagination-nav__label">Older Entries<!-- --> <!-- -->Â»</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.699d7d58.js"></script>
<script src="/assets/js/main.f167c9f1.js"></script>
</body>
</html>