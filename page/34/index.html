<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">I CAN MAKE THIS WORK | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" property="og:title" content="I CAN MAKE THIS WORK | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" name="description" content="The blog of johnnyreilly"><meta data-react-helmet="true" property="og:description" content="The blog of johnnyreilly"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/page/34"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_posts_list"><meta data-react-helmet="true" name="robots" content="max-image-preview:large"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/page/34"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/page/34" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/page/34" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ff16c2af.css">
<link rel="preload" href="/assets/js/runtime~main.96a2f417.js" as="script">
<link rel="preload" href="/assets/js/main.189e1c42.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog-archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://polywork.johnnyreilly.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Polywork<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/22/typescript-vs-jsdoc-javascript">TypeScript vs JSDoc JavaScript</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/18/azure-standard-tests-with-bicep">Azure standard availability tests with Bicep</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/31/nswag-generated-c-sharp-client-property-name-clash">NSwag generated C# client: Open API property name clashes and decimal types rather than double</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/18/docusaurus-meta-tags-and-google-discover">Docusaurus, meta tags and Google Discover</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/15/structured-data-seo-and-react">Structured data, SEO and React</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/2021/01/30/aspnet-serilog-and-application-insights">ASP.NET, Serilog and Application Insights</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2021-01-30T00:00:00.000Z" itemprop="datePublished">January 30, 2021</time> Â· <!-- -->4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/blog/2021-01-30-aspnet-serilog-and-application-insights/application-insights-properties.png"><div class="markdown" itemprop="articleBody"><p>If you&#x27;re deploying an ASP.NET application to Azure App Services, there&#x27;s a decent chance you&#x27;ll also be using the fantastic <a href="https://serilog.net/" target="_blank" rel="noopener noreferrer">Serilog</a> and will want to plug it into Azure&#x27;s <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview" target="_blank" rel="noopener noreferrer">Application Insights</a>.</p><p>This post will show you how it&#x27;s done, and it&#x27;ll also build upon the <a href="/2021/01/29/surfacing-azure-pipelines-build-info-in-an-aspnet-react-app">build info work from our previous post</a>. In what way? Great question. Well logs are a tremendous diagnostic tool. If you have logs which display some curious behaviour, and you&#x27;d like to replicate that in another environment, you really want to take exactly that version of the codebase out to play. Our last post introduced build info into our application in the form of our <code>AppVersionInfo</code> class that looks something like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;buildNumber&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;20210130.1&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;buildId&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;123456&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;branchName&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;main&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token property" style="color:rgb(128, 203, 196)">&quot;commitHash&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;7089620222c30c1ad88e4b556c0a7908ddd34a8e&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We&#x27;d initially exposed an endpoint in our application which surfaced up this information. Now we&#x27;re going to take that self same information and bake it into our log messages by making use of <a href="https://github.com/serilog/serilog/wiki/Enrichment" target="_blank" rel="noopener noreferrer">Serilog&#x27;s enrichment functionality</a>. Build info and Serilog&#x27;s enrichment are the double act your logging has been waiting for.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="lets-plug-it-together">Let&#x27;s plug it together<a aria-hidden="true" class="hash-link" href="#lets-plug-it-together" title="Direct link to heading">â€‹</a></h2><p>We&#x27;re going to need a number of Serilog dependencies added to our <code>.csproj</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly xml"><pre tabindex="0" class="prism-code language-xml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">PackageReference</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">Serilog.AspNetCore</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">3.4.0</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">PackageReference</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">Serilog.Enrichers.Environment</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">2.1.3</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">PackageReference</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">Serilog.Enrichers.Thread</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">3.1.0</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">PackageReference</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">Serilog.Sinks.ApplicationInsights</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">3.1.0</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">PackageReference</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">Serilog.Sinks.Async</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">1.4.0</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The earlier in your application lifetime you get logging wired up, the happier you will be. Earlier, means more information when you&#x27;re diagnosing issues. So we want to start in our <code>Program.cs</code>; <code>Startup.cs</code> would be just <em>way</em> too late.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">public class Program {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    const string APP_NAME = &quot;MyAmazingApp&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static int Main(string[] args) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        AppVersionInfo.InitialiseBuildInfoGivenPath(Directory.GetCurrentDirectory());</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        LoggerConfigurationExtensions.SetupLoggerConfiguration(APP_NAME, AppVersionInfo.GetBuildInfo());</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        try</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Log.Information(&quot;Starting web host&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            CreateHostBuilder(args).Build().Run();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return 0;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        catch (Exception ex)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Log.Fatal(ex, &quot;Host terminated unexpectedly&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return 1;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        finally</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Log.CloseAndFlush();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static IHostBuilder CreateHostBuilder(string[] args) =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        Host.CreateDefaultBuilder(args)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            .UseSerilog((hostBuilderContext, services, loggerConfiguration) =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                loggerConfiguration.ConfigureBaseLogging(APP_NAME, AppVersionInfo.GetBuildInfo());</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                loggerConfiguration.AddApplicationInsightsLogging(services, hostBuilderContext.Configuration);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            })</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            .ConfigureWebHostDefaults(webBuilder =&gt; {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                webBuilder</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    .UseStartup&lt;Startup&gt;();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If you look at the code above you&#x27;ll see that the first line of code that executes is <code>AppVersionInfo.InitialiseBuildInfoGivenPath</code>. This initialises our <code>AppVersionInfo</code> so we have meaningful build info to pump into our logs. The next thing we do is to configure Serilog with <code>LoggerConfigurationExtensions.SetupLoggerConfiguration</code>. This provides us with a configured logger so we are free to log any issues that take place during startup. (Incidentally, after startup you&#x27;ll likely inject an <code>ILogger</code> into your classes rather than using the static <code>Log</code> directly.)</p><p>Finally, we call <code>CreateHostBuilder</code> which in turn calls <code>UseSerilog</code> to plug Serilog into ASP.NET. If you take a look inside the body of <code>UseSerilog</code> you&#x27;ll see we configure the logging of ASP.NET (in the same way we did for Serilog) and we hook into Application Insights as well. There&#x27;s been a number of references to <code>LoggerConfigurationExtensions</code>. Let&#x27;s take a look at it:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">internal static class LoggerConfigurationExtensions {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    internal static void SetupLoggerConfiguration(string appName, BuildInfo buildInfo) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        Log.Logger = new LoggerConfiguration()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            .ConfigureBaseLogging(appName, buildInfo)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            .CreateLogger();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    internal static LoggerConfiguration ConfigureBaseLogging(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        this LoggerConfiguration loggerConfiguration,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        string appName,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        BuildInfo buildInfo</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    ) {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        loggerConfiguration</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            .MinimumLevel.Debug()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            .MinimumLevel.Override(&quot;Microsoft&quot;, LogEventLevel.Information)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // AMAZING COLOURS IN THE CONSOLE!!!!</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            .WriteTo.Async(a =&gt; a.Console(theme: AnsiConsoleTheme.Code))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            .Enrich.FromLogContext()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            .Enrich.WithMachineName()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            .Enrich.WithThreadId()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // Build information as custom properties</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            .Enrich.WithProperty(nameof(buildInfo.BuildId), buildInfo.BuildId)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            .Enrich.WithProperty(nameof(buildInfo.BuildNumber), buildInfo.BuildNumber)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            .Enrich.WithProperty(nameof(buildInfo.BranchName), buildInfo.BranchName)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            .Enrich.WithProperty(nameof(buildInfo.CommitHash), buildInfo.CommitHash)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            .Enrich.WithProperty(&quot;ApplicationName&quot;, appName);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        return loggerConfiguration;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    internal static LoggerConfiguration AddApplicationInsightsLogging(this LoggerConfiguration loggerConfiguration, IServiceProvider services, IConfiguration configuration)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        if (!string.IsNullOrWhiteSpace(configuration.GetValue&lt;string&gt;(&quot;APPINSIGHTS_INSTRUMENTATIONKEY&quot;)))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            loggerConfiguration.WriteTo.ApplicationInsights(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                services.GetRequiredService&lt;TelemetryConfiguration&gt;(),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                TelemetryConverter.Traces);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        return loggerConfiguration;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If we take a look at the <code>ConfigureBaseLogging</code> method above, we can see that our logs are being enriched with the build info, property by property. We&#x27;re also giving ourselves a beautifully coloured console thanks to Serilog&#x27;s glorious <a href="https://github.com/serilog/serilog-sinks-console#themes" target="_blank" rel="noopener noreferrer">theme support</a>:</p><p><img alt="screenshot of the console featuring coloured output" src="/assets/images/coloured-console-3892238b0e9a0355da8015effe4544d5.png"></p><p>Take a moment to admire the salmon pinks. Is it not lovely?</p><p>Finally we come to the main act. Plugging in Application Insights is as simple as dropping in <code>loggerConfiguration.WriteTo.ApplicationInsights</code> into our configuration. You&#x27;ll note that this depends upon the existence of an application setting of <code>APPINSIGHTS_INSTRUMENTATIONKEY</code> - this is the secret sauce that we need to be in place so we can pipe logs merrily to Application Insights. So you&#x27;ll need this configuration in place so this works.</p><p><img alt="screenshot of application insights with our output" src="/assets/images/application-insights-properties-c84e0ad0dbfa43565e738f78f016dbba.png"></p><p>As you can see, we now have the likes of <code>BuildNumber</code>, <code>CommitHash</code> and friends visible on each log. Happy diagnostic days!</p><p>I&#x27;m indebted to the marvellous <a href="https://twitter.com/MarcelMichau" target="_blank" rel="noopener noreferrer">Marcel Michau</a> who showed me how to get the fiddlier parts of how to get Application Insights plugged in the right way. Thanks chap!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/asp-net">asp.net</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure">Azure</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/application-insights">Application Insights</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/serilog">Serilog</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/page/33"><div class="pagination-nav__label">Â«<!-- --> <!-- -->Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/page/35"><div class="pagination-nav__label">Older Entries<!-- --> <!-- -->Â»</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.96a2f417.js"></script>
<script src="/assets/js/main.189e1c42.js"></script>
</body>
</html>