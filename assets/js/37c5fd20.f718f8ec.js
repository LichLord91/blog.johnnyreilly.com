"use strict";(self.webpackChunkjohnnyreilly_com=self.webpackChunkjohnnyreilly_com||[]).push([[68870],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var r=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},p=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},h="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),h=c(n),u=o,m=h["".concat(l,".").concat(u)]||h[u]||d[u]||i;return n?r.createElement(m,a(a({ref:t},p),{},{components:n})):r.createElement(m,a({ref:t},p))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,a=new Array(i);a[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[h]="string"==typeof e?e:o,a[1]=s;for(var c=2;c<i;c++)a[c]=n[c];return r.createElement.apply(null,a)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},68956:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>d,frontMatter:()=>a,metadata:()=>l,toc:()=>p});n(67294);var r=n(3905);function o(){return o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},o.apply(this,arguments)}function i(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}const a={slug:"license-to-kill-your-pwa",title:"LICENSE to kill your PWA",authors:"johnnyreilly",tags:[],hide_table_of_contents:!1},s=void 0,l={permalink:"/license-to-kill-your-pwa",editUrl:"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2020-01-21-license-to-kill-your-pwa/index.md",source:"@site/blog/2020-01-21-license-to-kill-your-pwa/index.md",title:"LICENSE to kill your PWA",description:"Update: 26/01/2020 - LICENSE to kill revoked!",date:"2020-01-21T00:00:00.000Z",formattedDate:"January 21, 2020",tags:[],readingTime:3.81,hasTruncateMarker:!0,authors:[{name:"John Reilly",title:"OSS Engineer - TypeScript, Azure, React, Node.js, .NET",url:"https://johnnyreilly.com/about",imageURL:"https://johnnyreilly.com/img/profile.jpg",key:"johnnyreilly"}],frontMatter:{slug:"license-to-kill-your-pwa",title:"LICENSE to kill your PWA",authors:"johnnyreilly",tags:[],hide_table_of_contents:!1},prevItem:{title:"From create-react-app to PWA",permalink:"/from-create-react-app-to-pwa"},nextItem:{title:"EF Core 3.1 breaks left join with no navigation property",permalink:"/ef-core-31-breaks-left-join-with-no-navigation-property"}},c={authorsImageUrls:[void 0]},p=[{value:"Update: 26/01/2020 - LICENSE to kill revoked!",id:"update-26012020---license-to-kill-revoked",level:2},{value:"The tragedy",id:"the-tragedy",level:2},{value:"The mystery",id:"the-mystery",level:2},{value:"The investigation",id:"the-investigation",level:2},{value:"The resolution",id:"the-resolution",level:2}],h={toc:p};function d(e){var{components:t}=e,a=i(e,["components"]);return(0,r.kt)("wrapper",o({},h,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",o({},{id:"update-26012020---license-to-kill-revoked"}),"Update: 26/01/2020 - LICENSE to kill revoked!"),(0,r.kt)("p",null,"Following the original publication of this post I received this tweet suggesting we should change the behaviour of the underlying ",(0,r.kt)("inlineCode",{parentName:"p"},"terser-webpack-plugin"),":"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Send a PR to change the name to .LICENSE.txt by default."),(0,r.kt)("p",{parentName:"blockquote"},"\u2014 Tobias Koppers (@wSokra) ",(0,r.kt)("a",o({parentName:"p"},{href:"https://twitter.com/wSokra/status/1220069497660411904?ref_src=twsrc%5Etfw"}),"January 22, 2020"))),(0,r.kt)("script",{async:"",src:"https://platform.twitter.com/widgets.js",charSet:"utf-8"}),(0,r.kt)("p",null,"That seemed like an excellent idea! I raised ",(0,r.kt)("a",o({parentName:"p"},{href:"https://github.com/webpack-contrib/terser-webpack-plugin/pull/210"}),"this PR")," which changes the behaviour such that instead of ",(0,r.kt)("inlineCode",{parentName:"p"},".LICENSE")," files being produced, ",(0,r.kt)("inlineCode",{parentName:"p"},".LICENSE.txt")," files are pumped out instead. Crucially they are IIS (and other servers) friendly. The great news is that future users of webpack / create-react-app etc will not face this problem at all; result!"),(0,r.kt)("h2",o({},{id:"the-tragedy"}),"The tragedy"),(0,r.kt)("p",null,"Recently my beloved PWA died. I didn't realise it at first. It wasn't until a week or so after the tragedy that I realised he'd gone. In his place was the stale memory of service workers gone by. Last week's code; cached and repeatedly served up to a disappointed audience. Terrible news."),(0,r.kt)("p",null,"What had happened? What indeed. The problem was quirky and (now that I know the answer) I'm going to share it with you. Because it's entirely non-obvious."),(0,r.kt)("h2",o({},{id:"the-mystery"}),"The mystery"),(0,r.kt)("p",null,"Once I realised that I was repeatedly being served up an old version of my PWA, I got to wondering.... Why? What's happening? What's wrong? What did I do? I felt bad. I stared at the ceiling. I sighed and opened my Chrome devtools. With no small amount of sadness I went to the ",(0,r.kt)("inlineCode",{parentName:"p"},"Application")," tab, hit ",(0,r.kt)("inlineCode",{parentName:"p"},"Service Workers")," and then ",(0,r.kt)("inlineCode",{parentName:"p"},"Unregister"),"."),(0,r.kt)("p",null,"Then I hit refresh and took a look at console. I saw this:"),(0,r.kt)("p",null,(0,r.kt)("img",{loading:"eager",fetchpriority:"high",src:n(4543).Z,width:"640",height:"32"})),(0,r.kt)("p",null,'What does this mean? Something about a "bad-precaching-response". And apparently this was happening whilst trying to load this resource: ',(0,r.kt)("inlineCode",{parentName:"p"},"/static/js/6.20102e99.chunk.js.LICENSE?__WB_REVISION__=e2fc36")),(0,r.kt)("p",null,"This ",(0,r.kt)("inlineCode",{parentName:"p"},"404")," was preventing pre-caching from executing successfully. This was what was killing my PWA. This was the perpetrator. How to fix this? Read on!"),(0,r.kt)("h2",o({},{id:"the-investigation"}),"The investigation"),(0,r.kt)("p",null,"Time to find out what's going on. I dropped that URL into my browser to see what would happen. ",(0,r.kt)("inlineCode",{parentName:"p"},"404")," city man:"),(0,r.kt)("p",null,(0,r.kt)("img",{loading:"lazy",src:n(40204).Z,width:"400",height:"233"})),(0,r.kt)("p",null,"So, to disk. I took a look at what was actually on the server in that location. Sure enough, the file existed. When I opened it up I found this:"),(0,r.kt)("pre",null,(0,r.kt)("code",o({parentName:"pre"},{className:"language-js"}),"/**\n * A better abstraction over CSS.\n *\n * @copyright Oleg Isonen (Slobodskoi) / Isonen 2014-present\n * @website https://github.com/cssinjs/jss\n * @license MIT\n */\n\n/*\nobject-assign\n(c) Sindre Sorhus\n@license MIT\n*/\n\n/** @license React v16.12.0\n * react.production.min.js\n *\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\n/** @license React v16.12.0\n * react-dom.production.min.js\n *\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\n/** @license React v0.18.0\n * scheduler.production.min.js\n *\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\n/** @license React v16.12.0\n * react-is.production.min.js\n *\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n")),(0,r.kt)("p",null,"What is this? Well, as the name of the file suggests, it's licenses. For some reason, my build was scraping the licenses from the head of some of my files and placing them in a separate ",(0,r.kt)("inlineCode",{parentName:"p"},"6.20102e99.chunk.js.LICENSE")," file. Doing some more digging I happened upon ",(0,r.kt)("a",o({parentName:"p"},{href:"https://github.com/facebook/create-react-app/issues/6441"}),"this discussion against the ",(0,r.kt)("inlineCode",{parentName:"a"},"create-react-app"))," project. It's worth saying, that my PWA was an ejected ",(0,r.kt)("inlineCode",{parentName:"p"},"create-react-app")," project."),(0,r.kt)("p",null,"It turned out the the issue was related to the ",(0,r.kt)("a",o({parentName:"p"},{href:"https://github.com/webpack-contrib/terser-webpack-plugin"}),(0,r.kt)("inlineCode",{parentName:"a"},"terser-webpack-plugin")),". The default behaviour performs this kind of license file extraction. The app was being served by an IIS server and it wasn't configured to support the ",(0,r.kt)("inlineCode",{parentName:"p"},".LICENSE")," file type."),(0,r.kt)("h2",o({},{id:"the-resolution"}),"The resolution"),(0,r.kt)("p",null,"The simplest solution was simply this: wave goodbye to ",(0,r.kt)("inlineCode",{parentName:"p"},"LICENSE")," files. If you haven't ejected from your ",(0,r.kt)("inlineCode",{parentName:"p"},"create-react-app")," then this might be a problem. But since I had, I was able to make this tweak to the terser settings in the ",(0,r.kt)("inlineCode",{parentName:"p"},"webpack.config.js"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",o({parentName:"pre"},{className:"language-js"}),"new TerserPlugin({\n    /* TURN OFF LICENSE FILES - SEE https://github.com/facebook/create-react-app/issues/6441 */\n    extractComments: false,\n    /* TURN OFF LICENSE FILES - Tweak by John Reilly */\n    terserOptions: {\n        // ....\n")),(0,r.kt)("p",null,"And with this we say goodbye to our ",(0,r.kt)("inlineCode",{parentName:"p"},"404"),"s and hello to a resurrected PWA!"))}d.isMDXComponent=!0},4543:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/LICENSE-cannot-be-cached-cdad74cbc2bb62a0b33f523c5f81c5e6.webp"},40204:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/LICENSE-file-screwing-me-over-7850432a918679c3d1ff5ad3d684b683.webp"}}]);