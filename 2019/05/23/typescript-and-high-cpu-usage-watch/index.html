<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=297675200"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","297675200",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="I CAN MAKE THIS WORK" href="/opensearch.xml">
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#3578e5">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">TypeScript and high CPU usage - watch don&#x27;t stare! | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.jpg"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/2019/05/23/typescript-and-high-cpu-usage-watch"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><meta data-react-helmet="true" name="robots" content="max-image-preview:large"><meta data-react-helmet="true" property="og:title" content="TypeScript and high CPU usage - watch don&#x27;t stare! | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="description" content="I&#x27;m one of the maintainers of the fork-ts-checker-webpack-plugin. Hi there!"><meta data-react-helmet="true" property="og:description" content="I&#x27;m one of the maintainers of the fork-ts-checker-webpack-plugin. Hi there!"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2019-05-23T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://twitter.com/johnny_reilly"><meta data-react-helmet="true" property="article:tag" content="cross-env,TypeScript,fork-ts-checker-webpack-plugin,watch API,Webpack"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/2019/05/23/typescript-and-high-cpu-usage-watch"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/2019/05/23/typescript-and-high-cpu-usage-watch" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/2019/05/23/typescript-and-high-cpu-usage-watch" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://J3MYR1INLT-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.03530969.css">
<link rel="preload" href="/assets/js/runtime~main.905556d5.js" as="script">
<link rel="preload" href="/assets/js/main.f568d319.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://polywork.johnnyreilly.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Polywork<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/02/02/lazy-loading-images-with-docusaurus">Lazy loading images with Docusaurus</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/02/01/migrating-from-github-pages-to-azure-static-web-apps">Migrating from GitHub Pages to Azure Static Web Apps</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2022/01/22/azure-container-apps-dapr-bicep-github-actions-debug-devcontainer">Azure Container Apps: dapr, devcontainer, debug and deploy</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2021/12/29/preload-fonts-with-docusaurus">Preload fonts with Docusaurus</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/2021/12/28/azure-cli-show-query-output-properties">Query deployment outputs with the Azure CLI</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">TypeScript and high CPU usage - watch don&#x27;t stare!</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2019-05-23T00:00:00.000Z" itemprop="datePublished">May 23, 2019</time> Â· <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>I&#x27;m one of the maintainers of the <a href="https://github.com/Realytics/fork-ts-checker-webpack-plugin" target="_blank" rel="noopener noreferrer">fork-ts-checker-webpack-plugin</a>. Hi there!</p><p>Recently, various issues have been raised against create-react-app (which uses fork-ts-checker-webpack-plugin) as well as against the plugin itself. They&#x27;ve been related to the level of CPU usage in watch mode on idle; i.e. it&#x27;s high!</p><ul><li><a href="https://github.com/Realytics/fork-ts-checker-webpack-plugin/issues/236" target="_blank" rel="noopener noreferrer">https://github.com/Realytics/fork-ts-checker-webpack-plugin/issues/236</a></li><li><a href="https://github.com/facebook/create-react-app/issues/6792" target="_blank" rel="noopener noreferrer">https://github.com/facebook/create-react-app/issues/6792</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="why-high">Why High?<a class="hash-link" href="#why-high" title="Direct link to heading">â€‹</a></h2><p>Now, under the covers, the <code>fork-ts-checker-webpack-plugin</code> uses the TypeScript watch API.</p><p>The marvellous <a href="https://github.com/NeKJ" target="_blank" rel="noopener noreferrer">John</a> (not me - another John) did some digging and discovered the root cause came down to the way that the TypeScript watch API watches files:</p><blockquote><p>TS uses internally the <code>fs.watch</code> and <code>fs.watchFile</code> API functions of nodejs for their watch mode. The latter function <a href="https://nodejs.org/api/fs.html#fs_fs_watchfile_filename_options_listener" target="_blank" rel="noopener noreferrer">is even not recommended by nodejs documentation</a> for performance reasons, and urges to use <code>fs.watch</code> instead.</p><p><strong>NodeJS doc:</strong></p><blockquote><p>Using fs.watch() is more efficient than fs.watchFile and fs.unwatchFile. fs.watch should be used instead of fs.watchFile and fs.unwatchFile when possible.</p></blockquote></blockquote><h2 class="anchor anchorWithStickyNavbar_mojV" id="there-is-another">&quot;there is another&quot;<a class="hash-link" href="#there-is-another" title="Direct link to heading">â€‹</a></h2><p>John also found that there are other file watching behaviours offered by TypeScript. What&#x27;s more, the file watching behaviour is <em>configurable with an environment variable</em>. That&#x27;s right, if an environment variable called <code>TSC_WATCHFILE</code> is set, it controls the file watching approach used. Big news!</p><p>John did some rough benchmarking of the performance of the different options that be set on his PC running linux 64 bit. Here&#x27;s how it came out:</p><table><thead><tr><th>Value</th><th>CPU usage on idle</th></tr></thead><tbody><tr><td>TS default <em>(TSC_WATCHFILE not set)</em></td><td><strong>7<!-- -->.<!-- -->4%</strong></td></tr><tr><td>UseFsEventsWithFallbackDynamicPolling</td><td>0<!-- -->.<!-- -->2%</td></tr><tr><td>UseFsEventsOnParentDirectory</td><td>0<!-- -->.<!-- -->2%</td></tr><tr><td>PriorityPollingInterval</td><td><strong>6<!-- -->.<!-- -->2%</strong></td></tr><tr><td>DynamicPriorityPolling</td><td>0<!-- -->.<!-- -->5%</td></tr><tr><td>UseFsEvents</td><td>0<!-- -->.<!-- -->2%</td></tr></tbody></table><p>As you can see, the default performs poorly. On the other hand, an option like <code>UseFsEventsWithFallbackDynamicPolling</code> is comparative greasy lightning.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="workaround">workaround!<a class="hash-link" href="#workaround" title="Direct link to heading">â€‹</a></h2><p>To get this better experience into your world now, you could just set an environment variable on your machine. However, that doesn&#x27;t scale; let&#x27;s instead look at introducing the environment variable into your project explicitly.</p><p>We&#x27;re going to do this in a cross platform way using <code>&lt;a href=&quot;https://github.com/kentcdodds/cross-env&quot;&gt;cross-env&lt;/a&gt;</code>. This is a mighty useful utility by Kent C Dodds which allows you to set environment variables in a way that will work on Windows, Mac and Linux. Imagine it as the jQuery of the environment variables world :-)</p><p>Let&#x27;s add it as a <code>devDependency</code>:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">yarn add -D cross-env</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Then take a look at your <code>package.json</code>. You&#x27;ve probably got a <code>start</code> script that looks something like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">&quot;start&quot;: &quot;webpack-dev-server --progress --color --mode development --config webpack.config.development.js&quot;,</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Or if you&#x27;re a create-react-app user maybe this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">&quot;start&quot;: &quot;react-scripts start&quot;,</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Prefix your <code>start</code> script with <code>cross-env TSC_WATCHFILE=UseFsEventsWithFallbackDynamicPolling</code>. This will, when run, initialise an environment variable called <code>TSC_WATCHFILE</code> with the value <code>UseFsEventsWithFallbackDynamicPolling</code>. Then it will start your development server as it did before. When TypeScript is fired up by webpack it will see this environment variable and use it to configure the file watching behaviour to one of the more performant options.</p><p>So, in the case of a <code>create-react-app</code> user, your finished <code>start</code> script would look like this:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#d6deeb"><span class="token plain">&quot;start&quot;: &quot;cross-env TSC_WATCHFILE=UseFsEventsWithFallbackDynamicPolling react-scripts start&quot;,</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-future">The Future<a class="hash-link" href="#the-future" title="Direct link to heading">â€‹</a></h2><p>There&#x27;s a possibility that the default watch behaviour may change in TypeScript in future. It&#x27;s currently under discussion, you can read more <a href="https://github.com/microsoft/TypeScript/issues/31048" target="_blank" rel="noopener noreferrer">here</a>.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cross-env">cross-env</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/type-script">TypeScript</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/fork-ts-checker-webpack-plugin">fork-ts-checker-webpack-plugin</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/watch-api">watch API</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/webpack">Webpack</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/blog/2019-05-23-typescript-and-high-cpu-usage-watch/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/2019/06/07/typescript-webpack-you-down-with-pnp"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">TypeScript / webpack - you down with PnP? Yarn, you know me!</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/2019/04/27/react-select-with-less-typing-lag"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">react-select with less typing lag</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#why-high" class="table-of-contents__link toc-highlight">Why High?</a></li><li><a href="#there-is-another" class="table-of-contents__link toc-highlight">&quot;there is another&quot;</a></li><li><a href="#workaround" class="table-of-contents__link toc-highlight">workaround!</a></li><li><a href="#the-future" class="table-of-contents__link toc-highlight">The Future</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" rel="noopener" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" loading="lazy" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.905556d5.js"></script>
<script src="/assets/js/main.f568d319.js"></script>
</body>
</html>