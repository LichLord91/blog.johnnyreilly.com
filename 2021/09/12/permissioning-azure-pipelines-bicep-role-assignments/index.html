<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">Permissioning Azure Pipelines with Bicep and Azure RBAC Role Assignments | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/2021/09/12/permissioning-azure-pipelines-bicep-role-assignments"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" name="robots" content="max-image-preview:large"><meta data-react-helmet="true" property="og:title" content="Permissioning Azure Pipelines with Bicep and Azure RBAC Role Assignments | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="description" content="How can we deploy resources to Azure, and then run an integration test through them in the context of an Azure Pipeline? This post will show how to do this by permissioning our Azure Pipeline to access these resources using Azure RBAC role assignments. It will also demonstrate a dotnet test that runs in the context of the pipeline and makes use of those role assignments."><meta data-react-helmet="true" property="og:description" content="How can we deploy resources to Azure, and then run an integration test through them in the context of an Azure Pipeline? This post will show how to do this by permissioning our Azure Pipeline to access these resources using Azure RBAC role assignments. It will also demonstrate a dotnet test that runs in the context of the pipeline and makes use of those role assignments."><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/blog/2021-09-12-permissioning-azure-pipelines-bicep-role-assignments/permissioning-azure-pipelines-with-bicep-and-role-assignments.png"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/blog/2021-09-12-permissioning-azure-pipelines-bicep-role-assignments/permissioning-azure-pipelines-with-bicep-and-role-assignments.png"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2021-09-12T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://twitter.com/johnny_reilly"><meta data-react-helmet="true" property="article:tag" content="Role Assignments,Bicep,Azure DevOps,Azure Pipelines"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/2021/09/12/permissioning-azure-pipelines-bicep-role-assignments"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/2021/09/12/permissioning-azure-pipelines-bicep-role-assignments" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/2021/09/12/permissioning-azure-pipelines-bicep-role-assignments" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ff16c2af.css">
<link rel="preload" href="/assets/js/runtime~main.96a2f417.js" as="script">
<link rel="preload" href="/assets/js/main.189e1c42.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog-archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://polywork.johnnyreilly.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Polywork<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/22/typescript-vs-jsdoc-javascript">TypeScript vs JSDoc JavaScript</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/18/azure-standard-tests-with-bicep">Azure standard availability tests with Bicep</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/31/nswag-generated-c-sharp-client-property-name-clash">NSwag generated C# client: Open API property name clashes and decimal types rather than double</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/18/docusaurus-meta-tags-and-google-discover">Docusaurus, meta tags and Google Discover</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/15/structured-data-seo-and-react">Structured data, SEO and React</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_GeHD" itemprop="headline">Permissioning Azure Pipelines with Bicep and Azure RBAC Role Assignments</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2021-09-12T00:00:00.000Z" itemprop="datePublished">September 12, 2021</time> Â· <!-- -->9 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><meta itemprop="image" content="https://blog.johnnyreilly.com/blog/2021-09-12-permissioning-azure-pipelines-bicep-role-assignments/permissioning-azure-pipelines-with-bicep-and-role-assignments.png"><div class="markdown" itemprop="articleBody"><p>How can we deploy resources to Azure, and then run an integration test through them in the context of an Azure Pipeline? This post will show how to do this by permissioning our Azure Pipeline to access these resources using Azure RBAC role assignments. It will also demonstrate a dotnet test that runs in the context of the pipeline and makes use of those role assignments.</p><p><img alt="title image reading &amp;quot;Permissioning Azure Pipelines with Bicep and Role Assignments&amp;quot; and some Azure logos" src="/assets/images/permissioning-azure-pipelines-with-bicep-and-role-assignments-f310e0c6ab1c5ecb98495cd7c278fea1.png"></p><p>We&#x27;re following this approach as an alternative to <a href="/2021/07/07/output-connection-strings-and-keys-from-azure-bicep">exporting connection strings</a>, as these can be viewed in the Azure Portal; which may be an security issue if you have many people who are able to access the portal and view deployment outputs.</p><p>We&#x27;re going to demonstrate this approach using Event Hubs. It&#x27;s worth calling out that this is a generally useful approach which can be applied to any Azure resources that support Azure RBAC Role Assignments. So wherever in this post you read &quot;Event Hubs&quot;, imagine substituting other Azure resources you&#x27;re working with.</p><p>The post will do the following:</p><ul><li>Add Event Hubs to our Azure subscription</li><li>Permission our service connection / service principal</li><li>Deploy to Azure with Bicep</li><li>Write an integration test</li><li>Write a pipeline to bring it all together</li></ul><h2 class="anchor anchorWithStickyNavbar_31ik" id="add-event-hubs-to-your-subscription">Add Event Hubs to your subscription<a aria-hidden="true" class="hash-link" href="#add-event-hubs-to-your-subscription" title="Direct link to heading">â€‹</a></h2><p>First of all, we may need to add Event Hubs to our Azure subscription.</p><p>Without this in place, we may encounter errors of the type:</p><blockquote><p>##<!-- -->[error]<!-- -->MissingSubscriptionRegistration: The subscription is not registered to use namespace &#x27;Microsoft.EventHub&#x27;. See <a href="https://aka.ms/rps-not-found" target="_blank" rel="noopener noreferrer">https://aka.ms/rps-not-found</a> for how to register subscriptions.</p></blockquote><p>We do this by going to &quot;Resource Providers&quot; in the <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer">Azure Portal</a> and registering the resources you need. Lots are registered by default, but not all.</p><p><img alt="Screenshot of the Azure Portal, subscriptions -&amp;gt; resource providers section, showing that Event Hubs have been registered" src="/assets/images/screenshot-azure-portal-subscription-resource-providers-be88a0731905bb2e97e82996628789df.png"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="permission-our-service-connection--service-principal">Permission our service connection / service principal<a aria-hidden="true" class="hash-link" href="#permission-our-service-connection--service-principal" title="Direct link to heading">â€‹</a></h2><p>In order that we can run pipelines related to Azure, we mostly need to have an Azure Resource Manager service connection set up in Azure DevOps. Once that exists, we also need to give it a role assignment to allow it to create role assignments of its own when pipelines are running.</p><p>Without this in place, we may encounter errors of the type:</p><blockquote><p>##<!-- -->[error]<!-- -->The template deployment failed with error: &#x27;Authorization failed for template resource &#x27;{GUID-THE-FIRST}&#x27; of type &#x27;Microsoft.Authorization/roleAssignments&#x27;. The client &#x27;{GUID-THE-SECOND}&#x27; with object id &#x27;{GUID-THE-SECOND}&#x27; does not have permission to perform action &#x27;Microsoft.Authorization/roleAssignments/write&#x27; at scope &#x27;/subscriptions/<!-- -->*<!-- -->*<!-- -->*<!-- -->/resourceGroups/johnnyreilly/providers/Microsoft.EventHub/namespaces/evhns-demo/providers/Microsoft.Authorization/roleAssignments/{GUID-THE-FIRST}&#x27;.&#x27;.</p></blockquote><p>Essentially, we want to be able to run pipelines that say &quot;hey Azure, we want to give permissions to our service connection&quot;. We are doing this <em>with</em> the self same service connection, so (chicken and egg) we first need to give it permission to give those commands in future. This is a little confusing; but let&#x27;s role with it. (Pun most definitely intended. ðŸ˜‰)</p><p>To grant that permission / add that role assignment, we go to the service connection in Azure Devops:</p><p><img alt="Screenshot of the service connection in Azure DevOps" src="/assets/images/screenshot-azure-devops-service-connection-f50cd8d004453beb7caf005a82cb3766.png"></p><p>We can see there&#x27;s two links here; first we&#x27;ll click on &quot;Manage Service Principal&quot;, which will take us to the service principal in the Azure Portal:</p><p><img alt="Screenshot of the service principal in the Azure Portal" src="/assets/images/screenshot-azure-portal-service-principal-a98fc857ed6ab3e718e29ff22cd3a02f.png"></p><p>Take note of the display name of the service principal; we&#x27;ll need that as we click on the &quot;Manage service connection roles&quot; link, which will take us to the resource groups IAM page in the Azure Portal:</p><p><img alt="Screenshot of the resource groups IAM page in the Azure Portal" src="/assets/images/screenshot-azure-portal-service-principal-access-control-7bc28b09e72342ec1bd95791c075aa2d.png"></p><p>Here we can click on &quot;Add role assignment&quot;, select &quot;Owner&quot;:</p><p><img alt="Screenshot of the add role assignment IAM page in the Azure Portal" src="/assets/images/screenshot-azure-portal-add-role-assignment-5a94eea687c534ad44496e905d5ef6cf.png"></p><p>Then when selecting members we should be able to look up the service principal to assign it:</p><p><img alt="Screenshot of the add role assignment select member IAM page in the Azure Portal" src="/assets/images/screenshot-azure-portal-add-role-assignment-member-1ef19f40155c3538e9a3ad90a4a281f7.png"></p><p>We now have a service connection which we should be able to use for granting permissions / role assignments, which is what we need.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="event-hub-and-role-assignment-with-bicep">Event Hub and Role Assignment with Bicep<a aria-hidden="true" class="hash-link" href="#event-hub-and-role-assignment-with-bicep" title="Direct link to heading">â€‹</a></h2><p>Next we want a Bicep file that will, when run, provision an Event Hub and a role assignment which will allow our Azure Pipeline (via its service connection) to interact with it.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bicep"><pre tabindex="0" class="prism-code language-bicep codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Name of the eventhub namespace&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param eventHubNamespaceName string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;Name of the eventhub name&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param eventHubName string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@description(&#x27;The service principal&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">param principalId string</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Create an Event Hub namespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHubNamespace &#x27;Microsoft.EventHub/namespaces@2021-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: eventHubNamespaceName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  location: resourceGroup().location</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  sku: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name: &#x27;Standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    tier: &#x27;Standard&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    capacity: 1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    zoneRedundant: true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// Create an Event Hub inside the namespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource eventHub &#x27;Microsoft.EventHub/namespaces/eventhubs@2021-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  parent: eventHubNamespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: eventHubName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    messageRetentionInDays: 7</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    partitionCount: 1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">// give Azure Pipelines Service Principal permissions against the Event Hub</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">var roleDefinitionAzureEventHubsDataOwner = subscriptionResourceId(&#x27;Microsoft.Authorization/roleDefinitions&#x27;, &#x27;f526a384-b230-433a-b45c-95f59c4a2dec&#x27;)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">resource integrationTestEventHubReceiverNamespaceRoleAssignment &#x27;Microsoft.Authorization/roleAssignments@2018-01-01-preview&#x27; = {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  name: guid(principalId, eventHub.id, roleDefinitionAzureEventHubsDataOwner)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  scope: eventHubNamespace</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    roleDefinitionId: roleDefinitionAzureEventHubsDataOwner</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    principalId: principalId</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Do note that our bicep template takes the service principal id as a parameter. We&#x27;re going to supply this later from our Azure Pipeline.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="our-test">Our test<a aria-hidden="true" class="hash-link" href="#our-test" title="Direct link to heading">â€‹</a></h2><p>We&#x27;re now going to write a dotnet integration test which will make use of the infrastructure deployed by our Bicep template. Let&#x27;s create a new test project:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">mkdir src</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cd src</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet new xunit -o IntegrationTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cd IntegrationTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet add package Azure.Identity</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet add package Azure.Messaging.EventHubs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet add package FluentAssertions</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">dotnet add package Microsoft.Extensions.Configuration.EnvironmentVariables</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We&#x27;ll create a test file called <code>EventHubTest.cs</code> with these contents:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Collections.Generic;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Linq;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Text;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Threading;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Threading.Tasks;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Azure.Identity;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Azure.Messaging.EventHubs;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Azure.Messaging.EventHubs.Consumer;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Azure.Messaging.EventHubs.Producer;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using FluentAssertions;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.Extensions.Configuration;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Newtonsoft.Json;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Xunit;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Xunit.Abstractions;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace IntegrationTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public record EchoMessage(string Id, string Message, DateTime Timestamp);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class EventHubTest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private readonly ITestOutputHelper _output;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public EventHubTest(ITestOutputHelper output)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _output = output;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [Fact]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public async Task Can_post_message_to_event_hub_and_read_it_back()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // ARRANGE</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var configuration = new ConfigurationBuilder()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .AddEnvironmentVariables()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                .Build();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // populated by variables specified in the Azure Pipeline</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var eventhubNamespaceName = configuration[&quot;EVENTHUBNAMESPACENAME&quot;];</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            eventhubNamespaceName.Should().NotBeNull();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var eventhubName = configuration[&quot;EVENTHUBNAME&quot;];</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            eventhubName.Should().NotBeNull();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var tenantId = configuration[&quot;TENANTID&quot;];</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            tenantId.Should().NotBeNull();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // populated as a consequence of the addSpnToEnvironment in the azure-pipelines.yml</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var servicePrincipalId = configuration[&quot;SERVICEPRINCIPALID&quot;];</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            servicePrincipalId.Should().NotBeNull();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var servicePrincipalKey = configuration[&quot;SERVICEPRINCIPALKEY&quot;];</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            servicePrincipalKey.Should().NotBeNull();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var fullyQualifiedNamespace = $&quot;{eventhubNamespaceName}.servicebus.windows.net&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var clientCredential = new ClientSecretCredential(tenantId, servicePrincipalId, servicePrincipalKey);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var eventHubClient = new EventHubProducerClient(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                fullyQualifiedNamespace: fullyQualifiedNamespace,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                eventHubName: eventhubName,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                credential: clientCredential</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var ourGuid = Guid.NewGuid().ToString();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var now = DateTime.UtcNow;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var sentEchoMessage = new EchoMessage(Id: ourGuid, Message: $&quot;Test message&quot;, Timestamp: now);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var sentEventData = new EventData(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                Encoding.UTF8.GetBytes(JsonConvert.SerializeObject(sentEchoMessage))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // ACT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            await eventHubClient.SendAsync(new List&lt;EventData&gt; { sentEventData }, CancellationToken.None);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var eventHubConsumerClient = new EventHubConsumerClient(</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                consumerGroup: EventHubConsumerClient.DefaultConsumerGroupName,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                fullyQualifiedNamespace: fullyQualifiedNamespace,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                eventHubName: eventhubName,</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                credential: clientCredential</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            List&lt;PartitionEvent&gt; partitionEvents = new();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            await foreach (var partitionEvent in eventHubConsumerClient.ReadEventsAsync(new ReadEventOptions</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                MaximumWaitTime = TimeSpan.FromSeconds(10)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (partitionEvent.Data == null) break;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                _output.WriteLine(Encoding.UTF8.GetString(partitionEvent.Data.EventBody.ToArray()));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                partitionEvents.Add(partitionEvent);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // ASSERT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            partitionEvents.Count.Should().BeGreaterOrEqualTo(1);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var firstOne = partitionEvents.FirstOrDefault(evnt =&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">              ExtractTypeFromEventBody&lt;EchoMessage&gt;(evnt, _output)?.Id == ourGuid</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var receivedEchoMessage = ExtractTypeFromEventBody&lt;EchoMessage&gt;(firstOne, _output);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            receivedEchoMessage.Should().BeEquivalentTo(sentEchoMessage, because: &quot;the event body should be the same one posted to the message queue&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private static T ExtractTypeFromEventBody&lt;T&gt;(PartitionEvent evnt, ITestOutputHelper _output)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            try</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return JsonConvert.DeserializeObject&lt;T&gt;(Encoding.UTF8.GetString(evnt.Data.EventBody.ToArray()));</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            catch (JsonException)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                _output.WriteLine(&quot;[&quot; + Encoding.UTF8.GetString(evnt.Data.EventBody.ToArray()) + &quot;] is probably not JSON&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return default(T);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Let&#x27;s talk through what happens in the test above:</p><ol><li>We read in Event Hub connection configuration for the test from environment variables. (These will be supplied by an Azure Pipeline that we will create shortly.)</li><li>We post a message to the Event Hub.</li><li>We read a message back from the Event Hub.</li><li>We confirm that the message we read back matches the one we posted.</li></ol><p>Now that we have our test, we want to be able to execute it. For that we need an Azure Pipeline!</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="azure-pipeline">Azure Pipeline<a aria-hidden="true" class="hash-link" href="#azure-pipeline" title="Direct link to heading">â€‹</a></h2><p>We&#x27;re going to add an <code>azure-pipelines.yml</code> file which Azure DevOps can use to power a pipeline:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yml"><pre tabindex="0" class="prism-code language-yml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token key atrule">variables</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> eventHubNamespaceName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> evhns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">demo</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> eventHubName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> evh</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">demo</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">pool</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token key atrule">vmImage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Get Service Principal Id</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(serviceConnection)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> bash</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> inlineScript</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">addSpnToEnvironment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        PRINCIPAL_ID=$(az ad sp show --id $servicePrincipalId --query objectId -o tsv)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        echo &quot;##vso[task.setvariable variable=PIPELINE_PRINCIPAL_ID;]$PRINCIPAL_ID&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">bash</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> az bicep build </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">file infra/main.bicep</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Compile Bicep to ARM&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureResourceManagerTemplateDeployment@3</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> DeployEventHubInfra</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deploy Event Hub infra</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">deploymentScope</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">azureResourceManagerConnection</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(serviceConnection)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">subscriptionId</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(subscriptionId)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Create Or Update Resource Group</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(azureResourceGroup)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">location</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(location)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">templateLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Linked artifact</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">csmFile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;infra/main.json&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># created by bash script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">overrideParameters</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">eventHubNamespaceName $(eventHubNamespaceName)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">eventHubName $(eventHubName)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">principalId $(PIPELINE_PRINCIPAL_ID)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">deploymentMode</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Incremental</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> UseDotNet@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;Install .NET SDK 5.0.x&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">packageType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;sdk&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 5.0.x</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> AzureCLI@2</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dotnet integration test</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(serviceConnection)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">scriptType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> pscore</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">scriptLocation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> inlineScript</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">addSpnToEnvironment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># allows access to service principal details in script</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      </span><span class="token key atrule">inlineScript</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(173, 219, 103)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        cd $(Build.SourcesDirectory)/src/IntegrationTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token scalar string" style="color:rgb(173, 219, 103)">        dotnet test</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>When the pipeline is run, it does the following:</p><ol><li>Gets the service principal id from the service connection.</li><li>Compiles our Bicep into an ARM template</li><li>Deploys the compiled ARM template to Azure</li><li>Installs the dotnet SDK</li><li>Uses the <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/azure-cli?view=azure-devops" target="_blank" rel="noopener noreferrer">Azure CLI task</a> which allows us to access service principal details in the pipeline to run our dotnet test.</li></ol><p>We&#x27;ll create a pipeline in Azure DevOps pointing to this file, and we&#x27;ll also create the variables that it depends upon:</p><ul><li><code>azureResourceGroup</code> - the name of your resource group in Azure where the app will be deployed</li><li><code>location</code> - where your app is deployed, eg <code>northeurope</code></li><li><code>serviceConnection</code> - the name of your AzureRM service connection in Azure DevOps</li><li><code>subscriptionId</code> - your Azure subscription id from the <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer">Azure Portal</a></li><li><code>tenantId</code> - the Azure tenant id from the <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer">Azure Portal</a></li></ul><h2 class="anchor anchorWithStickyNavbar_31ik" id="running-the-pipeline">Running the pipeline<a aria-hidden="true" class="hash-link" href="#running-the-pipeline" title="Direct link to heading">â€‹</a></h2><p>Now we&#x27;re ready to run our pipeline:</p><p><img alt="screenshot of pipeline running successfully" src="/assets/images/screenshot-azure-pipelines-tests-passing-83fbc25d889d3ef3f2af50edc01ed509.png"></p><p>Here we can see that the pipeline runs and the test passes. That means we&#x27;ve successfully provisioned the Event Hub and permissioned our pipeline to be able to access it using Azure RBAC role assignments. We then wrote a test which used the pipeline credentials to interact with the Event Hub. To see the repo that demostrates this, <a href="https://dev.azure.com/johnnyreilly/blog-demos/_git/permissioning-azure-pipelines-bicep-role-assignments" target="_blank" rel="noopener noreferrer">look here</a>.</p><p>Just to reiterate: we&#x27;ve demonstrated this approach using Event Hubs. This is a generally useful approach which can be applied to any Azure resources that support Azure RBAC Role Assignments.</p><p>Thanks to <a href="https://twitter.com/foldr" target="_blank" rel="noopener noreferrer">Jamie McCrindle</a> for helping out with permissioning the service connection / service principal. <a href="https://foldr.uk/rotating-azure-credentials-in-github-with-terraform" target="_blank" rel="noopener noreferrer">His post on rotating <code>AZURE_CREDENTIALS</code> in GitHub with Terraform</a> provides useful background for those who would like to do similar permissioning using Terraform.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_3kfx"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/role-assignments">Role Assignments</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/bicep">Bicep</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure-dev-ops">Azure DevOps</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/azure-pipelines">Azure Pipelines</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/blog/2021-09-12-permissioning-azure-pipelines-bicep-role-assignments.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/2021/10/15/structured-data-seo-and-react"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« <!-- -->Structured data, SEO and React</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/2021/09/10/google-apis-authentication-with-typescript"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Google APIs: authentication with TypeScript<!-- --> Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#add-event-hubs-to-your-subscription" class="table-of-contents__link toc-highlight">Add Event Hubs to your subscription</a></li><li><a href="#permission-our-service-connection--service-principal" class="table-of-contents__link toc-highlight">Permission our service connection / service principal</a></li><li><a href="#event-hub-and-role-assignment-with-bicep" class="table-of-contents__link toc-highlight">Event Hub and Role Assignment with Bicep</a></li><li><a href="#our-test" class="table-of-contents__link toc-highlight">Our test</a></li><li><a href="#azure-pipeline" class="table-of-contents__link toc-highlight">Azure Pipeline</a></li><li><a href="#running-the-pipeline" class="table-of-contents__link toc-highlight">Running the pipeline</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.96a2f417.js"></script>
<script src="/assets/js/main.189e1c42.js"></script>
</body>
</html>