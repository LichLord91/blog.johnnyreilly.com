<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">Integration Testing with Entity Framework and Snapshot Backups | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/2014/01/24/integration-testing-with-entity"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" name="robots" content="max-image-preview:large"><meta data-react-helmet="true" property="og:title" content="Integration Testing with Entity Framework and Snapshot Backups | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="description" content="I&#x27;ve written before about how unit testing Entity Framework is a contentious and sometimes pointless activity. The TL;DR is that LINQ-to-Objects != Linq-to-Entities and so if you want some useful tests around your data tier then integration tests that actually hit a database are what you want."><meta data-react-helmet="true" property="og:description" content="I&#x27;ve written before about how unit testing Entity Framework is a contentious and sometimes pointless activity. The TL;DR is that LINQ-to-Objects != Linq-to-Entities and so if you want some useful tests around your data tier then integration tests that actually hit a database are what you want."><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2014-01-24T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://twitter.com/johnny_reilly"><meta data-react-helmet="true" property="article:tag" content="Database Snapshot Backups,Integration Testing,SQL Server"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/2014/01/24/integration-testing-with-entity"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/2014/01/24/integration-testing-with-entity" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/2014/01/24/integration-testing-with-entity" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ff16c2af.css">
<link rel="preload" href="/assets/js/runtime~main.9adf4245.js" as="script">
<link rel="preload" href="/assets/js/main.7a281289.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog-archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://polywork.johnnyreilly.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Polywork<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/18/azure-standard-tests-with-bicep">Azure standard availability tests with Bicep</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/31/nswag-generated-c-sharp-client-property-name-clash">NSwag generated C# client: Open API property name clashes and decimal types rather than double</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/18/docusaurus-meta-tags-and-google-discover">Docusaurus, meta tags and Google Discover</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/15/structured-data-seo-and-react">Structured data, SEO and React</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/09/12/permissioning-azure-pipelines-bicep-role-assignments">Permissioning Azure Pipelines with Bicep and Azure RBAC Role Assignments</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_GeHD" itemprop="headline">Integration Testing with Entity Framework and Snapshot Backups</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2014-01-24T00:00:00.000Z" itemprop="datePublished">January 24, 2014</time> Â· <!-- -->15 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>I&#x27;ve written before about how unit testing <a href="http://icanmakethiswork.blogspot.co.uk/2012/10/unit-testing-and-entity-framework-filth.html" target="_blank" rel="noopener noreferrer">Entity Framework is a contentious and sometimes pointless activity</a>. The TL;DR is that LINQ-to-Objects != Linq-to-Entities and so if you want some useful tests around your data tier then integration tests that actually hit a database are what you want.</p><p>However hitting an actual database is has serious implications. For a start you need a database server and you need a database. But the real issue lies around cleanup. When you write a test that amends data in the database you need the test to clean up after itself. If it doesn&#x27;t then the next test that runs may trip over the amended data and that&#x27;s your test pack instantly useless.</p><p>What you want is a way to wipe the slate clean - to return the database back to the state that it was in before your test ran. Kind of like a database restore - except that would be slow. And this is where <a href="http://technet.microsoft.com/en-us/library/ms189548(v=sql.105).aspx" target="_blank" rel="noopener noreferrer">SQL Server&#x27;s snapshot backups</a> have got your back. To quote MSDN:</p><blockquote><p>*<!-- -->Snapshot backups have the following primary benefits:</p><ul><li>A backup can be created quickly, typically measured in seconds, with little or no effect on the server.</li><li>A restore operation can be accomplished from a disk backup just as quickly.</li><li>Backup to tape can be accomplished by another host without an effect on the production system.</li><li><strong>A copy of a production database can be created instantly for reporting or testing.</strong></li></ul><ul><li></li></ul></blockquote><p>Just the ticket.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="our-mission">Our Mission<a aria-hidden="true" class="hash-link" href="#our-mission" title="Direct link to heading">â€‹</a></h2><p>In this post I want to go through the process of taking an existing database, pointing Entity Framework at it, setting up some repositories and then creating an integration test pack that uses snapshot backups to cleanup after each test runs. The code detailed in this post is available in this <a href="https://github.com/johnnyreilly/SnapshotBackupsIntegrationTesting" target="_blank" rel="noopener noreferrer">GitHub repo</a> if you want to have a go yourself.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="we-need-a-database">We need a database<a aria-hidden="true" class="hash-link" href="#we-need-a-database" title="Direct link to heading">â€‹</a></h2><p>You can find a whole assortment of databases <a href="https://msftdbprodsamples.codeplex.com/releases" target="_blank" rel="noopener noreferrer">here</a>. I&#x27;m going to use <a href="https://msftdbprodsamples.codeplex.com/wikipage?title=AWLTDocs" target="_blank" rel="noopener noreferrer">AdventureWorksLT</a> as it&#x27;s small and simple. So I&#x27;ll download <a href="https://msftdbprodsamples.codeplex.com/downloads/get/478217" target="_blank" rel="noopener noreferrer">this</a> and unzip it. I&#x27;ll drop <code>AdventureWorksLT2008R2_Data.mdf</code> and <code>AdventureWorksLT2008R2_log.LDF</code> in my data folder and attach AdventureWorksLT2008R2 to my database server. And now I have a database:</p><p><img src="https://1.bp.blogspot.com/-Nke8F6wYI4A/UuEeJ6C0XqI/AAAAAAAAAgg/tbuhu2TuOpg/s320/Database2.png"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="assemble-me-your-finest-dbcontext">Assemble me your finest DbContext<a aria-hidden="true" class="hash-link" href="#assemble-me-your-finest-dbcontext" title="Direct link to heading">â€‹</a></h2><p>Or in English: we want to point Entity Framework at our new shiny database. So let&#x27;s fire up Visual Studio (I&#x27;m using 2013) and create a new solution called &quot;AdventureWorks&quot;.</p><p>To our solution let&#x27;s add a new class library project called &quot;AdventureWorks.EntityFramework&quot;. And to that we&#x27;ll add an ADO.NET Entity Data Model which we&#x27;ll call &quot;AdventureWorks.edmx&quot;. When the wizard fires up we&#x27;ll use the &quot;Generate from database&quot; option, click Next and select &quot;New Connection&quot;. In the dialog we&#x27;ll select our newly attached AdventureWorksLT2008R2 database. We&#x27;ll leave the &quot;save entity connection settings in App.Config&quot; option selected and click Next. I&#x27;m going to use Entity Framework 6.0 - though I think that any version would do. I&#x27;m going to pull in all tables / store procs and views. And now Entity Framework is pointing at my database:</p><p><img src="https://3.bp.blogspot.com/-Sv_GPsqilao/UuElIcLCYaI/AAAAAAAAAgw/7ui-xpml8dk/s400/EDMX.png"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="let-there-be-repositories">Let There be Repositories!<a aria-hidden="true" class="hash-link" href="#let-there-be-repositories" title="Direct link to heading">â€‹</a></h2><p>In the name of testability let&#x27;s create a new project to house repositories called &quot;AdventureWorks.Repositories&quot;. I&#x27;m going to use <a href="http://odetocode.com/about/scott-allen" target="_blank" rel="noopener noreferrer">K. Scott Allen</a>&#x27;s fine <a href="http://msdn.microsoft.com/en-us/library/ff714955.aspx" target="_blank" rel="noopener noreferrer">article on MSDN</a> to create a very basic set of repositories wrapped in a unit of work.</p><p>In my new project I&#x27;ll add a reference to the <code>AdventureWorks.EntityFramework</code> project and create a new <code>IRepository</code> interface that looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Linq;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Linq.Expressions;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace AdventureWorks.Repositories</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public interface IRepository&lt;T&gt; where T : class</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        IQueryable&lt;T&gt; FindAll();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        IQueryable&lt;T&gt; FindWhere(Expression&lt;Func&lt;T, bool&gt;&gt; predicate);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        T Add(T newEntity);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        T Remove(T entity);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>And a new <code>IUnitOfWork</code> interface that looks like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using AdventureWorks.EntityFramework;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace AdventureWorks.Repositories</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public interface IUnitOfWork</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;ErrorLog&gt; ErrorLogs { get; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;Address&gt; Addresses { get; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;Customer&gt; Customers { get; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;CustomerAddress&gt; CustomerAddresses { get; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;Product&gt; Products { get; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;ProductCategory&gt; ProductCategories { get; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;ProductDescription&gt; ProductDescriptions { get; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;ProductModel&gt; ProductModels { get; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;ProductModelProductDescription&gt; ProductModelProductDescriptions { get; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;SalesOrderDetail&gt; SalesOrderDetails { get; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;SalesOrderHeader&gt; SalesOrderHeaders { get; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;BuildVersion&gt; BuildVersions { get; }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        void Commit();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now for the implementation of <code>IRepository</code>. For this we&#x27;ll need a reference to Entity Framework in our project. Then we&#x27;ll create a class called <code>SqlRepository</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Data.Entity;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Linq;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Linq.Expressions;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace AdventureWorks.Repositories</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class SqlRepository&lt;T&gt; : IRepository&lt;T&gt; where T : class</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public SqlRepository(DbContext context)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _dbSet = context.Set&lt;T&gt;();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IQueryable&lt;T&gt; FindAll()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return _dbSet;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IQueryable&lt;T&gt; FindWhere(Expression&lt;Func&lt;T, bool&gt;&gt; predicate)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return _dbSet.Where(predicate);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public T Add(T newEntity)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return _dbSet.Add(newEntity);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public T Remove(T entity)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            return _dbSet.Remove(entity);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        protected DbSet&lt;T&gt; _dbSet;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>And we also need the implementation of <code>IUnitOfWork</code>. So we&#x27;ll create a class called <code>SqlUnitOfWork</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Linq;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Data.Entity;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using AdventureWorks.EntityFramework;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace AdventureWorks.Repositories</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class SqlUnitOfWork : IUnitOfWork</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public SqlUnitOfWork()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _context = new AdventureWorksLT2008R2Entities();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;ErrorLog&gt; ErrorLogs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            get</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (_errorLogs == null) _errorLogs = new SqlRepository&lt;ErrorLog&gt;(_context);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return _errorLogs;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;Address&gt; Addresses</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            get</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (_addresses == null) _addresses = new SqlRepository&lt;Address&gt;(_context);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return _addresses;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;Customer&gt; Customers</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            get</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (_customers == null) _customers = new SqlRepository&lt;Customer&gt;(_context);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return _customers;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;CustomerAddress&gt; CustomerAddresses</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            get</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (_customerAddresses == null) _customerAddresses = new SqlRepository&lt;CustomerAddress&gt;(_context);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return _customerAddresses;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;Product&gt; Products</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            get</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (_products == null) _products = new SqlRepository&lt;Product&gt;(_context);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return _products;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;ProductCategory&gt; ProductCategories</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            get</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (_productCategories == null) _productCategories = new SqlRepository&lt;ProductCategory&gt;(_context);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return _productCategories;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;ProductDescription&gt; ProductDescriptions</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            get</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (_productDescriptions == null) _productDescriptions = new SqlRepository&lt;ProductDescription&gt;(_context);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return _productDescriptions;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;ProductModel&gt; ProductModels</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            get</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (_productModels == null) _productModels = new SqlRepository&lt;ProductModel&gt;(_context);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return _productModels;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;ProductModelProductDescription&gt; ProductModelProductDescriptions</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            get</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (_productModelProductDescriptions == null) _productModelProductDescriptions = new SqlRepository&lt;ProductModelProductDescription&gt;(_context);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return _productModelProductDescriptions;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;SalesOrderDetail&gt; SalesOrderDetails</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            get</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (_salesOrderDetails == null) _salesOrderDetails = new SqlRepository&lt;SalesOrderDetail&gt;(_context);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return _salesOrderDetails;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;SalesOrderHeader&gt; SalesOrderHeaders</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            get</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (_salesOrderHeaders == null) _salesOrderHeaders = new SqlRepository&lt;SalesOrderHeader&gt;(_context);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return _salesOrderHeaders;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public IRepository&lt;BuildVersion&gt; BuildVersions</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            get</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (_buildVersions == null) _buildVersions = new SqlRepository&lt;BuildVersion&gt;(_context);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return _buildVersions;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public void Commit()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _context.SaveChanges();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        SqlRepository&lt;ErrorLog&gt; _errorLogs = null;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        SqlRepository&lt;Address&gt; _addresses = null;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        SqlRepository&lt;Customer&gt; _customers = null;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        SqlRepository&lt;CustomerAddress&gt; _customerAddresses = null;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        SqlRepository&lt;Product&gt; _products = null;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        SqlRepository&lt;ProductCategory&gt; _productCategories = null;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        SqlRepository&lt;ProductDescription&gt; _productDescriptions = null;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        SqlRepository&lt;ProductModel&gt; _productModels = null;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        SqlRepository&lt;ProductModelProductDescription&gt; _productModelProductDescriptions = null;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        SqlRepository&lt;SalesOrderDetail&gt; _salesOrderDetails = null;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        SqlRepository&lt;SalesOrderHeader&gt; _salesOrderHeaders = null;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        SqlRepository&lt;BuildVersion&gt; _buildVersions = null;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        readonly DbContext _context;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="and-now-lets-start-integration-testing">And Now Let&#x27;s Start Integration Testing!<a aria-hidden="true" class="hash-link" href="#and-now-lets-start-integration-testing" title="Direct link to heading">â€‹</a></h2><p>Let&#x27;s create a new Unit Test project called &quot;AdventureWorks.Repositories.IntegrationTests&quot;. (And just to be clear: this is <!-- -->*<!-- -->not<!-- -->*<!-- --> a unit test project - it is an <strong><em>integration</em></strong> test project.) We&#x27;ll add a reference back to our <code>AdventureWorks.Repositories</code> project for the repositories and one back to <code>AdventureWorks.EntityFramework</code> for our domain models. And finally you&#x27;ll need a reference to Entity Framework in your IntegrationTest project as well as well.</p><p>We&#x27;ll copy across the <code>app.config</code> from <code>AdventureWorks.EntityFramework</code> to <code>AdventureWorks.Repositories.IntegrationTests</code> as it contains the database connection details. It&#x27;ll look something like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly xml"><pre tabindex="0" class="prism-code language-xml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">configuration</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">configSections</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">section</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">entityFramework</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">type</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection, EntityFramework, Version=6.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">requirePermission</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">false</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">&lt;!-- For more information on Entity Framework configuration, visit http://go.microsoft.com/fwlink/?LinkID=237468 --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(127, 219, 202)">configSections</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">connectionStrings</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">add</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">AdventureWorksLT2008R2Entities</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token tag" style="color:rgb(127, 219, 202)">             </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">connectionString</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">metadata=res://*/AdventureWorks.csdl|res://*/AdventureWorks.ssdl|res://*/AdventureWorks.msl;provider=System.Data.SqlClient;provider connection string=</span><span class="token tag attr-value entity named-entity" style="color:rgb(127, 219, 202)">&amp;quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">data source=.;initial catalog=AdventureWorksLT2008R2;integrated security=True;MultipleActiveResultSets=True;App=EntityFramework</span><span class="token tag attr-value entity named-entity" style="color:rgb(127, 219, 202)">&amp;quot;</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token tag" style="color:rgb(127, 219, 202)">             </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">providerName</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">System.Data.EntityClient</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(127, 219, 202)">connectionStrings</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">entityFramework</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">defaultConnectionFactory</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">type</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">System.Data.Entity.Infrastructure.SqlConnectionFactory, EntityFramework</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">providers</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">provider</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">invariantName</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">System.Data.SqlClient</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">type</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">System.Data.Entity.SqlServer.SqlProviderServices, EntityFramework.SqlServer</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(127, 219, 202)">providers</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(127, 219, 202)">entityFramework</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(127, 219, 202)">configuration</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now we&#x27;re ready for a test. We&#x27;ll add ourselves a class called <code>BuildVersionTests</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Linq;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Linq.Expressions;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.VisualStudio.TestTools.UnitTesting;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace AdventureWorks.Repositories.IntegrationTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    [TestClass]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class BuildVersionTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [TestMethod]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public void BuildVersions_should_return_the_correct_version_information()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // Arrange</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var uow = new SqlUnitOfWork();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // Act</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var buildVersions = uow.BuildVersions.FindAll().ToList();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // Assert</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Assert.AreEqual(1, buildVersions.Count);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Assert.AreEqual(&quot;10.00.80404.00&quot;, buildVersions[0].Database_Version);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Assert.AreEqual(new DateTime(2008, 4, 4), buildVersions[0].ModifiedDate);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Assert.AreEqual(1, buildVersions[0].SystemInformationID);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Assert.AreEqual(new DateTime(2008, 4, 4), buildVersions[0].VersionDate);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This is as simple as it gets - our test creates a new unit of work and queries the <code>BuildVersions</code> table to see what we can see. All it&#x27;s really doing is demonstrating that we can now hit our database through our repositories. As a side note, we could have the exact same test operating directly on the <code>DbContext</code> like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">[TestMethod]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public void DbContext_BuildVersions_should_return_the_correct_version_information()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // Arrange</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var dbContext = new AdventureWorks.EntityFramework.AdventureWorksLT2008R2Entities();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // Act</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var buildVersions = dbContext.BuildVersions.ToList();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // Assert</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Assert.AreEqual(1, buildVersions.Count);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Assert.AreEqual(&quot;10.00.80404.00&quot;, buildVersions[0].Database_Version);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Assert.AreEqual(new DateTime(2008, 4, 4), buildVersions[0].ModifiedDate);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Assert.AreEqual(1, buildVersions[0].SystemInformationID);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Assert.AreEqual(new DateTime(2008, 4, 4), buildVersions[0].VersionDate);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>For the most part we won&#x27;t be doing this but I wanted to be clear that full power of Entity Framework is available to you as you&#x27;re putting together your integration tests.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="database-snapshotting-time">Database Snapshotting Time<a aria-hidden="true" class="hash-link" href="#database-snapshotting-time" title="Direct link to heading">â€‹</a></h2><p>Up until this point we&#x27;ve essentially been laying our infrastructure and doing our plumbing. We now have a database, domain models and data access courtesy of Entity Framework, a testable repository layer and finally an integration test pack. What we want now is to get our database snapshot / backup and restore mechanism set up and integrated into the test pack.</p><p>Let&#x27;s add references to the <code>System.Data</code> and <code>System.Configuration</code> assemblies to our integration testing project and then add a new class called <code>DatabaseSnapshot</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Configuration;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Data;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Data.SqlClient;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace AdventureWorks.Repositories.IntegrationTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static class DatabaseSnapshot</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private const string SpCreateSnapShotName = &quot;SnapshotBackup_Create&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private const string SpCreateSnapShot =</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@&quot;CREATE PROCEDURE [dbo].[&quot; + SpCreateSnapShotName + @&quot;]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    @databaseName        varchar(512),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    @databaseLogicalName varchar(512),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    @snapshotBackupPath  varchar(512),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    @snapshotBackupName  varchar(512)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">AS</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    SET NOCOUNT ON;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    DECLARE @sql varchar(500)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    SELECT @sql = &#x27;CREATE DATABASE &#x27; + @snapshotBackupName +</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                  &#x27; ON (NAME=[&#x27; + @databaseLogicalName +</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                  &#x27;], FILENAME=&#x27;&#x27;&#x27; + @snapshotBackupPath + @snapshotBackupName +</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                  &#x27;&#x27;&#x27;) AS SNAPSHOT OF [&#x27; + @databaseName + &#x27;]&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    EXEC(@sql)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">END&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private const string SpRestoreSnapShotName = &quot;SnapshotBackup_Restore&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private const string SpRestoreSnapShot =</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@&quot;CREATE PROCEDURE [dbo].[&quot; + SpRestoreSnapShotName + @&quot;]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    @databaseName varchar(512),</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    @snapshotBackupName varchar(512)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">AS</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    SET NOCOUNT ON;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    DECLARE @sql varchar(500)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    SET @sql  = &#x27;ALTER DATABASE [&#x27; + @databaseName + &#x27;] SET SINGLE_USER WITH ROLLBACK IMMEDIATE&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    EXEC (@sql)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    RESTORE DATABASE @databaseName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    FROM DATABASE_SNAPSHOT = @snapshotBackupName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    SET @sql = &#x27;ALTER DATABASE [&#x27; + @databaseName + &#x27;] SET MULTI_USER&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    EXEC (@sql)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">END&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private const string SpDeleteSnapShotName = &quot;SnapshotBackup_Delete&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private const string SpDeleteSnapShot =</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">@&quot;CREATE PROCEDURE [dbo].[&quot; + SpDeleteSnapShotName + @&quot;]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    @snapshotBackupName varchar(512)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">AS</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    SET NOCOUNT ON;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    DECLARE @sql varchar(500)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    SELECT @sql = &#x27;DROP DATABASE &#x27; + @snapshotBackupName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    EXEC(@sql)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">END&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private static string _masterDbConnectionString;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private static string _dbName;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private static ConnectionStringSettings _dbConnectionStringSettings;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private static ConnectionStringSettings DbConnectionStringSettings</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            get</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (_dbConnectionStringSettings == null)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    _dbConnectionStringSettings = ConfigurationManager.ConnectionStrings[&quot;SnapshotBackup&quot;];</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return _dbConnectionStringSettings;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// &lt;summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// Stored procedures should be executed against master database</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        /// &lt;/summary&gt;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private static string MasterDbConnectionString</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            get</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (string.IsNullOrEmpty(_masterDbConnectionString))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    var sqlConnection = new SqlConnection(DbConnectionStringSettings.ConnectionString);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    _masterDbConnectionString = DbConnectionStringSettings.ConnectionString.Replace(sqlConnection.Database, &quot;master&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return _masterDbConnectionString;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private static string DbName</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            get</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                if (string.IsNullOrEmpty(_dbName))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    _dbName = new SqlConnection(DbConnectionStringSettings.ConnectionString).Database.TrimStart(&#x27;[&#x27;).TrimEnd(&#x27;]&#x27;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                return _dbName;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static void SetupStoredProcedures()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            using (var conn = new SqlConnection(MasterDbConnectionString))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                conn.Open();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                // Drop the existing stored procedures</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                SqlCommand cmd;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                const string dropProcSql = &quot;IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N&#x27;[dbo].[{0}]&#x27;) AND type in (N&#x27;P&#x27;, N&#x27;PC&#x27;)) DROP PROCEDURE [dbo].[{0}]&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                foreach (var spName in new[] { SpCreateSnapShotName, SpDeleteSnapShotName, SpRestoreSnapShotName })</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    cmd = new SqlCommand(string.Format(dropProcSql, spName), conn);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    cmd.ExecuteNonQuery();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                // Create the stored procedures anew</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                foreach (var createProcSql in new[] { SpCreateSnapShot, SpDeleteSnapShot, SpRestoreSnapShot })</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    cmd = new SqlCommand(createProcSql, conn);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                    cmd.ExecuteNonQuery();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                conn.Close();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static void CreateSnapShot()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var databaseName = new SqlParameter { ParameterName = &quot;@databaseName&quot;, SqlValue = SqlDbType.VarChar, Value = DbName };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var databaseLogicalName = new SqlParameter { ParameterName = &quot;@databaseLogicalName&quot;, SqlValue = SqlDbType.VarChar, Value = ConfigurationManager.AppSettings[&quot;DatabaseLogicalName&quot;] };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var snapshotBackupPath = new SqlParameter { ParameterName = &quot;@snapshotBackupPath&quot;, SqlValue = SqlDbType.VarChar, Value = ConfigurationManager.AppSettings[&quot;SnapshotBackupPath&quot;] };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var snapshotBackupName = new SqlParameter { ParameterName = &quot;@snapshotBackupName&quot;, SqlValue = SqlDbType.VarChar, Value = ConfigurationManager.AppSettings[&quot;SnapshotBackupName&quot;] };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            ExecuteStoredProcAgainstMaster(SpCreateSnapShotName, new[] { databaseName, databaseLogicalName, snapshotBackupPath, snapshotBackupName });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static void DeleteSnapShot()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var snapshotBackupName = new SqlParameter { ParameterName = &quot;@snapshotBackupName&quot;, SqlValue = SqlDbType.VarChar, Value = ConfigurationManager.AppSettings[&quot;SnapshotBackupName&quot;] };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            ExecuteStoredProcAgainstMaster(SpDeleteSnapShotName, new[] { snapshotBackupName });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static void RestoreSnapShot()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var databaseName = new SqlParameter { ParameterName = &quot;@databaseName&quot;, SqlValue = SqlDbType.VarChar, Value = DbName };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var snapshotBackupName = new SqlParameter { ParameterName = &quot;@snapshotBackupName&quot;, SqlValue = SqlDbType.VarChar, Value = ConfigurationManager.AppSettings[&quot;SnapshotBackupName&quot;] };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            ExecuteStoredProcAgainstMaster(SpRestoreSnapShotName, new[] { databaseName, snapshotBackupName });</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private static void ExecuteStoredProcAgainstMaster(string storedProc, SqlParameter[] parameters)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            using (var conn = new SqlConnection(MasterDbConnectionString))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                conn.Open();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var cmd = new SqlCommand(storedProc, conn) { CommandType = CommandType.StoredProcedure };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                cmd.Parameters.AddRange(parameters);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                cmd.ExecuteNonQuery();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                conn.Close();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The <code>DatabaseSnapshot</code> class exposes 4 methods:</p><dl><dt>SetupStoredProcedures</dt><dd>This method creates 3 stored procedures on the master database: <code>SnapshotBackup_Create</code>, <code>SnapshotBackup_Restore</code> and <code>SnapshotBackup_Delete</code>. These procs do pretty much what their names suggest and the other 3 methods call these stored procedures when creating, restoring and deleting snapshot backups respectively. You can see the (fairly minimal) SQL for these stored procs at the top of the<code>DatabaseSnapshot</code> class.</dd><dt>CreateSnapShot</dt><dd>This method creates a snapshot backup of the database at this point in time.</dd><dt>RestoreSnapShot</dt><dd>This method restores the database back to state it was in when the snapshot backup was created.</dd><dt>DeleteSnapShot</dt><dd>This method attempts to delete the existing snapshot backup.</dd></dl><p>In order that we can use the <code>DatabaseSnapshot</code> class we need to add the following entries to our <code>app.config</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly xml"><pre tabindex="0" class="prism-code language-xml codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">configuration</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">connectionStrings</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">add</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">SnapshotBackup</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token tag" style="color:rgb(127, 219, 202)">             </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">connectionString</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">data source=.;initial catalog=AdventureWorksLT2008R2;Trusted_Connection=true;Connection Timeout=200</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(127, 219, 202)">connectionStrings</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">appSettings</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">add</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">key</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">DatabaseLogicalName</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">AdventureWorksLT2008_Data</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">add</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">key</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">SnapshotBackupPath</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">C:\DbSnapshots\</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(127, 219, 202)">add</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">key</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">SnapshotBackupName</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag attr-name" style="color:rgb(173, 219, 103);font-style:italic">value</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(127, 219, 202)">AdventureWorksLT2008R2_Snapshot</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(127, 219, 202)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(127, 219, 202)">appSettings</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(127, 219, 202)">configuration</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>These settings allow have the following purposes:</p><dl><dt>SnapshotBackup</dt><dd>A connection string that allows <code>DatabaseSnapshot</code> to connect to the database.</dd><dt>DatabaseLogicalName</dt><dd>The logical name of the database you want to backup. (This can be found on the Files tab of the Database Properties in SSMS)</dd><dt>SnapshotBackupPath</dt><dd>The location where the snapshot backup is to be stored. You need to make sure that this exists on your machine.</dd><dt>SnapshotBackupName</dt><dd>The name of the snapshot backup that will be created.</dd></dl><p>Now to make use of <code>DatabaseSnapshot</code>. Let&#x27;s add a new class called <code>SetUpTearDown</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.VisualStudio.TestTools.UnitTesting;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace AdventureWorks.Repositories.IntegrationTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    [TestClass]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public static class SetUpTearDown</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [AssemblyInitialize]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static void TestRunInitialize(TestContext context)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            try</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                // Try to delete the snapshot in case it was left over from aborted test runs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                DatabaseSnapshot.DeleteSnapShot();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            catch { /* this should fail with snapshot does not exist */ }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            DatabaseSnapshot.SetupStoredProcedures();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            DatabaseSnapshot.CreateSnapShot();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [AssemblyCleanup]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public static void TestRunCleanup()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            DatabaseSnapshot.DeleteSnapShot();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>At the start of the test run this will create a snapshot in case one doesn&#x27;t exist already. And at the end of the test run it will be a good citizen and delete the snapshot. We&#x27;ll also add an extra method to our <code>BuildVersionTests</code> class:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace AdventureWorks.Repositories.IntegrationTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    [TestClass]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class BuildVersionTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        // ...</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [TestCleanup]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public void TestCleanup()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            DatabaseSnapshot.RestoreSnapShot();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This will ensure that after each test runs the database will be restored back to the snapshot created in <code>SetUpTearDown</code>. Now if you re-run your tests, in between each test the restore back to the snapshot is taking place.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="prove-it">Prove it!<a aria-hidden="true" class="hash-link" href="#prove-it" title="Direct link to heading">â€‹</a></h2><p>Of course the tests we have in place at present don&#x27;t actually change the data at all. So I could be lying. I&#x27;m not. Let&#x27;s prove it by adding one more class called <code>CustomerTests</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Linq;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Linq.Expressions;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using Microsoft.VisualStudio.TestTools.UnitTesting;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using AdventureWorks.EntityFramework;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace AdventureWorks.Repositories.IntegrationTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    [TestClass]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class CustomerTests</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [TestMethod]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public void Should_change_a_customers_first_and_last_name()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // Arrange</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var uow = new SqlUnitOfWork();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // Act</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var customer = uow.Customers.FindWhere(x =&gt; x.FirstName == &quot;Jay&quot; &amp;&amp; x.LastName == &quot;Adams&quot;).First();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var customerId = customer.CustomerID;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            customer.FirstName = &quot;John&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            customer.LastName = &quot;Reilly&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            uow.Commit();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // Assert</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            Assert.IsNotNull(uow.Customers.FindWhere(x =&gt; x.FirstName == &quot;John&quot; &amp;&amp; x.LastName == &quot;Reilly&quot; &amp;&amp; x.CustomerID == customerId).SingleOrDefault());</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        [TestCleanup]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public void TestCleanup()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            DatabaseSnapshot.RestoreSnapShot();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The above test checks that you can look up an existing customer, Mr Jay Adams, and change his name to my name - to John Reilly. If I execute the test above and there was no restore in place then subsequently when I came to exercise this test it should start to fail as it no longer has a Mr Jay Adams to lookup. But with this restore mechanism in place I can execute this test repeatedly without worrying.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="rounding-off">Rounding off<a aria-hidden="true" class="hash-link" href="#rounding-off" title="Direct link to heading">â€‹</a></h2><p>And that&#x27;s us finished - we now have a database snapshot restore mechanism in place. With this we can develop integration tests that thoroughly change the data in our database secure in the knowledge that once the test is complete our database will be restored back to it&#x27;s initial state.</p><p>Obviously there are other alternative approaches for integration testing available to that which I&#x27;ve laid out in this post. But I can imagine that this approach is very useful for applying to legacy applications that you might inherit and need to continue supporting. Also, this approach should fit in well with a continuous integration setup. It would be pretty straightforward to have database that existed purely for testing purposes against which all the integration tests could be set to run at the point of each check in.</p><p>Thanks to Marc Talary, Sandeep Deo and Tishul Vadher who all contributed to <code>DatabaseSnapshot</code>. Credit is also due to Google due to the hundreds of articles the team ended up reading on snapshot backups.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_3kfx"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/database-snapshot-backups">Database Snapshot Backups</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/integration-testing">Integration Testing</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/sql-server">SQL Server</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/blog/2014-01-24-integration-testing-with-entity.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/2014/02/12/wpf-and-mystic-meg-or-playing"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« <!-- -->WPF and Mystic Meg or Playing Futurologist</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/2014/01/09/upgrading-to-typescript-095-personal"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Upgrading to TypeScript 0.9.5 - A Personal Memoir<!-- --> Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#our-mission" class="table-of-contents__link toc-highlight">Our Mission</a></li><li><a href="#we-need-a-database" class="table-of-contents__link toc-highlight">We need a database</a></li><li><a href="#assemble-me-your-finest-dbcontext" class="table-of-contents__link toc-highlight">Assemble me your finest DbContext</a></li><li><a href="#let-there-be-repositories" class="table-of-contents__link toc-highlight">Let There be Repositories!</a></li><li><a href="#and-now-lets-start-integration-testing" class="table-of-contents__link toc-highlight">And Now Let&#39;s Start Integration Testing!</a></li><li><a href="#database-snapshotting-time" class="table-of-contents__link toc-highlight">Database Snapshotting Time</a></li><li><a href="#prove-it" class="table-of-contents__link toc-highlight">Prove it!</a></li><li><a href="#rounding-off" class="table-of-contents__link toc-highlight">Rounding off</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.9adf4245.js"></script>
<script src="/assets/js/main.7a281289.js"></script>
</body>
</html>