<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="I CAN MAKE THIS WORK RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="I CAN MAKE THIS WORK Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-51754530-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="icon" href="/img/favicon/profile.jpg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(37, 194, 160)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/favicon/apple-touch-icon.png"><title data-react-helmet="true">Integration Tests with SQL Server Database Snapshots | I CAN MAKE THIS WORK</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" name="twitter:image" content="https://blog.johnnyreilly.com/img/profile.png"><meta data-react-helmet="true" property="og:url" content="https://blog.johnnyreilly.com/2016/09/12/integration-tests-with-sql-server"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" name="robots" content="max-image-preview:large"><meta data-react-helmet="true" property="og:title" content="Integration Tests with SQL Server Database Snapshots | I CAN MAKE THIS WORK"><meta data-react-helmet="true" name="description" content="Once More With Feeling"><meta data-react-helmet="true" property="og:description" content="Once More With Feeling"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2016-09-12T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://twitter.com/johnny_reilly"><meta data-react-helmet="true" property="article:tag" content="Database Snapshots,Integration Testing,SQL Server"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://blog.johnnyreilly.com/2016/09/12/integration-tests-with-sql-server"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/2016/09/12/integration-tests-with-sql-server" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://blog.johnnyreilly.com/2016/09/12/integration-tests-with-sql-server" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ff16c2af.css">
<link rel="preload" href="/assets/js/runtime~main.ad548b4c.js" as="script">
<link rel="preload" href="/assets/js/main.189e1c42.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/profile.jpg" alt="I CAN MAKE THIS WORK" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">I CAN MAKE THIS WORK</b></a><a class="navbar__item navbar__link" href="/about">About</a><a class="navbar__item navbar__link" href="/blog-archive">Blog Archive</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://polywork.johnnyreilly.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Polywork<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/johnnyreilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/22/typescript-vs-jsdoc-javascript">TypeScript vs JSDoc JavaScript</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/11/18/azure-standard-tests-with-bicep">Azure standard availability tests with Bicep</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/31/nswag-generated-c-sharp-client-property-name-clash">NSwag generated C# client: Open API property name clashes and decimal types rather than double</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/18/docusaurus-meta-tags-and-google-discover">Docusaurus, meta tags and Google Discover</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/2021/10/15/structured-data-seo-and-react">Structured data, SEO and React</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_GeHD" itemprop="headline">Integration Tests with SQL Server Database Snapshots</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2016-09-12T00:00:00.000Z" itemprop="datePublished">September 12, 2016</time> Â· <!-- -->6 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://blog.johnnyreilly.com/img/profile.jpg" alt="John Reilly"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/johnny_reilly" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">John Reilly</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_31ik" id="once-more-with-feeling">Once More With Feeling<a aria-hidden="true" class="hash-link" href="#once-more-with-feeling" title="Direct link to heading">â€‹</a></h2><p>This is a topic that I have written about <a href="https://blog.johnnyreilly.com/2014/01/integration-testing-with-entity.html" target="_blank" rel="noopener noreferrer">before</a>.... But not well. I recently had cause to dust down my notes on how to use snapshotting in your integration tests. To my dismay, referring back to my original blog post was less helpful than I&#x27;d hoped. Now I&#x27;ve cracked the enigma code that my original scribings turned out to be, it&#x27;s time to turn my relearnings back into something genuinely useful.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="whats-the-scenario">What&#x27;s the Scenario?<a aria-hidden="true" class="hash-link" href="#whats-the-scenario" title="Direct link to heading">â€‹</a></h2><p>You have a test database. You want to write integration tests. So what&#x27;s the problem? Well, these tests will add records, delete records, update records within the tables of the database. They will mutate the data. And that&#x27;s exactly what they ought to do; they&#x27;re testing that our code uses the database in the way we would hope and expect.</p><p>So how do we handle this? Well, we could handle this by writing code at the end of each test that is responsible for reverting the database back to the state that it was in at the start of the test. So if we had a test that added a record and tested it, we&#x27;d need the test to be responsible for removing that record before any subsequent tests run. Now that&#x27;s a totally legitimate approach but it adds tax. Each test becomes more complicated and requires more code.</p><p>So what&#x27;s another approach? Perhaps we could take a backup of our database before our first test runs. Then, at the end of each test, we could restore our backup to roll the database back to its initial state. Perfect, right? Less code to write, less scope for errors. So what&#x27;s the downside? Backups are slowwwww. Restores likewise. We could be waiting minutes between each test that runs. That&#x27;s not acceptable.</p><p>There is another way though: <a href="https://msdn.microsoft.com/en-us/library/ms175158.aspx" target="_blank" rel="noopener noreferrer">database snapshots</a> <!-- -->-<!-- --> a feature that&#x27;s been nestling inside SQL Server for a goodly number of years. For our use case, to all intents and purposes, database snapshots offers the same functionality as backups and restores. You can backup a database (take a snapshot of a database at a point in time), you can restore a database (roll back the database to the point of the snapshot). More importantly, you can do either operation in <!-- -->*<em>under a second</em>*<!-- -->. As it happens, Microsoft advocate using this approach themselves:</p><blockquote><p>In a testing environment, it can be useful when repeatedly running a test protocol for the database to contain identical data at the start of each round of testing. Before running the first round, an application developer or tester can create a database snapshot on the test database. After each test run, the database can be quickly returned to its prior state by reverting the database snapshot.</p></blockquote><p>Sold!</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="talk-is-cheap-show-me-the-code">Talk is cheap, show me the code<a aria-hidden="true" class="hash-link" href="#talk-is-cheap-show-me-the-code" title="Direct link to heading">â€‹</a></h2><p>In the end it comes down to 3 classes; <code>DatabaseSnapshot.cs</code> which does the actual snapshotting work and 2 classes that make use of it.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="databasesnapshotcs">DatabaseSnapshot.cs<a aria-hidden="true" class="hash-link" href="#databasesnapshotcs" title="Direct link to heading">â€‹</a></h3><p>This is our <code>DatabaseSnapshot</code> class. Isn&#x27;t it pretty?</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Data;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">using System.Data.SqlClient;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace Testing.Shared</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    public class DatabaseSnapshot</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private readonly string _dbName;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private readonly string _dbSnapShotPath;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private readonly string _dbSnapShotName;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private readonly string _dbConnectionString;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public DatabaseSnapshot(string dbName, string dbSnapshotPath, string dbSnapshotName, string dbConnectionString)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _dbName = dbName;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _dbSnapshotPath = dbSnapshotPath;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _dbSnapshotName = dbSnapshotName;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            _dbConnectionString = dbConnectionString;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public void CreateSnapshot()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            if (!System.IO.Directory.Exists(_dbSnapshotPath))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                System.IO.Directory.CreateDirectory(_dbSnapshotPath);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var sql = $&quot;CREATE DATABASE { _dbSnapshotName } ON (NAME=[{ _dbName }], FILENAME=&#x27;{ _dbSnapshotPath }{ _dbSnapshotName }&#x27;) AS SNAPSHOT OF [{_dbName }]&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            ExecuteSqlAgainstMaster(sql);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public void DeleteSnapshot()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var sql = $&quot;DROP DATABASE { _dbSnapshotName }&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            ExecuteSqlAgainstMaster(sql);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        public void RestoreSnapshot()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            var sql = &quot;USE master;\r\n&quot; +</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                $&quot;ALTER DATABASE {_dbName} SET SINGLE_USER WITH ROLLBACK IMMEDIATE;\r\n&quot; +</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                $&quot;RESTORE DATABASE {_dbName}\r\n&quot; +</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                $&quot;FROM DATABASE_SNAPSHOT = &#x27;{ _dbSnapshotName }&#x27;;\r\n&quot; +</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                $&quot;ALTER DATABASE {_dbName} SET MULTI_USER;\r\n&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            ExecuteSqlAgainstMaster(sql);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        private void ExecuteSqlAgainstMaster(string sql, params SqlParameter[] parameters)</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            using (var conn = new SqlConnection(_dbConnectionString))</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                conn.Open();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                var cmd = new SqlCommand(sql, conn) { CommandType = CommandType.Text };</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                cmd.Parameters.AddRange(parameters);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                cmd.ExecuteNonQuery();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                conn.Close();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>It exposes 3 methods:</p><dl><dt>CreateSnapshot</dt><dd>This method creates the snapshot of the database. We will run this right at the start, before any of our tests run.</dd><dt>DeleteSnapshot</dt><dd>Deletes the snapshot we created. We will run this at the end, after all our tests have finished running.</dd><dt>RestoreSnapshot</dt><dd>Restores the database back to the snapshot we took earlier. We run this after each test has completed. This method relies on a connection to the database (perhaps unsurprisingly). It switches the database in use away from the database that is being restored prior to actually running the restore. It happens to shift to the master database (I believe that&#x27;s entirely incidental; although I haven&#x27;t tested).</dd></dl><h3 class="anchor anchorWithStickyNavbar_31ik" id="setupandteardowncs">SetupAndTeardown.cs<a aria-hidden="true" class="hash-link" href="#setupandteardowncs" title="Direct link to heading">â€‹</a></h3><p>This class is responsible for setting up the snapshot we&#x27;re going to use in our tests right before any of the tests have run (in the <code>FixtureSetup</code> method). It&#x27;s also responsible for deleting the snapshot once all the tests have finished running (in the <code>FixtureTearDown</code> method). It should be noted that in this example I&#x27;m using NUnit and this class is written to depend on the hooks NUnit exposes for running code at the very beginning and end of the test cycle. All test frameworks have these hooks; if you&#x27;re using something other than NUnit then it&#x27;s just a case of swapping in the relevant attribute (everything tends to attribute driven in the test framework world).</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using NUnit.Framework;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace Testing.Shared</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">   [SetUpFixture]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">   public class SetupAndTeardown</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">   {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      public static DatabaseSnapshot DatabaseSnapshot;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      [SetUp]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      public void FixtureSetup()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">         DatabaseSnapshot = new DatabaseSnapshot(&quot;MyDbName&quot;, &quot;C:\\&quot;, &quot;MySnapshot&quot;, &quot;Data Source=.;initial catalog=MyDbName;integrated security=True;&quot;);</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">         try</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">         {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            // Try to delete the snapshot in case it was left over from aborted test runs</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            DatabaseSnapshot.DeleteSnapShot();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">         }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">         catch { /* this should fail with snapshot does not exist */ }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">         DatabaseSnapshot.CreateSnapShot();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      [TearDown]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      public void FixtureTearDown()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">         DatabaseSnapshot.DeleteSnapShot();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_31ik" id="testbasecs">TestBase.cs<a aria-hidden="true" class="hash-link" href="#testbasecs" title="Direct link to heading">â€‹</a></h3><p>All of our test classes are made to inherit from this class:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#d6deeb;background-color:#011627"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#d6deeb"><span class="token plain">using NUnit.Framework;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">namespace Testing.Shared</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">{</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">   public class TestBase</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">   {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      [TearDown]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      public void TearDown()</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">         SetupAndTeardown.DatabaseSnapshot.RestoreSnapShot();</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Which restores the database back to the snapshot position at the end of each test. And that... Is that!</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_3kfx"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/database-snapshots">Database Snapshots</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/integration-testing">Integration Testing</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/sql-server">SQL Server</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/blog/2016-09-12-integration-tests-with-sql-server.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/2016/09/22/typescript-20-es2016-and-babel"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« <!-- -->TypeScript 2.0, ES2016 and Babel</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/2016/08/19/the-ternary-operator-meets-destructuring"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">The Ternary Operator &lt;3 Destructuring<!-- --> Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#once-more-with-feeling" class="table-of-contents__link toc-highlight">Once More With Feeling</a></li><li><a href="#whats-the-scenario" class="table-of-contents__link toc-highlight">What&#39;s the Scenario?</a></li><li><a href="#talk-is-cheap-show-me-the-code" class="table-of-contents__link toc-highlight">Talk is cheap, show me the code</a><ul><li><a href="#databasesnapshotcs" class="table-of-contents__link toc-highlight">DatabaseSnapshot.cs</a></li><li><a href="#setupandteardowncs" class="table-of-contents__link toc-highlight">SetupAndTeardown.cs</a></li><li><a href="#testbasecs" class="table-of-contents__link toc-highlight">TestBase.cs</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Support me</div><ul class="footer__items"><li class="footer__item"><a href="https://www.buymeacoffee.com/qUBm0Wh" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a></li><li class="footer__item"><div style="display: flex; align-items: center;"><iframe src="https://github.com/sponsors/johnnyreilly/button" title="Sponsor johnnyreilly" height="35" width="116" style="border: 0;"></iframe><div>&nbsp;on GitHub</div></div></li></ul></div><div class="col footer__col"><div class="footer__title">Feeds</div><ul class="footer__items"><li class="footer__item"><a href="https://blog.johnnyreilly.com/rss.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>RSS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://blog.johnnyreilly.com/atom.xml" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Atom<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 John Reilly. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.ad548b4c.js"></script>
<script src="/assets/js/main.189e1c42.js"></script>
</body>
</html>